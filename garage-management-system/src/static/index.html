<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GarageManager Pro - Professional Garage Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo i {
            margin-right: 0.5rem;
            color: #4fc3f7;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .notification-badge {
            background: #f44336;
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        /* Layout */
        .layout {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(52, 152, 219, 0.1);
            border-left-color: #3498db;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(52, 152, 219, 0.2);
            border-left-color: #3498db;
            color: #3498db;
        }

        .nav-item i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            background: #e74c3c;
            color: white;
            border-radius: 12px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            background: #f8f9fa;
            overflow-y: auto;
        }

        .page {
            display: none;
            padding: 1rem;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-subtitle {
            color: #7f8c8d;
            font-size: 0.95rem;
            margin-top: 0.25rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.customers { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.vehicles { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.revenue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.documents { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .stat-info p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-controls {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            flex: 1;
            max-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 80px;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Column width management */
        .data-table .col-narrow {
            width: 8%;
            max-width: 100px;
        }

        .data-table .col-medium {
            width: 12%;
            max-width: 150px;
        }

        .data-table .col-wide {
            width: 15%;
            max-width: 200px;
        }

        .data-table .col-extra-wide {
            width: 20%;
            max-width: 250px;
        }

        .data-table .col-actions {
            width: 10%;
            max-width: 120px;
            text-align: center;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-overdue { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-completed { background: #d1ecf1; color: #0c5460; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: #f8f9fa;
        }

        .pagination button {
            padding: 0.5rem 0.75rem;
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #e9ecef;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.1);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Detail View */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .detail-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detail-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #495057;
            min-width: 120px;
        }

        .detail-value {
            color: #2c3e50;
            text-align: right;
            flex: 1;
        }

        .detail-value input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            line-height: 1.2;
            height: 32px;
        }

        .detail-value input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* Tabs */
        .tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
        }

        .tab-list {
            display: flex;
            gap: 0;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: #6c757d;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #495057;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .main-content {
                order: 1;
            }

            .page {
                padding: 0.5rem;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
                padding: 0.5rem;
            }

            .search-box {
                max-width: none;
            }

            .data-table th,
            .data-table td {
                padding: 0.25rem 0.5rem;
                font-size: 0.85rem;
            }

            .data-table .col-narrow {
                width: 6%;
                min-width: 60px;
            }

            .data-table .col-medium {
                width: 10%;
                min-width: 80px;
            }

            .data-table .col-wide {
                width: 12%;
                min-width: 100px;
            }

            .data-table .col-extra-wide {
                width: 15%;
                min-width: 120px;
            }

            .data-table .col-actions {
                width: 8%;
                min-width: 70px;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #6c757d;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MOT Reminder Specific Styles */
        .mot-status-expired {
            background: #f8d7da !important;
            color: #721c24 !important;
            border-left: 4px solid #dc3545 !important;
        }

        .mot-status-critical {
            background: #fff3cd !important;
            color: #856404 !important;
            border-left: 4px solid #fd7e14 !important;
        }

        .mot-status-due-soon {
            background: #d4edda !important;
            color: #155724 !important;
            border-left: 4px solid #ffc107 !important;
        }

        .mot-status-valid {
            background: #d1ecf1 !important;
            color: #0c5460 !important;
            border-left: 4px solid #28a745 !important;
        }

        .mot-card {
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }

        .mot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .mot-card-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mot-card-body {
            padding: 1rem;
        }

        .mot-urgency-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .drag-drop-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drag-drop-area:hover,
        .drag-drop-area.dragover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .file-upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            line-height: 1.2;
            height: auto;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Invoice specific styles */
        .invoice-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .invoice-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .invoice-actions {
            display: flex;
            gap: 0.5rem;
        }

        .invoice-actions button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .invoice-actions button:hover {
            background: rgba(255,255,255,0.2);
        }

        .invoice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .invoice-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .invoice-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .invoice-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .invoice-field:last-child {
            border-bottom: none;
        }

        .invoice-label {
            font-weight: 500;
            color: #495057;
            min-width: 120px;
        }

        .invoice-value {
            color: #2c3e50;
            text-align: right;
            flex: 1;
        }

        .invoice-value input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            line-height: 1.2;
            height: 32px;
        }

        .invoice-value input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .invoice-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
        }

        .invoice-tab-list {
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .invoice-tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-weight: 500;
            margin-right: 2px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .invoice-tab-button:hover {
            background: #5a6268;
        }

        .invoice-tab-button.active {
            background: #667eea;
        }

        .invoice-tab-content {
            display: none;
        }

        .invoice-tab-content.active {
            display: block;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .history-table th,
        .history-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        /* Make all text inputs single line */
        input[type="text"], 
        input[type="email"], 
        input[type="tel"], 
        input[type="number"],
        .form-control,
        .detail-value input,
        .invoice-value input {
            height: 32px !important;
            line-height: 1.2 !important;
            padding: 0.25rem 0.5rem !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* Ensure no textarea behavior */
        textarea {
            resize: none;
            height: 32px !important;
            line-height: 1.2 !important;
            padding: 0.25rem 0.5rem !important;
            overflow: hidden !important;
        }

        /* Completion Tracking Styles */
        .completed-vehicle {
            background-color: #f8f9fa !important;
            opacity: 0.8;
        }

        .completed-vehicle:hover {
            background-color: #e9ecef !important;
        }

        .completion-checkbox {
            accent-color: #28a745;
            transform: scale(1.1);
            margin-right: 0.5rem;
        }

        .verification-badge {
            background: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-filter-info {
            font-size: 0.9rem;
            color: #6c757d;
            padding: 0.25rem 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .bulk-actions .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        /* Enhanced notification styles */
        .notification.info {
            background: #17a2b8;
            color: white;
        }

        .notification.success {
            background: #28a745;
            color: white;
        }

        /* Strikethrough effect for completed registrations */
        .completed-registration {
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Fade effect for completed rows */
        .completed-vehicle td {
            opacity: 0.7;
        }

        .completed-vehicle .verification-badge {
            opacity: 1;
        }

        /* Smart Filtering Styles */
        .flagged-vehicle {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
        }

        .flagged-vehicle:hover {
            background-color: #ffeaa7 !important;
        }

        .flagged-vehicle td {
            position: relative;
        }

        .flagged-vehicle td:first-child::before {
            content: "ðŸ”’";
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        /* SMS Status Indicators */
        .sms-status-ready {
            background-color: #d4edda !important;
            color: #155724 !important;
        }

        .sms-status-flagged {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }

        .sms-status-no-mobile {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }

        .sms-status-sent {
            background-color: #d1ecf1 !important;
            color: #0c5460 !important;
        }

        /* Visual Priority Indicators */
        .priority-expired {
            border-left: 4px solid #dc3545 !important;
        }

        .priority-critical {
            border-left: 4px solid #ffc107 !important;
        }

        .priority-due-soon {
            border-left: 4px solid #17a2b8 !important;
        }

        .priority-flagged {
            border-left: 4px solid #6c757d !important;
        }

        /* Archived Vehicle Styles */
        .archived-vehicle {
            background-color: #f8f9fa !important;
            opacity: 0.7;
            border-left: 4px solid #6c757d !important;
        }

        .archived-vehicle:hover {
            background-color: #e9ecef !important;
        }

        .archived-vehicle td {
            color: #6c757d !important;
        }

        .archived-vehicle .badge {
            opacity: 0.8;
        }

        /* Interactive Filter Button Styles */
        .filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: white;
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .filter-btn:hover {
            border-color: #adb5bd;
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .filter-btn.filter-expired.active {
            background: #dc3545;
            border-color: #dc3545;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .filter-btn.filter-critical.active {
            background: #fd7e14;
            border-color: #fd7e14;
            box-shadow: 0 2px 8px rgba(253, 126, 20, 0.3);
        }

        .filter-btn.filter-due-soon.active {
            background: #ffc107;
            border-color: #ffc107;
            color: #212529;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .filter-btn.filter-normal.active {
            background: #28a745;
            border-color: #28a745;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .filter-btn.filter-flagged.active {
            background: #6c757d;
            border-color: #6c757d;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }

        .filter-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.2rem 0.4rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 1.5rem;
            text-align: center;
        }

        .filter-btn.active .filter-count {
            background: rgba(255, 255, 255, 0.3);
        }

        .filter-btn.filter-due-soon.active .filter-count {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Filter indicator styles */
        #active-filter-indicator {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive filter buttons */
        @media (max-width: 768px) {
            #mot-filter-buttons {
                flex-direction: column;
            }

            .filter-btn {
                justify-content: space-between;
                width: 100%;
            }
        }

        /* Settings Page Styles */
        .settings-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .settings-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .settings-tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .settings-tab-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .settings-tab-btn.active {
            background: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
        }

        .settings-tab-btn i {
            margin-right: 0.5rem;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .settings-section h3 {
            margin: 0 0 1.5rem 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-section h3 i {
            color: #007bff;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .help-text {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 400;
            margin-top: 0.25rem;
        }

        .settings-section .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .settings-section .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .settings-section .form-control:invalid {
            border-color: #dc3545;
        }

        .settings-section .form-control:invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            accent-color: #007bff;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .file-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connection-status {
            margin-left: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.testing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Operating Hours Styles */
        .operating-hours {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .day-hours {
            display: grid;
            grid-template-columns: 100px 1fr auto 1fr auto;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .day-label {
            font-weight: 500;
            color: #495057;
        }

        .time-input {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .time-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        /* Responsive Design for Settings */
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .settings-tabs {
                flex-direction: column;
            }

            .settings-tab-btn {
                min-width: auto;
            }

            .day-hours {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                text-align: center;
            }

            .button-group {
                flex-direction: column;
            }

            .settings-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* MOT Customer Integration Styles */
        .vehicle-mot-card {
            transition: all 0.3s ease;
        }

        .vehicle-mot-card.highlighted {
            background: #f8f9ff !important;
        }

        .vehicle-mot-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .mot-history-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .sms-timeline {
            max-height: 200px;
            overflow-y: auto;
        }

        .sms-entry {
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-car"></i>
            GarageManager Pro
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <button class="header-btn" onclick="exportData()">
                <i class="fas fa-download"></i>
                Export
            </button>
            <button class="header-btn" onclick="printPage()">
                <i class="fas fa-print"></i>
                Print
            </button>
            <button class="header-btn" onclick="showHelp()">
                <i class="fas fa-question-circle"></i>
                Help
            </button>
            <button class="header-btn" style="position: relative;">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">3</span>
            </button>
            <button class="header-btn" onclick="showAdminMenu()">
                <i class="fas fa-user-circle"></i>
                Admin
            </button>
        </div>
    </div>

    <!-- Layout -->
    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="#" class="nav-item active" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
                <span class="nav-badge">1</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('customers')">
                <i class="fas fa-users"></i>
                Customers
                <span class="nav-badge">2</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('vehicles')">
                <i class="fas fa-car"></i>
                Vehicles
                <span class="nav-badge">3</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('jobs')">
                <i class="fas fa-wrench"></i>
                Jobs
                <span class="nav-badge">4</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('mot-reminders')">
                <i class="fas fa-calendar-check"></i>
                MOT Reminders
                <span class="nav-badge" id="mot-urgent-count">0</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('parts')">
                <i class="fas fa-cogs"></i>
                Parts
                <span class="nav-badge">6</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('invoices')">
                <i class="fas fa-file-invoice"></i>
                Invoices
            </a>
            <a href="#" class="nav-item" onclick="showPage('reports')">
                <i class="fas fa-chart-bar"></i>
                Reports
            </a>
            <a href="#" class="nav-item" onclick="showPage('settings')">
                <i class="fas fa-cog"></i>
                Settings
                <span class="nav-badge">7</span>
            </a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-tachometer-alt"></i>
                            Dashboard
                        </h1>
                        <p class="page-subtitle">Overview of your garage management system</p>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon customers">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-customers">7,037</h3>
                            <p>Total Customers</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon vehicles">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-vehicles">10,364</h3>
                            <p>Total Vehicles</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue">
                            <i class="fas fa-pound-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-revenue">Â£8.6M</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon documents">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-documents">30,354</h3>
                            <p>Documents</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        Recent Activity
                    </div>
                    <div class="card-content">
                        <p>Recent jobs, invoices, and customer activity will be displayed here.</p>
                    </div>
                </div>
            </div>

            <!-- Customers Page -->
            <div id="customers" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-users"></i>
                            Customer Management
                        </h1>
                        <p class="page-subtitle">Manage all customers and their information</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="customer-search" placeholder="Customer Search" onkeyup="searchCustomers()">
                    </div>
                    <button class="btn btn-primary" onclick="showNewCustomerForm()">
                        <i class="fas fa-plus"></i>
                        New Customer
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-list"></i>
                        Customer List
                    </div>
                    <div class="table-controls">
                        <div>Showing <span id="customer-range">1 to 50</span> of <span id="customer-total">7,037</span> customers</div>
                        <div>
                            <select id="customer-per-page" onchange="changeCustomerPerPage()">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Account Number</th>
                                    <th class="col-wide">Name</th>
                                    <th class="col-wide">Company</th>
                                    <th class="col-extra-wide">Address</th>
                                    <th class="col-narrow">Postcode</th>
                                    <th class="col-medium">Phone</th>
                                    <th class="col-narrow">Vehicles</th>
                                    <th class="col-narrow">Documents</th>
                                    <th class="col-medium">Last Invoice</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body">
                                <tr>
                                    <td colspan="10" class="loading">
                                        <div class="spinner"></div>
                                        Loading customers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="customer-pagination">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Vehicles Page -->
            <div id="vehicles" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-car"></i>
                            Vehicle Management
                        </h1>
                        <p class="page-subtitle">Manage all vehicles and their information</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="vehicle-search" placeholder="Vehicle Search" onkeyup="searchVehicles()">
                    </div>
                    <button class="btn btn-primary" onclick="showNewVehicleForm()">
                        <i class="fas fa-plus"></i>
                        New Vehicle
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-list"></i>
                        Vehicle List
                    </div>
                    <div class="table-controls">
                        <div>Showing <span id="vehicle-range">1 to 50</span> of <span id="vehicle-total">10,364</span> vehicles</div>
                        <div>
                            <select id="vehicle-per-page" onchange="changeVehiclePerPage()">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Registration</th>
                                    <th class="col-medium">Make</th>
                                    <th class="col-medium">Model</th>
                                    <th class="col-narrow">Color</th>
                                    <th class="col-narrow">Fuel Type</th>
                                    <th class="col-medium">MOT Due</th>
                                    <th class="col-narrow">Mileage</th>
                                    <th class="col-wide">Customer</th>
                                    <th class="col-medium">Last Service</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicles-table-body">
                                <tr>
                                    <td colspan="10" class="loading">
                                        <div class="spinner"></div>
                                        Loading vehicles...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="vehicle-pagination">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Jobs Page -->
            <div id="jobs" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-wrench"></i>
                            Job Management
                        </h1>
                        <p class="page-subtitle">All jobs and work orders</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="job-search" placeholder="Job Search">
                    </div>
                    <button class="btn btn-primary" onclick="showNewJobForm()">
                        <i class="fas fa-plus"></i>
                        New Job
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-wrench"></i>
                        Job List
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-narrow">Job No</th>
                                    <th class="col-medium">Date</th>
                                    <th class="col-wide">Customer</th>
                                    <th class="col-medium">Vehicle</th>
                                    <th class="col-extra-wide">Description</th>
                                    <th class="col-narrow">Status</th>
                                    <th class="col-narrow">Total</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body">
                                <tr>
                                    <td colspan="8" class="loading">
                                        <div class="spinner"></div>
                                        Loading jobs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Invoices Page -->
            <div id="invoices" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-file-invoice"></i>
                            Invoice Management
                        </h1>
                        <p class="page-subtitle">All invoices and billing</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="invoice-search" placeholder="Invoice Search">
                    </div>
                    <button class="btn btn-primary" onclick="showNewInvoiceForm()">
                        <i class="fas fa-plus"></i>
                        New Invoice
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-file-invoice"></i>
                        Invoice List
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Invoice No</th>
                                    <th class="col-medium">Date</th>
                                    <th class="col-wide">Customer</th>
                                    <th class="col-medium">Vehicle</th>
                                    <th class="col-extra-wide">Description</th>
                                    <th class="col-narrow">Total</th>
                                    <th class="col-narrow">Status</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-table-body">
                                <tr>
                                    <td colspan="8" class="loading">
                                        <div class="spinner"></div>
                                        Loading invoices...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- MOT Reminders Page -->
            <div id="mot-reminders" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-calendar-check"></i>
                            MOT Reminders
                        </h1>
                        <p class="page-subtitle">Monitor MOT expiry dates and send reminders</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="mot-search" placeholder="Search by registration..." onkeyup="searchMOTVehicles()">
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="showAddVehicleModal()">
                            <i class="fas fa-plus"></i>
                            Add Vehicle
                        </button>
                        <button class="btn btn-secondary" onclick="showBulkUploadModal()">
                            <i class="fas fa-upload"></i>
                            Bulk Upload
                        </button>
                        <button class="btn btn-warning" onclick="showFailedRegistrationsModal()" id="failed-regs-button">
                            <i class="fas fa-exclamation-triangle"></i>
                            Review Failed
                            <span class="badge bg-light text-dark ms-1" id="failed-count">0</span>
                        </button>
                        <button class="btn btn-success" onclick="showSMSModal()" id="sms-button">
                            <i class="fas fa-sms"></i>
                            Send SMS
                            <span class="badge bg-light text-dark ms-1" id="sms-count">0</span>
                        </button>
                        <button class="btn btn-info" onclick="showSMSHistoryModal()">
                            <i class="fas fa-history"></i>
                            SMS History
                        </button>
                        <button class="btn btn-secondary" onclick="toggleArchivedView()" id="archive-toggle-btn">
                            <i class="fas fa-archive"></i>
                            <span id="archive-toggle-text">Show Archived</span>
                        </button>
                        <button class="btn btn-warning" onclick="linkExistingVehicles()" title="Link existing vehicles to customers">
                            <i class="fas fa-link"></i>
                            Link Customers
                        </button>
                        <button class="btn btn-danger" onclick="confirmClearAllData()" title="Clear all MOT data">
                            <i class="fas fa-trash-alt"></i>
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- MOT Statistics -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="mot-expired-count">0</h3>
                            <p>Expired MOTs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="mot-critical-count">0</h3>
                            <p>Due Within 7 Days</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="mot-due-soon-count">0</h3>
                            <p>Due Within 30 Days</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="mot-valid-count">0</h3>
                            <p>Valid MOTs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="mot-flagged-count">0</h3>
                            <p>Flagged (365+ days)</p>
                        </div>
                    </div>
                </div>

                <!-- Interactive Filter Buttons -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="card-content" style="padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <h5 style="margin-bottom: 0.75rem; color: #495057;">
                                <i class="fas fa-filter"></i> Filter by Status
                            </h5>
                            <div id="mot-filter-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="filter-btn active" data-filter="all" onclick="applyMOTFilter('all')">
                                    <i class="fas fa-list"></i> All Vehicles
                                    <span class="filter-count" id="filter-count-all">0</span>
                                </button>
                                <button class="filter-btn filter-expired" data-filter="expired" onclick="applyMOTFilter('expired')">
                                    <i class="fas fa-exclamation-triangle"></i> Expired
                                    <span class="filter-count" id="filter-count-expired">0</span>
                                </button>
                                <button class="filter-btn filter-critical" data-filter="critical" onclick="applyMOTFilter('critical')">
                                    <i class="fas fa-clock"></i> Critical
                                    <span class="filter-count" id="filter-count-critical">0</span>
                                </button>
                                <button class="filter-btn filter-due-soon" data-filter="due_soon" onclick="applyMOTFilter('due_soon')">
                                    <i class="fas fa-calendar-alt"></i> Due Soon
                                    <span class="filter-count" id="filter-count-due-soon">0</span>
                                </button>
                                <button class="filter-btn filter-normal" data-filter="normal" onclick="applyMOTFilter('normal')">
                                    <i class="fas fa-check-circle"></i> Normal
                                    <span class="filter-count" id="filter-count-normal">0</span>
                                </button>
                                <button class="filter-btn filter-flagged" data-filter="flagged" onclick="applyMOTFilter('flagged')">
                                    <i class="fas fa-lock"></i> Flagged
                                    <span class="filter-count" id="filter-count-flagged">0</span>
                                </button>
                            </div>
                        </div>

                        <!-- Active Filter Indicator -->
                        <div id="active-filter-indicator" style="display: none; padding: 0.5rem; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #2196f3;">
                            <i class="fas fa-info-circle" style="color: #1976d2;"></i>
                            <span id="active-filter-text">Showing: All Vehicles</span>
                            <button onclick="clearMOTFilter()" style="float: right; background: none; border: none; color: #1976d2; cursor: pointer;">
                                <i class="fas fa-times"></i> Clear Filter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- View Toggle -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="card-content" style="padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>View Mode:</strong>
                                <button class="btn btn-sm" id="list-view-btn" onclick="switchMOTView('list')" style="margin-left: 0.5rem; background: #667eea; color: white;">
                                    <i class="fas fa-list"></i> List View
                                </button>
                                <button class="btn btn-sm btn-secondary" id="card-view-btn" onclick="switchMOTView('card')" style="margin-left: 0.25rem;">
                                    <i class="fas fa-th-large"></i> Card View
                                </button>
                            </div>
                            <div>
                                <strong>Sort:</strong>
                                <select id="mot-sort-select" onchange="applySortToMOTVehicles()" style="margin-left: 0.5rem; padding: 0.25rem;">
                                    <option value="urgency">By Urgency</option>
                                    <option value="expiry">By Expiry Date</option>
                                    <option value="registration">By Registration</option>
                                    <option value="customer">By Customer</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Filter and Bulk Actions -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="card-content" style="padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div>
                                    <strong>Status Filter:</strong>
                                    <select id="status-filter-select" onchange="applyStatusFilter()" style="margin-left: 0.5rem; padding: 0.25rem;">
                                        <option value="all">All Vehicles</option>
                                        <option value="pending">Pending Only</option>
                                        <option value="completed">Completed Only</option>
                                    </select>
                                </div>
                                <div style="font-size: 0.9rem; color: #6c757d;">
                                    <span id="pending-count">0</span> pending,
                                    <span id="completed-count">0</span> completed
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <button class="btn btn-sm btn-success" onclick="markSelectedAsCompleted()"
                                        title="Mark selected vehicles as completed/verified">
                                    <i class="fas fa-check"></i> Mark as Completed
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="markSelectedAsPending()"
                                        title="Mark selected vehicles as pending (reset completion)">
                                    <i class="fas fa-undo"></i> Mark as Pending
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="archiveSelectedVehicles()"
                                        title="Archive selected vehicles (removes from active list)">
                                    <i class="fas fa-archive"></i> Archive Selected
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="resetAllCompletionStatus()"
                                        title="Reset all completion status">
                                    <i class="fas fa-refresh"></i> Reset All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MOT Vehicles List View -->
                <div class="table-container" id="mot-list-view">
                    <div class="table-header">
                        <i class="fas fa-list"></i>
                        MOT Status List
                        <span style="margin-left: auto; font-size: 0.9rem; font-weight: normal;">
                            Total: <span id="mot-total-count">0</span> vehicles
                        </span>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-narrow">
                                        <input type="checkbox" id="select-all-mot" onchange="toggleAllMOTSelection()">
                                    </th>
                                    <th class="col-medium">Registration</th>
                                    <th class="col-medium">Make/Model</th>
                                    <th class="col-wide">Customer</th>
                                    <th class="col-medium">MOT Expiry</th>
                                    <th class="col-narrow">Days Left</th>
                                    <th class="col-narrow">Status</th>
                                    <th class="col-medium">Mobile</th>
                                    <th class="col-narrow">SMS Status</th>
                                    <th class="col-narrow">Uploaded</th>
                                    <th class="col-narrow">SMS Sent</th>
                                    <th class="col-narrow">Verified</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mot-vehicles-table-body">
                                <tr>
                                    <td colspan="13" class="loading">
                                        <div class="spinner"></div>
                                        Loading MOT data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- MOT Vehicles Card View -->
                <div id="mot-card-view" style="display: none;">
                    <div id="mot-vehicles-cards" class="row">
                        <!-- Cards will be populated here -->
                    </div>
                </div>
            </div>

            <div id="parts" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-cogs"></i>
                            Parts Management
                        </h1>
                        <p class="page-subtitle">Inventory and parts tracking</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <p>Parts management functionality will be available soon.</p>
                    </div>
                </div>
            </div>

            <div id="reports" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-chart-bar"></i>
                            Reports
                        </h1>
                        <p class="page-subtitle">Business analytics and reports</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <p>Reports functionality will be available soon.</p>
                    </div>
                </div>
            </div>

            <div id="settings" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-cog"></i>
                            Settings
                        </h1>
                        <p class="page-subtitle">System configuration and preferences</p>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-success" onclick="saveAllSettings()">
                            <i class="fas fa-save"></i> Save All Settings
                        </button>
                        <button class="btn btn-secondary" onclick="resetAllSettings()">
                            <i class="fas fa-undo"></i> Reset to Defaults
                        </button>
                    </div>
                </div>

                <!-- Settings Navigation Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab-btn active" onclick="showSettingsTab('mot-settings')">
                        <i class="fas fa-calendar-check"></i> MOT Reminders
                    </button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('system-settings')">
                        <i class="fas fa-desktop"></i> System
                    </button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('garage-settings')">
                        <i class="fas fa-building"></i> Garage Info
                    </button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('user-settings')">
                        <i class="fas fa-user"></i> User Account
                    </button>
                </div>

                <!-- MOT Reminder Settings Tab -->
                <div id="mot-settings" class="settings-tab-content active">
                    <div class="settings-section">
                        <h3><i class="fas fa-key"></i> DVLA API Configuration</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Client ID
                                    <span class="help-text">Your DVSA API Client ID</span>
                                </label>
                                <input type="text" id="dvla-client-id" class="form-control"
                                       placeholder="Enter DVSA Client ID"
                                       value="2b3911f4-55f5-4a86-a9f0-0fc02c2bff0f">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Token URL
                                    <span class="help-text">DVSA OAuth2 token endpoint</span>
                                </label>
                                <input type="url" id="dvla-token-url" class="form-control"
                                       placeholder="Enter Token URL"
                                       value="https://login.microsoftonline.com/a455b827-244f-4c97-b5b4-ce5d13b4d00c/oauth2/v2.0/token">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="testDVLAConnection()">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <span id="dvla-status" class="connection-status"></span>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-sms"></i> SMS Service Settings</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    SMS Provider
                                    <span class="help-text">Choose your SMS service provider</span>
                                </label>
                                <select id="sms-provider" class="form-control">
                                    <option value="twilio">Twilio</option>
                                    <option value="textlocal">Textlocal</option>
                                    <option value="clicksend">ClickSend</option>
                                    <option value="custom">Custom Provider</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Sender ID
                                    <span class="help-text">Name or number shown as sender</span>
                                </label>
                                <input type="text" id="sms-sender-id" class="form-control"
                                       placeholder="e.g., GarageABC" maxlength="11">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Default SMS Template
                                <span class="help-text">Use {customer_name}, {registration}, {expiry_date} as placeholders</span>
                            </label>
                            <textarea id="sms-template" class="form-control" rows="3"
                                      placeholder="Hi {customer_name}, your vehicle {registration} MOT expires on {expiry_date}. Please contact us to book your MOT test.">Hi {customer_name}, your vehicle {registration} MOT expires on {expiry_date}. Please contact us to book your MOT test.</textarea>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-bell"></i> Notification Preferences</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Primary Reminder (Days Before)
                                    <span class="help-text">First reminder before MOT expiry</span>
                                </label>
                                <select id="reminder-primary" class="form-control">
                                    <option value="60">60 days</option>
                                    <option value="45">45 days</option>
                                    <option value="30" selected>30 days</option>
                                    <option value="21">21 days</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Follow-up Reminder (Days Before)
                                    <span class="help-text">Second reminder before MOT expiry</span>
                                </label>
                                <select id="reminder-followup" class="form-control">
                                    <option value="21">21 days</option>
                                    <option value="14" selected>14 days</option>
                                    <option value="10">10 days</option>
                                    <option value="7">7 days</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Final Reminder (Days Before)
                                    <span class="help-text">Last reminder before MOT expiry</span>
                                </label>
                                <select id="reminder-final" class="form-control">
                                    <option value="14">14 days</option>
                                    <option value="10">10 days</option>
                                    <option value="7" selected>7 days</option>
                                    <option value="3">3 days</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-database"></i> Data Management</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">Export MOT Data</label>
                                <div class="button-group">
                                    <button class="btn btn-secondary" onclick="exportMOTData('csv')">
                                        <i class="fas fa-file-csv"></i> Export as CSV
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportMOTData('json')">
                                        <i class="fas fa-file-code"></i> Export as JSON
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Import MOT Data</label>
                                <div class="file-input-group">
                                    <input type="file" id="import-mot-data" accept=".csv,.json" style="display: none;" onchange="importMOTData(event)">
                                    <button class="btn btn-secondary" onclick="document.getElementById('import-mot-data').click()">
                                        <i class="fas fa-upload"></i> Import Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">Completion Tracking</label>
                                <div class="button-group">
                                    <button class="btn btn-warning" onclick="clearCompletionHistory()">
                                        <i class="fas fa-eraser"></i> Clear Completion History
                                    </button>
                                    <button class="btn btn-info" onclick="exportCompletionData()">
                                        <i class="fas fa-download"></i> Export Completion Data
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Backup & Restore</label>
                                <div class="button-group">
                                    <button class="btn btn-success" onclick="createBackup()">
                                        <i class="fas fa-shield-alt"></i> Create Backup
                                    </button>
                                    <button class="btn btn-danger" onclick="restoreFromBackup()">
                                        <i class="fas fa-history"></i> Restore Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Settings Tab -->
                <div id="system-settings" class="settings-tab-content">
                    <div class="settings-section">
                        <h3><i class="fas fa-calendar-alt"></i> Date Format Preferences</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Date Format
                                    <span class="help-text">Choose how dates are displayed throughout the system</span>
                                </label>
                                <select id="date-format" class="form-control">
                                    <option value="DD-MM-YYYY" selected>DD-MM-YYYY (31-12-2024)</option>
                                    <option value="MM-DD-YYYY">MM-DD-YYYY (12-31-2024)</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD (2024-12-31)</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY (31/12/2024)</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY (12/31/2024)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Time Format
                                    <span class="help-text">Choose 12-hour or 24-hour time format</span>
                                </label>
                                <select id="time-format" class="form-control">
                                    <option value="24h" selected>24-hour (14:30)</option>
                                    <option value="12h">12-hour (2:30 PM)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-table"></i> Display Preferences</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Table Row Density
                                    <span class="help-text">Spacing between table rows</span>
                                </label>
                                <select id="table-density" class="form-control">
                                    <option value="compact">Compact</option>
                                    <option value="normal" selected>Normal</option>
                                    <option value="comfortable">Comfortable</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Default Page Size
                                    <span class="help-text">Number of items shown per page</span>
                                </label>
                                <select id="page-size" class="form-control">
                                    <option value="10">10 items</option>
                                    <option value="25" selected>25 items</option>
                                    <option value="50">50 items</option>
                                    <option value="100">100 items</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    UI Theme
                                    <span class="help-text">Choose the application theme</span>
                                </label>
                                <select id="ui-theme" class="form-control">
                                    <option value="light" selected>Light Theme</option>
                                    <option value="dark">Dark Theme</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="show-tooltips" checked>
                                <span class="checkmark"></span>
                                Show helpful tooltips and hints
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="auto-save" checked>
                                <span class="checkmark"></span>
                                Auto-save form data as you type
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-bell"></i> Notification Settings</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="desktop-notifications" checked>
                                    <span class="checkmark"></span>
                                    Enable desktop notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sound-notifications">
                                    <span class="checkmark"></span>
                                    Play sound for notifications
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Notification Duration
                                <span class="help-text">How long notifications stay visible</span>
                            </label>
                            <select id="notification-duration" class="form-control">
                                <option value="3000">3 seconds</option>
                                <option value="5000" selected>5 seconds</option>
                                <option value="10000">10 seconds</option>
                                <option value="0">Until dismissed</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Garage Information Settings Tab -->
                <div id="garage-settings" class="settings-tab-content">
                    <div class="settings-section">
                        <h3><i class="fas fa-building"></i> Business Information</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Garage Name
                                    <span class="help-text">Your business trading name</span>
                                </label>
                                <input type="text" id="garage-name" class="form-control"
                                       placeholder="Enter garage name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Business Registration Number
                                    <span class="help-text">Company registration or VAT number</span>
                                </label>
                                <input type="text" id="business-reg" class="form-control"
                                       placeholder="Enter registration number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Business Address
                                <span class="help-text">Full business address</span>
                            </label>
                            <textarea id="garage-address" class="form-control" rows="3"
                                      placeholder="Enter full business address"></textarea>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-phone"></i> Contact Information</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Main Phone Number
                                    <span class="help-text">Primary contact number</span>
                                </label>
                                <input type="tel" id="garage-phone" class="form-control"
                                       placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Mobile Number
                                    <span class="help-text">Mobile contact number</span>
                                </label>
                                <input type="tel" id="garage-mobile" class="form-control"
                                       placeholder="Enter mobile number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Email Address
                                    <span class="help-text">Business email address</span>
                                </label>
                                <input type="email" id="garage-email" class="form-control"
                                       placeholder="Enter email address">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Website URL
                                    <span class="help-text">Business website (optional)</span>
                                </label>
                                <input type="url" id="garage-website" class="form-control"
                                       placeholder="https://www.example.com">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-clock"></i> Operating Hours</h3>
                        <div class="operating-hours">
                            <div class="day-hours">
                                <label class="day-label">Monday</label>
                                <input type="time" id="mon-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="mon-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="mon-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Tuesday</label>
                                <input type="time" id="tue-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="tue-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="tue-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Wednesday</label>
                                <input type="time" id="wed-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="wed-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="wed-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Thursday</label>
                                <input type="time" id="thu-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="thu-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="thu-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Friday</label>
                                <input type="time" id="fri-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="fri-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="fri-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Saturday</label>
                                <input type="time" id="sat-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="sat-close" class="time-input" value="13:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sat-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Sunday</label>
                                <input type="time" id="sun-open" class="time-input" value="10:00">
                                <span>to</span>
                                <input type="time" id="sun-close" class="time-input" value="16:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sun-closed" checked>
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Account Settings Tab -->
                <div id="user-settings" class="settings-tab-content">
                    <div class="settings-section">
                        <h3><i class="fas fa-user"></i> Account Information</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Full Name
                                    <span class="help-text">Your full name</span>
                                </label>
                                <input type="text" id="user-name" class="form-control"
                                       placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Email Address
                                    <span class="help-text">Your email address</span>
                                </label>
                                <input type="email" id="user-email" class="form-control"
                                       placeholder="Enter your email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Job Title
                                    <span class="help-text">Your role in the garage</span>
                                </label>
                                <input type="text" id="user-title" class="form-control"
                                       placeholder="e.g., Manager, Technician">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Phone Number
                                    <span class="help-text">Your contact number</span>
                                </label>
                                <input type="tel" id="user-phone" class="form-control"
                                       placeholder="Enter your phone number">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-shield-alt"></i> Security Settings</h3>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="changePassword()">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="two-factor-auth">
                                <span class="checkmark"></span>
                                Enable two-factor authentication
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="session-timeout" checked>
                                <span class="checkmark"></span>
                                Auto-logout after inactivity
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-cog"></i> Personal Preferences</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Language
                                    <span class="help-text">Interface language</span>
                                </label>
                                <select id="user-language" class="form-control">
                                    <option value="en" selected>English</option>
                                    <option value="es">EspaÃ±ol</option>
                                    <option value="fr">FranÃ§ais</option>
                                    <option value="de">Deutsch</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Timezone
                                    <span class="help-text">Your local timezone</span>
                                </label>
                                <select id="user-timezone" class="form-control">
                                    <option value="Europe/London" selected>London (GMT)</option>
                                    <option value="Europe/Paris">Paris (CET)</option>
                                    <option value="America/New_York">New York (EST)</option>
                                    <option value="America/Los_Angeles">Los Angeles (PST)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="email-notifications" checked>
                                <span class="checkmark"></span>
                                Receive email notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="marketing-emails">
                                <span class="checkmark"></span>
                                Receive marketing emails
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customer-detail-modal" class="modal">
        <div class="modal-content" style="width: 95vw; max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title" id="customer-detail-title">Customer Details</h2>
                <button class="modal-close" onclick="closeCustomerDetail()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>Customer Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Account Number</span>
                            <span class="detail-value">
                                <input type="text" id="customer-account-number" onchange="updateCustomerField('account_number', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Company</span>
                            <span class="detail-value">
                                <input type="text" id="customer-company" onchange="updateCustomerField('company_name', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Name</span>
                            <span class="detail-value">
                                <input type="text" id="customer-name" onchange="updateCustomerField('name', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Address</span>
                            <span class="detail-value">
                                <input type="text" id="customer-address" onchange="updateCustomerField('address', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Postcode</span>
                            <span class="detail-value">
                                <input type="text" id="customer-postcode" onchange="updateCustomerField('postcode', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Mobile</span>
                            <span class="detail-value">
                                <input type="text" id="customer-mobile" onchange="updateCustomerField('mobile', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email</span>
                            <span class="detail-value">
                                <input type="text" id="customer-email" onchange="updateCustomerField('email', this.value)">
                            </span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h3>Account Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Customer Since</span>
                            <span class="detail-value" id="customer-since">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Total Vehicles</span>
                            <span class="detail-value" id="customer-vehicle-count">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Total Services</span>
                            <span class="detail-value" id="customer-service-count">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Last Service</span>
                            <span class="detail-value" id="customer-last-service">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Account Balance</span>
                            <span class="detail-value" id="customer-balance">Â£0.00</span>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab-list">
                        <button class="tab-button active" onclick="showCustomerTab('vehicles')">Vehicles</button>
                        <button class="tab-button" onclick="showCustomerTab('history')">Service History</button>
                        <button class="tab-button" onclick="showCustomerTab('invoices')">Invoices</button>
                        <button class="tab-button" onclick="showCustomerTab('documents')">Documents</button>
                    </div>
                </div>

                <div id="customer-tab-vehicles" class="tab-content active">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Registration</th>
                                    <th class="col-medium">Make</th>
                                    <th class="col-medium">Model</th>
                                    <th class="col-narrow">Color</th>
                                    <th class="col-medium">MOT Due</th>
                                    <th class="col-narrow">Mileage</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customer-vehicles-table">
                                <tr>
                                    <td colspan="7" class="loading">
                                        <div class="spinner"></div>
                                        Loading vehicles...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="customer-tab-history" class="tab-content">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Date</th>
                                    <th class="col-medium">Vehicle</th>
                                    <th class="col-extra-wide">Description</th>
                                    <th class="col-narrow">Total</th>
                                    <th class="col-narrow">Status</th>
                                </tr>
                            </thead>
                            <tbody id="customer-history-table">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <div class="spinner"></div>
                                        Loading service history...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="customer-tab-invoices" class="tab-content">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Invoice No</th>
                                    <th class="col-medium">Date</th>
                                    <th class="col-medium">Vehicle</th>
                                    <th class="col-extra-wide">Description</th>
                                    <th class="col-narrow">Total</th>
                                    <th class="col-narrow">Status</th>
                                </tr>
                            </thead>
                            <tbody id="customer-invoices-table">
                                <tr>
                                    <td colspan="6" class="loading">
                                        <div class="spinner"></div>
                                        Loading invoices...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="customer-tab-documents" class="tab-content">
                    <p>Customer documents will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Detail Modal -->
    <div id="vehicle-detail-modal" class="modal">
        <div class="modal-content" style="width: 95vw; max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title" id="vehicle-detail-title">Vehicle Details</h2>
                <button class="modal-close" onclick="closeVehicleDetail()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>Vehicle Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Registration</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-registration" onchange="updateVehicleField('registration', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Make</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-make" onchange="updateVehicleField('make', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Model</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-model" onchange="updateVehicleField('model', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Color</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-color" onchange="updateVehicleField('color', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fuel Type</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-fuel-type" onchange="updateVehicleField('fuel_type', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Mileage</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-mileage" onchange="updateVehicleField('mileage', this.value)">
                            </span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h3>Owner Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Customer</span>
                            <span class="detail-value" id="vehicle-customer-name">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Account</span>
                            <span class="detail-value" id="vehicle-customer-account">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone</span>
                            <span class="detail-value" id="vehicle-customer-phone">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">MOT Due</span>
                            <span class="detail-value" id="vehicle-mot-due">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Last Service</span>
                            <span class="detail-value" id="vehicle-last-service">-</span>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab-list">
                        <button class="tab-button active" onclick="showVehicleTab('history')">Service History</button>
                        <button class="tab-button" onclick="showVehicleTab('jobs')">Jobs</button>
                        <button class="tab-button" onclick="showVehicleTab('invoices')">Invoices</button>
                        <button class="tab-button" onclick="showVehicleTab('documents')">Documents</button>
                    </div>
                </div>

                <div id="vehicle-tab-history" class="tab-content active">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Doc No</th>
                                <th>Mileage</th>
                                <th>Description</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-history-table">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Loading service history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="vehicle-tab-jobs" class="tab-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Job No</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-jobs-table">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Loading jobs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="vehicle-tab-invoices" class="tab-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Invoice No</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-invoices-table">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Loading invoices...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="vehicle-tab-documents" class="tab-content">
                    <p>Vehicle documents will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div id="invoice-detail-modal" class="modal">
        <div class="modal-content" style="width: 95vw; max-width: 1400px;">
            <div class="modal-body">
                <div class="invoice-header">
                    <h2 class="invoice-title" id="invoice-detail-title">Standard Invoice: 88187 (JS: 90242) (Issued)</h2>
                    <button class="modal-close" onclick="closeInvoiceDetail()">&times;</button>
                </div>

                <div class="invoice-grid">
                    <div class="invoice-section">
                        <h3>Vehicle Information</h3>
                        <div class="invoice-field">
                            <span class="invoice-label">Registration</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-registration" onchange="updateInvoiceField('vehicle.registration', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Make / Model</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-make-model" onchange="updateInvoiceField('vehicle.make_model', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Chassis</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-chassis" onchange="updateInvoiceField('vehicle.chassis', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Engine CC</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-engine-cc" onchange="updateInvoiceField('vehicle.engine_cc', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Fuel Type</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-fuel-type" onchange="updateInvoiceField('vehicle.fuel_type', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Color</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-color" onchange="updateInvoiceField('vehicle.color', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Mileage</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-mileage" onchange="updateInvoiceField('vehicle.mileage', this.value)">
                            </span>
                        </div>
                    </div>
                    <div class="invoice-section">
                        <h3>Customer Information</h3>
                        <div class="invoice-field">
                            <span class="invoice-label">Account Number</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-account" onchange="updateInvoiceField('customer.account_number', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Company</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-company" onchange="updateInvoiceField('customer.company', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Name</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-name" onchange="updateInvoiceField('customer.name', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Address</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-address" onchange="updateInvoiceField('customer.address', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Postcode</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-postcode" onchange="updateInvoiceField('customer.postcode', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Mobile</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-mobile" onchange="updateInvoiceField('customer.mobile', this.value)">
                            </span>
                        </div>
                    </div>
                </div>

                <div class="invoice-tabs">
                    <div class="invoice-tab-list">
                        <button class="invoice-tab-button active" onclick="showInvoiceTab('history')">History</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('description')">Description</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('labour')">Labour</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('parts')">Parts</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('advisories')">Advisories</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('activity')">Activity</button>
                    </div>
                </div>

                <div id="invoice-tab-history" class="invoice-tab-content active">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Doc No</th>
                                <th>Mileage</th>
                                <th>Description</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-history-table">
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>
                                    Loading history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="invoice-tab-description" class="invoice-tab-content">
                    <div style="padding: 1rem;">
                        <textarea id="invoice-description" style="width: 100%; height: 200px; padding: 1rem; border: 1px solid #dee2e6; border-radius: 4px;" onchange="updateInvoiceField('description', this.value)"></textarea>
                    </div>
                </div>

                <div id="invoice-tab-labour" class="invoice-tab-content">
                    <p>Labour details will be displayed here.</p>
                </div>

                <div id="invoice-tab-parts" class="invoice-tab-content">
                    <p>Parts details will be displayed here.</p>
                </div>

                <div id="invoice-tab-advisories" class="invoice-tab-content">
                    <p>Advisories will be displayed here.</p>
                </div>

                <div id="invoice-tab-activity" class="invoice-tab-content">
                    <p>Activity log will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="add-vehicle-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Add Vehicle for MOT Monitoring</h2>
                <button class="modal-close" onclick="closeAddVehicleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-vehicle-form" onsubmit="addMOTVehicle(event)">
                    <div class="form-group">
                        <label class="form-label">Vehicle Registration</label>
                        <input type="text" id="vehicle-registration-input" class="form-control"
                               placeholder="e.g., AB12 CDE" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Name (Optional)</label>
                        <input type="text" id="customer-name-input" class="form-control"
                               placeholder="Customer name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobile Number (Optional)</label>
                        <input type="text" id="mobile-number-input" class="form-control"
                               placeholder="e.g., 07123456789">
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeAddVehicleModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Vehicle
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulk-upload-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Bulk Upload Vehicles</h2>
                <button class="modal-close" onclick="closeBulkUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Upload CSV or Excel File</label>
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: #0066cc;"></i>
                            <strong style="color: #0066cc;">DVLA Data Only</strong>
                        </div>
                        <p style="margin: 0; font-size: 0.9rem; color: #0066cc;">
                            Only vehicles found in the DVLA database will be added. Vehicles not found will be skipped to ensure data accuracy.
                        </p>
                    </div>
                    <div class="drag-drop-area" id="file-drop-area" onclick="document.getElementById('file-input').click()">
                        <div class="file-upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <p><strong>Click to select file</strong> or drag and drop</p>
                        <p style="font-size: 0.9rem; color: #6c757d;">Supports CSV and Excel files (.csv, .xlsx, .xls)</p>
                    </div>
                    <input type="file" id="file-input" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                </div>

                <div id="file-preview" style="display: none; margin-top: 1rem;">
                    <h5>File Preview:</h5>
                    <div id="file-info" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"></div>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        <table class="data-table" style="margin: 0;">
                            <thead id="preview-header"></thead>
                            <tbody id="preview-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Download Template</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="downloadTemplate('csv')">
                            <i class="fas fa-download"></i> CSV Template
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="downloadTemplate('excel')">
                            <i class="fas fa-download"></i> Excel Template
                        </button>
                    </div>
                    <small class="text-muted">Download a template file with the correct format</small>
                </div>

                <!-- Progress indicator -->
                <div id="upload-progress" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 0.375rem;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <div id="progress-text">Processing vehicles...</div>
                            <div class="progress" style="width: 300px; height: 8px; margin-top: 0.5rem;">
                                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" id="cancel-upload-btn" onclick="closeBulkUploadModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="upload-btn" onclick="processBulkUpload()" disabled>
                        <i class="fas fa-upload"></i> Upload Vehicles
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SMS Modal -->
    <div id="sms-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Send MOT Reminder SMS</h2>
                <button class="modal-close" onclick="closeSMSModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5>Selected Vehicles for SMS</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="selectUrgentVehicles()">
                                <i class="fas fa-exclamation-triangle"></i> Select Urgent Only
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="clearSMSSelection()">
                                <i class="fas fa-times"></i> Clear Selection
                            </button>
                        </div>
                    </div>

                    <div id="sms-vehicle-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        <!-- Selected vehicles will be listed here -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">SMS Service Status</label>
                    <div id="sms-service-status" style="padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
                        <i class="fas fa-info-circle"></i> Checking SMS service status...
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeSMSModal()">Cancel</button>
                    <button type="button" class="btn btn-success" id="send-sms-btn" onclick="sendBulkSMS()" disabled>
                        <i class="fas fa-sms"></i> Send SMS (<span id="sms-send-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Failed Registrations Review Modal -->
    <div id="failed-registrations-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title">Review Failed Registrations</h2>
                <button class="modal-close" onclick="closeFailedRegistrationsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5>Failed Registrations for Manual Review</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="loadFailedRegistrations()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-sm btn-success" onclick="bulkProcessSelected()">
                                <i class="fas fa-check"></i> Process Selected
                            </button>
                        </div>
                    </div>

                    <div id="failed-registrations-list" style="max-height: 500px; overflow-y: auto;">
                        <div class="loading" style="text-align: center; padding: 2rem;">
                            <div class="spinner"></div>
                            Loading failed registrations...
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeFailedRegistrationsModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SMS History Modal -->
    <div id="sms-history-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title">SMS History & Message Log</h2>
                <button class="modal-close" onclick="closeSMSHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5>SMS Message History</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="loadSMSHistory()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-sm btn-info" onclick="checkDeliveryStatus()">
                                <i class="fas fa-sync"></i> Check Delivery Status
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="exportSMSHistory()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div>
                                <label class="form-label">Filter by Registration:</label>
                                <input type="text" id="sms-history-filter" placeholder="Enter registration..."
                                       onkeyup="filterSMSHistory()" style="padding: 0.25rem;">
                            </div>
                            <div>
                                <label class="form-label">Show Last:</label>
                                <select id="sms-history-limit" onchange="loadSMSHistory()" style="padding: 0.25rem;">
                                    <option value="50">50 messages</option>
                                    <option value="100">100 messages</option>
                                    <option value="200">200 messages</option>
                                    <option value="500">500 messages</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="sms-history-list" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        <div class="loading" style="text-align: center; padding: 2rem;">
                            <div class="spinner"></div>
                            Loading SMS history...
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeSMSHistoryModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('ðŸš¨ JavaScript Error:', event.error);
            console.error('ðŸ“ Error location:', event.filename, 'Line:', event.lineno);
            console.error('ðŸ“ Error message:', event.message);
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('ðŸš¨ Unhandled Promise Rejection:', event.reason);
        });

        console.log('ðŸ”§ JavaScript loading started...');

        // Emergency navigation function - defined immediately
        window.emergencyShowPage = function(pageId) {
            console.log('ðŸš¨ Emergency navigation to:', pageId);

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show target page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                console.log('âœ… Emergency navigation successful');

                // Activate first settings tab if it's settings page
                if (pageId === 'settings') {
                    setTimeout(() => {
                        const firstTab = document.querySelector('.settings-tab-btn');
                        const firstTabContent = document.querySelector('.settings-tab-content');
                        if (firstTab) firstTab.classList.add('active');
                        if (firstTabContent) firstTabContent.classList.add('active');
                    }, 100);
                }

                return true;
            } else {
                console.error('âŒ Emergency navigation failed - page not found');
                return false;
            }
        };

        // Make emergency function available globally
        window.showPage = window.emergencyShowPage;

        console.log('ðŸ†˜ Emergency navigation system ready');

        // Global variables
        let currentCustomerPage = 1;
        let currentVehiclePage = 1;
        let currentCustomerPerPage = 50;
        let currentVehiclePerPage = 50;
        let currentCustomerSearch = '';
        let currentVehicleSearch = '';
        let currentCustomerId = null;
        let currentVehicleId = null;
        let currentInvoiceId = null;
        let currentActivePage = 'dashboard'; // Track current page

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Application initializing...');

            try {
                // Check if there's a saved page to restore
                const savedPage = localStorage.getItem('currentActivePage');
                if (savedPage && savedPage !== 'dashboard') {
                    currentActivePage = savedPage;
                    console.log('ðŸ“„ Restoring saved page:', savedPage);
                } else {
                    currentActivePage = 'dashboard';
                    console.log('ðŸ“„ Starting with default page: dashboard');
                }

                // Test if basic functions work
                console.log('ðŸ“Š Loading dashboard stats...');
                loadDashboardStats();

                console.log('ðŸ‘¥ Loading customers...');
                loadCustomers();

                console.log('ðŸš— Loading vehicles...');
                loadVehicles();

                console.log('ðŸ”§ Loading jobs...');
                loadJobs();

                console.log('ðŸ“„ Loading invoices...');
                loadInvoices();

                console.log('âš™ï¸ Initializing settings...');
                initializeSettings();

                // Restore the saved page after everything is loaded
                setTimeout(() => {
                    if (savedPage && savedPage !== 'dashboard') {
                        console.log('ðŸ”„ Restoring page:', savedPage);
                        showPage(savedPage);
                    }
                }, 500);

                console.log('âœ… Application initialized successfully');

                // Set up backup navigation system
                setTimeout(() => {
                    console.log('ðŸ”§ Setting up backup navigation system...');

                    // Add click event listeners to navigation items
                    const navItems = document.querySelectorAll('.nav-item');
                    console.log(`Found ${navItems.length} navigation links`);

                    navItems.forEach(navItem => {
                        navItem.addEventListener('click', function(e) {
                            e.preventDefault();

                            // Extract page ID from onclick attribute
                            const onclick = this.getAttribute('onclick');
                            if (onclick) {
                                const match = onclick.match(/showPage\('([^']+)'\)/);
                                if (match) {
                                    const pageId = match[1];
                                    console.log('ðŸ”— Backup navigation triggered for:', pageId);

                                    // Use emergency navigation
                                    if (typeof window.emergencyShowPage === 'function') {
                                        window.emergencyShowPage(pageId);
                                    } else if (typeof showPage === 'function') {
                                        showPage(pageId);
                                    } else {
                                        console.error('âŒ No navigation function available');
                                    }

                                    // Update active nav item
                                    document.querySelectorAll('.nav-item').forEach(item => {
                                        item.classList.remove('active');
                                    });
                                    this.classList.add('active');
                                }
                            }
                        });
                    });

                    console.log('âœ… Backup navigation system ready');

                    // Test if showPage function exists
                    if (typeof showPage === 'function') {
                        console.log('âœ… showPage function exists');
                    } else {
                        console.error('âŒ showPage function missing - using emergency backup');
                    }
                }, 1000);

            } catch (error) {
                console.error('ðŸ’¥ Application initialization failed:', error);
            }
        });

        // Navigation functions
        function showPage(pageId) {
            console.log('ðŸ”§ showPage called with:', pageId);

            try {
                // Save current page to localStorage for refresh persistence
                currentActivePage = pageId;
                localStorage.setItem('currentActivePage', pageId);
                console.log('ðŸ’¾ Saved current page:', pageId);

                // Hide all pages
                const allPages = document.querySelectorAll('.page');
                console.log('ðŸ“„ Found pages:', allPages.length);
                allPages.forEach(page => {
                    page.classList.remove('active');
                });

                // Remove active class from all nav items
                const allNavItems = document.querySelectorAll('.nav-item');
                console.log('ðŸ§­ Found nav items:', allNavItems.length);
                allNavItems.forEach(item => {
                    item.classList.remove('active');
                });

                // Show selected page
                const pageElement = document.getElementById(pageId);
                if (pageElement) {
                    pageElement.classList.add('active');
                    console.log('âœ… Page shown successfully:', pageId);
                } else {
                    console.error('âŒ Page element not found:', pageId);
                    return;
                }

                // Add active class to selected nav item
                const navItem = document.querySelector(`.nav-item[onclick*="'${pageId}'"]`);
                if (navItem) {
                    navItem.classList.add('active');
                    console.log('ðŸŽ¯ Nav item activated for:', pageId);
                } else {
                    console.log('âš ï¸ Nav item not found for:', pageId);
                }

                // Load data for the page if needed
                if (pageId === 'customers') {
                    loadCustomers();
                } else if (pageId === 'vehicles') {
                    loadVehicles();
                } else if (pageId === 'jobs') {
                    loadJobs();
                } else if (pageId === 'invoices') {
                    loadInvoices();
                } else if (pageId === 'mot-reminders') {
                    ensureMOTDataLoaded();
                } else if (pageId === 'settings') {
                    console.log('âš™ï¸ Loading settings page...');

                    // Ensure settings are loaded and page is properly displayed
                    if (!settingsData || Object.keys(settingsData).length === 0) {
                        console.log('ðŸ“Š Loading settings data...');
                        loadSettings();
                    }

                    // Ensure the first tab is active
                    setTimeout(() => {
                        const firstTab = document.querySelector('.settings-tab-btn');
                        const firstTabContent = document.querySelector('.settings-tab-content');
                        console.log('ðŸ” Settings tabs found:', !!firstTab, !!firstTabContent);

                        if (firstTab && !firstTab.classList.contains('active')) {
                            firstTab.classList.add('active');
                            console.log('âœ… First settings tab activated');
                        }
                        if (firstTabContent && !firstTabContent.classList.contains('active')) {
                            firstTabContent.classList.add('active');
                            console.log('âœ… First settings tab content activated');
                        }
                    }, 100);
                }

            } catch (error) {
                console.error('ðŸ’¥ Error in showPage:', error);
            }
        }

        // Dashboard functions
        function loadDashboardStats() {
            fetch('/api/dashboard')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-customers').textContent = data.customers.toLocaleString();
                    document.getElementById('total-vehicles').textContent = data.vehicles.toLocaleString();
                    document.getElementById('total-revenue').textContent = 'Â£' + (data.revenue / 1000000).toFixed(1) + 'M';
                    document.getElementById('total-documents').textContent = data.documents.toLocaleString();
                })
                .catch(error => {
                    console.error('Error loading dashboard stats:', error);
                });
        }

        // Customer functions
        function loadCustomers() {
            const tableBody = document.getElementById('customers-table-body');
            tableBody.innerHTML = '<tr><td colspan="10" class="loading"><div class="spinner"></div>Loading customers...</td></tr>';
            
            const url = `/api/customers?page=${currentCustomerPage}&per_page=${currentCustomerPerPage}&search=${encodeURIComponent(currentCustomerSearch)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayCustomers(data);
                    updateCustomerPagination(data);
                })
                .catch(error => {
                    console.error('Error loading customers:', error);
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #dc3545;">Error loading customers</td></tr>';
                });
        }

        function displayCustomers(data) {
            const tableBody = document.getElementById('customers-table-body');
            
            if (data.customers && data.customers.length > 0) {
                tableBody.innerHTML = data.customers.map(customer => `
                    <tr>
                        <td>${customer.account_number || '-'}</td>
                        <td>${customer.name || '-'}</td>
                        <td>${customer.company_name || '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${customer.address || '-'}</td>
                        <td>${extractPostcode(customer.address) || '-'}</td>
                        <td>${customer.mobile || customer.telephone || '-'}</td>
                        <td>${customer.vehicle_count || 0}</td>
                        <td>${customer.document_count || 0}</td>
                        <td>-</td>
                        <td>
                            <button class="btn btn-primary" onclick="showCustomerDetail('${customer.id || customer.account_number}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No customers found</td></tr>';
            }
            
            // Update range display
            const start = (data.page - 1) * data.per_page + 1;
            const end = Math.min(data.page * data.per_page, data.total);
            document.getElementById('customer-range').textContent = `${start} to ${end}`;
            document.getElementById('customer-total').textContent = data.total.toLocaleString();
        }

        function updateCustomerPagination(data) {
            const pagination = document.getElementById('customer-pagination');
            const totalPages = data.total_pages;
            const currentPage = data.page;
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button onclick="changeCustomerPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button onclick="changeCustomerPage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            
            // Next button
            paginationHTML += `<button onclick="changeCustomerPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changeCustomerPage(page) {
            currentCustomerPage = page;
            loadCustomers();
        }

        function changeCustomerPerPage() {
            currentCustomerPerPage = parseInt(document.getElementById('customer-per-page').value);
            currentCustomerPage = 1;
            loadCustomers();
        }

        function searchCustomers() {
            currentCustomerSearch = document.getElementById('customer-search').value;
            currentCustomerPage = 1;
            loadCustomers();
        }

        function showCustomerDetail(customerId) {
            currentCustomerId = customerId;
            const modal = document.getElementById('customer-detail-modal');
            modal.classList.add('active');
            
            // Load customer details
            fetch(`/api/customers/${customerId}`)
                .then(response => response.json())
                .then(customer => {
                    document.getElementById('customer-detail-title').textContent = `Customer Details: ${customer.account_number || customer.id} - ${customer.name || customer.company_name}`;
                    
                    // Populate customer information
                    document.getElementById('customer-account-number').value = customer.account_number || '';
                    document.getElementById('customer-company').value = customer.company_name || '';
                    document.getElementById('customer-name').value = customer.name || '';
                    document.getElementById('customer-address').value = customer.address || '';
                    document.getElementById('customer-postcode').value = extractPostcode(customer.address) || '';
                    document.getElementById('customer-mobile').value = customer.mobile || '';
                    document.getElementById('customer-email').value = customer.email || '';
                    
                    // Populate account information
                    document.getElementById('customer-since').textContent = formatDate(customer.created_date);
                    document.getElementById('customer-vehicle-count').textContent = customer.vehicles ? customer.vehicles.length : '0';
                    document.getElementById('customer-service-count').textContent = customer.service_history ? customer.service_history.length : '0';
                    document.getElementById('customer-last-service').textContent = customer.service_history && customer.service_history.length > 0 ? formatDate(customer.service_history[0].date) : '-';
                    document.getElementById('customer-balance').textContent = 'Â£' + (customer.account_balance || 0).toFixed(2);
                    
                    // Load customer vehicles
                    loadCustomerVehicles(customer.vehicles || []);
                    
                    // Load service history
                    loadCustomerHistory(customer.service_history || []);
                })
                .catch(error => {
                    console.error('Error loading customer details:', error);
                    showNotification('Error loading customer details', 'error');
                });
        }

        function closeCustomerDetail() {
            document.getElementById('customer-detail-modal').classList.remove('active');
            currentCustomerId = null;
        }

        function showCustomerTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('#customer-detail-modal .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide all tab contents
            document.querySelectorAll('#customer-detail-modal .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.querySelector(`#customer-detail-modal .tab-button[onclick="showCustomerTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`customer-tab-${tabName}`).classList.add('active');
        }

        function loadCustomerVehicles(vehicles) {
            const tableBody = document.getElementById('customer-vehicles-table');
            
            if (vehicles && vehicles.length > 0) {
                tableBody.innerHTML = vehicles.map(vehicle => `
                    <tr>
                        <td>${vehicle.registration || '-'}</td>
                        <td>${vehicle.make || '-'}</td>
                        <td>${vehicle.model || '-'}</td>
                        <td>${vehicle.color || '-'}</td>
                        <td>${formatDate(vehicle.mot_due)}</td>
                        <td>${vehicle.mileage || '-'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="showVehicleDetail('${vehicle.id || vehicle.registration}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No vehicles found</td></tr>';
            }
        }

        function loadCustomerHistory(history) {
            const tableBody = document.getElementById('customer-history-table');
            
            if (history && history.length > 0) {
                tableBody.innerHTML = history.map(item => `
                    <tr>
                        <td>${formatDate(item.date)}</td>
                        <td>${item.vehicle || '-'}</td>
                        <td>${item.description}</td>
                        <td>Â£${item.total.toFixed(2)}</td>
                        <td><span class="status-badge status-${item.status.toLowerCase()}">${item.status}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No service history found</td></tr>';
            }
        }

        function updateCustomerField(field, value) {
            if (!currentCustomerId) return;
            
            const data = {};
            data[field] = value;
            
            fetch(`/api/customers/${currentCustomerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification('Customer updated successfully', 'success');
                } else {
                    showNotification('Error updating customer', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating customer:', error);
                showNotification('Error updating customer', 'error');
            });
        }

        // Vehicle functions
        function loadVehicles() {
            const tableBody = document.getElementById('vehicles-table-body');
            tableBody.innerHTML = '<tr><td colspan="10" class="loading"><div class="spinner"></div>Loading vehicles...</td></tr>';
            
            const url = `/api/vehicles?page=${currentVehiclePage}&per_page=${currentVehiclePerPage}&search=${encodeURIComponent(currentVehicleSearch)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayVehicles(data);
                    updateVehiclePagination(data);
                })
                .catch(error => {
                    console.error('Error loading vehicles:', error);
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #dc3545;">Error loading vehicles</td></tr>';
                });
        }

        function displayVehicles(data) {
            const tableBody = document.getElementById('vehicles-table-body');
            
            if (data.vehicles && data.vehicles.length > 0) {
                tableBody.innerHTML = data.vehicles.map(vehicle => `
                    <tr>
                        <td>${vehicle.registration || '-'}</td>
                        <td>${vehicle.make || '-'}</td>
                        <td>${vehicle.model || '-'}</td>
                        <td>${vehicle.color || '-'}</td>
                        <td>${vehicle.fuel_type || '-'}</td>
                        <td>${formatDate(vehicle.mot_due)}</td>
                        <td>${vehicle.mileage || '-'}</td>
                        <td>${vehicle.customer_name || vehicle.customer_company || '-'}</td>
                        <td>-</td>
                        <td>
                            <button class="btn btn-primary" onclick="showVehicleDetail('${vehicle.id || vehicle.registration}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No vehicles found</td></tr>';
            }
            
            // Update range display
            const start = (data.page - 1) * data.per_page + 1;
            const end = Math.min(data.page * data.per_page, data.total);
            document.getElementById('vehicle-range').textContent = `${start} to ${end}`;
            document.getElementById('vehicle-total').textContent = data.total.toLocaleString();
        }

        function updateVehiclePagination(data) {
            const pagination = document.getElementById('vehicle-pagination');
            const totalPages = data.total_pages;
            const currentPage = data.page;
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button onclick="changeVehiclePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button onclick="changeVehiclePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            
            // Next button
            paginationHTML += `<button onclick="changeVehiclePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changeVehiclePage(page) {
            currentVehiclePage = page;
            loadVehicles();
        }

        function changeVehiclePerPage() {
            currentVehiclePerPage = parseInt(document.getElementById('vehicle-per-page').value);
            currentVehiclePage = 1;
            loadVehicles();
        }

        function searchVehicles() {
            currentVehicleSearch = document.getElementById('vehicle-search').value;
            currentVehiclePage = 1;
            loadVehicles();
        }

        function showVehicleDetail(vehicleId) {
            currentVehicleId = vehicleId;
            const modal = document.getElementById('vehicle-detail-modal');
            modal.classList.add('active');
            
            // Load vehicle details
            fetch(`/api/vehicles/${vehicleId}`)
                .then(response => response.json())
                .then(vehicle => {
                    document.getElementById('vehicle-detail-title').textContent = `Vehicle Details: ${vehicle.registration} - ${vehicle.make} ${vehicle.model}`;
                    
                    // Populate vehicle information
                    document.getElementById('vehicle-registration').value = vehicle.registration || '';
                    document.getElementById('vehicle-make').value = vehicle.make || '';
                    document.getElementById('vehicle-model').value = vehicle.model || '';
                    document.getElementById('vehicle-color').value = vehicle.color || '';
                    document.getElementById('vehicle-fuel-type').value = vehicle.fuel_type || '';
                    document.getElementById('vehicle-mileage').value = vehicle.mileage || '';
                    
                    // Populate owner information
                    document.getElementById('vehicle-customer-name').textContent = vehicle.customer_name || vehicle.customer_company || '-';
                    document.getElementById('vehicle-customer-account').textContent = vehicle.customer_account || '-';
                    document.getElementById('vehicle-customer-phone').textContent = vehicle.customer_mobile || vehicle.customer_phone || '-';
                    document.getElementById('vehicle-mot-due').textContent = formatDate(vehicle.mot_due);
                    document.getElementById('vehicle-last-service').textContent = vehicle.service_history && vehicle.service_history.length > 0 ? formatDate(vehicle.service_history[0].date) : '-';
                    
                    // Load service history
                    loadVehicleHistory(vehicle.service_history || []);
                })
                .catch(error => {
                    console.error('Error loading vehicle details:', error);
                    showNotification('Error loading vehicle details', 'error');
                });
        }

        function closeVehicleDetail() {
            document.getElementById('vehicle-detail-modal').classList.remove('active');
            currentVehicleId = null;
        }

        function showVehicleTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('#vehicle-detail-modal .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide all tab contents
            document.querySelectorAll('#vehicle-detail-modal .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.querySelector(`#vehicle-detail-modal .tab-button[onclick="showVehicleTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`vehicle-tab-${tabName}`).classList.add('active');
        }

        function loadVehicleHistory(history) {
            const tableBody = document.getElementById('vehicle-history-table');
            
            if (history && history.length > 0) {
                tableBody.innerHTML = history.map(item => `
                    <tr>
                        <td>${formatDate(item.date)}</td>
                        <td>${item.doc_no}</td>
                        <td>${item.mileage}</td>
                        <td>${item.description}</td>
                        <td>Â£${item.total.toFixed(2)}</td>
                        <td><span class="status-badge status-${item.status.toLowerCase()}">${item.status}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No service history found</td></tr>';
            }
        }

        function updateVehicleField(field, value) {
            if (!currentVehicleId) return;
            
            const data = {};
            data[field] = value;
            
            fetch(`/api/vehicles/${currentVehicleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification('Vehicle updated successfully', 'success');
                } else {
                    showNotification('Error updating vehicle', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating vehicle:', error);
                showNotification('Error updating vehicle', 'error');
            });
        }

        // Job functions
        function loadJobs() {
            const tableBody = document.getElementById('jobs-table-body');
            tableBody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>Loading jobs...</td></tr>';
            
            fetch('/api/jobs')
                .then(response => response.json())
                .then(data => {
                    displayJobs(data.jobs || []);
                })
                .catch(error => {
                    console.error('Error loading jobs:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545;">Error loading jobs</td></tr>';
                });
        }

        function displayJobs(jobs) {
            const tableBody = document.getElementById('jobs-table-body');
            
            if (jobs && jobs.length > 0) {
                tableBody.innerHTML = jobs.map(job => `
                    <tr>
                        <td>${job.job_no}</td>
                        <td>${formatDate(job.date)}</td>
                        <td>${job.customer}</td>
                        <td>${job.vehicle}</td>
                        <td>${job.description}</td>
                        <td><span class="status-badge status-${job.status.toLowerCase()}">${job.status}</span></td>
                        <td>Â£${(job.total || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-primary" onclick="showJobDetail('${job.id}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No jobs found</td></tr>';
            }
        }

        // Invoice functions
        function loadInvoices() {
            const tableBody = document.getElementById('invoices-table-body');
            tableBody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>Loading invoices...</td></tr>';
            
            fetch('/api/invoices')
                .then(response => response.json())
                .then(data => {
                    displayInvoices(data.invoices || []);
                })
                .catch(error => {
                    console.error('Error loading invoices:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545;">Error loading invoices</td></tr>';
                });
        }

        function displayInvoices(invoices) {
            const tableBody = document.getElementById('invoices-table-body');
            
            if (invoices && invoices.length > 0) {
                tableBody.innerHTML = invoices.map(invoice => `
                    <tr>
                        <td>${invoice.invoice_no}</td>
                        <td>${formatDate(invoice.date)}</td>
                        <td>${invoice.customer}</td>
                        <td>${invoice.vehicle}</td>
                        <td>${invoice.description}</td>
                        <td>Â£${(invoice.total || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${invoice.status.toLowerCase()}">${invoice.status}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="showInvoiceDetail('${invoice.id}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No invoices found</td></tr>';
            }
        }

        function showInvoiceDetail(invoiceId) {
            currentInvoiceId = invoiceId;
            const modal = document.getElementById('invoice-detail-modal');
            modal.classList.add('active');
            
            // Load invoice details
            fetch(`/api/invoices/${invoiceId}`)
                .then(response => response.json())
                .then(invoice => {
                    document.getElementById('invoice-detail-title').textContent = `Standard Invoice: ${invoice.invoice_no} (JS: ${invoice.js_number}) (${invoice.status})`;
                    
                    // Populate vehicle information
                    document.getElementById('invoice-vehicle-registration').value = invoice.vehicle.registration || '';
                    document.getElementById('invoice-vehicle-make-model').value = `${invoice.vehicle.make || ''} ${invoice.vehicle.model || ''}`.trim();
                    document.getElementById('invoice-vehicle-chassis').value = invoice.vehicle.chassis || '';
                    document.getElementById('invoice-vehicle-engine-cc').value = invoice.vehicle.engine_cc || '';
                    document.getElementById('invoice-vehicle-fuel-type').value = invoice.vehicle.fuel_type || '';
                    document.getElementById('invoice-vehicle-color').value = invoice.vehicle.color || '';
                    document.getElementById('invoice-vehicle-mileage').value = invoice.vehicle.mileage || '';
                    
                    // Populate customer information
                    document.getElementById('invoice-customer-account').value = invoice.customer.account_number || '';
                    document.getElementById('invoice-customer-company').value = invoice.customer.company || '';
                    document.getElementById('invoice-customer-name').value = invoice.customer.name || '';
                    document.getElementById('invoice-customer-address').value = `${invoice.customer.house_no || ''} ${invoice.customer.road || ''}, ${invoice.customer.locality || ''}, ${invoice.customer.town || ''}`.trim();
                    document.getElementById('invoice-customer-postcode').value = invoice.customer.postcode || '';
                    document.getElementById('invoice-customer-mobile').value = invoice.customer.mobile || '';
                    
                    // Populate description
                    document.getElementById('invoice-description').value = invoice.description || '';
                    
                    // Load history
                    loadInvoiceHistory(invoice.history || []);
                })
                .catch(error => {
                    console.error('Error loading invoice details:', error);
                    showNotification('Error loading invoice details', 'error');
                });
        }

        function closeInvoiceDetail() {
            document.getElementById('invoice-detail-modal').classList.remove('active');
            currentInvoiceId = null;
        }

        function showInvoiceTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('#invoice-detail-modal .invoice-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide all tab contents
            document.querySelectorAll('#invoice-detail-modal .invoice-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.querySelector(`#invoice-detail-modal .invoice-tab-button[onclick="showInvoiceTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`invoice-tab-${tabName}`).classList.add('active');
        }

        function loadInvoiceHistory(history) {
            const tableBody = document.getElementById('invoice-history-table');
            
            if (history && history.length > 0) {
                tableBody.innerHTML = history.map(item => `
                    <tr>
                        <td>${formatDate(item.date)}</td>
                        <td>${item.doc_no}</td>
                        <td>${item.mileage}</td>
                        <td>${item.description}</td>
                        <td>Â£${item.total.toFixed(2)}</td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No history found</td></tr>';
            }
        }

        function updateInvoiceField(field, value) {
            if (!currentInvoiceId) return;
            
            // For now, just show a notification that the field was updated
            showNotification('Invoice field updated', 'success');
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString || dateString === '-' || dateString === '') return '-';

            // Handle different date formats
            let date;
            if (dateString.includes('.')) {
                // Handle YYYY.MM.DD format (DVSA API format)
                const parts = dateString.split('.');
                if (parts.length === 3) {
                    date = new Date(parts[0], parts[1] - 1, parts[2]); // Month is 0-indexed
                } else {
                    return dateString;
                }
            } else if (dateString.includes('/')) {
                // Handle MM/DD/YYYY or DD/MM/YYYY format
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    // Try DD/MM/YYYY format first (UK format)
                    if (parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                        // Assume DD/MM/YYYY if day and month are 2 digits or less
                        date = new Date(parts[2], parts[1] - 1, parts[0]); // Year, Month (0-indexed), Day
                    } else {
                        // Fallback to MM/DD/YYYY (US format)
                        date = new Date(dateString);
                    }
                } else {
                    date = new Date(dateString);
                }
            } else if (dateString.includes('-')) {
                // Handle YYYY-MM-DD format or DD-MM-YYYY format
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    if (parts[0].length === 4) {
                        // YYYY-MM-DD format
                        date = new Date(dateString);
                    } else {
                        // DD-MM-YYYY format (already formatted)
                        return dateString;
                    }
                } else {
                    date = new Date(dateString);
                }
            } else {
                return dateString; // Return as-is if format is unrecognized
            }

            // Check if date is valid
            if (isNaN(date.getTime())) {
                return dateString; // Return original if invalid
            }

            // Format as DD-MM-YYYY
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            return `${day}-${month}-${year}`;
        }

        function extractPostcode(address) {
            if (!address) return '';
            const postcodeRegex = /([A-Z]{1,2}[0-9][A-Z0-9]?\s?[0-9][A-Z]{2})/i;
            const match = address.match(postcodeRegex);
            return match ? match[1] : '';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Header button functions
        function refreshData() {
            showNotification('Refreshing data...', 'info');

            // Refresh data for all pages
            loadDashboardStats();
            loadCustomers();
            loadVehicles();
            loadJobs();
            loadInvoices();

            // Refresh MOT data if on MOT page
            if (currentActivePage === 'mot-reminders') {
                loadMOTReminders();
                loadFailedRegistrations();
            }

            // Stay on current page
            console.log('ðŸ”„ Refreshing while staying on page:', currentActivePage);
        }

        function exportData() {
            showNotification('Export functionality coming soon', 'warning');
        }

        function printPage() {
            window.print();
        }

        function showHelp() {
            showNotification('Help documentation coming soon', 'info');
        }

        function showAdminMenu() {
            showNotification('Admin menu coming soon', 'info');
        }

        // Form functions (placeholders)
        function showNewCustomerForm() {
            showNotification('New customer form coming soon', 'info');
        }

        function showNewVehicleForm() {
            showNotification('New vehicle form coming soon', 'info');
        }

        function showNewJobForm() {
            showNotification('New job form coming soon', 'info');
        }

        function showNewInvoiceForm() {
            showNotification('New invoice form coming soon', 'info');
        }

        function showJobDetail(jobId) {
            showNotification('Job detail view coming soon', 'info');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        showNotification('Save functionality coming soon', 'info');
                        break;
                    case 'f':
                        e.preventDefault();
                        const activeSearchBox = document.querySelector('.page.active .search-box input');
                        if (activeSearchBox) {
                            activeSearchBox.focus();
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshData();
                        break;
                }
            }
        });
        // MOT Reminder System Variables
        let motVehicles = [];
        let selectedMOTVehicles = [];
        let currentMOTView = 'list';
        let motSortBy = 'urgency';
        let completedVehicles = new Set(); // Track completed/verified vehicles
        let currentStatusFilter = 'all'; // 'all', 'pending', 'completed'
        let currentMOTFilter = 'all'; // Interactive filter for vehicle status
        let motGroupedData = {}; // Store grouped vehicle data
        let showArchivedVehicles = false; // Whether to show archived vehicles

        // API Configuration
        const API_BASE_URL = 'http://127.0.0.1:5002/api';

        const DVSA_CONFIG = {
            clientId: '2b3911f4-55f5-4a86-a9f0-0fc02c2bff0f',
            tokenUrl: 'https://login.microsoftonline.com/a455b827-244f-4c97-b5b4-ce5d13b4d00c/oauth2/v2.0/token',
            apiUrl: 'https://history.mot.api.gov.uk/v1/trade/vehicles/registration'
        };

        // Load MOT Reminders
        async function loadMOTReminders() {
            try {
                console.log('Loading MOT reminders...');

                // Try to load from backend API first
                try {
                    const apiUrl = `${API_BASE_URL}/mot/vehicles?include_archived=${showArchivedVehicles}`;
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.vehicles) {
                            console.log('Loaded vehicles from API:', data.vehicles.length);
                            motVehicles = data.vehicles;
                            updateMOTStatistics();
                            displayMOTVehicles();
                            updateMOTUrgentBadge();
                            updateFailedRegistrationsCount();
                            return;
                        }
                    }
                } catch (apiError) {
                    console.log('Backend API not available, using local storage:', apiError.message);
                }

                // Fallback to localStorage
                const savedVehicles = localStorage.getItem('motVehicles');
                if (savedVehicles) {
                    try {
                        motVehicles = JSON.parse(savedVehicles);
                        console.log('Loaded vehicles from localStorage:', motVehicles.length);
                    } catch (parseError) {
                        console.error('Error parsing saved vehicles:', parseError);
                        motVehicles = [];
                    }
                } else {
                    console.log('No saved vehicles found, starting with empty system');
                    // Start with empty array - no demo data
                    motVehicles = [];
                }

                updateMOTStatistics();
                displayMOTVehicles();
                updateMOTUrgentBadge();
                updateFailedRegistrationsCount();
                console.log('MOT reminders loaded successfully');
            } catch (error) {
                console.error('Error loading MOT reminders:', error);
                showNotification('Error loading MOT data', 'error');
                // Ensure we still show something even if there's an error
                motVehicles = [];
                updateMOTStatistics();
                displayMOTVehicles();
                updateMOTUrgentBadge();
                updateFailedRegistrationsCount();
            }
        }



        // Update MOT Statistics with smart filtering
        function updateMOTStatistics() {
            const stats = {
                expired: 0,
                critical: 0,
                dueSoon: 0,
                valid: 0,
                flagged: 0
            };

            let pendingCount = 0;
            let completedCount = 0;

            if (motVehicles && motVehicles.length > 0) {
                motVehicles.forEach(vehicle => {
                    // Count completion status
                    if (completedVehicles.has(vehicle.registration)) {
                        completedCount++;
                    } else {
                        pendingCount++;
                    }

                    // Count MOT status with smart filtering
                    if (vehicle.is_expired) {
                        stats.expired++;
                    } else if (vehicle.days_until_expiry <= 7) {
                        stats.critical++;
                    } else if (vehicle.days_until_expiry <= 30) {
                        stats.dueSoon++;
                    } else if (vehicle.days_until_expiry > 365) {
                        stats.flagged++;
                    } else {
                        stats.valid++;
                    }
                });
            }

            // Update MOT status counts
            document.getElementById('mot-expired-count').textContent = stats.expired;
            document.getElementById('mot-critical-count').textContent = stats.critical;
            document.getElementById('mot-due-soon-count').textContent = stats.dueSoon;
            document.getElementById('mot-valid-count').textContent = stats.valid;
            document.getElementById('mot-flagged-count').textContent = stats.flagged;
            document.getElementById('mot-total-count').textContent = motVehicles ? motVehicles.length : 0;

            // Update completion status counts
            const pendingElement = document.getElementById('pending-count');
            const completedElement = document.getElementById('completed-count');
            if (pendingElement) pendingElement.textContent = pendingCount;
            if (completedElement) completedElement.textContent = completedCount;

            // Update filter button counts
            updateFilterButtonCounts(stats);
        }

        // Update MOT Urgent Badge in Navigation
        function updateMOTUrgentBadge() {
            const urgentCount = motVehicles && motVehicles.length > 0
                ? motVehicles.filter(v => v.is_expired || v.days_until_expiry <= 7).length
                : 0;
            const badge = document.getElementById('mot-urgent-count');
            badge.textContent = urgentCount;
            badge.style.display = urgentCount > 0 ? 'inline' : 'none';
            badge.style.background = urgentCount > 0 ? '#dc3545' : '#6c757d';
        }

        // Display MOT Vehicles
        function displayMOTVehicles() {
            if (currentMOTView === 'list') {
                displayMOTList();
            } else {
                displayMOTCards();
            }
        }

        // Interactive Filter Functions
        function updateFilterButtonCounts(stats) {
            const totalCount = motVehicles ? motVehicles.length : 0;

            // Update filter button counts
            document.getElementById('filter-count-all').textContent = totalCount;
            document.getElementById('filter-count-expired').textContent = stats.expired || 0;
            document.getElementById('filter-count-critical').textContent = stats.critical || 0;
            document.getElementById('filter-count-due-soon').textContent = stats.dueSoon || 0;
            document.getElementById('filter-count-normal').textContent = stats.valid || 0;
            document.getElementById('filter-count-flagged').textContent = stats.flagged || 0;
        }

        function applyMOTFilter(filterType) {
            // Update active filter
            currentMOTFilter = filterType;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');

            // Show/hide filter indicator
            const indicator = document.getElementById('active-filter-indicator');
            const indicatorText = document.getElementById('active-filter-text');

            if (filterType === 'all') {
                indicator.style.display = 'none';
            } else {
                const filterNames = {
                    'expired': 'Expired Vehicles',
                    'critical': 'Critical Vehicles (â‰¤7 days)',
                    'due_soon': 'Due Soon Vehicles (8-30 days)',
                    'normal': 'Normal Vehicles (31-365 days)',
                    'flagged': 'Flagged Vehicles (365+ days)'
                };

                const filteredVehicles = getFilteredVehicles();
                const totalCount = motVehicles ? motVehicles.length : 0;

                indicatorText.textContent = `Showing: ${filterNames[filterType]} (${filteredVehicles.length} of ${totalCount})`;
                indicator.style.display = 'block';
            }

            // Refresh the display
            displayMOTVehicles();
        }

        function clearMOTFilter() {
            applyMOTFilter('all');
        }

        function getFilteredVehicles() {
            if (!motVehicles || currentMOTFilter === 'all') {
                return motVehicles || [];
            }

            return motVehicles.filter(vehicle => {
                switch (currentMOTFilter) {
                    case 'expired':
                        return vehicle.is_expired;
                    case 'critical':
                        return !vehicle.is_expired && vehicle.days_until_expiry <= 7;
                    case 'due_soon':
                        return !vehicle.is_expired && vehicle.days_until_expiry > 7 && vehicle.days_until_expiry <= 30;
                    case 'normal':
                        return !vehicle.is_expired && vehicle.days_until_expiry > 30 && vehicle.days_until_expiry <= 365;
                    case 'flagged':
                        return !vehicle.is_expired && vehicle.days_until_expiry > 365;
                    default:
                        return true;
                }
            });
        }

        // Display MOT List View
        function displayMOTList() {
            const tbody = document.getElementById('mot-vehicles-table-body');

            // Apply interactive filter first
            let filteredVehicles = getFilteredVehicles();

            // Then apply status filter (pending/completed)
            if (currentStatusFilter === 'pending') {
                filteredVehicles = filteredVehicles.filter(v => !completedVehicles.has(v.registration));
            } else if (currentStatusFilter === 'completed') {
                filteredVehicles = filteredVehicles.filter(v => completedVehicles.has(v.registration));
            }

            if (filteredVehicles.length === 0) {
                let message, description;

                if (motVehicles.length === 0) {
                    message = 'No Vehicles Added Yet';
                    description = 'Start monitoring MOT expiry dates by adding vehicles to the system.';
                } else if (currentMOTFilter !== 'all') {
                    const filterNames = {
                        'expired': 'Expired Vehicles',
                        'critical': 'Critical Vehicles',
                        'due_soon': 'Due Soon Vehicles',
                        'normal': 'Normal Vehicles',
                        'flagged': 'Flagged Vehicles'
                    };
                    message = `No ${filterNames[currentMOTFilter]} Found`;
                    description = `There are currently no vehicles in the ${filterNames[currentMOTFilter].toLowerCase()} category.`;
                } else if (currentStatusFilter === 'pending') {
                    message = 'No Pending Vehicles';
                    description = 'All vehicles have been marked as completed/verified.';
                } else {
                    message = 'No Completed Vehicles';
                    description = 'No vehicles have been marked as completed yet.';
                }

                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 3rem; color: #6c757d;">
                            <i class="fas fa-car" style="font-size: 4rem; margin-bottom: 1rem; display: block; color: #dee2e6;"></i>
                            <h4 style="margin-bottom: 1rem; color: #6c757d;">${message}</h4>
                            <p style="margin-bottom: 1.5rem;">${description}</p>
                            ${motVehicles.length === 0 ? `
                                <div style="display: flex; gap: 1rem; justify-content: center;">
                                    <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                        <i class="fas fa-plus"></i> Add Vehicle
                                    </button>
                                    <button class="btn btn-secondary" onclick="showBulkUploadModal()">
                                        <i class="fas fa-upload"></i> Bulk Upload
                                    </button>
                                </div>
                            ` : ''}
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedVehicles = getSortedMOTVehicles(filteredVehicles);

            tbody.innerHTML = sortedVehicles.map(vehicle => {
                const statusClass = getMOTStatusClass(vehicle);
                const statusText = getMOTStatusText(vehicle);
                const isSelected = selectedMOTVehicles.includes(vehicle.registration);
                const isCompleted = completedVehicles.has(vehicle.registration);

                // Smart filtering indicators
                const isFlagged = vehicle.days_until_expiry > 365;
                const canSendSMS = vehicle.mobile_number && !isFlagged;
                const recentSMS = vehicle.recent_sms?.has_recent_sms;

                // Visual indicators
                const flagIcon = isFlagged ? 'ðŸ”’' : vehicle.is_expired ? 'ðŸš¨' : vehicle.days_until_expiry <= 7 ? 'âš ï¸' : vehicle.days_until_expiry <= 30 ? 'ðŸ“…' : 'âœ…';

                return `
                    <tr class="${statusClass} ${isCompleted ? 'completed-vehicle' : ''} ${isFlagged ? 'flagged-vehicle' : ''} ${vehicle.is_archived ? 'archived-vehicle' : ''}">
                        <td>
                            <input type="checkbox" ${isSelected ? 'checked' : ''}
                                   onchange="toggleMOTVehicleSelection('${vehicle.registration}')"
                                   ${isFlagged ? 'title="Flagged vehicle - requires manual approval"' : ''}>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" ${isCompleted ? 'checked' : ''}
                                       onchange="toggleVehicleCompletion('${vehicle.registration}')"
                                       title="Mark as completed/verified"
                                       style="accent-color: #28a745;">
                                <span style="font-size: 1.2rem; margin-right: 0.25rem;" title="${isFlagged ? 'Flagged: 365+ days' : statusText}">${flagIcon}</span>
                                <strong style="${isCompleted ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${vehicle.registration}</strong>
                                ${isFlagged ? '<span class="badge bg-secondary" style="font-size: 0.6rem; margin-left: 0.25rem;">FLAGGED</span>' : ''}
                                ${vehicle.is_archived ? '<span class="badge bg-dark" style="font-size: 0.6rem; margin-left: 0.25rem;">ARCHIVED</span>' : ''}
                            </div>
                        </td>
                        <td style="${isCompleted ? 'opacity: 0.7;' : ''}">${vehicle.make} ${vehicle.model}</td>
                        <td style="${isCompleted ? 'opacity: 0.7;' : ''}">${vehicle.customer_name || '-'}</td>
                        <td style="${isCompleted ? 'opacity: 0.7;' : ''}">${formatDateForDisplay(vehicle.mot_expiry_date)}</td>
                        <td>
                            <span class="badge ${vehicle.is_expired ? 'bg-danger' : vehicle.days_until_expiry <= 7 ? 'bg-warning' : vehicle.days_until_expiry <= 30 ? 'bg-info' : isFlagged ? 'bg-secondary' : 'bg-success'}" style="${isCompleted ? 'opacity: 0.7;' : ''}">
                                ${vehicle.is_expired ? 'EXPIRED' : isFlagged ? vehicle.days_until_expiry + ' days (Flagged)' : vehicle.days_until_expiry + ' days'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass.replace('mot-status-', 'status-')}" style="${isCompleted ? 'opacity: 0.7;' : ''}">${isFlagged ? 'FLAGGED' : statusText}</span>
                        </td>
                        <td style="${isCompleted ? 'opacity: 0.7;' : ''}">${vehicle.mobile_number || '-'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.25rem; flex-direction: column;">
                                ${!vehicle.mobile_number ? `
                                    <span class="badge bg-danger" style="font-size: 0.6rem;">No Mobile</span>
                                ` : isFlagged ? `
                                    <span class="badge bg-warning" style="font-size: 0.6rem;">Manual Review</span>
                                ` : recentSMS ? `
                                    <span class="badge bg-info" style="font-size: 0.6rem;">SMS Sent</span>
                                ` : canSendSMS ? `
                                    <span class="badge bg-success" style="font-size: 0.6rem;">Ready</span>
                                ` : `
                                    <span class="badge bg-secondary" style="font-size: 0.6rem;">Cannot Send</span>
                                `}
                            </div>
                        </td>
                        <td style="font-size: 0.8rem; ${isCompleted ? 'opacity: 0.7;' : ''}">
                            ${vehicle.uploaded_at ? formatDateTime(vehicle.uploaded_at) : '-'}
                        </td>
                        <td style="font-size: 0.8rem; ${isCompleted ? 'opacity: 0.7;' : ''}">
                            ${vehicle.sms_sent_at ? formatDateTime(vehicle.sms_sent_at) : '-'}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                ${isCompleted ? `
                                    <span class="badge bg-success" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                                        <i class="fas fa-check"></i> Verified
                                    </span>
                                ` : ''}
                            </div>
                        </td>
                        <td>
                            ${vehicle.main_customer_id ? `
                                <button class="btn btn-sm btn-info" onclick="viewCustomerDetails('${vehicle.main_customer_id}', '${vehicle.registration}')" title="View Customer Details">
                                    <i class="fas fa-user"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-primary" onclick="checkMOTStatus('${vehicle.registration}')" title="Refresh MOT Status">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="sendSingleSMS('${vehicle.registration}')"
                                    ${!canSendSMS ? 'disabled' : ''}
                                    title="${!vehicle.mobile_number ? 'No mobile number' : isFlagged ? 'Flagged vehicle - manual approval required' : 'Send SMS'}">
                                <i class="fas fa-sms"></i>
                            </button>
                            ${vehicle.is_archived ? `
                                <button class="btn btn-sm btn-info" onclick="unarchiveVehicle('${vehicle.registration}')" title="Unarchive vehicle">
                                    <i class="fas fa-box-open"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-secondary" onclick="archiveVehicle('${vehicle.registration}')" title="Archive vehicle">
                                    <i class="fas fa-archive"></i>
                                </button>
                            `}
                            <button class="btn btn-sm btn-danger" onclick="removeMOTVehicle('${vehicle.registration}')" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get MOT Status Class
        function getMOTStatusClass(vehicle) {
            if (vehicle.is_expired) return 'mot-status-expired';
            if (vehicle.days_until_expiry <= 7) return 'mot-status-critical';
            if (vehicle.days_until_expiry <= 30) return 'mot-status-due-soon';
            return 'mot-status-valid';
        }

        // Get MOT Status Text
        function getMOTStatusText(vehicle) {
            if (vehicle.is_expired) return 'EXPIRED';
            if (vehicle.days_until_expiry <= 7) return 'CRITICAL';
            if (vehicle.days_until_expiry <= 30) return 'DUE SOON';
            return 'VALID';
        }

        // Sort MOT Vehicles Utility Function
        function getSortedMOTVehicles(vehicles) {
            if (!vehicles || vehicles.length === 0) return [];

            const sorted = [...vehicles];

            switch (motSortBy) {
                case 'urgency':
                    return sorted.sort((a, b) => {
                        if (a.is_expired && !b.is_expired) return -1;
                        if (!a.is_expired && b.is_expired) return 1;
                        if (a.is_expired && b.is_expired) return b.days_until_expiry - a.days_until_expiry;
                        return a.days_until_expiry - b.days_until_expiry;
                    });
                case 'expiry':
                    return sorted.sort((a, b) => a.days_until_expiry - b.days_until_expiry);
                case 'registration':
                    return sorted.sort((a, b) => a.registration.localeCompare(b.registration));
                case 'customer':
                    return sorted.sort((a, b) => (a.customer_name || '').localeCompare(b.customer_name || ''));
                default:
                    return sorted;
            }
        }

        // Apply sort to MOT vehicles and refresh display
        function applySortToMOTVehicles() {
            motSortBy = document.getElementById('mot-sort-select').value;
            displayMOTVehicles();
        }

        // Switch MOT View
        function switchMOTView(view) {
            currentMOTView = view;

            const listBtn = document.getElementById('list-view-btn');
            const cardBtn = document.getElementById('card-view-btn');
            const listView = document.getElementById('mot-list-view');
            const cardView = document.getElementById('mot-card-view');

            if (view === 'list') {
                listBtn.style.background = '#667eea';
                listBtn.style.color = 'white';
                cardBtn.style.background = '#6c757d';
                cardBtn.style.color = 'white';
                listView.style.display = 'block';
                cardView.style.display = 'none';
                displayMOTList();
            } else {
                cardBtn.style.background = '#667eea';
                cardBtn.style.color = 'white';
                listBtn.style.background = '#6c757d';
                listBtn.style.color = 'white';
                listView.style.display = 'none';
                cardView.style.display = 'block';
                displayMOTCards();
            }

            localStorage.setItem('motViewMode', view);
        }

        // Display MOT Cards View
        function displayMOTCards() {
            const container = document.getElementById('mot-vehicles-cards');

            // Apply interactive filter
            const filteredVehicles = getFilteredVehicles();

            if (filteredVehicles.length === 0) {
                let message, description;

                if (motVehicles.length === 0) {
                    message = 'No Vehicles Added Yet';
                    description = 'Start monitoring MOT expiry dates by adding vehicles to the system.';
                } else if (currentMOTFilter !== 'all') {
                    const filterNames = {
                        'expired': 'Expired Vehicles',
                        'critical': 'Critical Vehicles',
                        'due_soon': 'Due Soon Vehicles',
                        'normal': 'Normal Vehicles',
                        'flagged': 'Flagged Vehicles'
                    };
                    message = `No ${filterNames[currentMOTFilter]} Found`;
                    description = `There are currently no vehicles in the ${filterNames[currentMOTFilter].toLowerCase()} category.`;
                } else {
                    message = 'No Vehicles Found';
                    description = 'No vehicles match the current filter criteria.';
                }

                container.innerHTML = `
                    <div class="col-12" style="text-align: center; padding: 4rem; color: #6c757d;">
                        <i class="fas fa-car" style="font-size: 5rem; margin-bottom: 1.5rem; display: block; color: #dee2e6;"></i>
                        <h3 style="margin-bottom: 1rem; color: #6c757d;">${message}</h3>
                        <p style="margin-bottom: 2rem; font-size: 1.1rem;">${description}</p>
                        ${motVehicles.length === 0 ? `
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                    <i class="fas fa-plus"></i> Add Vehicle
                                </button>
                                <button class="btn btn-secondary" onclick="showBulkUploadModal()">
                                    <i class="fas fa-upload"></i> Bulk Upload
                                </button>
                            </div>
                        ` : currentMOTFilter !== 'all' ? `
                            <button class="btn btn-secondary" onclick="clearMOTFilter()">
                                <i class="fas fa-times"></i> Clear Filter
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }

            const sortedVehicles = getSortedMOTVehicles(filteredVehicles);

            container.innerHTML = sortedVehicles.map(vehicle => {
                const statusClass = getMOTStatusClass(vehicle);
                const statusText = getMOTStatusText(vehicle);
                const isSelected = selectedMOTVehicles.includes(vehicle.registration);

                return `
                    <div class="col-md-6 col-lg-4">
                        <div class="mot-card ${statusClass}">
                            <div class="mot-card-header">
                                <div>
                                    <h5 style="margin: 0; font-weight: bold;">${vehicle.registration}</h5>
                                    <small>${vehicle.make} ${vehicle.model}</small>
                                </div>
                                <div>
                                    <input type="checkbox" ${isSelected ? 'checked' : ''}
                                           onchange="toggleMOTVehicleSelection('${vehicle.registration}')">
                                </div>
                            </div>
                            <div class="mot-card-body">
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>Customer:</strong> ${vehicle.customer_name || 'Not specified'}
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>MOT Expires:</strong> ${formatDateForDisplay(vehicle.mot_expiry_date)}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <span class="badge ${vehicle.is_expired ? 'bg-danger mot-urgency-badge' : vehicle.days_until_expiry <= 7 ? 'bg-warning' : vehicle.days_until_expiry <= 30 ? 'bg-info' : 'bg-success'}">
                                        ${vehicle.is_expired ? 'EXPIRED' : vehicle.days_until_expiry + ' days left'}
                                    </span>
                                    <span class="status-badge ${statusClass.replace('mot-status-', 'status-')}" style="margin-left: 0.5rem;">${statusText}</span>
                                </div>
                                <div style="display: flex; gap: 0.25rem;">
                                    <button class="btn btn-sm btn-primary" onclick="checkMOTStatus('${vehicle.registration}')" title="Refresh">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="sendSingleSMS('${vehicle.registration}')"
                                            ${!vehicle.mobile_number ? 'disabled' : ''} title="SMS">
                                        <i class="fas fa-sms"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="removeMOTVehicle('${vehicle.registration}')" title="Remove">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format Date for Display (DD-MM-YYYY)
        function formatDateForDisplay(dateString) {
            if (!dateString || dateString === '-' || dateString === 'Unknown') {
                return '-';
            }

            // If already in DD-MM-YYYY format, return as-is
            if (typeof dateString === 'string' && dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
                return dateString;
            }

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString;
                }

                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();

                return `${day}-${month}-${year}`;
            } catch (error) {
                return dateString;
            }
        }

        // Calculate Days Until Expiry
        function calculateDaysUntilExpiry(expiryDate) {
            try {
                const today = new Date();
                const expiry = new Date(expiryDate);
                const diffTime = expiry - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            } catch (error) {
                return 0;
            }
        }

        // Modal Functions
        function showAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.add('active');
            document.getElementById('vehicle-registration-input').focus();
        }

        function closeAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.remove('active');
            document.getElementById('add-vehicle-form').reset();
        }

        function showBulkUploadModal() {
            document.getElementById('bulk-upload-modal').classList.add('active');
        }

        function closeBulkUploadModal() {
            document.getElementById('bulk-upload-modal').classList.remove('active');

            // Reset modal state
            document.getElementById('file-input').value = '';
            document.getElementById('file-info').innerHTML = '';
            document.getElementById('file-preview').style.display = 'none';
            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-btn').disabled = true;
            document.getElementById('cancel-upload-btn').disabled = false;

            // Clear upload data
            window.uploadFileData = null;
        }

        function showSMSModal() {
            updateSMSVehicleList();
            document.getElementById('sms-modal').classList.add('active');
            checkSMSServiceStatus();
        }

        function closeSMSModal() {
            document.getElementById('sms-modal').classList.remove('active');
        }

        // Add Vehicle Function
        async function addMOTVehicle(event) {
            event.preventDefault();

            const registration = document.getElementById('vehicle-registration-input').value.trim().toUpperCase().replace(/\s+/g, ''); // Remove all spaces
            const customerName = document.getElementById('customer-name-input').value.trim();
            const mobileNumber = document.getElementById('mobile-number-input').value.trim();

            if (!registration) {
                showNotification('Please enter a vehicle registration', 'error');
                return;
            }

            // Check if vehicle already exists
            if (motVehicles.find(v => v.registration === registration)) {
                showNotification('Vehicle already exists in the system', 'error');
                return;
            }

            try {
                showNotification('Checking MOT status with DVSA API...', 'info');

                // Try to use backend API first
                try {
                    const response = await fetch(`${API_BASE_URL}/mot/vehicles`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            registration: registration,
                            customer_name: customerName,
                            mobile_number: mobileNumber
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            // Reload vehicles from backend
                            await loadMOTReminders();
                            closeAddVehicleModal();
                            showNotification(`Vehicle ${registration} added successfully`, 'success');
                            return;
                        } else {
                            throw new Error(result.error || 'Backend API error');
                        }
                    }
                } catch (apiError) {
                    console.log('Backend API not available, using local storage');
                }

                // Only use real DVSA API data - no fallback
                let motData = await fetchDVSAData(registration);
                if (!motData) {
                    console.log('DVSA API failed - no fallback data will be used');
                    throw new Error('Could not retrieve MOT data from DVLA. Please check the registration number and try again.');
                }

                if (motData) {
                    const vehicle = {
                        registration: registration,
                        make: motData.make || 'Unknown',
                        model: motData.model || 'Unknown',
                        customer_name: customerName || '',
                        mobile_number: mobileNumber || '',
                        mot_expiry_date: motData.mot_expiry_date,
                        days_until_expiry: motData.days_until_expiry,
                        is_expired: motData.is_expired,
                        last_test_date: motData.last_test_date,
                        test_result: motData.test_result
                    };

                    motVehicles.push(vehicle);
                    localStorage.setItem('motVehicles', JSON.stringify(motVehicles));

                    updateMOTStatistics();
                    displayMOTVehicles();
                    updateMOTUrgentBadge();

                    closeAddVehicleModal();
                    showNotification(`Vehicle ${registration} added successfully`, 'success');
                } else {
                    showNotification('Could not retrieve MOT data for this vehicle', 'error');
                }
            } catch (error) {
                console.error('Error adding vehicle:', error);
                showNotification('Error adding vehicle. Please try again.', 'error');
            }
        }

        // Real DVSA API Call - Direct integration with DVSA MOT History API
        async function fetchDVSAData(registration) {
            try {
                console.log(`ðŸ” Fetching real DVSA data for registration: ${registration}`);

                // Call through our backend API to avoid CORS issues
                const apiUrl = `${API_BASE_URL}/mot/check/${registration}`;
                console.log(`ðŸ“¡ Backend API URL: ${apiUrl}`);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log(`ðŸ“¥ Backend API Response status: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    console.log(`ðŸ“‹ Full DVSA response for ${registration}:`, result);

                    if (result && result.length > 0) {
                        const vehicle = result[0]; // Get the first vehicle record

                        // Extract MOT data from DVSA response
                        const motTests = vehicle.motTests || [];
                        const latestTest = motTests.length > 0 ? motTests[0] : null;

                        let motExpiryDate = null;
                        let lastTestDate = null;
                        let testResult = 'UNKNOWN';

                        if (latestTest) {
                            motExpiryDate = latestTest.expiryDate;
                            lastTestDate = latestTest.completedDate;
                            testResult = latestTest.testResult;
                        }

                        // Calculate days until expiry
                        let daysUntilExpiry = 0;
                        let isExpired = false;

                        if (motExpiryDate) {
                            const today = new Date();
                            const expiry = new Date(motExpiryDate);
                            daysUntilExpiry = Math.floor((expiry - today) / (1000 * 60 * 60 * 24));
                            isExpired = daysUntilExpiry < 0;
                        }

                        const motData = {
                            registration: registration,
                            make: vehicle.make || 'Unknown',
                            model: vehicle.model || 'Unknown',
                            mot_expiry_date: motExpiryDate ? formatDateToDDMMYYYY(motExpiryDate) : null,
                            days_until_expiry: daysUntilExpiry,
                            is_expired: isExpired,
                            last_test_date: lastTestDate ? formatDateToDDMMYYYY(lastTestDate) : null,
                            test_result: testResult
                        };

                        console.log(`âœ… Backend API success for ${registration}:`, motData);
                        return motData;
                    } else {
                        console.error(`âŒ No vehicle data found in backend response for ${registration}`);
                        return null;
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`âŒ Backend API HTTP error ${response.status} for ${registration}: ${errorText}`);
                    return null;
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error(`â° Backend API timeout for ${registration}`);
                } else {
                    console.error(`ðŸ’¥ Error fetching backend data for ${registration}:`, error);
                }
                return null;
            }
        }

        // Helper function to format date to DD-MM-YYYY
        function formatDateToDDMMYYYY(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return dateString;
            }
        }



        // Check MOT Status (refresh)
        async function checkMOTStatus(registration) {
            try {
                showNotification('Refreshing MOT status from DVSA...', 'info');

                // Only use real DVSA API data
                let motData = await fetchDVSAData(registration);
                if (!motData) {
                    console.log('Backend API failed for refresh - no fallback data available');
                    showNotification('Could not refresh MOT data from DVLA', 'error');
                    return;
                }

                if (motData) {
                    const vehicleIndex = motVehicles.findIndex(v => v.registration === registration);
                    if (vehicleIndex !== -1) {
                        motVehicles[vehicleIndex] = {
                            ...motVehicles[vehicleIndex],
                            ...motData
                        };

                        localStorage.setItem('motVehicles', JSON.stringify(motVehicles));
                        updateMOTStatistics();
                        displayMOTVehicles();
                        updateMOTUrgentBadge();

                        showNotification(`MOT status updated for ${registration}`, 'success');
                    }
                }
            } catch (error) {
                console.error('Error checking MOT status:', error);
                showNotification('Error refreshing MOT status', 'error');
            }
        }

        // Remove MOT Vehicle
        function removeMOTVehicle(registration) {
            if (confirm(`Are you sure you want to remove ${registration} from MOT monitoring?`)) {
                motVehicles = motVehicles.filter(v => v.registration !== registration);
                selectedMOTVehicles = selectedMOTVehicles.filter(r => r !== registration);

                localStorage.setItem('motVehicles', JSON.stringify(motVehicles));

                updateMOTStatistics();
                displayMOTVehicles();
                updateMOTUrgentBadge();

                showNotification(`Vehicle ${registration} removed`, 'success');
            }
        }

        // Vehicle Selection Functions
        function toggleMOTVehicleSelection(registration) {
            const index = selectedMOTVehicles.indexOf(registration);
            if (index === -1) {
                selectedMOTVehicles.push(registration);
            } else {
                selectedMOTVehicles.splice(index, 1);
            }

            updateSMSButtonState();
            displayMOTVehicles(); // Refresh to show selection state
        }

        function toggleAllMOTSelection() {
            const selectAllCheckbox = document.getElementById('select-all-mot');

            if (selectAllCheckbox.checked) {
                selectedMOTVehicles = motVehicles.map(v => v.registration);
            } else {
                selectedMOTVehicles = [];
            }

            updateSMSButtonState();
            displayMOTVehicles();
        }

        function selectUrgentVehicles() {
            selectedMOTVehicles = motVehicles
                .filter(v => v.is_expired || v.days_until_expiry <= 7)
                .map(v => v.registration);

            updateSMSButtonState();
            displayMOTVehicles();
            updateSMSVehicleList();
        }

        function clearSMSSelection() {
            selectedMOTVehicles = [];
            updateSMSButtonState();
            displayMOTVehicles();
            updateSMSVehicleList();
        }

        // Update SMS Button State
        function updateSMSButtonState() {
            const smsButton = document.getElementById('sms-button');
            const smsCount = document.getElementById('sms-count');
            const vehiclesWithMobile = selectedMOTVehicles.filter(reg => {
                const vehicle = motVehicles.find(v => v.registration === reg);
                return vehicle && vehicle.mobile_number;
            }).length;

            smsCount.textContent = vehiclesWithMobile;
            smsButton.disabled = vehiclesWithMobile === 0;
        }

        // SMS Functions
        function updateSMSVehicleList() {
            const container = document.getElementById('sms-vehicle-list');
            const sendBtn = document.getElementById('send-sms-btn');
            const sendCount = document.getElementById('sms-send-count');

            const selectedVehicles = motVehicles.filter(v => selectedMOTVehicles.includes(v.registration));
            const vehiclesWithMobile = selectedVehicles.filter(v => v.mobile_number);

            if (selectedVehicles.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; text-align: center; color: #6c757d;">No vehicles selected</p>';
                sendBtn.disabled = true;
                sendCount.textContent = '0';
                return;
            }

            container.innerHTML = selectedVehicles.map(vehicle => {
                const statusClass = getMOTStatusClass(vehicle);
                const statusText = getMOTStatusText(vehicle);
                const hasMobile = !!vehicle.mobile_number;

                return `
                    <div style="padding: 0.75rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; ${!hasMobile ? 'opacity: 0.6;' : ''}">
                        <div>
                            <strong>${vehicle.registration}</strong> - ${vehicle.make} ${vehicle.model}
                            <br>
                            <small>Customer: ${vehicle.customer_name || 'Not specified'}</small>
                            <br>
                            <small>Mobile: ${vehicle.mobile_number || 'Not provided'}</small>
                        </div>
                        <div>
                            <span class="status-badge ${statusClass.replace('mot-status-', 'status-')}">${statusText}</span>
                            ${!hasMobile ? '<br><small style="color: #dc3545;">No mobile number</small>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            sendBtn.disabled = vehiclesWithMobile.length === 0;
            sendCount.textContent = vehiclesWithMobile.length;
        }

        async function checkSMSServiceStatus() {
            const statusDiv = document.getElementById('sms-service-status');

            // Show loading state
            statusDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="spinner" style="width: 16px; height: 16px;"></div>
                    <span>Checking SMS service status...</span>
                </div>
            `;

            try {
                // Check SMS service status using dedicated endpoint
                const response = await fetch(`${API_BASE_URL}/mot/sms/status`);
                const data = await response.json();

                if (data.success && data.configured && !data.demo_mode) {
                    // Real SMS sending is enabled
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-check-circle" style="color: #28a745;"></i>
                            <span><strong>SMS Service:</strong> Real SMS Sending Enabled</span>
                        </div>
                        <small style="color: #6c757d; margin-top: 0.25rem; display: block;">
                            SMS messages will be sent to customers via Twilio (${data.from_number})
                        </small>
                    `;
                } else if (data.success && data.demo_mode) {
                    // Demo mode
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: #17a2b8;"></i>
                            <span><strong>SMS Service:</strong> Demo Mode - Messages will be logged to console</span>
                        </div>
                        <small style="color: #6c757d; margin-top: 0.25rem; display: block;">
                            Configure Twilio credentials to enable real SMS sending
                        </small>
                    `;
                } else {
                    throw new Error(data.error || 'SMS service not configured');
                }
            } catch (error) {
                // Fallback to demo mode display
                statusDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
                        <span><strong>SMS Service:</strong> Not Available</span>
                    </div>
                    <small style="color: #6c757d; margin-top: 0.25rem; display: block;">
                        Check that the MOT service is running
                    </small>
                `;
            }
        }

        async function sendSingleSMS(registration) {
            const vehicle = motVehicles.find(v => v.registration === registration);
            if (!vehicle || !vehicle.mobile_number) {
                showNotification('No mobile number available for this vehicle', 'error');
                return;
            }

            if (confirm(`Send MOT reminder SMS to ${vehicle.customer_name || 'customer'} for ${registration}?`)) {
                try {
                    // Try to use backend API first
                    const response = await fetch(`${API_BASE_URL}/mot/sms/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            registrations: [registration]
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.sent > 0) {
                            showNotification(`SMS sent successfully to ${vehicle.customer_name || 'customer'}`, 'success');
                            loadMOTReminders(); // Refresh to show archived vehicle
                            return;
                        } else if (result.skipped > 0) {
                            showNotification(`SMS skipped: ${result.results[0]?.reason || 'Unknown reason'}`, 'warning');
                            return;
                        }
                    }
                } catch (apiError) {
                    console.log('Backend API not available, using demo mode');
                }

                // Fallback to demo mode
                simulateSMSSend([vehicle]);
                loadMOTReminders(); // Refresh even in demo mode
            }
        }

        async function sendBulkSMS() {
            const selectedVehicles = motVehicles.filter(v =>
                selectedMOTVehicles.includes(v.registration) && v.mobile_number
            );

            if (selectedVehicles.length === 0) {
                showNotification('No vehicles with mobile numbers selected', 'error');
                return;
            }

            if (confirm(`Send MOT reminder SMS to ${selectedVehicles.length} customers?`)) {
                try {
                    showNotification(`Sending SMS to ${selectedVehicles.length} customers...`, 'info');

                    // Try to use backend API first
                    try {
                        const response = await fetch(`${API_BASE_URL}/mot/sms/send`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                registrations: selectedVehicles.map(v => v.registration)
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                showNotification(`SMS sent successfully to ${result.sent} customers`, 'success');
                                if (result.failed > 0) {
                                    showNotification(`${result.failed} SMS messages failed to send`, 'warning');
                                }
                                if (result.skipped > 0) {
                                    showNotification(`${result.skipped} vehicles skipped`, 'info');
                                }

                                // Clear selection and refresh list (vehicles will be archived)
                                selectedMOTVehicles = [];
                                updateSMSButtonState();
                                loadMOTReminders();
                                closeSMSModal();
                                return;
                            }
                        }
                    } catch (apiError) {
                        console.log('Backend API not available, using demo mode');
                    }

                    // Fallback to demo mode
                    simulateSMSSend(selectedVehicles);

                    // Clear selection and refresh list (even in demo mode)
                    selectedMOTVehicles = [];
                    updateSMSButtonState();
                    loadMOTReminders();
                    closeSMSModal();
                } catch (error) {
                    console.error('Error sending SMS:', error);
                    showNotification('Error sending SMS messages', 'error');
                }
            }
        }

        function simulateSMSSend(vehicles) {
            showNotification(`Sending SMS to ${vehicles.length} customers...`, 'info');

            // Simulate SMS sending delay
            setTimeout(() => {
                vehicles.forEach(vehicle => {
                    const template = getSMSTemplate(vehicle);
                    console.log(`ðŸ“± SMS DEMO MODE:`);
                    console.log(`To: ${vehicle.mobile_number}`);
                    console.log(`Customer: ${vehicle.customer_name || 'Unknown'}`);
                    console.log(`Vehicle: ${vehicle.registration}`);
                    console.log(`Message: ${template}`);
                    console.log('-'.repeat(50));
                });

                showNotification(`SMS sent successfully to ${vehicles.length} customers`, 'success');
            }, 1000);
        }

        function getSMSTemplate(vehicle) {
            const customerGreeting = vehicle.customer_name ? `Hi ${vehicle.customer_name}, ` : 'Hi, ';

            if (vehicle.is_expired) {
                return `ðŸš¨ URGENT: MOT EXPIRED
${customerGreeting}Your ${vehicle.make} ${vehicle.model} (${vehicle.registration}) MOT expired on ${vehicle.mot_expiry_date}.
You cannot legally drive this vehicle. Please book your MOT test immediately.
Contact us for assistance.`;
            } else if (vehicle.days_until_expiry <= 7) {
                return `âš ï¸ CRITICAL: MOT Due Soon
${customerGreeting}Your ${vehicle.make} ${vehicle.model} (${vehicle.registration}) MOT expires in ${vehicle.days_until_expiry} days on ${vehicle.mot_expiry_date}.
Please book your MOT test urgently to avoid any issues.
Contact us to arrange your test.`;
            } else if (vehicle.days_until_expiry <= 30) {
                return `ðŸ“… MOT Reminder
${customerGreeting}Your ${vehicle.make} ${vehicle.model} (${vehicle.registration}) MOT expires in ${vehicle.days_until_expiry} days on ${vehicle.mot_expiry_date}.
Please book your MOT test soon to ensure continuous coverage.
Contact us to schedule your test.`;
            } else {
                return `ðŸ”” MOT Reminder
${customerGreeting}Your ${vehicle.make} ${vehicle.model} (${vehicle.registration}) MOT expires on ${vehicle.mot_expiry_date}.
Don't forget to book your MOT test.
Contact us for more information.`;
            }
        }

        // Search Function
        function searchMOTVehicles() {
            const searchTerm = document.getElementById('mot-search').value.toLowerCase();

            if (!searchTerm) {
                displayMOTVehicles();
                return;
            }

            const filteredVehicles = motVehicles.filter(vehicle =>
                vehicle.registration.toLowerCase().includes(searchTerm) ||
                vehicle.make.toLowerCase().includes(searchTerm) ||
                vehicle.model.toLowerCase().includes(searchTerm) ||
                (vehicle.customer_name && vehicle.customer_name.toLowerCase().includes(searchTerm))
            );

            // Temporarily replace motVehicles for display
            const originalVehicles = motVehicles;
            motVehicles = filteredVehicles;
            displayMOTVehicles();
            motVehicles = originalVehicles;
        }

        // Sort Function (for UI sorting)
        function applySortToMOTVehicles() {
            motSortBy = document.getElementById('mot-sort-select').value;
            displayMOTVehicles();
        }

        // Completion Tracking Functions
        function loadCompletionStatus() {
            // Load completion status from localStorage
            try {
                const saved = localStorage.getItem('motCompletedVehicles');
                if (saved) {
                    completedVehicles = new Set(JSON.parse(saved));
                    console.log(`ðŸ“‹ Loaded ${completedVehicles.size} completed vehicles from storage`);
                }
            } catch (error) {
                console.error('Error loading completion status:', error);
                completedVehicles = new Set();
            }
        }

        function saveCompletionStatus() {
            // Save completion status to localStorage
            try {
                localStorage.setItem('motCompletedVehicles', JSON.stringify([...completedVehicles]));
                console.log(`ðŸ’¾ Saved ${completedVehicles.size} completed vehicles to storage`);
            } catch (error) {
                console.error('Error saving completion status:', error);
            }
        }

        function toggleVehicleCompletion(registration) {
            // Toggle completion status for a single vehicle
            if (completedVehicles.has(registration)) {
                completedVehicles.delete(registration);
                console.log(`âœ… Marked ${registration} as pending`);
            } else {
                completedVehicles.add(registration);
                console.log(`âœ… Marked ${registration} as completed`);
            }

            saveCompletionStatus();
            displayMOTVehicles();
            updateMOTStatistics();
        }

        function markSelectedAsCompleted() {
            // Mark all selected vehicles as completed
            if (selectedMOTVehicles.length === 0) {
                showNotification('No vehicles selected', 'warning');
                return;
            }

            const pendingSelected = selectedMOTVehicles.filter(reg => !completedVehicles.has(reg));

            if (pendingSelected.length === 0) {
                showNotification('All selected vehicles are already marked as completed', 'info');
                return;
            }

            if (confirm(`Mark ${pendingSelected.length} vehicles as completed/verified?`)) {
                pendingSelected.forEach(reg => completedVehicles.add(reg));
                saveCompletionStatus();
                displayMOTVehicles();
                updateMOTStatistics();
                showNotification(`${pendingSelected.length} vehicles marked as completed`, 'success');
            }
        }

        function markSelectedAsPending() {
            // Mark all selected vehicles as pending
            if (selectedMOTVehicles.length === 0) {
                showNotification('No vehicles selected', 'warning');
                return;
            }

            const completedSelected = selectedMOTVehicles.filter(reg => completedVehicles.has(reg));

            if (completedSelected.length === 0) {
                showNotification('All selected vehicles are already pending', 'info');
                return;
            }

            if (confirm(`Mark ${completedSelected.length} vehicles as pending (reset completion status)?`)) {
                completedSelected.forEach(reg => completedVehicles.delete(reg));
                saveCompletionStatus();
                displayMOTVehicles();
                updateMOTStatistics();
                showNotification(`${completedSelected.length} vehicles marked as pending`, 'success');
            }
        }

        function resetAllCompletionStatus() {
            // Reset completion status for all vehicles
            if (completedVehicles.size === 0) {
                showNotification('No completed vehicles to reset', 'info');
                return;
            }

            const count = completedVehicles.size;
            if (confirm(`Reset completion status for all ${count} completed vehicles?\n\nThis will mark them all as pending again.`)) {
                completedVehicles.clear();
                saveCompletionStatus();
                displayMOTVehicles();
                updateMOTStatistics();
                showNotification(`Reset completion status for ${count} vehicles`, 'success');
            }
        }

        function applyStatusFilter() {
            // Apply status filter to vehicle display
            currentStatusFilter = document.getElementById('status-filter-select').value;
            displayMOTVehicles();
            updateMOTStatistics();
        }

        // Helper function to parse customer field and extract information
        function parseCustomerField(customerField) {
            if (!customerField) return { name: '', mobile: '' };

            // Extract mobile number (pattern: m: followed by digits)
            const mobileMatch = customerField.match(/m:\s*(\d{11}|\d{10})/);
            const mobile = mobileMatch ? mobileMatch[1] : '';

            // Extract name - look for pattern before first 't:'
            // Handle cases like "Mr Benaim t:" where there's no space before t:
            const nameMatch = customerField.match(/^([^t]+?)(?:\s*t:|$)/);
            let name = nameMatch ? nameMatch[1].trim() : '';

            // Clean up name (remove quotes and common prefixes)
            name = name.replace(/^["']|["']$/g, ''); // Remove quotes
            name = name.replace(/^(Mr|Mrs|Ms|Miss|Dr)\s+/i, ''); // Remove titles

            return { name: name.trim(), mobile: mobile };
        }

        // Helper function to clean and validate mobile numbers
        function cleanMobileNumber(mobileField) {
            if (!mobileField) return '';

            // Remove all non-digit characters except +
            let cleaned = mobileField.replace(/[^\d+]/g, '');

            // Handle UK mobile numbers
            if (cleaned.match(/^(\+44|0)?7\d{9}$/)) {
                // Convert to +44 format
                if (cleaned.startsWith('07')) {
                    return '+44' + cleaned.substring(1);
                } else if (cleaned.startsWith('447')) {
                    return '+' + cleaned;
                } else if (cleaned.startsWith('+447')) {
                    return cleaned;
                } else if (cleaned.match(/^7\d{9}$/)) {
                    return '+44' + cleaned;
                }
            }

            // Return original if it looks like a valid mobile (10-11 digits starting with 07)
            if (cleaned.match(/^07\d{9}$/)) {
                return cleaned;
            }

            return ''; // Invalid mobile number
        }

        // File Upload Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processUploadFile(file);
            }
        }

        function processUploadFile(file) {
            const fileInfo = document.getElementById('file-info');
            const preview = document.getElementById('file-preview');
            const uploadBtn = document.getElementById('upload-btn');

            fileInfo.innerHTML = `
                <strong>File:</strong> ${file.name}<br>
                <strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                <strong>Type:</strong> ${file.type || 'Unknown'}
            `;

            preview.style.display = 'block';

            if (file.name.endsWith('.csv')) {
                processCSVFile(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                showNotification('Excel files are supported but require additional processing. Please use CSV format for now.', 'warning');
                uploadBtn.disabled = true;
            } else {
                showNotification('Unsupported file format. Please use CSV or Excel files.', 'error');
                uploadBtn.disabled = true;
            }
        }

        function processCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                console.log('ðŸ“„ Raw CSV content (first 500 chars):', csv.substring(0, 500));

                const lines = csv.split('\n').filter(line => line.trim());
                console.log('ðŸ“Š Total lines found:', lines.length);

                if (lines.length < 2) {
                    showNotification('CSV file must contain at least a header row and one data row', 'error');
                    return;
                }

                // Parse CSV properly handling quoted fields
                const parsedData = parseCSV(csv);
                console.log('ðŸ” Parsed CSV data:', parsedData);

                if (parsedData.length < 2) {
                    showNotification('CSV file must contain at least a header row and one data row', 'error');
                    return;
                }

                const headers = parsedData[0].map(h => h.trim().toLowerCase().replace(/"/g, ''));
                const dataRows = parsedData.slice(1);

                console.log('ðŸ“‹ Parsed headers:', headers);
                console.log('ðŸ“„ First few data rows:', dataRows.slice(0, 3));

                const previewHeader = document.getElementById('preview-header');
                const previewBody = document.getElementById('preview-body');

                // Show headers
                previewHeader.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

                // Show first 5 rows
                const previewRows = dataRows.slice(0, 5).map(row => {
                    return `<tr>${row.map(cell => `<td>${cell.replace(/"/g, '').substring(0, 50)}</td>`).join('')}</tr>`;
                }).join('');

                previewBody.innerHTML = previewRows;

                // Validate required columns
                const hasRegistration = headers.some(h =>
                    h.includes('registration') || h.includes('reg') || h === 'vehicle'
                );

                console.log('ðŸŽ¯ Registration column found:', hasRegistration);
                console.log('ðŸ” Available headers:', headers);

                if (hasRegistration) {
                    document.getElementById('upload-btn').disabled = false;
                    // Store parsed data instead of raw lines
                    window.uploadFileData = {
                        headers,
                        lines: dataRows.map(row => row.join(',')) // Convert back to CSV format for compatibility
                    };
                    console.log('âœ… Upload data prepared:', window.uploadFileData);
                } else {
                    showNotification('CSV must contain a registration column (registration, reg, or vehicle)', 'error');
                    document.getElementById('upload-btn').disabled = true;
                }
            };
            reader.readAsText(file);
        }

        // Improved CSV parser that handles quoted fields properly
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');

            for (let line of lines) {
                if (!line.trim()) continue;

                const row = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            // Escaped quote
                            current += '"';
                            i++; // Skip next quote
                        } else {
                            // Toggle quote state
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // End of field
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }

                // Add the last field
                row.push(current.trim());
                rows.push(row);
            }

            return rows;
        }

        // Helper function to parse a single CSV line
        function parseCSVLine(line) {
            const row = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    row.push(current.trim().replace(/^"|"$/g, '')); // Remove surrounding quotes
                    current = '';
                } else {
                    current += char;
                }
            }

            // Add the last field
            row.push(current.trim().replace(/^"|"$/g, ''));
            return row;
        }

        async function processBulkUpload() {
            console.log('ðŸš€ Starting bulk upload process with REAL uploaded file data...');

            if (!window.uploadFileData) {
                console.error('âŒ No upload file data available');
                showNotification('No file data available', 'error');
                return;
            }

            // Prevent multiple simultaneous uploads
            if (window.uploadInProgress) {
                console.log('âš ï¸ Upload already in progress, ignoring request');
                return;
            }

            window.uploadInProgress = true;

            try {
                const { headers, lines } = window.uploadFileData;
                console.log('ðŸ“Š PROCESSING REAL UPLOADED FILE DATA:');
                console.log('   ðŸ“‹ Headers found:', headers);
                console.log('   ðŸ“„ Total data lines:', lines.length);
                console.log('   ðŸ” First 3 lines of YOUR uploaded file:');
                lines.slice(0, 3).forEach((line, i) => {
                    console.log(`      Line ${i + 1}: ${line}`);
                });

                // Validate data size
                if (lines.length > 100) {
                    if (!confirm(`You are about to upload ${lines.length} vehicles. This may take a while. Continue?`)) {
                        window.uploadInProgress = false;
                        return;
                    }
                }

                const regIndex = headers.findIndex(h =>
                    h.includes('registration') || h.includes('reg') || h === 'vehicle'
                );
                const nameIndex = headers.findIndex(h =>
                    h.includes('name') || h.includes('customer')
                );
                const mobileIndex = headers.findIndex(h =>
                    h.includes('mobile') || h.includes('phone') || h.includes('tel')
                );
                // Also look for additional mobile columns
                const mobileIndex2 = headers.findIndex((h, i) =>
                    i !== mobileIndex && (h.includes('mobile') || h.includes('phone') || h.includes('tel'))
                );
                const makeIndex = headers.findIndex(h =>
                    h.includes('make') || h === 'make'
                );

                console.log('ðŸŽ¯ Column indices:', { regIndex, nameIndex, mobileIndex, mobileIndex2, makeIndex });
                console.log('ðŸ” Registration column found at index:', regIndex, '- header:', headers[regIndex]);
                console.log('ðŸ‘¤ Customer column found at index:', nameIndex, '- header:', nameIndex >= 0 ? headers[nameIndex] : 'NOT FOUND');
                console.log('ðŸ“± Mobile column found at index:', mobileIndex, '- header:', mobileIndex >= 0 ? headers[mobileIndex] : 'NOT FOUND');
                console.log('ðŸ“± Mobile column 2 found at index:', mobileIndex2, '- header:', mobileIndex2 >= 0 ? headers[mobileIndex2] : 'NOT FOUND');

                if (regIndex === -1) {
                    console.error('No registration column found');
                    showNotification('No registration column found in CSV', 'error');
                    window.uploadInProgress = false;
                    return;
                }

                let processed = 0;
                let skipped = 0;
                const totalLines = lines.length;

                // Show progress indicator
                document.getElementById('upload-progress').style.display = 'block';
                document.getElementById('upload-btn').disabled = true;
                document.getElementById('cancel-upload-btn').disabled = true;

                showNotification('Processing bulk upload with DVSA API...', 'info');

                // Process each line using the backend API
                for (let index = 0; index < lines.length; index++) {
                    try {
                        const line = lines[index];
                        console.log(`\nðŸ“ Processing YOUR uploaded data - Line ${index + 1}/${totalLines}:`);
                        console.log(`   Raw line: ${line}`);

                        if (!line || line.trim() === '') {
                            console.log('âš ï¸ Empty line, skipping');
                            skipped++;
                            continue;
                        }

                        // Parse the CSV line properly
                        const cells = parseCSVLine(line);
                        console.log(`   ðŸ“Š Parsed into ${cells.length} cells:`, cells);

                        const registration = cells[regIndex]?.toUpperCase().trim().replace(/\s+/g, '');
                        console.log(`   ðŸš— Extracted registration from column ${regIndex} (${headers[regIndex]}): "${registration}"`);

                        if (!registration || registration === '') {
                            console.log('âŒ No registration found in this line, skipping');
                            skipped++;
                            continue;
                        }

                        // Parse customer information
                        let customerName = '';
                        let mobileNumber = '';

                        if (nameIndex >= 0 && cells[nameIndex]) {
                            const customerField = cells[nameIndex];
                            console.log(`   ðŸ‘¤ Customer field from column ${nameIndex} (${headers[nameIndex]}): "${customerField}"`);

                            // Check if this looks like a complex customer field (contains 't:' or 'm:')
                            if (customerField.includes('t:') || customerField.includes('m:')) {
                                // Use the complex parser for fields like "Mr Gary Liss t: m: 07804391204 e: maps.liss@gmail.com"
                                const customerInfo = parseCustomerField(customerField);
                                customerName = customerInfo.name;
                                mobileNumber = customerInfo.mobile;
                            } else {
                                // Simple customer name - just clean it up
                                customerName = customerField.trim();
                                // Remove titles and clean up
                                customerName = customerName.replace(/^(Mr|Mrs|Ms|Miss|Dr|Lady)\s+/i, '');
                                customerName = customerName.replace(/^["']|["']$/g, ''); // Remove quotes
                            }
                            console.log(`   ðŸ“‹ Parsed customer info: name="${customerName}", mobile="${mobileNumber}"`);
                        }

                        // Try to get mobile number from various columns
                        if (!mobileNumber && mobileIndex >= 0) {
                            const mobileField = cells[mobileIndex] || '';
                            console.log(`   ðŸ“± Mobile field from column ${mobileIndex} (${headers[mobileIndex]}): "${mobileField}"`);
                            // Clean and validate mobile number
                            const cleanMobile = cleanMobileNumber(mobileField);
                            if (cleanMobile) {
                                mobileNumber = cleanMobile;
                            }
                        }

                        // Try second mobile column if first didn't work
                        if (!mobileNumber && mobileIndex2 >= 0) {
                            const mobileField2 = cells[mobileIndex2] || '';
                            console.log(`   ðŸ“± Mobile field 2 from column ${mobileIndex2} (${headers[mobileIndex2]}): "${mobileField2}"`);
                            const cleanMobile = cleanMobileNumber(mobileField2);
                            if (cleanMobile) {
                                mobileNumber = cleanMobile;
                            }
                        }

                        // Prepare data for API call
                        const vehicleData = {
                            registration: registration,
                            customer_name: customerName,
                            mobile_number: mobileNumber,
                            upload_batch_id: `bulk_${Date.now()}`
                        };

                        console.log(`   ðŸš€ Sending to DVSA API:`, vehicleData);

                        // Use the backend API to add the vehicle (handles DVSA API and failed registrations automatically)
                        const response = await fetch(`${API_BASE_URL}/mot/vehicles`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(vehicleData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                processed++;
                                console.log(`âœ… Successfully processed ${registration}`);
                            } else {
                                skipped++;
                                console.log(`âŒ Failed ${registration}: ${result.error}`);
                            }
                        } else {
                            skipped++;
                            console.log(`ðŸ’¥ API error for ${registration}`);
                        }

                        // Update progress
                        const progressPercent = Math.round(((index + 1) / totalLines) * 100);
                        document.getElementById('progress-bar').style.width = progressPercent + '%';
                        document.getElementById('progress-text').textContent = `Processing ${index + 1} of ${totalLines} (${processed} added, ${skipped} failed)`;

                        // Small delay to prevent overwhelming
                        if (index % 5 === 0 && index > 0) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }

                    } catch (lineError) {
                        console.error(`Error processing line ${index + 1}:`, lineError);
                        skipped++;
                    }
                }

                // Reload data to show results
                await loadMOTReminders();
                updateFailedRegistrationsCount();

                // Hide progress and close modal
                document.getElementById('upload-progress').style.display = 'none';
                document.getElementById('upload-btn').disabled = false;
                document.getElementById('cancel-upload-btn').disabled = false;

                window.uploadInProgress = false;
                closeBulkUploadModal();

                if (processed > 0 && skipped > 0) {
                    showNotification(`Upload complete: ${processed} vehicles added, ${skipped} failed (available for manual review)`, 'warning');
                } else if (processed > 0) {
                    showNotification(`Upload complete: ${processed} vehicles added successfully`, 'success');
                } else {
                    showNotification(`No vehicles added - all ${skipped} registrations failed (check manual review)`, 'error');
                }

            } catch (error) {
                console.error('Error in bulk upload process:', error);

                // Hide progress and re-enable buttons
                document.getElementById('upload-progress').style.display = 'none';
                document.getElementById('upload-btn').disabled = false;
                document.getElementById('cancel-upload-btn').disabled = false;

                window.uploadInProgress = false;
                showNotification('Error during bulk upload: ' + error.message, 'error');
            }
        }

        function downloadTemplate(format) {
            if (format === 'csv') {
                // Create CSV content matching your format with real UK registrations
                const csvContent = `type,work due,print due,email due,sms due,registration,make,customer,last invoiced
MOT,22/06/2025,Due Now,-,-,AB12CDE,Vauxhall Astra,"Mr John Smith t: m: 07123456789 e: john@example.com",10/06/2024
MOT,23/06/2025,Due Now,-,Due Now,EJ13UYV,Toyota Yaris,"Mrs Sarah Johnson t: m: 07987654321 e: sarah@example.com",05/12/2024
MOT,24/06/2025,Due Now,-,Due Now,L15AJR,Ford Focus,"Mr Mike Wilson t: m: 07555123456 e: mike@example.com",28/11/2024
MOT,25/06/2025,Due Now,-,-,MT03HHE,Fiat Punto,"Ms Emma Davis t: m: 07777888999 e: emma@example.com",25/06/2024
MOT,26/06/2025,Due Now,-,Due Now,KU53UYG,Renault Clio,"Mr James Brown t: m: 07444555666 e: james@example.com",15/05/2024`;

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mot_vehicles_template.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('CSV template downloaded successfully', 'success');
            } else if (format === 'excel') {
                // For Excel, we'll create a CSV that can be opened in Excel
                const csvContent = `type,work due,print due,email due,sms due,registration,make,customer,last invoiced
MOT,22/06/2025,Due Now,-,-,AB12CDE,Vauxhall Astra,"Mr John Smith t: m: 07123456789 e: john@example.com",10/06/2024
MOT,23/06/2025,Due Now,-,Due Now,EJ13UYV,Toyota Yaris,"Mrs Sarah Johnson t: m: 07987654321 e: sarah@example.com",05/12/2024
MOT,24/06/2025,Due Now,-,Due Now,L15AJR,Ford Focus,"Mr Mike Wilson t: m: 07555123456 e: mike@example.com",28/11/2024
MOT,25/06/2025,Due Now,-,-,MT03HHE,Fiat Punto,"Ms Emma Davis t: m: 07777888999 e: emma@example.com",25/06/2024
MOT,26/06/2025,Due Now,-,Due Now,KU53UYG,Renault Clio,"Mr James Brown t: m: 07444555666 e: james@example.com",15/05/2024`;

                const blob = new Blob([csvContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mot_vehicles_template.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('Excel-compatible template downloaded successfully', 'success');
            }
        }

        // Drag and Drop Functionality
        function initializeDragAndDrop() {
            const dropArea = document.getElementById('file-drop-area');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            dropArea.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                dropArea.classList.add('dragover');
            }

            function unhighlight() {
                dropArea.classList.remove('dragover');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    processUploadFile(files[0]);
                }
            }
        }

        // Confirm and clear all MOT data
        function confirmClearAllData() {
            const vehicleCount = motVehicles.length;
            if (vehicleCount === 0) {
                showNotification('No data to clear', 'info');
                return;
            }

            const message = `Are you sure you want to clear all ${vehicleCount} vehicles from the MOT system?\n\nThis action cannot be undone.`;
            if (confirm(message)) {
                clearAllMOTData();
            }
        }

        // Clear all MOT data function
        function clearAllMOTData() {
            console.log('Clearing all MOT data from localStorage');
            localStorage.removeItem('motVehicles');
            motVehicles = [];
            selectedMOTVehicles = [];
            updateMOTStatistics();
            displayMOTVehicles();
            updateMOTUrgentBadge();
            showNotification('All MOT data cleared successfully', 'success');
        }

        // Clear demo data function (legacy)
        function clearDemoData() {
            const savedVehicles = localStorage.getItem('motVehicles');
            if (savedVehicles) {
                try {
                    const vehicles = JSON.parse(savedVehicles);
                    // Check if this looks like demo data (has specific demo registrations)
                    const demoRegistrations = ['AB12CDE', 'XY98ZYZ', 'MN56JKL', 'PQ34RST', 'UV78WXY', 'CD90EFG', 'GH12IJK', 'LM34NOP', 'QR56STU', 'VW78XYZ'];
                    const hasDemoData = vehicles.some(v => demoRegistrations.includes(v.registration));

                    if (hasDemoData) {
                        console.log('Clearing demo data from localStorage');
                        localStorage.removeItem('motVehicles');
                    }
                } catch (error) {
                    console.log('Error checking demo data, clearing localStorage');
                    localStorage.removeItem('motVehicles');
                }
            }
        }

        // Initialize MOT Reminders on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing MOT system...');

            // Load completion status from localStorage
            loadCompletionStatus();

            // Initialize drag and drop
            setTimeout(initializeDragAndDrop, 100);

            // Restore view preference
            const savedView = localStorage.getItem('motViewMode');
            if (savedView) {
                currentMOTView = savedView;
            }

            // Load MOT data immediately
            console.log('Loading MOT reminders on page load...');
            loadMOTReminders();
        });

        // Also ensure data loads when switching to MOT page
        function ensureMOTDataLoaded() {
            console.log('ðŸ”„ Ensuring MOT data is loaded...');

            // Load completion status if not already loaded
            if (completedVehicles.size === 0) {
                loadCompletionStatus();
            }

            // Always try to load MOT reminders when switching to the page
            console.log('Loading MOT reminders for page switch...');
            loadMOTReminders();

            // Also load failed registrations count
            updateFailedRegistrationsCount();
        }

        // Failed Registrations Management
        let failedRegistrations = [];

        async function loadFailedRegistrations() {
            try {
                console.log('Loading failed registrations...');

                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations?status=pending`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        failedRegistrations = result.failed_registrations;
                        displayFailedRegistrations();
                        updateFailedRegistrationsCount();
                        console.log(`Loaded ${failedRegistrations.length} failed registrations`);
                    } else {
                        throw new Error(result.error || 'Failed to load failed registrations');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error loading failed registrations:', error);
                showNotification('Error loading failed registrations', 'error');
                failedRegistrations = [];
                displayFailedRegistrations();
            }
        }

        function displayFailedRegistrations() {
            const container = document.getElementById('failed-registrations-list');

            if (failedRegistrations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h4>No Failed Registrations</h4>
                        <p>All registrations have been successfully processed or reviewed.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-narrow">
                                <input type="checkbox" id="select-all-failed" onchange="toggleAllFailedSelection()">
                            </th>
                            <th class="col-medium">Original Registration</th>
                            <th class="col-medium">Customer</th>
                            <th class="col-medium">Mobile</th>
                            <th class="col-wide">Error Message</th>
                            <th class="col-medium">Corrected Registration</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            failedRegistrations.forEach(failed => {
                html += `
                    <tr>
                        <td>
                            <input type="checkbox" class="failed-checkbox" value="${failed.id}">
                        </td>
                        <td>
                            <strong>${failed.original_registration}</strong>
                        </td>
                        <td>${failed.customer_name || '-'}</td>
                        <td>${failed.mobile_number || '-'}</td>
                        <td>
                            <small style="color: #dc3545;">${failed.error_message}</small>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm"
                                   id="corrected-${failed.id}"
                                   value="${failed.original_registration}"
                                   placeholder="Enter corrected registration"
                                   style="min-width: 150px;">
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.25rem;">
                                <button class="btn btn-sm btn-success"
                                        onclick="retryFailedRegistration(${failed.id})"
                                        title="Retry with corrected registration">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary"
                                        onclick="dismissFailedRegistration(${failed.id})"
                                        title="Dismiss this registration">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        async function retryFailedRegistration(failedId) {
            const correctedInput = document.getElementById(`corrected-${failedId}`);
            const correctedRegistration = correctedInput.value.trim().toUpperCase();

            if (!correctedRegistration) {
                showNotification('Please enter a corrected registration', 'error');
                return;
            }

            try {
                showNotification('Retrying with corrected registration...', 'info');

                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations/${failedId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        corrected_registration: correctedRegistration,
                        action: 'retry'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification(result.message || 'Registration corrected successfully', 'success');
                        await loadFailedRegistrations(); // Refresh the list
                        await loadMOTReminders(); // Refresh main MOT list
                    } else {
                        showNotification(result.error || 'Failed to retry registration', 'error');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error retrying failed registration:', error);
                showNotification('Error retrying registration', 'error');
            }
        }

        async function dismissFailedRegistration(failedId) {
            if (!confirm('Are you sure you want to dismiss this failed registration? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations/${failedId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'dismiss'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Registration dismissed', 'success');
                        await loadFailedRegistrations(); // Refresh the list
                    } else {
                        showNotification(result.error || 'Failed to dismiss registration', 'error');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error dismissing failed registration:', error);
                showNotification('Error dismissing registration', 'error');
            }
        }

        function toggleAllFailedSelection() {
            const selectAll = document.getElementById('select-all-failed');
            const checkboxes = document.querySelectorAll('.failed-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        async function bulkProcessSelected() {
            const selectedCheckboxes = document.querySelectorAll('.failed-checkbox:checked');

            if (selectedCheckboxes.length === 0) {
                showNotification('Please select registrations to process', 'error');
                return;
            }

            const updates = [];
            for (const checkbox of selectedCheckboxes) {
                const failedId = parseInt(checkbox.value);
                const correctedInput = document.getElementById(`corrected-${failedId}`);
                const correctedRegistration = correctedInput.value.trim().toUpperCase();

                if (correctedRegistration) {
                    updates.push({
                        id: failedId,
                        corrected_registration: correctedRegistration,
                        action: 'retry'
                    });
                }
            }

            if (updates.length === 0) {
                showNotification('Please enter corrected registrations for selected items', 'error');
                return;
            }

            try {
                showNotification(`Processing ${updates.length} registrations...`, 'info');

                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ updates })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`Processed ${result.successful} of ${result.total_processed} registrations`, 'success');
                        await loadFailedRegistrations(); // Refresh the list
                        await loadMOTReminders(); // Refresh main MOT list
                    } else {
                        showNotification('Bulk processing failed', 'error');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error bulk processing failed registrations:', error);
                showNotification('Error processing registrations', 'error');
            }
        }

        async function updateFailedRegistrationsCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations?status=pending`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const count = result.failed_registrations.length;
                        const badge = document.getElementById('failed-count');
                        const button = document.getElementById('failed-regs-button');

                        if (badge) {
                            badge.textContent = count;
                        }

                        if (button) {
                            if (count > 0) {
                                button.style.display = 'inline-flex';
                            } else {
                                button.style.display = 'none';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating failed registrations count:', error);
            }
        }

        function showFailedRegistrationsModal() {
            loadFailedRegistrations();
            document.getElementById('failed-registrations-modal').classList.add('active');
        }

        function closeFailedRegistrationsModal() {
            document.getElementById('failed-registrations-modal').classList.remove('active');
        }

        // Real-time Correction During Upload
        let currentUploadState = {
            lines: [],
            currentIndex: 0,
            processed: 0,
            skipped: 0,
            correctionPending: false,
            currentLine: null,
            regIndex: -1,
            nameIndex: -1,
            mobileIndex: -1
        };

        function showRealtimeCorrection(originalReg, customerName, mobile, currentIndex, totalCount) {
            currentUploadState.correctionPending = true;

            document.getElementById('failed-original-reg').textContent = originalReg;
            document.getElementById('correction-input').value = originalReg;
            document.getElementById('failed-customer-info').textContent = customerName ? `${customerName}${mobile ? ` (${mobile})` : ''}` : 'No customer info';
            document.getElementById('current-processing-index').textContent = currentIndex + 1;
            document.getElementById('total-processing-count').textContent = totalCount;

            document.getElementById('realtime-correction').style.display = 'block';
            document.getElementById('correction-input').focus();
            document.getElementById('correction-input').select();

            // Enable Enter key to apply correction
            document.getElementById('correction-input').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    applyCorrectionAndContinue();
                }
            };
        }

        function hideRealtimeCorrection() {
            document.getElementById('realtime-correction').style.display = 'none';
            currentUploadState.correctionPending = false;
        }

        async function applyCorrectionAndContinue() {
            const correctedReg = document.getElementById('correction-input').value.trim().toUpperCase();

            if (!correctedReg) {
                showNotification('Please enter a corrected registration', 'error');
                return;
            }

            try {
                document.getElementById('correct-btn').disabled = true;
                document.getElementById('correct-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';

                // Try to add the corrected registration
                const line = currentUploadState.currentLine;
                const customerName = currentUploadState.nameIndex >= 0 ? line[currentUploadState.nameIndex] : '';
                const mobileNumber = currentUploadState.mobileIndex >= 0 ? line[currentUploadState.mobileIndex] : '';

                const response = await fetch(`${API_BASE_URL}/mot/vehicles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        registration: correctedReg,
                        customer_name: customerName,
                        mobile_number: mobileNumber
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentUploadState.processed++;
                        showNotification(`âœ… Corrected: ${correctedReg} added successfully`, 'success');
                        hideRealtimeCorrection();
                        continueUploadProcessing();
                        return;
                    } else {
                        showNotification(`âŒ Correction failed: ${result.error}`, 'error');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error applying correction:', error);
                showNotification('Error applying correction', 'error');
            } finally {
                document.getElementById('correct-btn').disabled = false;
                document.getElementById('correct-btn').innerHTML = '<i class="fas fa-check"></i> Correct & Continue';
            }
        }

        function skipAndContinue() {
            currentUploadState.skipped++;
            hideRealtimeCorrection();
            continueUploadProcessing();
        }

        function cancelUpload() {
            hideRealtimeCorrection();
            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-btn').disabled = false;
            document.getElementById('cancel-upload-btn').disabled = false;
            window.uploadInProgress = false;
            showNotification('Upload cancelled', 'warning');
        }

        function continueUploadProcessing() {
            // Continue with the next registration in the upload
            currentUploadState.currentIndex++;
            processNextUploadLine();
        }

        async function processNextUploadLine() {
            const { lines, currentIndex, regIndex, nameIndex, mobileIndex } = currentUploadState;

            if (currentIndex >= lines.length) {
                // Upload complete
                completeUpload();
                return;
            }

            const line = lines[currentIndex];
            const registration = line[regIndex];

            if (!registration || registration.trim() === '') {
                currentUploadState.currentIndex++;
                processNextUploadLine();
                return;
            }

            const cleanReg = registration.trim().toUpperCase().replace(/\s+/g, '');
            const customerName = nameIndex >= 0 ? line[nameIndex] : '';
            const mobileNumber = mobileIndex >= 0 ? line[mobileIndex] : '';

            // Update progress
            const progress = ((currentIndex + 1) / lines.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `Processing ${currentIndex + 1} of ${lines.length}: ${cleanReg}`;

            try {
                // Try to add the vehicle
                const response = await fetch(`${API_BASE_URL}/mot/vehicles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        registration: cleanReg,
                        customer_name: customerName,
                        mobile_number: mobileNumber
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentUploadState.processed++;
                        currentUploadState.currentIndex++;
                        processNextUploadLine();
                    } else {
                        // Registration failed - show correction interface
                        currentUploadState.currentLine = line;
                        showRealtimeCorrection(cleanReg, customerName, mobileNumber, currentIndex, lines.length);
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error processing registration:', error);
                currentUploadState.currentLine = line;
                showRealtimeCorrection(cleanReg, customerName, mobileNumber, currentIndex, lines.length);
            }
        }

        function completeUpload() {
            const { processed, skipped } = currentUploadState;

            // Reload data
            loadMOTReminders();
            updateFailedRegistrationsCount();

            // Hide progress and close modal
            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-btn').disabled = false;
            document.getElementById('cancel-upload-btn').disabled = false;

            window.uploadInProgress = false;
            closeBulkUploadModal();

            if (processed > 0 && skipped > 0) {
                showNotification(`Upload complete: ${processed} vehicles added, ${skipped} skipped`, 'warning');
            } else if (processed > 0) {
                showNotification(`Upload complete: ${processed} vehicles added successfully`, 'success');
            } else {
                showNotification('No vehicles were added', 'warning');
            }

            // Reset upload state
            currentUploadState = {
                lines: [],
                currentIndex: 0,
                processed: 0,
                skipped: 0,
                correctionPending: false,
                currentLine: null,
                regIndex: -1,
                nameIndex: -1,
                mobileIndex: -1
            };
        }

        // Settings Page Functions
        let currentSettingsTab = 'mot-settings';
        let settingsData = {};

        // Show Settings Tab
        function showSettingsTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab content
            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }

            currentSettingsTab = tabId;
        }

        // Load Settings from localStorage
        function loadSettings() {
            try {
                const saved = localStorage.getItem('garageSettings');
                if (saved) {
                    settingsData = JSON.parse(saved);
                    populateSettingsForm();
                } else {
                    // Set default values
                    setDefaultSettings();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                setDefaultSettings();
            }
        }

        // Set Default Settings
        function setDefaultSettings() {
            settingsData = {
                // DVLA API Settings
                dvlaClientId: '2b3911f4-55f5-4a86-a9f0-0fc02c2bff0f',
                dvlaTokenUrl: 'https://login.microsoftonline.com/a455b827-244f-4c97-b5b4-ce5d13b4d00c/oauth2/v2.0/token',

                // SMS Settings
                smsProvider: 'twilio',
                smsSenderId: '',
                smsTemplate: 'Hi {customer_name}, your vehicle {registration} MOT expires on {expiry_date}. Please contact us to book your MOT test.',

                // Notification Settings
                reminderPrimary: 30,
                reminderFollowup: 14,
                reminderFinal: 7,

                // System Settings
                dateFormat: 'DD-MM-YYYY',
                timeFormat: '24h',
                tableDensity: 'normal',
                pageSize: 25,
                uiTheme: 'light',
                showTooltips: true,
                autoSave: true,
                desktopNotifications: true,
                soundNotifications: false,
                notificationDuration: 5000,

                // Garage Information
                garageName: '',
                businessReg: '',
                garageAddress: '',
                garagePhone: '',
                garageMobile: '',
                garageEmail: '',
                garageWebsite: '',

                // Operating Hours
                operatingHours: {
                    monday: { open: '08:00', close: '17:00', closed: false },
                    tuesday: { open: '08:00', close: '17:00', closed: false },
                    wednesday: { open: '08:00', close: '17:00', closed: false },
                    thursday: { open: '08:00', close: '17:00', closed: false },
                    friday: { open: '08:00', close: '17:00', closed: false },
                    saturday: { open: '08:00', close: '13:00', closed: false },
                    sunday: { open: '10:00', close: '16:00', closed: true }
                },

                // User Settings
                userName: '',
                userEmail: '',
                userTitle: '',
                userPhone: '',
                twoFactorAuth: false,
                sessionTimeout: true,
                userLanguage: 'en',
                userTimezone: 'Europe/London',
                emailNotifications: true,
                marketingEmails: false
            };

            populateSettingsForm();
        }

        // Populate Settings Form
        function populateSettingsForm() {
            // DVLA API Settings
            document.getElementById('dvla-client-id').value = settingsData.dvlaClientId || '';
            document.getElementById('dvla-token-url').value = settingsData.dvlaTokenUrl || '';

            // SMS Settings
            document.getElementById('sms-provider').value = settingsData.smsProvider || 'twilio';
            document.getElementById('sms-sender-id').value = settingsData.smsSenderId || '';
            document.getElementById('sms-template').value = settingsData.smsTemplate || '';

            // Notification Settings
            document.getElementById('reminder-primary').value = settingsData.reminderPrimary || 30;
            document.getElementById('reminder-followup').value = settingsData.reminderFollowup || 14;
            document.getElementById('reminder-final').value = settingsData.reminderFinal || 7;

            // System Settings
            document.getElementById('date-format').value = settingsData.dateFormat || 'DD-MM-YYYY';
            document.getElementById('time-format').value = settingsData.timeFormat || '24h';
            document.getElementById('table-density').value = settingsData.tableDensity || 'normal';
            document.getElementById('page-size').value = settingsData.pageSize || 25;
            document.getElementById('ui-theme').value = settingsData.uiTheme || 'light';
            document.getElementById('show-tooltips').checked = settingsData.showTooltips !== false;
            document.getElementById('auto-save').checked = settingsData.autoSave !== false;
            document.getElementById('desktop-notifications').checked = settingsData.desktopNotifications !== false;
            document.getElementById('sound-notifications').checked = settingsData.soundNotifications === true;
            document.getElementById('notification-duration').value = settingsData.notificationDuration || 5000;

            // Garage Information
            document.getElementById('garage-name').value = settingsData.garageName || '';
            document.getElementById('business-reg').value = settingsData.businessReg || '';
            document.getElementById('garage-address').value = settingsData.garageAddress || '';
            document.getElementById('garage-phone').value = settingsData.garagePhone || '';
            document.getElementById('garage-mobile').value = settingsData.garageMobile || '';
            document.getElementById('garage-email').value = settingsData.garageEmail || '';
            document.getElementById('garage-website').value = settingsData.garageWebsite || '';

            // Operating Hours
            if (settingsData.operatingHours) {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                const dayAbbr = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

                days.forEach((day, index) => {
                    const abbr = dayAbbr[index];
                    const hours = settingsData.operatingHours[day];
                    if (hours) {
                        document.getElementById(`${abbr}-open`).value = hours.open || '08:00';
                        document.getElementById(`${abbr}-close`).value = hours.close || '17:00';
                        document.getElementById(`${abbr}-closed`).checked = hours.closed === true;
                    }
                });
            }

            // User Settings
            document.getElementById('user-name').value = settingsData.userName || '';
            document.getElementById('user-email').value = settingsData.userEmail || '';
            document.getElementById('user-title').value = settingsData.userTitle || '';
            document.getElementById('user-phone').value = settingsData.userPhone || '';
            document.getElementById('two-factor-auth').checked = settingsData.twoFactorAuth === true;
            document.getElementById('session-timeout').checked = settingsData.sessionTimeout !== false;
            document.getElementById('user-language').value = settingsData.userLanguage || 'en';
            document.getElementById('user-timezone').value = settingsData.userTimezone || 'Europe/London';
            document.getElementById('email-notifications').checked = settingsData.emailNotifications !== false;
            document.getElementById('marketing-emails').checked = settingsData.marketingEmails === true;
        }

        // Save All Settings
        function saveAllSettings() {
            try {
                // Collect all form data
                settingsData = {
                    // DVLA API Settings
                    dvlaClientId: document.getElementById('dvla-client-id').value,
                    dvlaTokenUrl: document.getElementById('dvla-token-url').value,

                    // SMS Settings
                    smsProvider: document.getElementById('sms-provider').value,
                    smsSenderId: document.getElementById('sms-sender-id').value,
                    smsTemplate: document.getElementById('sms-template').value,

                    // Notification Settings
                    reminderPrimary: parseInt(document.getElementById('reminder-primary').value),
                    reminderFollowup: parseInt(document.getElementById('reminder-followup').value),
                    reminderFinal: parseInt(document.getElementById('reminder-final').value),

                    // System Settings
                    dateFormat: document.getElementById('date-format').value,
                    timeFormat: document.getElementById('time-format').value,
                    tableDensity: document.getElementById('table-density').value,
                    pageSize: parseInt(document.getElementById('page-size').value),
                    uiTheme: document.getElementById('ui-theme').value,
                    showTooltips: document.getElementById('show-tooltips').checked,
                    autoSave: document.getElementById('auto-save').checked,
                    desktopNotifications: document.getElementById('desktop-notifications').checked,
                    soundNotifications: document.getElementById('sound-notifications').checked,
                    notificationDuration: parseInt(document.getElementById('notification-duration').value),

                    // Garage Information
                    garageName: document.getElementById('garage-name').value,
                    businessReg: document.getElementById('business-reg').value,
                    garageAddress: document.getElementById('garage-address').value,
                    garagePhone: document.getElementById('garage-phone').value,
                    garageMobile: document.getElementById('garage-mobile').value,
                    garageEmail: document.getElementById('garage-email').value,
                    garageWebsite: document.getElementById('garage-website').value,

                    // Operating Hours
                    operatingHours: {
                        monday: {
                            open: document.getElementById('mon-open').value,
                            close: document.getElementById('mon-close').value,
                            closed: document.getElementById('mon-closed').checked
                        },
                        tuesday: {
                            open: document.getElementById('tue-open').value,
                            close: document.getElementById('tue-close').value,
                            closed: document.getElementById('tue-closed').checked
                        },
                        wednesday: {
                            open: document.getElementById('wed-open').value,
                            close: document.getElementById('wed-close').value,
                            closed: document.getElementById('wed-closed').checked
                        },
                        thursday: {
                            open: document.getElementById('thu-open').value,
                            close: document.getElementById('thu-close').value,
                            closed: document.getElementById('thu-closed').checked
                        },
                        friday: {
                            open: document.getElementById('fri-open').value,
                            close: document.getElementById('fri-close').value,
                            closed: document.getElementById('fri-closed').checked
                        },
                        saturday: {
                            open: document.getElementById('sat-open').value,
                            close: document.getElementById('sat-close').value,
                            closed: document.getElementById('sat-closed').checked
                        },
                        sunday: {
                            open: document.getElementById('sun-open').value,
                            close: document.getElementById('sun-close').value,
                            closed: document.getElementById('sun-closed').checked
                        }
                    },

                    // User Settings
                    userName: document.getElementById('user-name').value,
                    userEmail: document.getElementById('user-email').value,
                    userTitle: document.getElementById('user-title').value,
                    userPhone: document.getElementById('user-phone').value,
                    twoFactorAuth: document.getElementById('two-factor-auth').checked,
                    sessionTimeout: document.getElementById('session-timeout').checked,
                    userLanguage: document.getElementById('user-language').value,
                    userTimezone: document.getElementById('user-timezone').value,
                    emailNotifications: document.getElementById('email-notifications').checked,
                    marketingEmails: document.getElementById('marketing-emails').checked
                };

                // Save to localStorage
                localStorage.setItem('garageSettings', JSON.stringify(settingsData));

                // Apply settings immediately
                applySettings();

                showNotification('Settings saved successfully!', 'success');

            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Error saving settings. Please try again.', 'error');
            }
        }

        // Reset All Settings
        function resetAllSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
                localStorage.removeItem('garageSettings');
                setDefaultSettings();
                showNotification('Settings reset to defaults', 'info');
            }
        }

        // Apply Settings
        function applySettings() {
            // Apply date format
            if (settingsData.dateFormat) {
                // This would be used throughout the application
                console.log('Applied date format:', settingsData.dateFormat);
            }

            // Apply theme
            if (settingsData.uiTheme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }

            // Apply table density
            if (settingsData.tableDensity) {
                document.body.className = document.body.className.replace(/table-density-\w+/g, '');
                document.body.classList.add(`table-density-${settingsData.tableDensity}`);
            }
        }

        // Test DVLA Connection
        function testDVLAConnection() {
            const statusElement = document.getElementById('dvla-status');
            const clientId = document.getElementById('dvla-client-id').value;
            const tokenUrl = document.getElementById('dvla-token-url').value;

            if (!clientId || !tokenUrl) {
                statusElement.textContent = 'Please enter both Client ID and Token URL';
                statusElement.className = 'connection-status error';
                return;
            }

            statusElement.textContent = 'Testing connection...';
            statusElement.className = 'connection-status testing';

            // Simulate API test (in real implementation, this would make an actual API call)
            setTimeout(() => {
                if (clientId === '2b3911f4-55f5-4a86-a9f0-0fc02c2bff0f') {
                    statusElement.textContent = 'Connection successful!';
                    statusElement.className = 'connection-status success';
                } else {
                    statusElement.textContent = 'Connection failed - Invalid credentials';
                    statusElement.className = 'connection-status error';
                }
            }, 2000);
        }

        // Export MOT Data
        function exportMOTData(format) {
            if (format === 'csv') {
                // Export as CSV
                const csvData = convertMOTDataToCSV();
                downloadFile(csvData, 'mot-data.csv', 'text/csv');
                showNotification('MOT data exported as CSV', 'success');
            } else if (format === 'json') {
                // Export as JSON
                const jsonData = JSON.stringify(motVehicles, null, 2);
                downloadFile(jsonData, 'mot-data.json', 'application/json');
                showNotification('MOT data exported as JSON', 'success');
            }
        }

        // Import MOT Data
        function importMOTData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedData;

                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(content);
                    } else if (file.name.endsWith('.csv')) {
                        importedData = parseCSVToMOTData(content);
                    }

                    if (importedData && importedData.length > 0) {
                        motVehicles = importedData;
                        displayMOTVehicles();
                        updateMOTStatistics();
                        showNotification(`Imported ${importedData.length} vehicles successfully`, 'success');
                    } else {
                        showNotification('No valid data found in file', 'error');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Error importing data. Please check file format.', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Clear Completion History
        function clearCompletionHistory() {
            if (confirm('Are you sure you want to clear all completion tracking history?')) {
                localStorage.removeItem('motCompletedVehicles');
                completedVehicles.clear();
                displayMOTVehicles();
                updateMOTStatistics();
                showNotification('Completion history cleared', 'info');
            }
        }

        // Export Completion Data
        function exportCompletionData() {
            const completionData = {
                completedVehicles: [...completedVehicles],
                exportDate: new Date().toISOString(),
                totalCompleted: completedVehicles.size
            };

            const jsonData = JSON.stringify(completionData, null, 2);
            downloadFile(jsonData, 'completion-data.json', 'application/json');
            showNotification('Completion data exported', 'success');
        }

        // Create Backup
        function createBackup() {
            const backupData = {
                settings: settingsData,
                motVehicles: motVehicles,
                completedVehicles: [...completedVehicles],
                backupDate: new Date().toISOString(),
                version: '1.0'
            };

            const jsonData = JSON.stringify(backupData, null, 2);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            downloadFile(jsonData, `garage-backup-${timestamp}.json`, 'application/json');
            showNotification('Backup created successfully', 'success');
        }

        // Restore from Backup
        function restoreFromBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);

                        if (confirm('Are you sure you want to restore from backup? This will overwrite all current data.')) {
                            // Restore settings
                            if (backupData.settings) {
                                settingsData = backupData.settings;
                                localStorage.setItem('garageSettings', JSON.stringify(settingsData));
                                populateSettingsForm();
                            }

                            // Restore MOT vehicles
                            if (backupData.motVehicles) {
                                motVehicles = backupData.motVehicles;
                                displayMOTVehicles();
                                updateMOTStatistics();
                            }

                            // Restore completion data
                            if (backupData.completedVehicles) {
                                completedVehicles = new Set(backupData.completedVehicles);
                                saveCompletionStatus();
                            }

                            showNotification('Backup restored successfully', 'success');
                        }
                    } catch (error) {
                        console.error('Restore error:', error);
                        showNotification('Error restoring backup. Please check file format.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Change Password
        function changePassword() {
            // This would open a password change dialog
            showNotification('Password change functionality would be implemented here', 'info');
        }

        // Helper function to download files
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Helper function to convert MOT data to CSV
        function convertMOTDataToCSV() {
            if (!motVehicles || motVehicles.length === 0) {
                return 'No data available';
            }

            const headers = ['Registration', 'Make', 'Model', 'MOT Expiry', 'Days Until Expiry', 'Customer', 'Phone', 'Email'];
            const csvRows = [headers.join(',')];

            motVehicles.forEach(vehicle => {
                const row = [
                    vehicle.registration || '',
                    vehicle.make || '',
                    vehicle.model || '',
                    vehicle.mot_expiry || '',
                    vehicle.days_until_expiry || '',
                    vehicle.customer_name || '',
                    vehicle.customer_phone || '',
                    vehicle.customer_email || ''
                ];
                csvRows.push(row.map(field => `"${field}"`).join(','));
            });

            return csvRows.join('\n');
        }

        // Helper function to parse CSV to MOT data
        function parseCSVToMOTData(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                    const vehicle = {};
                    headers.forEach((header, index) => {
                        vehicle[header.toLowerCase().replace(/\s+/g, '_')] = values[index] || '';
                    });
                    data.push(vehicle);
                }
            }

            return data;
        }

        // Initialize Settings when page loads
        function initializeSettings() {
            try {
                loadSettings();
                applySettings();
                console.log('Settings initialized successfully');
            } catch (error) {
                console.error('Error initializing settings:', error);
                // Set default settings if there's an error
                setDefaultSettings();
            }
        }

        // Test function to verify settings page is working
        function testSettingsPage() {
            console.log('Testing settings page...');

            // Test if settings page exists
            const settingsPage = document.getElementById('settings');
            console.log('Settings page element:', settingsPage ? 'Found' : 'Not found');

            // Test if settings tabs exist
            const settingsTabs = document.querySelectorAll('.settings-tab-btn');
            console.log('Settings tabs found:', settingsTabs.length);

            // Test if settings functions exist
            const functions = ['showPage', 'showSettingsTab', 'loadSettings', 'saveAllSettings'];
            functions.forEach(func => {
                console.log(`Function ${func}:`, typeof window[func] === 'function' ? 'Exists' : 'Missing');
            });

            // Test localStorage
            try {
                localStorage.setItem('test', 'value');
                const retrieved = localStorage.getItem('test');
                console.log('localStorage test:', retrieved === 'value' ? 'Working' : 'Failed');
                localStorage.removeItem('test');
            } catch (e) {
                console.log('localStorage error:', e.message);
            }

            return 'Settings page test completed - check console for details';
        }

        // Make test function available globally for debugging
        window.testSettingsPage = testSettingsPage;

        // Quick settings test function
        window.quickSettingsTest = function() {
            console.log('ðŸ§ª Quick Settings Test Starting...');

            // Test 1: Check if settings page exists
            const settingsPage = document.getElementById('settings');
            console.log('1ï¸âƒ£ Settings page element:', settingsPage ? 'âœ… Found' : 'âŒ Not found');

            // Test 2: Check if showPage function exists
            console.log('2ï¸âƒ£ showPage function:', typeof showPage === 'function' ? 'âœ… Exists' : 'âŒ Missing');

            // Test 3: Check navigation link
            const settingsNav = document.querySelector('a[onclick*="settings"]');
            console.log('3ï¸âƒ£ Settings navigation:', settingsNav ? 'âœ… Found' : 'âŒ Not found');

            // Test 4: Try to show settings page
            if (typeof showPage === 'function') {
                console.log('4ï¸âƒ£ Attempting to show settings page...');
                showPage('settings');

                // Check if it worked
                setTimeout(() => {
                    const isActive = settingsPage && settingsPage.classList.contains('active');
                    console.log('5ï¸âƒ£ Settings page active:', isActive ? 'âœ… Yes' : 'âŒ No');

                    if (isActive) {
                        console.log('ðŸŽ‰ Settings page is working correctly!');
                    } else {
                        console.log('âŒ Settings page failed to activate');
                    }
                }, 200);
            }

            return 'Test completed - check console output above';
        };

        // Force settings navigation function
        window.forceShowSettings = function() {
            console.log('ðŸ”§ Force showing settings page...');

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show settings page
            const settingsPage = document.getElementById('settings');
            if (settingsPage) {
                settingsPage.classList.add('active');
                console.log('âœ… Settings page forced to show');

                // Activate first tab
                const firstTab = document.querySelector('.settings-tab-btn');
                const firstTabContent = document.querySelector('.settings-tab-content');
                if (firstTab) firstTab.classList.add('active');
                if (firstTabContent) firstTabContent.classList.add('active');

                return 'Settings page should now be visible';
            } else {
                console.error('âŒ Settings page element not found');
                return 'Settings page element not found';
            }
        };

        // SMS History Functions
        function showSMSHistoryModal() {
            document.getElementById('sms-history-modal').classList.add('active');
            loadSMSHistory();
        }

        function closeSMSHistoryModal() {
            document.getElementById('sms-history-modal').classList.remove('active');
        }

        async function loadSMSHistory() {
            const historyList = document.getElementById('sms-history-list');
            const limit = document.getElementById('sms-history-limit').value;

            historyList.innerHTML = `
                <div class="loading" style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    Loading SMS history...
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/mot/sms/history?limit=${limit}`);
                const data = await response.json();

                if (data.success && data.history) {
                    displaySMSHistory(data.history);
                } else {
                    historyList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6c757d;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                            <h4>No SMS History Found</h4>
                            <p>No SMS messages have been sent yet.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading SMS history:', error);
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                        <h4>Error Loading History</h4>
                        <p>Could not load SMS history. Please try again.</p>
                    </div>
                `;
            }
        }

        function displaySMSHistory(history) {
            const historyList = document.getElementById('sms-history-list');

            if (history.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                        <h4>No SMS History</h4>
                        <p>No SMS messages have been sent yet.</p>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = `
                <table class="data-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Registration</th>
                            <th>Customer</th>
                            <th>Mobile</th>
                            <th>Message Type</th>
                            <th>MOT Expiry</th>
                            <th>Days Left</th>
                            <th>Send Status</th>
                            <th>Delivery Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(item => `
                            <tr>
                                <td style="font-size: 0.9rem;">
                                    ${formatDateTime(item.sent_at)}
                                </td>
                                <td>
                                    <strong>${item.registration}</strong>
                                </td>
                                <td>${item.customer_name || '-'}</td>
                                <td>${item.mobile_number || '-'}</td>
                                <td>
                                    <span class="badge ${getMessageTypeBadge(item.message_type)}">${item.message_type.toUpperCase()}</span>
                                </td>
                                <td>${formatDateForDisplay(item.mot_expiry_date)}</td>
                                <td>
                                    <span class="badge ${getDaysLeftBadge(item.days_until_expiry)}">
                                        ${item.days_until_expiry !== null ? item.days_until_expiry + ' days' : '-'}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge ${item.status === 'sent' ? 'bg-success' : 'bg-danger'}">
                                        ${item.status === 'sent' ? 'Sent' : 'Failed'}
                                    </span>
                                </td>
                                <td>
                                    ${getDeliveryStatusBadge(item.delivery_status, item.delivery_error_code)}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function getMessageTypeBadge(messageType) {
            switch (messageType) {
                case 'expired': return 'bg-danger';
                case 'critical': return 'bg-warning';
                case 'due_soon': return 'bg-info';
                case 'reminder': return 'bg-primary';
                default: return 'bg-secondary';
            }
        }

        function getDaysLeftBadge(daysLeft) {
            if (daysLeft === null) return 'bg-secondary';
            if (daysLeft < 0) return 'bg-danger';
            if (daysLeft <= 7) return 'bg-warning';
            if (daysLeft <= 30) return 'bg-info';
            return 'bg-success';
        }

        function getDeliveryStatusBadge(deliveryStatus, errorCode) {
            if (!deliveryStatus) {
                return '<span class="badge bg-secondary" title="Delivery status pending">Pending</span>';
            }

            switch (deliveryStatus.toLowerCase()) {
                case 'delivered':
                    return '<span class="badge bg-success" title="Message delivered successfully"><i class="fas fa-check"></i> Delivered</span>';
                case 'sent':
                    return '<span class="badge bg-info" title="Message sent, delivery pending"><i class="fas fa-paper-plane"></i> Sent</span>';
                case 'queued':
                    return '<span class="badge bg-warning" title="Message queued for delivery"><i class="fas fa-clock"></i> Queued</span>';
                case 'failed':
                case 'undelivered':
                    const errorText = errorCode ? ` (Error: ${errorCode})` : '';
                    return `<span class="badge bg-danger" title="Message delivery failed${errorText}"><i class="fas fa-times"></i> Failed</span>`;
                case 'receiving':
                    return '<span class="badge bg-primary" title="Message being processed"><i class="fas fa-spinner"></i> Processing</span>';
                default:
                    return `<span class="badge bg-secondary" title="Status: ${deliveryStatus}">${deliveryStatus}</span>`;
            }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            try {
                const date = new Date(dateTimeString);
                return date.toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateTimeString;
            }
        }

        function filterSMSHistory() {
            const filter = document.getElementById('sms-history-filter').value.toLowerCase();
            const rows = document.querySelectorAll('#sms-history-list tbody tr');

            rows.forEach(row => {
                const registration = row.cells[1].textContent.toLowerCase();
                const customer = row.cells[2].textContent.toLowerCase();

                if (registration.includes(filter) || customer.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function checkDeliveryStatus() {
            try {
                showNotification('Checking delivery status...', 'info');

                const response = await fetch(`${API_BASE_URL}/mot/sms/check-delivery-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(
                        `Delivery status updated for ${result.updated_count} of ${result.total_checked} messages`,
                        'success'
                    );
                    // Refresh the SMS history to show updated statuses
                    loadSMSHistory();
                } else {
                    showNotification(`Error checking delivery status: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error checking delivery status:', error);
                showNotification('Error checking delivery status', 'error');
            }
        }

        function exportSMSHistory() {
            // This would export the SMS history to CSV
            showNotification('Export functionality coming soon', 'info');
        }

        // Archive Functions
        function toggleArchivedView() {
            showArchivedVehicles = !showArchivedVehicles;
            const toggleBtn = document.getElementById('archive-toggle-btn');
            const toggleText = document.getElementById('archive-toggle-text');

            if (showArchivedVehicles) {
                toggleText.textContent = 'Hide Archived';
                toggleBtn.classList.remove('btn-secondary');
                toggleBtn.classList.add('btn-warning');
            } else {
                toggleText.textContent = 'Show Archived';
                toggleBtn.classList.remove('btn-warning');
                toggleBtn.classList.add('btn-secondary');
            }

            loadMOTReminders();
        }

        async function archiveVehicle(registration) {
            if (!confirm(`Archive vehicle ${registration}?\n\nThis will remove it from the active MOT reminders list.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/mot/vehicles/${registration}/archive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reason: 'Manual archive'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`Vehicle ${registration} archived successfully`, 'success');
                    loadMOTReminders();
                } else {
                    showNotification(`Error archiving vehicle: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error archiving vehicle:', error);
                showNotification('Error archiving vehicle', 'error');
            }
        }

        async function unarchiveVehicle(registration) {
            if (!confirm(`Unarchive vehicle ${registration}?\n\nThis will return it to the active MOT reminders list.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/mot/vehicles/${registration}/unarchive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`Vehicle ${registration} unarchived successfully`, 'success');
                    loadMOTReminders();
                } else {
                    showNotification(`Error unarchiving vehicle: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error unarchiving vehicle:', error);
                showNotification('Error unarchiving vehicle', 'error');
            }
        }

        async function archiveSelectedVehicles() {
            if (selectedMOTVehicles.length === 0) {
                showNotification('No vehicles selected', 'warning');
                return;
            }

            const activeSelected = selectedMOTVehicles.filter(reg => {
                const vehicle = motVehicles.find(v => v.registration === reg);
                return vehicle && !vehicle.is_archived;
            });

            if (activeSelected.length === 0) {
                showNotification('No active vehicles selected for archiving', 'info');
                return;
            }

            if (!confirm(`Archive ${activeSelected.length} selected vehicles?\n\nThis will remove them from the active MOT reminders list.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/mot/vehicles/archive/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        registrations: activeSelected,
                        reason: 'Bulk archive - selected vehicles'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`${result.archived_count} vehicles archived successfully`, 'success');
                    selectedMOTVehicles = [];
                    updateSMSButtonState();
                    loadMOTReminders();
                } else {
                    showNotification(`Error archiving vehicles: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error archiving vehicles:', error);
                showNotification('Error archiving vehicles', 'error');
            }
        }

        // Link Existing Vehicles to Customers
        async function linkExistingVehicles() {
            if (!confirm('Link existing MOT vehicles to customer accounts?\n\nThis will:\nâ€¢ Match vehicles to existing customers\nâ€¢ Create new customer accounts where needed\nâ€¢ Enable customer view buttons\n\nContinue?')) {
                return;
            }

            try {
                showNotification('Linking vehicles to customers...', 'info');

                const response = await fetch('http://127.0.0.1:5002/api/mot/link-existing-vehicles', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    const message = `Customer linking completed!\n\n` +
                        `â€¢ ${result.linked_to_existing} vehicles linked to existing customers\n` +
                        `â€¢ ${result.created_new_customers} new customers created\n` +
                        `â€¢ ${result.total_processed - result.linked_to_existing - result.created_new_customers} vehicles skipped\n\n` +
                        `Customer view buttons are now available for linked vehicles.`;

                    showNotification(message, 'success');

                    // Refresh the MOT list to show customer buttons
                    loadMOTReminders();
                } else {
                    showNotification(`Error linking customers: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Error linking customers:', error);
                showNotification('Error linking customers to vehicles', 'error');
            }
        }

        // Customer Integration Functions
        async function viewCustomerDetails(customerId, registration) {
            try {
                // Get customer information from main database
                const customerResponse = await fetch(`/api/customers/${customerId}`);
                const customerData = await customerResponse.json();

                if (!customerData.success) {
                    showNotification('Error loading customer details', 'error');
                    return;
                }

                // Get MOT history for this customer
                const motHistoryResponse = await fetch(`http://127.0.0.1:5002/api/mot/customer/history/${customerId}`);
                const motHistoryData = await motHistoryResponse.json();

                // Show customer detail modal with MOT integration
                showCustomerDetailWithMOT(customerData.customer, motHistoryData.vehicles || [], registration);

            } catch (error) {
                console.error('Error loading customer details:', error);
                showNotification('Error loading customer details', 'error');
            }
        }

        function showCustomerDetailWithMOT(customer, motVehicles, highlightRegistration) {
            // Update customer detail modal title
            document.getElementById('customer-detail-title').textContent = `${customer.name} - Customer & MOT Details`;

            // Add MOT tab to existing customer modal
            const tabsHeader = document.querySelector('#customer-detail-modal .tabs-header');
            if (tabsHeader && !document.querySelector('.tab-button[onclick*="mot-history"]')) {
                const motTab = document.createElement('button');
                motTab.className = 'tab-button';
                motTab.onclick = () => showCustomerTab('mot-history');
                motTab.innerHTML = '<i class="fas fa-car"></i> MOT History';
                tabsHeader.appendChild(motTab);
            }

            // Add MOT tab content
            const tabsContainer = document.querySelector('#customer-detail-modal .tabs-container');
            if (tabsContainer && !document.getElementById('customer-tab-mot-history')) {
                const motTabContent = document.createElement('div');
                motTabContent.id = 'customer-tab-mot-history';
                motTabContent.className = 'tab-content';
                motTabContent.innerHTML = generateMOTHistoryContent(motVehicles, highlightRegistration);
                tabsContainer.appendChild(motTabContent);
            }

            // Show the customer detail modal
            document.getElementById('customer-detail-modal').classList.add('active');

            // Load customer data into the modal
            loadCustomerDetail(customer.id);

            // If we have a specific registration to highlight, switch to MOT tab
            if (highlightRegistration) {
                setTimeout(() => {
                    showCustomerTab('mot-history');
                }, 100);
            }
        }

        function generateMOTHistoryContent(motVehicles, highlightRegistration) {
            if (!motVehicles || motVehicles.length === 0) {
                return `
                    <div class="empty-state">
                        <i class="fas fa-car" style="font-size: 3rem; color: #dee2e6; margin-bottom: 1rem;"></i>
                        <h4>No MOT Data Found</h4>
                        <p>This customer has no vehicles in the MOT reminder system.</p>
                    </div>
                `;
            }

            return `
                <div class="mot-history-container">
                    <h4 style="margin-bottom: 1.5rem;">
                        <i class="fas fa-car"></i> Vehicle MOT History
                        <span class="badge bg-primary ms-2">${motVehicles.length} Vehicle${motVehicles.length !== 1 ? 's' : ''}</span>
                    </h4>

                    ${motVehicles.map(vehicle => {
                        const isHighlighted = vehicle.registration === highlightRegistration;
                        const motData = vehicle.mot_data;
                        const statusClass = motData ? (motData.is_expired ? 'danger' : motData.days_until_expiry <= 7 ? 'warning' : motData.days_until_expiry <= 30 ? 'info' : 'success') : 'secondary';

                        return `
                            <div class="vehicle-mot-card ${isHighlighted ? 'highlighted' : ''}" style="margin-bottom: 1.5rem; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; ${isHighlighted ? 'border-color: #0d6efd; box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);' : ''}">
                                <div class="vehicle-header" style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                    <div>
                                        <h5 style="margin: 0; color: #0d6efd;">
                                            ${vehicle.registration}
                                            ${isHighlighted ? '<i class="fas fa-star text-warning ms-2" title="Current vehicle"></i>' : ''}
                                        </h5>
                                        <p style="margin: 0; color: #6c757d;">${vehicle.make} ${vehicle.model}</p>
                                    </div>
                                    <div>
                                        ${motData ? `
                                            <span class="badge bg-${statusClass}">
                                                ${motData.is_expired ? 'EXPIRED' : motData.days_until_expiry <= 7 ? 'CRITICAL' : motData.days_until_expiry <= 30 ? 'DUE SOON' : 'VALID'}
                                            </span>
                                        ` : '<span class="badge bg-secondary">NO MOT DATA</span>'}
                                    </div>
                                </div>

                                ${motData ? `
                                    <div class="mot-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                        <div>
                                            <strong>MOT Expiry:</strong><br>
                                            <span style="color: ${motData.is_expired ? '#dc3545' : '#6c757d'};">
                                                ${formatDateForDisplay(motData.mot_expiry_date)}
                                            </span>
                                        </div>
                                        <div>
                                            <strong>Days Until Expiry:</strong><br>
                                            <span style="color: ${motData.is_expired ? '#dc3545' : motData.days_until_expiry <= 7 ? '#fd7e14' : '#6c757d'};">
                                                ${motData.days_until_expiry} days
                                            </span>
                                        </div>
                                        <div>
                                            <strong>Last Test:</strong><br>
                                            <span style="color: #6c757d;">
                                                ${formatDateForDisplay(motData.last_test_date)}
                                            </span>
                                        </div>
                                        <div>
                                            <strong>Test Result:</strong><br>
                                            <span style="color: #6c757d;">
                                                ${motData.test_result || 'Unknown'}
                                            </span>
                                        </div>
                                    </div>
                                ` : ''}

                                ${vehicle.sms_history && vehicle.sms_history.length > 0 ? `
                                    <div class="sms-history">
                                        <h6><i class="fas fa-sms"></i> SMS History</h6>
                                        <div class="sms-timeline">
                                            ${vehicle.sms_history.map(sms => `
                                                <div class="sms-entry" style="padding: 0.5rem; border-left: 3px solid #0d6efd; margin-left: 1rem; margin-bottom: 0.5rem; background: #f8f9fa;">
                                                    <div style="display: flex; justify-content: between; align-items: center;">
                                                        <span style="font-weight: 500;">${sms.message_type}</span>
                                                        <span style="font-size: 0.8rem; color: #6c757d;">
                                                            ${formatDateTime(sms.sent_at)}
                                                        </span>
                                                    </div>
                                                    <div style="font-size: 0.8rem; color: #6c757d;">
                                                        Status: ${sms.status} ${sms.delivery_status ? `| Delivery: ${sms.delivery_status}` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

    </script>
</body>
</html>

