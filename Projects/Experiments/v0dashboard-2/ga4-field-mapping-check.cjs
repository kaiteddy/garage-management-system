#!/usr/bin/env node

/**
 * üîß GA4 FIELD MAPPING CHECK
 * Check actual GA4 customer data with correct field names
 */

require('dotenv').config({ path: '.env.local' });
const fs = require('fs');
const path = require('path');

console.log('üîß GA4 FIELD MAPPING CHECK');
console.log('===========================');
console.log('‚è∞ Time:', new Date().toLocaleTimeString());
console.log('');

// Simple CSV parser
function parseCSV(content) {
  const lines = content.split('\n').filter(line => line.trim());
  if (lines.length === 0) return [];
  
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
  const records = [];
  
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
    if (values.length === headers.length) {
      const record = {};
      headers.forEach((header, index) => {
        record[header] = values[index];
      });
      records.push(record);
    }
  }
  
  return records;
}

async function checkGA4Fields() {
  try {
    console.log('1Ô∏è‚É£ ANALYZING GA4 CUSTOMER DATA WITH CORRECT FIELDS...');
    const ga4Path = '/Users/adamrutstein/Desktop/GA4 EXPORT';
    const customersPath = path.join(ga4Path, 'Customers.csv');
    
    if (!fs.existsSync(customersPath)) {
      console.log('‚ùå GA4 Customers.csv not found');
      return;
    }
    
    const content = fs.readFileSync(customersPath, 'utf-8');
    const ga4Records = parseCSV(content);
    
    console.log('üìä GA4 Customer analysis:');
    console.log(`   üìã Total records: ${ga4Records.length}`);
    console.log('');
    
    if (ga4Records.length > 0) {
      // Check actual field mapping
      const sampleRecord = ga4Records[0];
      console.log('üìä GA4 Field mapping:');
      console.log(`   üè∑Ô∏è  Name: nameforename="${sampleRecord.nameforename}", namesurname="${sampleRecord.namesurname}"`);
      console.log(`   üìß Email: contactemail="${sampleRecord.contactemail}"`);
      console.log(`   üì± Phone: contactmobile="${sampleRecord.contactmobile}", contacttelephone="${sampleRecord.contacttelephone}"`);
      console.log(`   üè† Address: addresshouseno="${sampleRecord.addresshouseno}", addressroad="${sampleRecord.addressroad}"`);
      console.log(`   üè¢ Company: namecompany="${sampleRecord.namecompany}"`);
      console.log('');
      
      // Analyze actual customer data quality
      let realEmails = 0;
      let realNames = 0;
      let realPhones = 0;
      let companies = 0;
      
      const customerSamples = [];
      
      ga4Records.forEach(record => {
        // Check email
        const email = record.contactemail || '';
        if (email && email.includes('@') && email.includes('.') && !email.includes('placeholder')) {
          realEmails++;
        }
        
        // Check name
        const firstName = record.nameforename || '';
        const lastName = record.namesurname || '';
        if (firstName && firstName.trim() !== '') {
          realNames++;
        }
        
        // Check phone
        const mobile = record.contactmobile || '';
        const telephone = record.contacttelephone || '';
        if (mobile || telephone) {
          realPhones++;
        }
        
        // Check company
        const company = record.namecompany || '';
        if (company && company.trim() !== '') {
          companies++;
        }
        
        // Collect samples
        if (customerSamples.length < 15 && (firstName || email || company)) {
          customerSamples.push({
            id: record._id,
            name: `${firstName} ${lastName}`.trim(),
            email: email,
            phone: mobile || telephone,
            company: company
          });
        }
      });
      
      console.log('üìä GA4 Customer data quality:');
      console.log(`   üìß Real emails: ${realEmails} (${((realEmails/ga4Records.length)*100).toFixed(1)}%)`);
      console.log(`   üë§ Real names: ${realNames} (${((realNames/ga4Records.length)*100).toFixed(1)}%)`);
      console.log(`   üì± Phone numbers: ${realPhones} (${((realPhones/ga4Records.length)*100).toFixed(1)}%)`);
      console.log(`   üè¢ Companies: ${companies} (${((companies/ga4Records.length)*100).toFixed(1)}%)`);
      console.log('');
      
      console.log('üë• Sample GA4 customers (with correct field mapping):');
      customerSamples.forEach((c, i) => {
        const displayName = c.name || c.company || 'Unknown';
        const displayEmail = c.email || 'No email';
        const displayPhone = c.phone || 'No phone';
        console.log(`   ${i+1}. ${displayName} - ${displayEmail} (${displayPhone}) [ID: ${c.id}]`);
      });
      console.log('');
      
      console.log('2Ô∏è‚É£ FIELD MAPPING SOLUTION...');
      console.log('=============================');
      console.log('');
      console.log('üîß CORRECT FIELD MAPPING:');
      console.log('   Database ‚Üí GA4');
      console.log('   first_name ‚Üí nameforename');
      console.log('   last_name ‚Üí namesurname');
      console.log('   email ‚Üí contactemail');
      console.log('   phone ‚Üí contactmobile OR contacttelephone');
      console.log('   company ‚Üí namecompany');
      console.log('');
      
      console.log('üìä IMPORT POTENTIAL:');
      if (realEmails > 100) {
        console.log(`   ‚úÖ ${realEmails} customers with real emails - WORTH IMPORTING`);
      } else {
        console.log(`   ‚ö†Ô∏è  Only ${realEmails} customers with real emails - LIMITED VALUE`);
      }
      
      if (realNames > 1000) {
        console.log(`   ‚úÖ ${realNames} customers with real names - GOOD DATA QUALITY`);
      } else {
        console.log(`   ‚ö†Ô∏è  Only ${realNames} customers with real names - POOR DATA QUALITY`);
      }
      
      console.log('');
      console.log('üí° RECOMMENDATION:');
      
      if (realEmails > 100 && realNames > 1000) {
        console.log('   ‚úÖ PROCEED with customer import using correct field mapping');
        console.log('   ‚úÖ Will add significant real customer data');
        console.log('   ‚úÖ Use contactemail for deduplication');
      } else if (realNames > 1000) {
        console.log('   ‚ö†Ô∏è  PROCEED with caution - good names but few emails');
        console.log('   ‚ö†Ô∏è  Consider importing for name/phone data only');
      } else {
        console.log('   ‚ùå SKIP customer import - poor data quality');
        console.log('   ‚ùå Focus on documents and line items instead');
      }
    }
    
    console.log('');
    console.log('‚úÖ GA4 FIELD MAPPING CHECK COMPLETE');
    
  } catch (error) {
    console.log('‚ùå GA4 FIELD MAPPING CHECK FAILED:', error.message);
  }
}

checkGA4Fields();
