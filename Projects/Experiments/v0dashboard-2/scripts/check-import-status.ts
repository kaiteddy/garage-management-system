#!/usr/bin/env ts-node

import { Pool } from 'pg';
import * as dotenv from 'dotenv';
import * as path from 'path';

// Load environment variables
dotenv.config({ path: path.resolve(process.cwd(), '.env.local') });

async function checkImportStatus() {
  const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: { rejectUnauthorized: false },
  });

  const client = await pool.connect();
  
  try {
    console.log('üéâ FINAL IMPORT STATUS REPORT');
    console.log('================================\n');

    // Count all records
    const customers = await client.query('SELECT COUNT(*) FROM customers');
    const vehicles = await client.query('SELECT COUNT(*) FROM vehicles');
    const documents = await client.query('SELECT COUNT(*) FROM documents');
    
    console.log('üìä TOTAL RECORDS:');
    console.log(`üë§ Customers: ${customers.rows[0].count}`);
    console.log(`üöó Vehicles: ${vehicles.rows[0].count}`);
    console.log(`üìÑ Documents: ${documents.rows[0].count}`);
    console.log(`üìà TOTAL: ${parseInt(customers.rows[0].count) + parseInt(vehicles.rows[0].count) + parseInt(documents.rows[0].count)} records\n`);
    
    // Check customer-vehicle links
    const linkedVehicles = await client.query('SELECT COUNT(*) FROM vehicles WHERE customer_id IS NOT NULL');
    const unlinkedVehicles = await client.query('SELECT COUNT(*) FROM vehicles WHERE customer_id IS NULL');
    
    console.log('üîó CUSTOMER-VEHICLE RELATIONSHIPS:');
    console.log(`‚úÖ Linked vehicles: ${linkedVehicles.rows[0].count}`);
    console.log(`‚ö™ Unlinked vehicles: ${unlinkedVehicles.rows[0].count}`);
    console.log(`üìä Link rate: ${Math.round((parseInt(linkedVehicles.rows[0].count) / parseInt(vehicles.rows[0].count)) * 100)}%\n`);
    
    // Check recent additions (last 24 hours)
    const recentCustomers = await client.query("SELECT COUNT(*) FROM customers WHERE created_at > NOW() - INTERVAL '24 hours'");
    const recentVehicles = await client.query("SELECT COUNT(*) FROM vehicles WHERE created_at > NOW() - INTERVAL '24 hours'");
    const recentDocuments = await client.query("SELECT COUNT(*) FROM documents WHERE created_at > NOW() - INTERVAL '24 hours'");
    
    console.log('üÜï RECENT ADDITIONS (Last 24 hours):');
    console.log(`üë§ New customers: ${recentCustomers.rows[0].count}`);
    console.log(`üöó New vehicles: ${recentVehicles.rows[0].count}`);
    console.log(`üìÑ New documents: ${recentDocuments.rows[0].count}\n`);
    
    // Sample some data
    const sampleCustomers = await client.query('SELECT first_name, last_name, email FROM customers ORDER BY created_at DESC LIMIT 3');
    const sampleVehicles = await client.query('SELECT registration, make, model, customer_id FROM vehicles WHERE customer_id IS NOT NULL ORDER BY created_at DESC LIMIT 3');
    
    console.log('üìù SAMPLE DATA:');
    console.log('Recent customers:');
    sampleCustomers.rows.forEach((customer, i) => {
      console.log(`  ${i + 1}. ${customer.first_name} ${customer.last_name} (${customer.email})`);
    });
    
    console.log('\nRecent linked vehicles:');
    sampleVehicles.rows.forEach((vehicle, i) => {
      console.log(`  ${i + 1}. ${vehicle.registration} - ${vehicle.make} ${vehicle.model} (Customer: ${vehicle.customer_id})`);
    });
    
    console.log('\n‚úÖ Import appears to be successful!');
    console.log('üí° APIs will continue to enhance records with additional data as needed.');

  } catch (error: any) {
    console.error('‚ùå Error checking status:', error.message);
  } finally {
    client.release();
    await pool.end();
  }
}

// Run the status check
checkImportStatus().catch(console.error);
