#!/usr/bin/env node

/**
 * üîß MANUAL SAFE IMPORT
 * Ultra-conservative import - 1 customer at a time with immediate feedback
 * Run this directly in your terminal for instant results
 */

require('dotenv').config({ path: '.env.local' });
const { neon } = require('@neondatabase/serverless');
const fs = require('fs');
const path = require('path');

console.log('üîß MANUAL SAFE IMPORT');
console.log('=====================');
console.log('‚ö° Processing 1 customer at a time with immediate feedback');
console.log('‚è∞ Start:', new Date().toLocaleTimeString());

// Simple CSV parser
function parseCSV(content) {
  const lines = content.split('\n').filter(line => line.trim());
  if (lines.length === 0) return [];
  
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
  const records = [];
  
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
    if (values.length === headers.length) {
      const record = {};
      headers.forEach((header, index) => {
        record[header] = values[index];
      });
      records.push(record);
    }
  }
  
  return records;
}

async function manualSafeImport() {
  try {
    console.log('1Ô∏è‚É£ Testing database connection...');
    
    const sql = neon(process.env.DATABASE_URL, {
      connectionTimeoutMillis: 5000,
      queryTimeoutMillis: 8000
    });
    
    // Test connection
    const testResult = await sql`SELECT COUNT(*) as count FROM customers`;
    console.log(`‚úÖ Database connected. Current customers: ${testResult[0].count}`);
    console.log('');
    
    console.log('2Ô∏è‚É£ Loading existing customer IDs...');
    const existingCustomers = await sql`SELECT id FROM customers`;
    const existingIds = new Set(existingCustomers.map(c => c.id));
    console.log(`‚úÖ Loaded ${existingIds.size} existing customer IDs`);
    console.log('');
    
    console.log('3Ô∏è‚É£ Loading GA4 customer data...');
    const ga4Path = '/Users/adamrutstein/Desktop/GA4 EXPORT';
    const customersPath = path.join(ga4Path, 'Customers.csv');
    
    if (!fs.existsSync(customersPath)) {
      console.log('‚ùå Customers.csv not found at:', customersPath);
      return;
    }
    
    const content = fs.readFileSync(customersPath, 'utf-8');
    const allCustomers = parseCSV(content);
    console.log(`‚úÖ Loaded ${allCustomers.length} GA4 customers`);
    
    // Filter for new customers
    const newCustomers = allCustomers.filter(record => {
      const id = record._id;
      const firstName = record.nameforename || 'Unknown';
      
      return id && 
             !existingIds.has(id) && 
             firstName && 
             firstName !== 'Unknown';
    });
    
    console.log(`‚úÖ Found ${newCustomers.length} new customers to import`);
    console.log('');
    
    if (newCustomers.length === 0) {
      console.log('üéâ All customers already imported!');
      return;
    }
    
    console.log('4Ô∏è‚É£ MANUAL IMPORT PROCESS (First 20 customers)...');
    console.log('================================================');
    
    // Import first 20 customers only (ultra-safe)
    const customersToImport = newCustomers.slice(0, 20);
    let imported = 0;
    let errors = 0;
    
    for (let i = 0; i < customersToImport.length; i++) {
      const customer = customersToImport[i];
      
      try {
        console.log(`üîÑ Importing customer ${i + 1}/20: ${customer.nameforename} ${customer.namesurname || ''}...`);
        
        const id = customer._id;
        const firstName = customer.nameforename;
        const lastName = customer.namesurname || '';
        const email = customer.contactemail || '';
        const phone = customer.contactmobile || customer.contacttelephone || null;
        
        // Build address
        const addressParts = [customer.addresshouseno, customer.addressroad].filter(p => p && p.trim());
        const addressLine1 = addressParts.join(' ').trim() || null;
        const city = customer.addresstown || null;
        const postcode = customer.addresspostcode || null;
        
        await sql`
          INSERT INTO customers (
            id, first_name, last_name, email, phone, 
            address_line1, city, postcode, created_at, updated_at
          )
          VALUES (
            ${id}, ${firstName}, ${lastName}, ${email}, ${phone},
            ${addressLine1}, ${city}, ${postcode}, NOW(), NOW()
          )
        `;
        
        imported++;
        console.log(`   ‚úÖ Success! Customer ${firstName} ${lastName} imported`);
        
        // Small pause between customers
        await new Promise(resolve => setTimeout(resolve, 500));
        
      } catch (error) {
        errors++;
        console.log(`   ‚ùå Error importing ${customer.nameforename}: ${error.message.substring(0, 60)}`);
      }
    }
    
    console.log('');
    console.log('5Ô∏è‚É£ FINAL VERIFICATION...');
    console.log('=========================');
    
    const finalCount = await sql`SELECT COUNT(*) as count FROM customers`;
    const customersAdded = finalCount[0].count - testResult[0].count;
    
    console.log('üìä MANUAL IMPORT RESULTS:');
    console.log(`   üë• Starting customers: ${testResult[0].count}`);
    console.log(`   üë• Final customers: ${finalCount[0].count}`);
    console.log(`   üìà Customers added: ${customersAdded}`);
    console.log(`   ‚úÖ Successful imports: ${imported}`);
    console.log(`   ‚ùå Errors: ${errors}`);
    console.log('');
    
    if (imported > 0) {
      console.log('üéâ MANUAL IMPORT SUCCESS!');
      console.log('=========================');
      console.log('‚úÖ Customers imported safely');
      console.log('‚úÖ Database remained responsive');
      console.log('‚úÖ No lockups occurred');
      
      const remaining = newCustomers.length - 20;
      if (remaining > 0) {
        console.log('');
        console.log('üí° NEXT STEPS:');
        console.log(`   üìä ${remaining} customers remaining`);
        console.log('   üîÑ Run this script again to import next 20');
        console.log('   ‚ö° Each run is safe and adds more data');
      }
    }
    
    console.log('');
    console.log('üîß MANUAL SAFE IMPORT COMPLETE!');
    
  } catch (error) {
    console.log('‚ùå MANUAL IMPORT ERROR:', error.message);
    console.log('üîç Full error:', error.stack);
  }
}

// Execute manual import
manualSafeImport();
