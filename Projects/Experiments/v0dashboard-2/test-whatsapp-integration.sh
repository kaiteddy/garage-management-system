#!/bin/bash

echo "üß™ TESTING WHATSAPP INTEGRATION"
echo "==============================="
echo ""

# Configuration
PRODUCTION_URL="https://garagemanagerpro.vercel.app"
WHATSAPP_SENDER="+15558340240"
TWILIO_SANDBOX="+14155238886"

echo "üì± WhatsApp Sender: $WHATSAPP_SENDER"
echo "üåê Production URL: $PRODUCTION_URL"
echo "üìû Twilio Sandbox: $TWILIO_SANDBOX"
echo ""

echo "üîç STEP 1: TESTING WEBHOOK ENDPOINTS"
echo "====================================="

# Test webhook endpoints
echo "Testing Voice webhook..."
VOICE_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" "$PRODUCTION_URL/api/voice/webhook")
VOICE_CODE=$(echo "$VOICE_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
echo "‚úÖ Voice webhook: HTTP $VOICE_CODE"

echo "Testing SMS/WhatsApp webhook..."
SMS_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" "$PRODUCTION_URL/api/webhooks/communication-responses")
SMS_CODE=$(echo "$SMS_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
echo "‚úÖ SMS/WhatsApp webhook: HTTP $SMS_CODE"

echo "Testing Status callback..."
STATUS_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" "$PRODUCTION_URL/api/webhooks/status-callback")
STATUS_CODE=$(echo "$STATUS_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
echo "‚úÖ Status callback: HTTP $STATUS_CODE"

echo ""
echo "üîß STEP 2: TESTING TWILIO CONFIGURATION API"
echo "============================================"

echo "Testing Twilio webhook configuration endpoint..."
CONFIG_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" -X POST "$PRODUCTION_URL/api/twilio/configure-webhooks" \
  -H "Content-Type: application/json" \
  -d "{
    \"phoneNumber\": \"$WHATSAPP_SENDER\",
    \"baseUrl\": \"$PRODUCTION_URL\",
    \"updateSMS\": true,
    \"updateVoice\": true,
    \"updateStatusCallback\": true
  }")

CONFIG_CODE=$(echo "$CONFIG_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
echo "‚úÖ Webhook configuration: HTTP $CONFIG_CODE"

if [ "$CONFIG_CODE" = "200" ]; then
    echo "üéâ Webhook configuration successful!"
else
    echo "‚ö†Ô∏è  Webhook configuration may have issues (HTTP $CONFIG_CODE)"
fi

echo ""
echo "üì± STEP 3: WHATSAPP SANDBOX VERIFICATION"
echo "========================================"

echo "Testing WhatsApp sandbox webhook..."
SANDBOX_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" -X POST "$PRODUCTION_URL/api/webhooks/communication-responses" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "From=whatsapp:$TWILIO_SANDBOX&To=whatsapp:$WHATSAPP_SENDER&Body=test message")

SANDBOX_CODE=$(echo "$SANDBOX_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
echo "‚úÖ WhatsApp sandbox test: HTTP $SANDBOX_CODE"

echo ""
echo "üìã STEP 4: CONFIGURATION SUMMARY"
echo "================================="
echo "üó£Ô∏è  Voice URL: $PRODUCTION_URL/api/voice/webhook"
echo "üí¨ SMS URL: $PRODUCTION_URL/api/webhooks/communication-responses"
echo "üì± WhatsApp URL: $PRODUCTION_URL/api/webhooks/communication-responses"
echo "üìä Status Callback: $PRODUCTION_URL/api/webhooks/status-callback"
echo ""

echo "üéØ STEP 5: MANUAL VERIFICATION CHECKLIST"
echo "========================================"
echo "Please verify the following manually:"
echo ""
echo "1. üìû TWILIO PHONE NUMBER CONFIGURATION:"
echo "   https://console.twilio.com/us1/develop/phone-numbers/manage/incoming"
echo "   ‚Ä¢ Click on: $WHATSAPP_SENDER"
echo "   ‚Ä¢ Voice URL should be: $PRODUCTION_URL/api/voice/webhook"
echo "   ‚Ä¢ SMS URL should be: $PRODUCTION_URL/api/webhooks/communication-responses"
echo "   ‚Ä¢ Status Callback should be: $PRODUCTION_URL/api/webhooks/status-callback"
echo ""
echo "2. üì± WHATSAPP SANDBOX CONFIGURATION:"
echo "   https://console.twilio.com/us1/develop/sms/whatsapp/sandbox"
echo "   ‚Ä¢ Webhook URL should be: $PRODUCTION_URL/api/webhooks/communication-responses"
echo "   ‚Ä¢ HTTP method should be: POST"
echo ""
echo "3. üîê ENVIRONMENT VARIABLES (Vercel Dashboard):"
echo "   ‚Ä¢ TWILIO_ACCOUNT_SID=AC1572c0e5e4b55bb7440c3d9da482fd36"
echo "   ‚Ä¢ TWILIO_AUTH_TOKEN=[Your auth token]"
echo "   ‚Ä¢ TWILIO_PHONE_NUMBER=$WHATSAPP_SENDER"
echo "   ‚Ä¢ TWILIO_WHATSAPP_NUMBER=whatsapp:$WHATSAPP_SENDER"
echo ""

echo "üß™ STEP 6: LIVE TESTING INSTRUCTIONS"
echo "===================================="
echo "To test WhatsApp functionality:"
echo ""
echo "1. Join WhatsApp Sandbox:"
echo "   ‚Ä¢ Send 'join <sandbox-code>' to whatsapp:$TWILIO_SANDBOX"
echo "   ‚Ä¢ Get the sandbox code from: https://console.twilio.com/us1/develop/sms/whatsapp/sandbox"
echo ""
echo "2. Send Test Message:"
echo "   ‚Ä¢ Send any message to whatsapp:$TWILIO_SANDBOX"
echo "   ‚Ä¢ Check application logs for webhook reception"
echo ""
echo "3. Test MOT Reminders:"
echo "   ‚Ä¢ Visit: $PRODUCTION_URL/mot-reminders-sms"
echo "   ‚Ä¢ Send a test MOT reminder"
echo ""

echo "‚úÖ INTEGRATION TEST COMPLETE!"
echo ""
echo "üìä RESULTS SUMMARY:"
echo "==================="
echo "Voice webhook: HTTP $VOICE_CODE"
echo "SMS/WhatsApp webhook: HTTP $SMS_CODE"
echo "Status callback: HTTP $STATUS_CODE"
echo "Configuration API: HTTP $CONFIG_CODE"
echo "Sandbox test: HTTP $SANDBOX_CODE"
echo ""
echo "üì± WhatsApp Sender Number: $WHATSAPP_SENDER"
echo "üåê Production URL: $PRODUCTION_URL"
