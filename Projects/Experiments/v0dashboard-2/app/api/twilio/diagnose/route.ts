import { NextResponse } from "next/server"
import twilio from 'twilio'

export async function GET() {
  try {
    console.log("[TWILIO-DIAGNOSE] Running comprehensive Twilio diagnostics...")
    
    const accountSid = process.env.TWILIO_ACCOUNT_SID
    const authToken = process.env.TWILIO_AUTH_TOKEN
    const phoneNumber = process.env.TWILIO_PHONE_NUMBER
    const whatsappNumber = process.env.TWILIO_WHATSAPP_NUMBER
    
    const diagnostics = {
      timestamp: new Date().toISOString(),
      environment: {
        nodeEnv: process.env.NODE_ENV,
        vercelUrl: process.env.VERCEL_URL,
        publicAppUrl: process.env.NEXT_PUBLIC_APP_URL
      },
      credentials: {
        accountSid: accountSid ? `‚úÖ Set (${accountSid.substring(0, 8)}...)` : '‚ùå Missing',
        authToken: authToken ? '‚úÖ Set (hidden)' : '‚ùå Missing',
        phoneNumber: phoneNumber || '‚ùå Missing',
        whatsappNumber: whatsappNumber || '‚ùå Missing'
      },
      connection: null,
      phoneNumberDetails: null,
      webhookStatus: null,
      recommendations: [],
      errors: []
    }
    
    // Determine base URL
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 
                   process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` :
                   'https://garagemanagerpro.vercel.app'
    
    diagnostics.environment.detectedBaseUrl = baseUrl
    
    // Test Twilio connection
    if (accountSid && authToken) {
      try {
        const client = twilio(accountSid, authToken)
        
        // Test account access
        const account = await client.api.accounts(accountSid).fetch()
        diagnostics.connection = {
          status: '‚úÖ Connected',
          accountStatus: account.status,
          accountType: account.type,
          friendlyName: account.friendlyName
        }
        
        // Get phone number details
        if (phoneNumber) {
          try {
            const phoneNumbers = await client.incomingPhoneNumbers.list({
              phoneNumber: phoneNumber,
              limit: 1
            })
            
            if (phoneNumbers.length > 0) {
              const phone = phoneNumbers[0]
              diagnostics.phoneNumberDetails = {
                sid: phone.sid,
                phoneNumber: phone.phoneNumber,
                friendlyName: phone.friendlyName,
                capabilities: phone.capabilities,
                voiceUrl: phone.voiceUrl,
                voiceMethod: phone.voiceMethod,
                smsUrl: phone.smsUrl,
                smsMethod: phone.smsMethod,
                statusCallback: phone.statusCallback,
                statusCallbackMethod: phone.statusCallbackMethod
              }
              
              // Check webhook configuration
              const expectedWebhooks = {
                voice: `${baseUrl}/api/twilio/voice`,
                sms: `${baseUrl}/api/sms/webhook`,
                statusCallback: `${baseUrl}/api/twilio/status-callback`
              }
              
              diagnostics.webhookStatus = {
                expected: expectedWebhooks,
                current: {
                  voice: phone.voiceUrl,
                  sms: phone.smsUrl,
                  statusCallback: phone.statusCallback
                },
                matches: {
                  voice: phone.voiceUrl === expectedWebhooks.voice,
                  sms: phone.smsUrl === expectedWebhooks.sms,
                  statusCallback: phone.statusCallback === expectedWebhooks.statusCallback
                }
              }
              
              // Generate recommendations
              if (!diagnostics.webhookStatus.matches.voice) {
                diagnostics.recommendations.push(`üîß Voice webhook needs update: ${phone.voiceUrl} ‚Üí ${expectedWebhooks.voice}`)
              }
              if (!diagnostics.webhookStatus.matches.sms) {
                diagnostics.recommendations.push(`üîß SMS webhook needs update: ${phone.smsUrl} ‚Üí ${expectedWebhooks.sms}`)
              }
              if (!diagnostics.webhookStatus.matches.statusCallback) {
                diagnostics.recommendations.push(`üîß Status callback needs update: ${phone.statusCallback} ‚Üí ${expectedWebhooks.statusCallback}`)
              }
              
              if (diagnostics.recommendations.length === 0) {
                diagnostics.recommendations.push('‚úÖ All webhooks are correctly configured!')
              }
              
            } else {
              diagnostics.errors.push(`‚ùå Phone number ${phoneNumber} not found in Twilio account`)
              diagnostics.recommendations.push('üìû Verify phone number is correct and exists in your Twilio account')
            }
          } catch (error) {
            diagnostics.errors.push(`‚ùå Error fetching phone number details: ${error instanceof Error ? error.message : 'Unknown error'}`)
          }
        } else {
          diagnostics.recommendations.push('üìû Configure TWILIO_PHONE_NUMBER environment variable')
        }
        
        // Test recent messages
        try {
          const recentMessages = await client.messages.list({
            limit: 5,
            dateSentAfter: new Date(Date.now() - 24 * 60 * 60 * 1000) // Last 24 hours
          })
          
          diagnostics.recentActivity = {
            messageCount: recentMessages.length,
            messages: recentMessages.map(msg => ({
              sid: msg.sid,
              from: msg.from,
              to: msg.to,
              status: msg.status,
              direction: msg.direction,
              dateSent: msg.dateSent
            }))
          }
        } catch (error) {
          diagnostics.errors.push(`‚ö†Ô∏è Could not fetch recent messages: ${error instanceof Error ? error.message : 'Unknown error'}`)
        }
        
      } catch (error) {
        diagnostics.connection = {
          status: '‚ùå Connection failed',
          error: error instanceof Error ? error.message : 'Unknown error'
        }
        diagnostics.errors.push(`‚ùå Twilio connection failed: ${error instanceof Error ? error.message : 'Unknown error'}`)
        diagnostics.recommendations.push('üîê Verify TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN are correct')
      }
    } else {
      diagnostics.connection = {
        status: '‚ùå No credentials'
      }
      diagnostics.recommendations.push('üîê Configure TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN environment variables')
    }
    
    // Environment-specific recommendations
    if (process.env.NODE_ENV === 'development') {
      diagnostics.recommendations.push('üöÄ For production deployment, ensure environment variables are set in Vercel')
    }
    
    if (!process.env.NEXT_PUBLIC_APP_URL && !process.env.VERCEL_URL) {
      diagnostics.recommendations.push('üåê Set NEXT_PUBLIC_APP_URL for consistent webhook URLs')
    }
    
    return NextResponse.json({
      success: true,
      diagnostics: diagnostics
    })
    
  } catch (error) {
    console.error('[TWILIO-DIAGNOSE] Error:', error)
    
    return NextResponse.json({
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
      timestamp: new Date().toISOString()
    }, { status: 500 })
  }
}
