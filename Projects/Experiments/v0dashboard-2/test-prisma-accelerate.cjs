#!/usr/bin/env node

/**
 * üß™ PRISMA ACCELERATE CONNECTION TEST
 * Simple test to verify Prisma Accelerate is working
 */

require('dotenv').config({ path: '.env.local' });

console.log('üß™ PRISMA ACCELERATE CONNECTION TEST');
console.log('====================================');
console.log('‚è∞ Start:', new Date().toLocaleTimeString());

async function testPrismaAccelerate() {
  try {
    console.log('1Ô∏è‚É£ Checking environment variables...');
    
    const dbUrl = process.env.DATABASE_URL;
    if (!dbUrl) {
      console.log('‚ùå DATABASE_URL not found');
      return;
    }
    
    if (dbUrl.startsWith('prisma+postgres://accelerate.prisma-data.net/')) {
      console.log('‚úÖ Prisma Accelerate URL detected');
    } else {
      console.log('‚ö†Ô∏è  Not using Prisma Accelerate URL');
      console.log('   Current URL:', dbUrl.substring(0, 50) + '...');
    }
    
    console.log('');
    console.log('2Ô∏è‚É£ Testing basic connection...');
    
    // Import Prisma Client
    const { PrismaClient } = require('@prisma/client');
    
    const prisma = new PrismaClient({
      datasourceUrl: process.env.DATABASE_URL,
      log: ['error', 'warn']
    });
    
    console.log('‚úÖ Prisma Client created');
    
    console.log('');
    console.log('3Ô∏è‚É£ Testing database query...');
    
    const start = Date.now();
    const result = await prisma.$queryRaw`SELECT COUNT(*) as customers FROM customers`;
    const queryTime = Date.now() - start;
    
    console.log(`‚úÖ Query successful in ${queryTime}ms`);
    console.log(`üë• Current customers: ${result[0].customers}`);
    
    console.log('');
    console.log('4Ô∏è‚É£ Testing Prisma model query...');
    
    const modelStart = Date.now();
    const customerCount = await prisma.customer.count();
    const modelTime = Date.now() - modelStart;
    
    console.log(`‚úÖ Model query successful in ${modelTime}ms`);
    console.log(`üë• Customer count via model: ${customerCount}`);
    
    await prisma.$disconnect();
    
    console.log('');
    console.log('‚úÖ PRISMA ACCELERATE TEST SUCCESSFUL!');
    console.log('=====================================');
    console.log('üöÄ Connection: Working');
    console.log('üöÄ Queries: Fast and reliable');
    console.log('üöÄ Ready for GA4 import');
    
  } catch (error) {
    console.log('‚ùå PRISMA ACCELERATE TEST FAILED');
    console.log('=================================');
    console.log('Error:', error.message);
    
    if (error.message.includes('timeout')) {
      console.log('üí° Connection timeout - Check Accelerate API key');
    } else if (error.message.includes('authentication')) {
      console.log('üí° Authentication failed - Verify API key');
    } else if (error.message.includes('relation') || error.message.includes('table')) {
      console.log('üí° Schema mismatch - Run prisma db push');
    } else {
      console.log('üí° Unexpected error - Check configuration');
    }
  }
}

testPrismaAccelerate();
