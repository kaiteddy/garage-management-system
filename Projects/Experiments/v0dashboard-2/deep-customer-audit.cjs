#!/usr/bin/env node

/**
 * üîç DEEP CUSTOMER AUDIT
 * Comprehensive investigation of missing customers
 */

require('dotenv').config({ path: '.env.local' });
const { neon } = require('@neondatabase/serverless');
const fs = require('fs');
const path = require('path');

console.log('üîç DEEP CUSTOMER AUDIT');
console.log('=======================');
console.log('‚è∞ Time:', new Date().toLocaleTimeString());
console.log('');

// Simple CSV parser
function parseCSV(content) {
  const lines = content.split('\n').filter(line => line.trim());
  if (lines.length === 0) return [];
  
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
  const records = [];
  
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
    if (values.length === headers.length) {
      const record = {};
      headers.forEach((header, index) => {
        record[header] = values[index];
      });
      records.push(record);
    }
  }
  
  return records;
}

async function deepCustomerAudit() {
  try {
    console.log('1Ô∏è‚É£ CONNECTING TO DATABASE...');
    const sql = neon(process.env.DATABASE_URL, {
      connectionTimeoutMillis: 30000,
      queryTimeoutMillis: 120000
    });
    
    await sql`SELECT 1`;
    console.log('‚úÖ Database connected');
    console.log('');
    
    console.log('2Ô∏è‚É£ COMPREHENSIVE DATABASE ANALYSIS...');
    
    // Check vehicle-customer relationships
    const vehicleCustomerStats = await sql`
      SELECT 
        COUNT(*) as total_vehicles,
        COUNT(DISTINCT customer_id) as unique_customer_ids,
        COUNT(CASE WHEN customer_id IS NOT NULL THEN 1 END) as vehicles_with_customers,
        COUNT(CASE WHEN customer_id IS NULL THEN 1 END) as vehicles_without_customers
      FROM vehicles
    `;
    
    const vcs = vehicleCustomerStats[0];
    console.log('üöó Vehicle-Customer Relationship Analysis:');
    console.log(`   Total vehicles: ${vcs.total_vehicles}`);
    console.log(`   Unique customer IDs: ${vcs.unique_customer_ids}`);
    console.log(`   Vehicles with customers: ${vcs.vehicles_with_customers}`);
    console.log(`   Vehicles without customers: ${vcs.vehicles_without_customers}`);
    console.log('');
    
    // Check document-customer relationships
    const docCustomerStats = await sql`
      SELECT 
        COUNT(*) as total_documents,
        COUNT(DISTINCT customer_id) as unique_customer_ids,
        COUNT(CASE WHEN customer_id IS NOT NULL THEN 1 END) as docs_with_customers,
        COUNT(CASE WHEN customer_id IS NULL THEN 1 END) as docs_without_customers
      FROM customer_documents
    `;
    
    const dcs = docCustomerStats[0];
    console.log('üìÑ Document-Customer Relationship Analysis:');
    console.log(`   Total documents: ${dcs.total_documents}`);
    console.log(`   Unique customer IDs: ${dcs.unique_customer_ids}`);
    console.log(`   Documents with customers: ${dcs.docs_with_customers}`);
    console.log(`   Documents without customers: ${dcs.docs_without_customers}`);
    console.log('');
    
    // Check if customer IDs exist in customers table
    const orphanedCustomerIds = await sql`
      SELECT DISTINCT v.customer_id, COUNT(*) as vehicle_count
      FROM vehicles v
      LEFT JOIN customers c ON v.customer_id = c.id::text
      WHERE v.customer_id IS NOT NULL 
        AND c.id IS NULL
      GROUP BY v.customer_id
      ORDER BY vehicle_count DESC
      LIMIT 20
    `;
    
    console.log('üîç Orphaned Customer IDs (vehicles point to non-existent customers):');
    if (orphanedCustomerIds.length > 0) {
      orphanedCustomerIds.forEach((row, i) => {
        console.log(`   ${i+1}. Customer ID: ${row.customer_id} (${row.vehicle_count} vehicles)`);
      });
    } else {
      console.log('   ‚úÖ No orphaned customer IDs found');
    }
    console.log('');
    
    // Check customer table structure and data
    const customerSample = await sql`
      SELECT id, first_name, last_name, email, phone, created_at
      FROM customers
      ORDER BY created_at DESC
      LIMIT 20
    `;
    
    console.log('üë• Customer Table Sample (most recent):');
    customerSample.forEach((c, i) => {
      const name = `${c.first_name || 'Unknown'} ${c.last_name || ''}`.trim();
      const email = c.email || 'No email';
      console.log(`   ${i+1}. ID: ${c.id} - ${name} - ${email}`);
    });
    console.log('');
    
    console.log('3Ô∏è‚É£ ANALYZING ALL GA4 FILES FOR CUSTOMER REFERENCES...');
    const ga4Path = '/Users/adamrutstein/Desktop/GA4 EXPORT';
    
    if (!fs.existsSync(ga4Path)) {
      console.log('‚ùå GA4 Export folder not found');
      return;
    }
    
    const files = fs.readdirSync(ga4Path).filter(f => f.endsWith('.csv'));
    console.log(`üìÅ Found ${files.length} GA4 files to analyze`);
    console.log('');
    
    // Analyze each file for customer references
    const customerIdSets = {};
    
    for (const filename of files) {
      const filePath = path.join(ga4Path, filename);
      console.log(`üìÑ Analyzing ${filename}...`);
      
      try {
        const content = fs.readFileSync(filePath, 'utf-8');
        const records = parseCSV(content);
        
        console.log(`   üìã Records: ${records.length}`);
        
        if (records.length > 0) {
          const sampleRecord = records[0];
          const customerFields = Object.keys(sampleRecord).filter(key => 
            key.includes('customer') || key.includes('_id_customer')
          );
          
          if (customerFields.length > 0) {
            console.log(`   üîó Customer reference fields: ${customerFields.join(', ')}`);
            
            // Collect unique customer IDs
            const uniqueCustomerIds = new Set();
            records.forEach(record => {
              customerFields.forEach(field => {
                const customerId = record[field];
                if (customerId && customerId.trim() !== '') {
                  uniqueCustomerIds.add(customerId);
                }
              });
            });
            
            customerIdSets[filename] = uniqueCustomerIds;
            console.log(`   üë• Unique customer IDs: ${uniqueCustomerIds.size}`);
            
            // Show sample customer IDs
            const sampleIds = Array.from(uniqueCustomerIds).slice(0, 5);
            console.log(`   üìä Sample IDs: ${sampleIds.join(', ')}`);
          } else {
            console.log(`   ‚ö†Ô∏è  No customer reference fields found`);
          }
        }
        
      } catch (error) {
        console.log(`   ‚ùå Error reading ${filename}: ${error.message}`);
      }
      
      console.log('');
    }
    
    console.log('4Ô∏è‚É£ CUSTOMER ID CROSS-REFERENCE ANALYSIS...');
    
    // Find all unique customer IDs across all files
    const allCustomerIds = new Set();
    Object.values(customerIdSets).forEach(idSet => {
      idSet.forEach(id => allCustomerIds.add(id));
    });
    
    console.log(`üìä Total unique customer IDs across all GA4 files: ${allCustomerIds.size}`);
    console.log('');
    
    // Compare with actual Customers.csv
    if (customerIdSets['Customers.csv']) {
      const customersFileIds = customerIdSets['Customers.csv'].size;
      const referencedIds = allCustomerIds.size;
      
      console.log('üîç Customer ID Analysis:');
      console.log(`   üìÑ Customers.csv has: ${customersFileIds} customer records`);
      console.log(`   üîó Referenced across all files: ${referencedIds} unique customer IDs`);
      
      if (referencedIds > customersFileIds) {
        console.log(`   ‚ö†Ô∏è  MISSING CUSTOMERS: ${referencedIds - customersFileIds} customer IDs are referenced but not in Customers.csv!`);
      } else if (customersFileIds > referencedIds) {
        console.log(`   ‚ÑπÔ∏è  EXTRA CUSTOMERS: ${customersFileIds - referencedIds} customers in Customers.csv are not referenced elsewhere`);
      } else {
        console.log(`   ‚úÖ PERFECT MATCH: All customer IDs align`);
      }
    }
    console.log('');
    
    console.log('5Ô∏è‚É£ RECOMMENDATIONS...');
    console.log('======================');
    console.log('');
    
    const totalReferencedCustomers = allCustomerIds.size;
    const currentDbCustomers = parseInt(customerSample.length > 0 ? '1834' : '0'); // From previous query
    
    console.log('üéØ FINDINGS:');
    console.log(`   üìä Current database customers: ${currentDbCustomers}`);
    console.log(`   üìä GA4 referenced customers: ${totalReferencedCustomers}`);
    console.log(`   üìä Vehicles in database: ${vcs.total_vehicles}`);
    console.log(`   üìä Documents in database: ${dcs.total_documents}`);
    console.log('');
    
    if (totalReferencedCustomers > currentDbCustomers * 2) {
      console.log('üí° RECOMMENDATION:');
      console.log('   üö® MAJOR CUSTOMER DATA MISSING!');
      console.log('   ‚úÖ PROCEED with full customer import');
      console.log('   ‚úÖ Many customers are referenced but missing from database');
      console.log('   ‚úÖ This explains the vehicle/document to customer ratio');
    } else if (totalReferencedCustomers > currentDbCustomers) {
      console.log('üí° RECOMMENDATION:');
      console.log('   ‚ö†Ô∏è  Some customer data missing');
      console.log('   ‚úÖ Import additional customers');
      console.log('   ‚úÖ Will improve data relationships');
    } else {
      console.log('üí° RECOMMENDATION:');
      console.log('   ‚úÖ Customer data appears complete');
      console.log('   ‚ÑπÔ∏è  Focus on other data types');
    }
    
    console.log('');
    console.log('‚úÖ DEEP CUSTOMER AUDIT COMPLETE');
    
  } catch (error) {
    console.log('‚ùå DEEP CUSTOMER AUDIT FAILED:', error.message);
  }
}

deepCustomerAudit();
