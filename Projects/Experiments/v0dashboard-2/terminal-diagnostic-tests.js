#!/usr/bin/env node

/**
 * üß™ TERMINAL DIAGNOSTIC TEST SUITE
 * Comprehensive testing to identify the exact terminal issue
 */

console.log('üß™ TERMINAL DIAGNOSTIC TEST SUITE');
console.log('==================================');
console.log('‚è∞ Start Time:', new Date().toISOString());
console.log('üñ•Ô∏è  Platform:', process.platform);
console.log('üì¶ Node Version:', process.version);
console.log('üíæ Memory Usage:', Math.round(process.memoryUsage().heapUsed / 1024 / 1024), 'MB');
console.log('');

// Test 1: Basic JavaScript execution
console.log('TEST 1: Basic JavaScript Execution');
console.log('===================================');
try {
  const testVar = 'Hello World';
  console.log('‚úÖ Variable assignment:', testVar);
  console.log('‚úÖ Console.log working');
  console.log('‚úÖ Basic JS execution: PASS');
} catch (e) {
  console.log('‚ùå Basic JS execution: FAIL -', e.message);
}
console.log('');

// Test 2: Process information
console.log('TEST 2: Process Information');
console.log('===========================');
try {
  console.log('‚úÖ Process ID:', process.pid);
  console.log('‚úÖ Working Directory:', process.cwd());
  console.log('‚úÖ Platform:', process.platform);
  console.log('‚úÖ Architecture:', process.arch);
  console.log('‚úÖ Node Path:', process.execPath);
  console.log('‚úÖ Process info: PASS');
} catch (e) {
  console.log('‚ùå Process info: FAIL -', e.message);
}
console.log('');

// Test 3: File system access
console.log('TEST 3: File System Access');
console.log('===========================');
try {
  const fs = require('fs');
  const path = require('path');
  
  // Test current directory
  const currentDir = process.cwd();
  console.log('‚úÖ Current directory access:', currentDir);
  
  // Test directory listing
  const files = fs.readdirSync('.');
  console.log('‚úÖ Directory listing: Found', files.length, 'items');
  
  // Test file existence
  const packageExists = fs.existsSync('package.json');
  console.log('‚úÖ File existence check:', packageExists ? 'package.json found' : 'package.json not found');
  
  console.log('‚úÖ File system access: PASS');
} catch (e) {
  console.log('‚ùå File system access: FAIL -', e.message);
}
console.log('');

// Test 4: Environment variables
console.log('TEST 4: Environment Variables');
console.log('==============================');
try {
  console.log('‚úÖ HOME:', process.env.HOME || 'Not set');
  console.log('‚úÖ PATH length:', (process.env.PATH || '').length, 'characters');
  console.log('‚úÖ NODE_ENV:', process.env.NODE_ENV || 'Not set');
  console.log('‚úÖ Environment variables: PASS');
} catch (e) {
  console.log('‚ùå Environment variables: FAIL -', e.message);
}
console.log('');

// Test 5: Async operations
console.log('TEST 5: Async Operations');
console.log('========================');
try {
  setTimeout(() => {
    console.log('‚úÖ setTimeout: PASS');
  }, 100);
  
  setImmediate(() => {
    console.log('‚úÖ setImmediate: PASS');
  });
  
  Promise.resolve('test').then(result => {
    console.log('‚úÖ Promise resolution: PASS -', result);
  });
  
  console.log('‚úÖ Async operations scheduled');
} catch (e) {
  console.log('‚ùå Async operations: FAIL -', e.message);
}
console.log('');

// Test 6: Module loading
console.log('TEST 6: Module Loading');
console.log('======================');
try {
  const os = require('os');
  console.log('‚úÖ OS module loaded');
  console.log('‚úÖ OS Type:', os.type());
  console.log('‚úÖ OS Platform:', os.platform());
  console.log('‚úÖ OS Release:', os.release());
  console.log('‚úÖ Total Memory:', Math.round(os.totalmem() / 1024 / 1024 / 1024), 'GB');
  console.log('‚úÖ Free Memory:', Math.round(os.freemem() / 1024 / 1024 / 1024), 'GB');
  console.log('‚úÖ CPU Count:', os.cpus().length);
  console.log('‚úÖ Module loading: PASS');
} catch (e) {
  console.log('‚ùå Module loading: FAIL -', e.message);
}
console.log('');

// Test 7: Network/DNS (if available)
console.log('TEST 7: Network Capabilities');
console.log('=============================');
try {
  const dns = require('dns');
  console.log('‚úÖ DNS module loaded');
  
  // Test DNS resolution (non-blocking)
  dns.lookup('google.com', (err, address) => {
    if (err) {
      console.log('‚ö†Ô∏è  DNS lookup: Limited -', err.code);
    } else {
      console.log('‚úÖ DNS lookup: PASS -', address);
    }
  });
  
  console.log('‚úÖ Network modules: PASS');
} catch (e) {
  console.log('‚ùå Network capabilities: FAIL -', e.message);
}
console.log('');

// Test 8: Database connection (if env available)
console.log('TEST 8: Database Connection Test');
console.log('=================================');
try {
  // Try to load dotenv
  require('dotenv').config({ path: '.env.local' });
  
  if (process.env.DATABASE_URL) {
    console.log('‚úÖ Database URL found');
    
    // Try to load neon
    const { neon } = require('@neondatabase/serverless');
    console.log('‚úÖ Neon module loaded');
    
    const sql = neon(process.env.DATABASE_URL);
    console.log('‚úÖ SQL client created');
    
    // Test connection (async)
    sql`SELECT NOW() as current_time, 'test' as message`
      .then(result => {
        console.log('‚úÖ Database connection: PASS');
        console.log('‚úÖ Database time:', result[0].current_time);
        console.log('‚úÖ Database message:', result[0].message);
      })
      .catch(err => {
        console.log('‚ùå Database connection: FAIL -', err.message);
      });
    
  } else {
    console.log('‚ö†Ô∏è  Database URL not found in environment');
  }
} catch (e) {
  console.log('‚ùå Database test: FAIL -', e.message);
}
console.log('');

// Test 9: Child process capabilities
console.log('TEST 9: Child Process Test');
console.log('===========================');
try {
  const { spawn } = require('child_process');
  console.log('‚úÖ Child process module loaded');
  
  // Test simple command
  const child = spawn('echo', ['Hello from child process']);
  
  child.stdout.on('data', (data) => {
    console.log('‚úÖ Child process output:', data.toString().trim());
  });
  
  child.on('close', (code) => {
    console.log('‚úÖ Child process: PASS - Exit code:', code);
  });
  
  child.on('error', (err) => {
    console.log('‚ùå Child process: FAIL -', err.message);
  });
  
} catch (e) {
  console.log('‚ùå Child process test: FAIL -', e.message);
}
console.log('');

// Test 10: Final summary
setTimeout(() => {
  console.log('üèÅ TERMINAL DIAGNOSTIC COMPLETE');
  console.log('================================');
  console.log('‚è∞ End Time:', new Date().toISOString());
  console.log('');
  console.log('üìä SUMMARY:');
  console.log('- If you see this message, basic Node.js execution works');
  console.log('- If tests hang, the issue is with specific operations');
  console.log('- If no output appears, the terminal interface is blocked');
  console.log('');
  console.log('üí° NEXT STEPS:');
  console.log('- Compare results with expected behavior');
  console.log('- Identify which specific test fails or hangs');
  console.log('- Use this info to determine the root cause');
  console.log('');
  console.log('‚úÖ Diagnostic script completed successfully!');
}, 2000);
