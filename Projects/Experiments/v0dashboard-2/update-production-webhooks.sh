#!/bin/bash

echo "üöÄ UPDATING TWILIO WEBHOOKS FOR PRODUCTION"
echo "=========================================="
echo ""

# Production URLs
PRODUCTION_URL="https://garagemanagerpro.vercel.app"
PHONE_NUMBER="+15558340240"

echo "üì± Phone Number: $PHONE_NUMBER"
echo "üåê Production URL: $PRODUCTION_URL"
echo ""

echo "üîß Updating webhooks automatically..."
echo ""

# Update webhooks using the API
curl -X POST "$PRODUCTION_URL/api/twilio/configure-webhooks" \
  -H "Content-Type: application/json" \
  -d "{
    \"phoneNumber\": \"$PHONE_NUMBER\",
    \"baseUrl\": \"$PRODUCTION_URL\",
    \"updateSMS\": true,
    \"updateVoice\": true,
    \"updateStatusCallback\": true
  }" | jq .

echo ""
echo "‚úÖ WEBHOOK CONFIGURATION COMPLETE!"
echo ""

echo "üìã NEW WEBHOOK URLS:"
echo "==================="
echo "üó£Ô∏è  Voice URL: $PRODUCTION_URL/api/twilio/voice"
echo "üí¨ SMS URL: $PRODUCTION_URL/api/webhooks/communication-responses"
echo "üì± WhatsApp URL: $PRODUCTION_URL/api/webhooks/communication-responses"
echo "üìä Status Callback: $PRODUCTION_URL/api/webhooks/status-callback"
echo ""

echo "üß™ TESTING WEBHOOKS:"
echo "===================="
echo "Testing webhook endpoints..."

# Test each webhook endpoint
echo "Testing Voice webhook..."
curl -s -o /dev/null -w "Voice webhook: %{http_code}\n" "$PRODUCTION_URL/api/twilio/voice"

echo "Testing SMS webhook..."
curl -s -o /dev/null -w "SMS webhook: %{http_code}\n" "$PRODUCTION_URL/api/webhooks/communication-responses"

echo "Testing Status callback..."
curl -s -o /dev/null -w "Status callback: %{http_code}\n" "$PRODUCTION_URL/api/webhooks/status-callback"

echo ""
echo "üì± WHATSAPP SANDBOX SETUP:"
echo "=========================="
echo "1. Go to: https://console.twilio.com/us1/develop/sms/whatsapp/sandbox"
echo "2. Set webhook URL: $PRODUCTION_URL/api/webhooks/communication-responses"
echo "3. Set HTTP method: POST"
echo "4. Save configuration"
echo ""

echo "üéØ MANUAL VERIFICATION:"
echo "======================="
echo "1. Go to: https://console.twilio.com/us1/develop/phone-numbers/manage/incoming"
echo "2. Click on: $PHONE_NUMBER"
echo "3. Verify these URLs are set:"
echo "   ‚Ä¢ Voice URL: $PRODUCTION_URL/api/twilio/voice"
echo "   ‚Ä¢ SMS URL: $PRODUCTION_URL/api/webhooks/communication-responses"
echo "   ‚Ä¢ Status Callback: $PRODUCTION_URL/api/webhooks/status-callback"
echo ""

echo "‚úÖ PRODUCTION DEPLOYMENT COMPLETE!"
echo "üåê Main URL: $PRODUCTION_URL"
echo "üì± WhatsApp messages will now work correctly!"
