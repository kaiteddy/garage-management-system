<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block page_title %}Garage Management System{% endblock %}</title>

    <!-- Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Modern CSS Framework -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/design-system.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/components.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/modern-layout.css') }}"
    />

    {% block extra_css %}{% endblock %}
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Skip to main content for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary-600 text-white px-4 py-2 rounded-lg z-50"
    >
      Skip to main content
    </a>

    <!-- Header -->
    <header
      class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40"
    >
      <div class="w-full max-w-none px-6">
        <div class="flex items-center justify-between h-16">
          <!-- Logo and Brand -->
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
              <div
                class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center"
              >
                <i class="fas fa-wrench text-white text-sm"></i>
              </div>
              <h1 class="text-xl font-bold text-gray-900">GarageManager Pro</h1>
            </div>
          </div>

          <!-- Navigation -->
          <nav class="hidden md:flex items-center gap-1">
            <a
              href="{{ url_for('index') }}"
              class="nav-item {% if request.endpoint == 'index' %}active{% endif %}"
            >
              <i class="fas fa-chart-line mr-2"></i>
              Dashboard
            </a>
            <a href="{{ url_for('legacy') }}" class="nav-item">
              <i class="fas fa-users mr-2"></i>
              Customers
            </a>
            <a href="{{ url_for('legacy') }}" class="nav-item">
              <i class="fas fa-car mr-2"></i>
              Vehicles
            </a>
            <a href="{{ url_for('legacy') }}" class="nav-item">
              <i class="fas fa-tools mr-2"></i>
              Jobs
            </a>
            <a href="{{ url_for('legacy') }}" class="nav-item">
              <i class="fas fa-file-invoice mr-2"></i>
              Invoices
            </a>
            <a href="/mot" class="nav-item">
              <i class="fas fa-clipboard-check mr-2"></i>
              MOT Dashboard
            </a>
            <a href="/mot/sms" class="nav-item relative">
              <i class="fas fa-sms mr-2"></i>
              SMS Centre
              <span
                id="smsNotificationBadge"
                class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"
              ></span>
            </a>
            <a
              href="{{ url_for('google_drive.google_drive_page') }}"
              class="nav-item"
            >
              <i class="fab fa-google-drive mr-2"></i>
              Sync
            </a>
          </nav>

          <!-- User Menu -->
          <div class="flex items-center gap-3">
            <!-- Notifications -->
            <button class="btn btn-ghost btn-sm relative">
              <i class="fas fa-bell"></i>
              <span
                class="absolute -top-1 -right-1 w-3 h-3 bg-error-500 rounded-full"
              ></span>
            </button>

            <!-- User Profile -->
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center"
              >
                <i class="fas fa-user text-primary-600 text-sm"></i>
              </div>
              <span class="hidden sm:block text-sm font-medium text-gray-700"
                >Admin</span
              >
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="w-full max-w-none px-6 py-8">
      {% block content %}
      <div class="text-center py-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">
          Welcome to GarageManager Pro
        </h2>
        <p class="text-gray-600">Professional garage management made simple.</p>
      </div>
      {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
      <div class="w-full max-w-none px-6 py-6">
        <div
          class="flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <div class="text-sm text-gray-500">
            © 2024 GarageManager Pro. All rights reserved.
          </div>
          <div class="flex items-center gap-4 text-sm text-gray-500">
            <a href="#" class="hover:text-primary-600 transition-colors"
              >Help</a
            >
            <a href="#" class="hover:text-primary-600 transition-colors"
              >Support</a
            >
            <a href="#" class="hover:text-primary-600 transition-colors"
              >Privacy</a
            >
          </div>
        </div>
      </div>
    </footer>

    <!-- Core JavaScript -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/emergency-protection.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navigation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/modern-layout.js') }}"></script>

    {% block scripts %}{% endblock %}

    <!-- Screenshot Feedback Hotkey -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markerjs3@2.18.0/dist/markerjs3.min.js"></script>
    <script>
      console.log('Screenshot feedback script loading...');

      // Check if libraries loaded
      if (typeof html2canvas !== 'undefined') {
        console.log('✅ html2canvas loaded successfully');
      } else {
        console.error('❌ html2canvas failed to load');
      }

      if (typeof markerjs3 !== 'undefined') {
        console.log('✅ markerjs3 loaded successfully');
      } else {
        console.error('❌ markerjs3 failed to load');
      }

      document.addEventListener('keydown', async function(e) {
        console.log('Key pressed:', e.code, 'Ctrl:', e.ctrlKey, 'Shift:', e.shiftKey);

        if (e.ctrlKey && e.shiftKey && e.code === 'F12') {
          console.log('Screenshot hotkey pressed!');
          e.preventDefault();
          const target = document.querySelector('#main-content') || document.body;
          if (!target) return;
          const canvas = await html2canvas(target, { backgroundColor: null });
          const uri = canvas.toDataURL('image/png');
          const img = new window.Image();
          img.src = uri;
          img.onload = function() {
            const markerArea = new markerjs3.MarkerArea(img);
            markerArea.addEventListener('render', async function(event) {
              const annotated = event.dataUrl;
              const payload = {
                image: annotated,
                route: window.location.pathname,
                time: new Date().toISOString(),
                build: 'garage-dev',
                userAgent: navigator.userAgent
              };
              try {
                await fetch('/api/feedback', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                alert('Feedback sent!');
              } catch (err) {
                alert('Failed to send feedback.');
              }
            });
            markerArea.show();
          };
        }
      });

      console.log('Screenshot feedback script loaded and ready');
    </script>

    <!-- Initialize Application -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Initialize modern layout
          if (typeof ModernLayout !== 'undefined') {
              ModernLayout.init();
          }

          // Check for urgent SMS notifications
          checkSMSNotifications();

          // Initialize page-specific functionality
          {% block page_init %}{% endblock %}
      });

      // Check for urgent vehicles needing SMS
      async function checkSMSNotifications() {
          try {
              const response = await fetch('/api/mot/vehicles');
              if (response.ok) {
                  const data = await response.json();
                  const urgentVehicles = data.vehicles.filter(v =>
                      v.mobile_number && (v.is_expired || (v.days_until_expiry !== null && v.days_until_expiry <= 7))
                  );

                  const badge = document.getElementById('smsNotificationBadge');
                  if (badge && urgentVehicles.length > 0) {
                      badge.classList.remove('hidden');
                      badge.title = `${urgentVehicles.length} urgent vehicle(s) need SMS reminders`;
                  }
              }
          } catch (error) {
              console.log('Could not check SMS notifications:', error);
          }
      }
    </script>
  </body>
</html>
