<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GarageManager Pro - Complete Garage Management System</title>

    <!-- External Dependencies -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      /* CSS Variables */
      :root {
        --primary-color: #667eea;
        --primary-dark: #5a67d8;
        --secondary-color: #764ba2;
        --success-color: #48bb78;
        --warning-color: #ed8936;
        --error-color: #f56565;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --white: #ffffff;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Reset and Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
        background: var(--gray-50);
        color: var(--gray-900);
        line-height: 1.6;
        overflow-x: hidden;
      }

      /* Header */
      .header {
        background: linear-gradient(
          135deg,
          #3b82f6 0%,
          #1d4ed8 50%,
          #1e40af 100%
        );
        color: var(--white);
        padding: 1rem 2rem;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .logo i {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .header-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--white);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .header-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
      }

      /* Layout */
      .layout {
        display: flex;
        margin-top: 70px;
        min-height: calc(100vh - 70px);
      }

      /* Sidebar - macOS Style */
      .sidebar {
        width: 280px;
        background: linear-gradient(
          135deg,
          #3b82f6 0%,
          #1d4ed8 50%,
          #1e40af 100%
        );
        padding: 2rem 1rem;
        position: fixed;
        left: 0;
        top: 70px;
        bottom: 0;
        overflow-y: auto;
        z-index: 100;
        backdrop-filter: blur(20px);
      }

      .nav-section {
        margin-bottom: 1rem;
      }

      .nav-section-title {
        padding: 0 1rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 1.5rem;
      }

      .nav-section:first-child .nav-section-title {
        margin-top: 0;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.5rem;
        margin: 0.25rem 0;
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        border-radius: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        font-weight: 500;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.25);
        color: var(--white);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .nav-item i {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .nav-item.active i {
        opacity: 1;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        min-height: calc(100vh - 70px);
      }

      /* Pages */
      .page {
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: var(--transition);
      }

      .page.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
        animation: pageSlideIn 0.4s ease-out;
      }

      @keyframes pageSlideIn {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Page Header */
      .page-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--gray-200);
      }

      .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .page-title i {
        color: var(--primary-color);
        font-size: 2rem;
      }

      .page-subtitle {
        color: var(--gray-600);
        font-size: 1.125rem;
        font-weight: 400;
      }

      .page-actions {
        margin-top: 1rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      /* Cards */
      .card {
        background: var(--white);
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.08);
        overflow: hidden;
        margin-bottom: 2rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(139, 92, 246, 0.1);
      }

      .card:hover {
        box-shadow: 0 8px 30px rgba(139, 92, 246, 0.15);
        transform: translateY(-4px);
        border-color: rgba(139, 92, 246, 0.2);
      }

      .card-header {
        background: linear-gradient(
          90deg,
          var(--gray-50) 0%,
          var(--gray-100) 100%
        );
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--gray-200);
        font-weight: 600;
        color: var(--gray-800);
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .card-header i {
        color: var(--primary-color);
        font-size: 1.25rem;
      }

      .card-content {
        padding: 2rem;
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: var(--white);
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.08);
        border-left: 4px solid var(--primary-color);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(139, 92, 246, 0.1);
      }

      .stat-card:hover {
        box-shadow: 0 8px 30px rgba(139, 92, 246, 0.15);
        transform: translateY(-4px);
        border-color: rgba(139, 92, 246, 0.2);
      }

      .stat-card.customers {
        border-left-color: var(--primary-color);
      }
      .stat-card.vehicles {
        border-left-color: var(--success-color);
      }
      .stat-card.jobs {
        border-left-color: var(--warning-color);
      }
      .stat-card.revenue {
        border-left-color: var(--secondary-color);
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.5rem;
        display: block;
      }

      .stat-label {
        color: var(--gray-600);
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .stat-change {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .stat-change.positive {
        color: var(--success-color);
      }
      .stat-change.negative {
        color: var(--error-color);
      }

      /* Buttons */
      .btn {
        background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
        color: var(--white);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
      }

      .btn:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
      }

      .btn-secondary {
        background: var(--gray-200);
        color: var(--gray-700);
      }

      .btn-secondary:hover {
        background: var(--gray-300);
      }

      .btn-success {
        background: var(--success-color);
      }

      .btn-warning {
        background: var(--warning-color);
      }

      .btn-danger {
        background: var(--error-color);
      }

      /* Tables */
      .table-container {
        overflow-x: auto;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--white);
      }

      .data-table th {
        background: var(--gray-50);
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        border-bottom: 1px solid var(--gray-200);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .data-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-100);
        color: var(--gray-600);
      }

      .data-table tr:hover {
        background: var(--gray-50);
      }

      /* Loading States */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid var(--gray-200);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-cell {
        text-align: center;
        padding: 3rem;
        color: var(--gray-500);
      }

      /* Console */
      .console {
        background: var(--gray-900);
        color: var(--success-color);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        font-size: 0.875rem;
        height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        line-height: 1.4;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .header {
          padding: 1rem;
        }

        .main-content {
          padding: 1rem;
        }

        .page-title {
          font-size: 2rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Customer Profile Modal */
      .customer-profile-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }

      .modal-content {
        position: relative;
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-xl);
        width: 90vw;
        max-width: 1200px;
        height: 80vh;
        max-height: 800px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .modal-header {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--secondary-color) 100%
        );
        color: var(--white);
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .modal-close {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: var(--white);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .customer-profile-tabs {
        display: flex;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
        padding: 0 2rem;
      }

      .tab-btn {
        background: none;
        border: none;
        padding: 1rem 1.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-600);
        border-bottom: 3px solid transparent;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .tab-btn:hover,
      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background: var(--white);
      }

      .tab-content {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
      }

      .tab-pane {
        display: none;
      }

      .tab-pane.active {
        display: block;
      }

      .customer-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .detail-card {
        background: var(--gray-50);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        border-left: 4px solid var(--primary-color);
      }

      .detail-card h4 {
        margin: 0 0 1rem 0;
        color: var(--gray-800);
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--gray-200);
      }

      .detail-row:last-child {
        border-bottom: none;
      }

      .detail-row .label {
        font-weight: 500;
        color: var(--gray-600);
      }

      .detail-row .value {
        color: var(--gray-900);
        font-weight: 500;
      }

      .detail-row .value a {
        color: var(--primary-color);
        text-decoration: none;
      }

      .detail-row .value a:hover {
        text-decoration: underline;
      }

      .customer-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
      }

      .vehicles-list,
      .jobs-list,
      .invoices-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
      }

      .vehicle-card,
      .job-card,
      .invoice-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        cursor: pointer;
        transition: var(--transition);
      }

      .vehicle-card:hover,
      .job-card:hover,
      .invoice-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
        border-color: var(--primary-color);
      }

      .vehicle-header,
      .job-header,
      .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .vehicle-header h4,
      .job-header h4,
      .invoice-header h4 {
        margin: 0;
        color: var(--gray-800);
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .vehicle-year,
      .invoice-amount {
        background: var(--primary-color);
        color: var(--white);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .job-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: capitalize;
      }

      .status-completed {
        background: var(--success-color);
        color: var(--white);
      }
      .status-in_progress {
        background: var(--warning-color);
        color: var(--white);
      }
      .status-pending {
        background: var(--error-color);
        color: var(--white);
      }
      .status-cancelled {
        background: var(--gray-400);
        color: var(--white);
      }

      .vehicle-details,
      .job-details,
      .invoice-details {
        color: var(--gray-600);
        font-size: 0.875rem;
      }

      .vehicle-details p,
      .job-details p,
      .invoice-details p {
        margin: 0.25rem 0;
      }

      .documents-section {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .documents-toolbar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .documents-list {
        flex: 1;
        overflow-y: auto;
      }

      .document-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: var(--transition);
      }

      .document-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
        border-color: var(--primary-color);
      }

      .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .document-header h4 {
        margin: 0;
        color: var(--gray-800);
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .document-size {
        background: var(--gray-200);
        color: var(--gray-700);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .document-details {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin-bottom: 1rem;
      }

      .document-details p {
        margin: 0.25rem 0;
      }

      .document-actions {
        display: flex;
        gap: 0.5rem;
      }

      .no-documents {
        text-align: center;
        padding: 3rem;
        color: var(--gray-500);
      }

      .error-message {
        text-align: center;
        padding: 2rem;
        color: var(--error-color);
        background: var(--gray-50);
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
      }

      .error-message i {
        font-size: 2rem;
        margin-bottom: 1rem;
      }

      .text-danger {
        color: var(--error-color) !important;
      }

      /* Safari Specific Fixes */
      .safari-browser .page.active {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateY(0) !important;
      }

      .safari-browser .main-content,
      .safari-browser .card,
      .safari-browser .stat-card {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
      }

      .safari-browser .modal-content {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-car"></i>
        GarageManager Pro
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="refreshData()">
          <i class="fas fa-sync"></i>
          <span>Refresh</span>
        </button>
        <button class="header-btn" onclick="showNotifications()">
          <i class="fas fa-bell"></i>
          <span>Alerts</span>
        </button>
        <button class="header-btn" onclick="showHelp()">
          <i class="fas fa-question-circle"></i>
          <span>Help</span>
        </button>
      </div>
    </div>

    <!-- Layout -->
    <div class="layout">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <a class="nav-item active" onclick="showPage('dashboard')">
            <i class="fas fa-chart-line"></i>
            Dashboard
          </a>
          <a class="nav-item" onclick="showPage('customers')">
            <i class="fas fa-users"></i>
            Customers
          </a>
          <a class="nav-item" onclick="showPage('vehicles')">
            <i class="fas fa-car"></i>
            Vehicles
          </a>
          <a class="nav-item" onclick="showPage('jobs')">
            <i class="fas fa-wrench"></i>
            Jobs
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Workshop</div>
          <a class="nav-item" onclick="showPage('workshop-diary')">
            <i class="fas fa-calendar-alt"></i>
            Workshop Diary
          </a>
          <a class="nav-item" onclick="showPage('job-sheets')">
            <i class="fas fa-clipboard-list"></i>
            Job Sheets
          </a>
          <a class="nav-item" onclick="showPage('quotes')">
            <i class="fas fa-file-invoice-dollar"></i>
            Quotes
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Services</div>
          <a class="nav-item" onclick="showPage('mot-reminders')">
            <i class="fas fa-car-crash"></i>
            MOT Reminders
          </a>
          <a class="nav-item" onclick="showPage('online-booking')">
            <i class="fas fa-calendar-plus"></i>
            Online Booking
          </a>
          <a class="nav-item" onclick="showPage('customer-portal')">
            <i class="fas fa-user-circle"></i>
            Customer Portal
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Business</div>
          <a class="nav-item" onclick="showPage('parts')">
            <i class="fas fa-cogs"></i>
            Parts
          </a>
          <a class="nav-item" onclick="showPage('invoices')">
            <i class="fas fa-file-invoice"></i>
            Invoices
          </a>
          <a class="nav-item" onclick="showPage('reports')">
            <i class="fas fa-chart-bar"></i>
            Reports
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">System</div>
          <a class="nav-item" onclick="showPage('settings')">
            <i class="fas fa-cog"></i>
            Settings
          </a>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-chart-line"></i>
              Dashboard
            </h1>
            <p class="page-subtitle">
              Overview of your garage management system
            </p>
          </div>

          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-card customers">
              <div class="stat-number" id="customers-stat">0</div>
              <div class="stat-label">Total Customers</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                +12% this month
              </div>
            </div>
            <div class="stat-card vehicles">
              <div class="stat-number" id="vehicles-stat">0</div>
              <div class="stat-label">Vehicles</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                +8% this month
              </div>
            </div>
            <div class="stat-card jobs">
              <div class="stat-number" id="jobs-stat">0</div>
              <div class="stat-label">Active Jobs</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                +15% this month
              </div>
            </div>
            <div class="stat-card revenue">
              <div class="stat-number" id="revenue-stat">£0</div>
              <div class="stat-label">Monthly Revenue</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                +22% this month
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card">
            <div class="card-header">
              <i class="fas fa-bolt"></i>
              Quick Actions
            </div>
            <div class="card-content">
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 1rem;
                "
              >
                <button class="btn" onclick="showPage('customers')">
                  <i class="fas fa-user-plus"></i>
                  Add Customer
                </button>
                <button class="btn" onclick="showPage('vehicles')">
                  <i class="fas fa-car"></i>
                  Add Vehicle
                </button>
                <button class="btn" onclick="showPage('jobs')">
                  <i class="fas fa-plus"></i>
                  New Job
                </button>
                <button class="btn" onclick="showPage('quotes')">
                  <i class="fas fa-file-invoice-dollar"></i>
                  Create Quote
                </button>
                <button class="btn" onclick="showPage('mot-reminders')">
                  <i class="fas fa-car-crash"></i>
                  MOT Check
                </button>
                <button class="btn" onclick="showPage('workshop-diary')">
                  <i class="fas fa-calendar-alt"></i>
                  Schedule
                </button>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="card">
            <div class="card-header">
              <i class="fas fa-clock"></i>
              Recent Activity
            </div>
            <div class="card-content">
              <div id="recent-activity">
                <div class="loading-cell">
                  <div class="loading-spinner"></div>
                  <p>Loading recent activity...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Customers Page -->
        <div id="customers" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-users"></i>
              Customers
            </h1>
            <p class="page-subtitle">Manage customer records and information</p>
            <div class="page-actions">
              <button class="btn" onclick="addCustomer()">
                <i class="fas fa-user-plus"></i>
                Add Customer
              </button>
              <button class="btn btn-secondary" onclick="importCustomers()">
                <i class="fas fa-upload"></i>
                Import
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-list"></i>
              Customer Database
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Phone</th>
                      <th>Email</th>
                      <th>Vehicles</th>
                      <th>Last Visit</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="customers-table">
                    <tr>
                      <td colspan="6" class="loading-cell">
                        <div class="loading-spinner"></div>
                        <p>Loading customers...</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Vehicles Page -->
        <div id="vehicles" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-car"></i>
              Vehicles
            </h1>
            <p class="page-subtitle">Vehicle records and maintenance history</p>
            <div class="page-actions">
              <button class="btn" onclick="addVehicle()">
                <i class="fas fa-plus"></i>
                Add Vehicle
              </button>
              <button class="btn btn-secondary" onclick="bulkUpload()">
                <i class="fas fa-upload"></i>
                Bulk Upload
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-car"></i>
              Vehicle Registry
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Registration</th>
                      <th>Make</th>
                      <th>Model</th>
                      <th>Year</th>
                      <th>Customer</th>
                      <th>MOT Due</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vehicles-table">
                    <tr>
                      <td colspan="7" class="loading-cell">
                        <div class="loading-spinner"></div>
                        <p>Loading vehicles...</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Jobs Page -->
        <div id="jobs" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-wrench"></i>
              Jobs
            </h1>
            <p class="page-subtitle">Work orders and job tracking</p>
            <div class="page-actions">
              <button class="btn" onclick="createJob()">
                <i class="fas fa-plus"></i>
                New Job
              </button>
              <button class="btn btn-secondary" onclick="showJobTemplates()">
                <i class="fas fa-copy"></i>
                Templates
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-list"></i>
              Active Jobs
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Job #</th>
                      <th>Customer</th>
                      <th>Vehicle</th>
                      <th>Description</th>
                      <th>Status</th>
                      <th>Due Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="jobs-table">
                    <tr>
                      <td colspan="7" class="loading-cell">
                        <div class="loading-spinner"></div>
                        <p>Loading jobs...</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- MOT Reminders Page -->
        <div id="mot-reminders" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-car-crash"></i>
              MOT Reminders
            </h1>
            <p class="page-subtitle">MOT expiry tracking and SMS reminders</p>
            <div class="page-actions">
              <button class="btn" onclick="checkMOTExpiry()">
                <i class="fas fa-search"></i>
                Check Expiry
              </button>
              <button class="btn btn-warning" onclick="sendReminders()">
                <i class="fas fa-sms"></i>
                Send Reminders
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-exclamation-triangle"></i>
              Upcoming MOT Expiries
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Registration</th>
                      <th>Customer</th>
                      <th>Phone</th>
                      <th>MOT Due</th>
                      <th>Days Left</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="mot-table">
                    <tr>
                      <td colspan="7" class="loading-cell">
                        <div class="loading-spinner"></div>
                        <p>Loading MOT data...</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Workshop Diary Page -->
        <div id="workshop-diary" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-calendar-alt"></i>
              Workshop Diary
            </h1>
            <p class="page-subtitle">
              Schedule and manage workshop appointments
            </p>
            <div class="page-actions">
              <button class="btn" onclick="addAppointment()">
                <i class="fas fa-plus"></i>
                New Appointment
              </button>
              <button class="btn btn-secondary" onclick="viewCalendar()">
                <i class="fas fa-calendar"></i>
                Calendar View
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-clock"></i>
              Today's Schedule
            </div>
            <div class="card-content">
              <p>Workshop scheduling system coming soon!</p>
            </div>
          </div>
        </div>

        <!-- Job Sheets Page -->
        <div id="job-sheets" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-clipboard-list"></i>
              Job Sheets
            </h1>
            <p class="page-subtitle">Digital job cards and work instructions</p>
            <div class="page-actions">
              <button class="btn" onclick="createJobSheet()">
                <i class="fas fa-plus"></i>
                New Job Sheet
              </button>
              <button class="btn btn-secondary" onclick="printJobSheets()">
                <i class="fas fa-print"></i>
                Print
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-list"></i>
              Active Job Sheets
            </div>
            <div class="card-content">
              <p>Digital job sheet system coming soon!</p>
            </div>
          </div>
        </div>

        <!-- Quotes Page -->
        <div id="quotes" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-file-invoice-dollar"></i>
              Quotes
            </h1>
            <p class="page-subtitle">Create and manage customer quotes</p>
            <div class="page-actions">
              <button class="btn" onclick="createQuote()">
                <i class="fas fa-plus"></i>
                New Quote
              </button>
              <button class="btn btn-secondary" onclick="quoteTemplates()">
                <i class="fas fa-copy"></i>
                Templates
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-file-alt"></i>
              Recent Quotes
            </div>
            <div class="card-content">
              <p>Quote management system coming soon!</p>
            </div>
          </div>
        </div>

        <!-- Online Booking Page -->
        <div id="online-booking" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-calendar-plus"></i>
              Online Booking
            </h1>
            <p class="page-subtitle">Customer self-service booking system</p>
            <div class="page-actions">
              <button class="btn" onclick="configureBooking()">
                <i class="fas fa-cog"></i>
                Configure
              </button>
              <button class="btn btn-secondary" onclick="viewBookingPage()">
                <i class="fas fa-external-link-alt"></i>
                View Public Page
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-calendar-check"></i>
              Recent Bookings
            </div>
            <div class="card-content">
              <p>Online booking system coming soon!</p>
            </div>
          </div>
        </div>

        <!-- Customer Portal Page -->
        <div id="customer-portal" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-user-circle"></i>
              Customer Portal
            </h1>
            <p class="page-subtitle">Customer self-service portal</p>
            <div class="page-actions">
              <button class="btn" onclick="configurePortal()">
                <i class="fas fa-cog"></i>
                Configure
              </button>
              <button class="btn btn-secondary" onclick="viewPortal()">
                <i class="fas fa-external-link-alt"></i>
                View Portal
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-users"></i>
              Portal Activity
            </div>
            <div class="card-content">
              <p>Customer portal coming soon!</p>
            </div>
          </div>
        </div>

        <!-- Parts Page -->
        <div id="parts" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-cogs"></i>
              Parts
            </h1>
            <p class="page-subtitle">Parts inventory and supplier management</p>
            <div class="page-actions">
              <button class="btn" onclick="addPart()">
                <i class="fas fa-plus"></i>
                Add Part
              </button>
              <button class="btn btn-secondary" onclick="orderParts()">
                <i class="fas fa-shopping-cart"></i>
                Order Parts
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-boxes"></i>
              Parts Inventory
            </div>
            <div class="card-content">
              <p>Parts management system coming soon!</p>
            </div>
          </div>
        </div>

        <!-- Invoices Page -->
        <div id="invoices" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-file-invoice"></i>
              Invoices
            </h1>
            <p class="page-subtitle">Invoice management and billing</p>
            <div class="page-actions">
              <button class="btn" onclick="createInvoice()">
                <i class="fas fa-plus"></i>
                New Invoice
              </button>
              <button class="btn btn-secondary" onclick="exportInvoices()">
                <i class="fas fa-download"></i>
                Export
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-list"></i>
              Recent Invoices
            </div>
            <div class="card-content">
              <p>Invoice management system coming soon!</p>
            </div>
          </div>
        </div>

        <!-- Reports Page -->
        <div id="reports" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-chart-bar"></i>
              Reports
            </h1>
            <p class="page-subtitle">Business analytics and reporting</p>
            <div class="page-actions">
              <button class="btn" onclick="generateReport()">
                <i class="fas fa-chart-line"></i>
                Generate Report
              </button>
              <button class="btn btn-secondary" onclick="scheduleReports()">
                <i class="fas fa-clock"></i>
                Schedule
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-chart-pie"></i>
              Business Analytics
            </div>
            <div class="card-content">
              <p>Reporting system coming soon!</p>
            </div>
          </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
          <div class="page-header">
            <h1 class="page-title">
              <i class="fas fa-cog"></i>
              Settings
            </h1>
            <p class="page-subtitle">System configuration and preferences</p>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-database"></i>
              Data Management
            </div>
            <div class="card-content">
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                  gap: 1rem;
                "
              >
                <button class="btn" onclick="showUploadPage()">
                  <i class="fas fa-upload"></i>
                  Data Upload
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                  <i class="fas fa-download"></i>
                  Export Data
                </button>
                <button class="btn btn-secondary" onclick="backupData()">
                  <i class="fas fa-save"></i>
                  Backup
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-bell"></i>
              Notifications
            </div>
            <div class="card-content">
              <p>Configure SMS and email notification settings.</p>
              <div style="margin-top: 1rem">
                <button class="btn btn-secondary" onclick="configureSMS()">
                  <i class="fas fa-sms"></i>
                  SMS Settings
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Console/Debug -->
        <div class="card" style="margin-top: 2rem">
          <div class="card-header">
            <i class="fas fa-terminal"></i>
            System Console
            <button
              class="btn btn-secondary"
              onclick="clearConsole()"
              style="margin-left: auto; padding: 0.5rem 1rem"
            >
              Clear
            </button>
          </div>
          <div class="console" id="console"></div>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Global variables
      let currentPage = "dashboard";
      let appData = {
        customers: [],
        vehicles: [],
        jobs: [],
        stats: {},
      };

      // Console functionality
      const consoleDiv = document.getElementById("console");
      const originalLog = console.log;
      const originalError = console.error;

      function logToConsole(type, ...args) {
        const timestamp = new Date().toLocaleTimeString();
        const message = args
          .map((arg) =>
            typeof arg === "object"
              ? JSON.stringify(arg, null, 2)
              : String(arg),
          )
          .join(" ");
        consoleDiv.textContent += `[${timestamp}] ${type}: ${message}\n`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      }

      console.log = function (...args) {
        originalLog.apply(console, args);
        logToConsole("LOG", ...args);
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        logToConsole("ERROR", ...args);
      };

      function clearConsole() {
        consoleDiv.textContent = "";
      }

      // Safari detection and optimization
      const isSafari = /^((?!chrome|android).)*safari/i.test(
        navigator.userAgent,
      );
      const isSafari19 = navigator.userAgent.includes("Version/19");

      if (isSafari) {
        document.body.classList.add("safari-browser");
        console.log("🍎 Safari browser detected");
        if (isSafari19) {
          console.log("🍎 Safari 19.0 optimizations active");
        }
      }

      // Navigation system
      function showPage(pageId) {
        console.log(`🔄 Navigating to: ${pageId}`);

        try {
          // Hide all pages
          document.querySelectorAll(".page").forEach((page) => {
            page.classList.remove("active");
            if (isSafari) {
              page.style.display = "none";
            }
          });

          // Remove active from nav items
          document.querySelectorAll(".nav-item").forEach((item) => {
            item.classList.remove("active");
          });

          // Show selected page
          const page = document.getElementById(pageId);
          if (page) {
            page.classList.add("active");
            if (isSafari) {
              page.style.display = "block";
              page.style.opacity = "1";
              page.style.visibility = "visible";
              page.style.transform = "translateY(0)";
            }
            console.log(`✅ Page ${pageId} activated`);
          } else {
            console.error(`❌ Page ${pageId} not found`);
            return;
          }

          // Activate nav item
          const navItem = document.querySelector(`[onclick*="${pageId}"]`);
          if (navItem) {
            navItem.classList.add("active");
          }

          // Update current page
          currentPage = pageId;

          // Load page data if needed
          loadPageData(pageId);
        } catch (error) {
          console.error("❌ Navigation error:", error);
        }
      }

      // Data loading functions
      async function loadPageData(pageId) {
        console.log(`📊 Loading data for: ${pageId}`);

        switch (pageId) {
          case "dashboard":
            await loadDashboardData();
            break;
          case "customers":
            await loadCustomersData();
            break;
          case "vehicles":
            await loadVehiclesData();
            break;
          case "jobs":
            await loadJobsData();
            break;
          case "mot-reminders":
            await loadMOTData();
            break;
          default:
            console.log(`ℹ️ No specific data loading for: ${pageId}`);
        }
      }

      async function loadDashboardData() {
        try {
          console.log("📊 Loading dashboard statistics...");

          const response = await fetch("/api/stats");
          if (response.ok) {
            const data = await response.json();
            appData.stats = data.stats || data;

            // Update stat cards
            document.getElementById("customers-stat").textContent =
              appData.stats.customers || "0";
            document.getElementById("vehicles-stat").textContent =
              appData.stats.vehicles || "0";
            document.getElementById("jobs-stat").textContent =
              appData.stats.jobs || "0";
            document.getElementById("revenue-stat").textContent =
              appData.stats.revenue || "£0";

            console.log("✅ Dashboard stats loaded:", appData.stats);
          } else {
            throw new Error(`HTTP ${response.status}`);
          }

          // Load recent activity
          await loadRecentActivity();
        } catch (error) {
          console.error("❌ Failed to load dashboard data:", error);
          // Show demo data
          document.getElementById("customers-stat").textContent = "6,010";
          document.getElementById("vehicles-stat").textContent = "10,376";
          document.getElementById("jobs-stat").textContent = "32,812";
          document.getElementById("revenue-stat").textContent = "£4,637,086";
        }
      }

      async function loadRecentActivity() {
        try {
          const activityDiv = document.getElementById("recent-activity");
          activityDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                            <strong>New Customer Added</strong><br>
                            <span style="color: var(--gray-600); font-size: 0.875rem;">John Smith - 2 minutes ago</span>
                        </div>
                        <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; border-left: 4px solid var(--success-color);">
                            <strong>Job Completed</strong><br>
                            <span style="color: var(--gray-600); font-size: 0.875rem;">MOT Test - ABC123 - 15 minutes ago</span>
                        </div>
                        <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; border-left: 4px solid var(--warning-color);">
                            <strong>MOT Reminder Sent</strong><br>
                            <span style="color: var(--gray-600); font-size: 0.875rem;">5 customers notified - 1 hour ago</span>
                        </div>
                    </div>
                `;
        } catch (error) {
          console.error("❌ Failed to load recent activity:", error);
        }
      }

      async function loadCustomersData() {
        try {
          console.log("👥 Loading customers data...");
          const response = await fetch("/api/customers");
          if (response.ok) {
            const data = await response.json();
            appData.customers = data.customers || [];
            renderCustomersTable();
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("❌ Failed to load customers:", error);
          renderCustomersTable(true);
        }
      }

      function renderCustomersTable(demo = false) {
        const tbody = document.getElementById("customers-table");
        if (demo || appData.customers.length === 0) {
          tbody.innerHTML = `
                    <tr><td>John Smith</td><td>07123 456789</td><td>john@example.com</td><td>2</td><td>2024-06-15</td><td><button class="btn btn-secondary">View</button></td></tr>
                    <tr><td>Sarah Johnson</td><td>07987 654321</td><td>sarah@example.com</td><td>1</td><td>2024-06-10</td><td><button class="btn btn-secondary">View</button></td></tr>
                    <tr><td>Mike Wilson</td><td>07555 123456</td><td>mike@example.com</td><td>3</td><td>2024-06-08</td><td><button class="btn btn-secondary">View</button></td></tr>
                `;
        } else {
          tbody.innerHTML = appData.customers
            .map(
              (customer) => `
                    <tr>
                        <td>${customer.name || "N/A"}</td>
                        <td>${customer.phone || "N/A"}</td>
                        <td>${customer.email || "N/A"}</td>
                        <td>${customer.vehicle_count || 0}</td>
                        <td>${customer.last_visit || "Never"}</td>
                        <td><button class="btn btn-secondary" onclick="viewCustomer(${customer.id})">View</button></td>
                    </tr>
                `,
            )
            .join("");
        }
      }

      async function loadVehiclesData() {
        try {
          console.log("🚗 Loading vehicles data...");
          const response = await fetch("/api/vehicles");
          if (response.ok) {
            const data = await response.json();
            appData.vehicles = data.vehicles || [];
            renderVehiclesTable();
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("❌ Failed to load vehicles:", error);
          renderVehiclesTable(true);
        }
      }

      function renderVehiclesTable(demo = false) {
        const tbody = document.getElementById("vehicles-table");
        if (demo || appData.vehicles.length === 0) {
          tbody.innerHTML = `
                    <tr><td>ABC123</td><td>Ford</td><td>Focus</td><td>2020</td><td>John Smith</td><td>2024-12-15</td><td><button class="btn btn-secondary">View</button></td></tr>
                    <tr><td>XYZ789</td><td>Toyota</td><td>Corolla</td><td>2019</td><td>Sarah Johnson</td><td>2024-11-20</td><td><button class="btn btn-secondary">View</button></td></tr>
                    <tr><td>DEF456</td><td>BMW</td><td>320i</td><td>2021</td><td>Mike Wilson</td><td>2025-01-10</td><td><button class="btn btn-secondary">View</button></td></tr>
                `;
        } else {
          tbody.innerHTML = appData.vehicles
            .map(
              (vehicle) => `
                    <tr>
                        <td>${vehicle.registration || "N/A"}</td>
                        <td>${vehicle.make || "N/A"}</td>
                        <td>${vehicle.model || "N/A"}</td>
                        <td>${vehicle.year || "N/A"}</td>
                        <td>${vehicle.customer_name || "N/A"}</td>
                        <td>${vehicle.mot_due || "N/A"}</td>
                        <td><button class="btn btn-secondary" onclick="viewVehicle('${vehicle.registration}')">View</button></td>
                    </tr>
                `,
            )
            .join("");
        }
      }

      async function loadJobsData() {
        try {
          console.log("🔧 Loading jobs data...");
          const response = await fetch("/api/jobs");
          if (response.ok) {
            const data = await response.json();
            appData.jobs = data.jobs || [];
            renderJobsTable();
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("❌ Failed to load jobs:", error);
          renderJobsTable(true);
        }
      }

      function renderJobsTable(demo = false) {
        const tbody = document.getElementById("jobs-table");
        if (demo || appData.jobs.length === 0) {
          tbody.innerHTML = `
                    <tr><td>J001</td><td>John Smith</td><td>ABC123</td><td>MOT Test</td><td><span style="color: var(--warning-color);">In Progress</span></td><td>2024-06-25</td><td><button class="btn btn-secondary">View</button></td></tr>
                    <tr><td>J002</td><td>Sarah Johnson</td><td>XYZ789</td><td>Service</td><td><span style="color: var(--success-color);">Completed</span></td><td>2024-06-20</td><td><button class="btn btn-secondary">View</button></td></tr>
                    <tr><td>J003</td><td>Mike Wilson</td><td>DEF456</td><td>Brake Repair</td><td><span style="color: var(--error-color);">Pending</span></td><td>2024-06-30</td><td><button class="btn btn-secondary">View</button></td></tr>
                `;
        } else {
          tbody.innerHTML = appData.jobs
            .map(
              (job) => `
                    <tr>
                        <td>${job.job_number || "N/A"}</td>
                        <td>${job.customer_name || "N/A"}</td>
                        <td>${job.vehicle_reg || "N/A"}</td>
                        <td>${job.description || "N/A"}</td>
                        <td><span style="color: var(--${job.status === "completed" ? "success" : job.status === "in_progress" ? "warning" : "error"}-color);">${job.status || "N/A"}</span></td>
                        <td>${job.due_date || "N/A"}</td>
                        <td><button class="btn btn-secondary" onclick="viewJob('${job.id}')">View</button></td>
                    </tr>
                `,
            )
            .join("");
        }
      }

      async function loadMOTData() {
        try {
          console.log("🚗 Loading MOT data...");
          const response = await fetch("/api/mot-reminders");
          if (response.ok) {
            const data = await response.json();
            renderMOTTable(data.reminders || []);
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("❌ Failed to load MOT data:", error);
          renderMOTTable([], true);
        }
      }

      function renderMOTTable(reminders, demo = false) {
        const tbody = document.getElementById("mot-table");
        if (demo || reminders.length === 0) {
          tbody.innerHTML = `
                    <tr><td>ABC123</td><td>John Smith</td><td>07123 456789</td><td>2024-07-15</td><td><span style="color: var(--error-color);">25</span></td><td>Pending</td><td><button class="btn btn-warning">Send SMS</button></td></tr>
                    <tr><td>XYZ789</td><td>Sarah Johnson</td><td>07987 654321</td><td>2024-08-20</td><td><span style="color: var(--warning-color);">61</span></td><td>Pending</td><td><button class="btn btn-warning">Send SMS</button></td></tr>
                    <tr><td>DEF456</td><td>Mike Wilson</td><td>07555 123456</td><td>2024-09-10</td><td><span style="color: var(--success-color);">82</span></td><td>Sent</td><td><button class="btn btn-secondary">Resend</button></td></tr>
                `;
        } else {
          tbody.innerHTML = reminders
            .map(
              (reminder) => `
                    <tr>
                        <td>${reminder.registration || "N/A"}</td>
                        <td>${reminder.customer_name || "N/A"}</td>
                        <td>${reminder.phone || "N/A"}</td>
                        <td>${reminder.mot_due || "N/A"}</td>
                        <td><span style="color: var(--${reminder.days_left < 30 ? "error" : reminder.days_left < 60 ? "warning" : "success"}-color);">${reminder.days_left || "N/A"}</span></td>
                        <td>${reminder.status || "Pending"}</td>
                        <td><button class="btn btn-warning" onclick="sendMOTReminder('${reminder.id}')">Send SMS</button></td>
                    </tr>
                `,
            )
            .join("");
        }
      }

      // Action functions
      function refreshData() {
        console.log("🔄 Refreshing data...");
        loadPageData(currentPage);
      }

      function showNotifications() {
        console.log("🔔 Showing notifications...");
        alert("Notifications feature coming soon!");
      }

      function showHelp() {
        console.log("❓ Showing help...");
        alert("Help documentation coming soon!");
      }

      // Customer functions
      function addCustomer() {
        console.log("👤 Adding new customer...");
        alert("Add Customer form coming soon!");
      }

      function importCustomers() {
        console.log("📥 Importing customers...");
        alert("Customer import feature coming soon!");
      }

      async function viewCustomer(id) {
        console.log(`👤 Viewing customer: ${id}`);
        try {
          const response = await fetch(`/api/customer/${id}`);
          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              showCustomerProfile(data);
            } else {
              throw new Error(data.error);
            }
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("❌ Failed to load customer:", error);
          alert(`Failed to load customer details: ${error.message}`);
        }
      }

      function showCustomerProfile(data) {
        const customer = data.customer;
        const vehicles = data.vehicles || [];
        const jobs = data.jobs || [];
        const invoices = data.invoices || [];

        // Create customer profile modal
        const modal = document.createElement("div");
        modal.className = "customer-profile-modal";
        modal.innerHTML = `
                <div class="modal-overlay" onclick="closeCustomerProfile()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-user"></i> ${customer.name || "Unknown Customer"}</h2>
                        <button class="modal-close" onclick="closeCustomerProfile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="customer-profile-tabs">
                            <button class="tab-btn active" onclick="showProfileTab('details')">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                            <button class="tab-btn" onclick="showProfileTab('vehicles')">
                                <i class="fas fa-car"></i> Vehicles (${vehicles.length})
                            </button>
                            <button class="tab-btn" onclick="showProfileTab('jobs')">
                                <i class="fas fa-wrench"></i> Jobs (${jobs.length})
                            </button>
                            <button class="tab-btn" onclick="showProfileTab('invoices')">
                                <i class="fas fa-file-invoice"></i> Invoices (${invoices.length})
                            </button>
                            <button class="tab-btn" onclick="showProfileTab('documents')">
                                <i class="fas fa-folder"></i> Documents
                            </button>
                        </div>

                        <div class="tab-content">
                            <div id="details-tab" class="tab-pane active">
                                <div class="customer-details-grid">
                                    <div class="detail-card">
                                        <h4><i class="fas fa-id-card"></i> Contact Information</h4>
                                        <div class="detail-row">
                                            <span class="label">Account Number:</span>
                                            <span class="value">${customer.account_number || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Name:</span>
                                            <span class="value">${customer.name || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Company:</span>
                                            <span class="value">${customer.company || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Phone:</span>
                                            <span class="value">
                                                <a href="tel:${customer.phone || ""}">${customer.phone || "N/A"}</a>
                                            </span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Mobile:</span>
                                            <span class="value">
                                                <a href="tel:${customer.mobile || ""}">${customer.mobile || "N/A"}</a>
                                            </span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Email:</span>
                                            <span class="value">
                                                <a href="mailto:${customer.email || ""}">${customer.email || "N/A"}</a>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="detail-card">
                                        <h4><i class="fas fa-map-marker-alt"></i> Address</h4>
                                        <div class="detail-row">
                                            <span class="label">Address:</span>
                                            <span class="value">${customer.address || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Postcode:</span>
                                            <span class="value">${customer.postcode || "N/A"}</span>
                                        </div>
                                    </div>
                                    <div class="detail-card">
                                        <h4><i class="fas fa-chart-line"></i> Statistics</h4>
                                        <div class="detail-row">
                                            <span class="label">Total Vehicles:</span>
                                            <span class="value">${vehicles.length}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Total Jobs:</span>
                                            <span class="value">${jobs.length}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Total Invoices:</span>
                                            <span class="value">${invoices.length}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Total Spent:</span>
                                            <span class="value">£${invoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="customer-actions">
                                    <button class="btn" onclick="editCustomer(${customer.id})">
                                        <i class="fas fa-edit"></i> Edit Customer
                                    </button>
                                    <button class="btn btn-secondary" onclick="addVehicleForCustomer(${customer.id})">
                                        <i class="fas fa-car"></i> Add Vehicle
                                    </button>
                                    <button class="btn btn-secondary" onclick="createJobForCustomer(${customer.id})">
                                        <i class="fas fa-wrench"></i> New Job
                                    </button>
                                    <button class="btn btn-secondary" onclick="sendSMSToCustomer(${customer.id})">
                                        <i class="fas fa-sms"></i> Send SMS
                                    </button>
                                </div>
                            </div>

                            <div id="vehicles-tab" class="tab-pane">
                                <div class="vehicles-list">
                                    ${
                                      vehicles.length > 0
                                        ? vehicles
                                            .map(
                                              (vehicle) => `
                                        <div class="vehicle-card" onclick="viewVehicle('${vehicle.registration}')">
                                            <div class="vehicle-header">
                                                <h4><i class="fas fa-car"></i> ${vehicle.registration}</h4>
                                                <span class="vehicle-year">${vehicle.year || "Unknown"}</span>
                                            </div>
                                            <div class="vehicle-details">
                                                <p><strong>${vehicle.make} ${vehicle.model}</strong></p>
                                                <p>Color: ${vehicle.color || "N/A"}</p>
                                                <p>MOT Due: ${vehicle.mot_due || "N/A"}</p>
                                                <p>Tax Due: ${vehicle.tax_due || "N/A"}</p>
                                            </div>
                                        </div>
                                    `,
                                            )
                                            .join("")
                                        : "<p>No vehicles registered for this customer.</p>"
                                    }
                                </div>
                            </div>

                            <div id="jobs-tab" class="tab-pane">
                                <div class="jobs-list">
                                    ${
                                      jobs.length > 0
                                        ? jobs
                                            .map(
                                              (job) => `
                                        <div class="job-card" onclick="viewJob('${job.id}')">
                                            <div class="job-header">
                                                <h4><i class="fas fa-wrench"></i> Job #${job.job_number || job.id}</h4>
                                                <span class="job-status status-${job.status}">${job.status || "Unknown"}</span>
                                            </div>
                                            <div class="job-details">
                                                <p><strong>${job.description || "No description"}</strong></p>
                                                <p>Vehicle: ${job.vehicle_registration || "N/A"}</p>
                                                <p>Date: ${job.created_date || "N/A"}</p>
                                                <p>Total: £${job.total_amount || "0.00"}</p>
                                            </div>
                                        </div>
                                    `,
                                            )
                                            .join("")
                                        : "<p>No jobs found for this customer.</p>"
                                    }
                                </div>
                            </div>

                            <div id="invoices-tab" class="tab-pane">
                                <div class="invoices-list">
                                    ${
                                      invoices.length > 0
                                        ? invoices
                                            .map(
                                              (invoice) => `
                                        <div class="invoice-card" onclick="viewInvoice('${invoice.id}')">
                                            <div class="invoice-header">
                                                <h4><i class="fas fa-file-invoice"></i> Invoice #${invoice.invoice_number || invoice.id}</h4>
                                                <span class="invoice-amount">£${invoice.total_amount || "0.00"}</span>
                                            </div>
                                            <div class="invoice-details">
                                                <p>Date: ${invoice.invoice_date || "N/A"}</p>
                                                <p>Due: ${invoice.due_date || "N/A"}</p>
                                                <p>Status: ${invoice.status || "Unknown"}</p>
                                            </div>
                                        </div>
                                    `,
                                            )
                                            .join("")
                                        : "<p>No invoices found for this customer.</p>"
                                    }
                                </div>
                            </div>

                            <div id="documents-tab" class="tab-pane">
                                <div class="documents-section">
                                    <div class="documents-toolbar">
                                        <button class="btn" onclick="uploadDocument(${customer.id})">
                                            <i class="fas fa-upload"></i> Upload Document
                                        </button>
                                        <button class="btn btn-secondary" onclick="refreshDocuments(${customer.id})">
                                            <i class="fas fa-sync"></i> Refresh
                                        </button>
                                    </div>
                                    <div id="customer-documents-${customer.id}" class="documents-list">
                                        <div class="loading-cell">
                                            <div class="loading-spinner"></div>
                                            <p>Loading documents...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);

        // Load documents for the customer
        loadCustomerDocuments(customer.id);

        console.log("✅ Customer profile displayed");
      }

      function closeCustomerProfile() {
        const modal = document.querySelector(".customer-profile-modal");
        if (modal) {
          modal.remove();
          console.log("✅ Customer profile closed");
        }
      }

      function showProfileTab(tabName) {
        // Remove active class from all tabs and panes
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-pane")
          .forEach((pane) => pane.classList.remove("active"));

        // Add active class to selected tab and pane
        document
          .querySelector(`[onclick*="${tabName}"]`)
          .classList.add("active");
        document.getElementById(`${tabName}-tab`).classList.add("active");

        console.log(`📋 Switched to ${tabName} tab`);
      }

      async function loadCustomerDocuments(customerId) {
        try {
          console.log(`📁 Loading documents for customer: ${customerId}`);
          const response = await fetch(`/api/customer/${customerId}/documents`);
          const documentsContainer = document.getElementById(
            `customer-documents-${customerId}`,
          );

          if (response.ok) {
            const data = await response.json();
            const documents = data.documents || [];

            if (documents.length > 0) {
              documentsContainer.innerHTML = documents
                .map(
                  (doc) => `
                            <div class="document-card" onclick="viewDocument('${doc.id}')">
                                <div class="document-header">
                                    <h4><i class="fas fa-file-${getDocumentIcon(doc.type)}"></i> ${doc.name}</h4>
                                    <span class="document-size">${formatFileSize(doc.size)}</span>
                                </div>
                                <div class="document-details">
                                    <p>Type: ${doc.type || "Unknown"}</p>
                                    <p>Uploaded: ${formatDate(doc.created_date)}</p>
                                    <p>Category: ${doc.category || "General"}</p>
                                </div>
                                <div class="document-actions">
                                    <button class="btn btn-secondary" onclick="downloadDocument('${doc.id}', event)">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                    <button class="btn btn-secondary" onclick="shareDocument('${doc.id}', event)">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                </div>
                            </div>
                        `,
                )
                .join("");
            } else {
              documentsContainer.innerHTML = `
                            <div class="no-documents">
                                <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                                <p>No documents found for this customer.</p>
                                <button class="btn" onclick="uploadDocument(${customerId})">
                                    <i class="fas fa-upload"></i> Upload First Document
                                </button>
                            </div>
                        `;
            }
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("❌ Failed to load documents:", error);
          const documentsContainer = document.getElementById(
            `customer-documents-${customerId}`,
          );
          documentsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load documents: ${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadCustomerDocuments(${customerId})">
                            <i class="fas fa-retry"></i> Retry
                        </button>
                    </div>
                `;
        }
      }

      function getDocumentIcon(type) {
        const iconMap = {
          pdf: "pdf",
          doc: "word",
          docx: "word",
          xls: "excel",
          xlsx: "excel",
          jpg: "image",
          jpeg: "image",
          png: "image",
          gif: "image",
          txt: "alt",
          csv: "csv",
        };
        return iconMap[type?.toLowerCase()] || "file";
      }

      function formatFileSize(bytes) {
        if (!bytes) return "Unknown";
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (
          Math.round((bytes / Math.pow(1024, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      function formatDate(dateString) {
        if (!dateString) return "Unknown";
        const date = new Date(dateString);
        return date.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      }

      // Customer profile action functions
      function editCustomer(customerId) {
        console.log(`✏️ Editing customer: ${customerId}`);
        alert("Edit customer functionality coming soon!");
      }

      function addVehicleForCustomer(customerId) {
        console.log(`🚗 Adding vehicle for customer: ${customerId}`);
        alert("Add vehicle functionality coming soon!");
      }

      function createJobForCustomer(customerId) {
        console.log(`🔧 Creating job for customer: ${customerId}`);
        alert("Create job functionality coming soon!");
      }

      function sendSMSToCustomer(customerId) {
        console.log(`📱 Sending SMS to customer: ${customerId}`);
        alert("SMS functionality coming soon!");
      }

      // Document functions
      function viewDocument(documentId) {
        console.log(`📄 Viewing document: ${documentId}`);
        window.open(`/api/document/${documentId}/view`, "_blank");
      }

      function downloadDocument(documentId, event) {
        event.stopPropagation();
        console.log(`⬇️ Downloading document: ${documentId}`);
        window.open(`/api/document/${documentId}/download`, "_blank");
      }

      function shareDocument(documentId, event) {
        event.stopPropagation();
        console.log(`🔗 Sharing document: ${documentId}`);
        alert("Document sharing functionality coming soon!");
      }

      function uploadDocument(customerId) {
        console.log(`📤 Uploading document for customer: ${customerId}`);
        alert("Document upload functionality coming soon!");
      }

      function refreshDocuments(customerId) {
        console.log(`🔄 Refreshing documents for customer: ${customerId}`);
        loadCustomerDocuments(customerId);
      }

      // Vehicle functions
      function addVehicle() {
        console.log("🚗 Adding new vehicle...");
        alert("Add Vehicle form coming soon!");
      }

      function bulkUpload() {
        console.log("📤 Bulk upload vehicles...");
        alert("Bulk upload feature coming soon!");
      }

      async function viewVehicle(registration) {
        console.log(`🚗 Viewing vehicle: ${registration}`);
        try {
          const response = await fetch(`/api/vehicles/${registration}`);
          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              showVehicleProfile(data);
            } else {
              throw new Error(data.error);
            }
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("❌ Failed to load vehicle:", error);
          alert(`Failed to load vehicle details: ${error.message}`);
        }
      }

      function showVehicleProfile(data) {
        const vehicle = data.vehicle;
        const jobs = data.jobs || [];
        const invoices = data.invoices || [];
        const customer = data.customer || {};

        // Create vehicle profile modal
        const modal = document.createElement("div");
        modal.className = "customer-profile-modal"; // Reuse customer modal styles
        modal.innerHTML = `
                <div class="modal-overlay" onclick="closeVehicleProfile()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-car"></i> ${vehicle.registration || "Unknown Vehicle"}</h2>
                        <button class="modal-close" onclick="closeVehicleProfile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="customer-profile-tabs">
                            <button class="tab-btn active" onclick="showVehicleTab('details')">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                            <button class="tab-btn" onclick="showVehicleTab('history')">
                                <i class="fas fa-history"></i> Service History (${jobs.length})
                            </button>
                            <button class="tab-btn" onclick="showVehicleTab('invoices')">
                                <i class="fas fa-file-invoice"></i> Invoices (${invoices.length})
                            </button>
                            <button class="tab-btn" onclick="showVehicleTab('mot')">
                                <i class="fas fa-car-crash"></i> MOT & Tax
                            </button>
                        </div>

                        <div class="tab-content">
                            <div id="details-tab" class="tab-pane active">
                                <div class="customer-details-grid">
                                    <div class="detail-card">
                                        <h4><i class="fas fa-car"></i> Vehicle Information</h4>
                                        <div class="detail-row">
                                            <span class="label">Registration:</span>
                                            <span class="value">${vehicle.registration || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Make:</span>
                                            <span class="value">${vehicle.make || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Model:</span>
                                            <span class="value">${vehicle.model || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Year:</span>
                                            <span class="value">${vehicle.year || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Color:</span>
                                            <span class="value">${vehicle.color || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Engine Size:</span>
                                            <span class="value">${vehicle.engine_size || "N/A"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Fuel Type:</span>
                                            <span class="value">${vehicle.fuel_type || "N/A"}</span>
                                        </div>
                                    </div>
                                    <div class="detail-card">
                                        <h4><i class="fas fa-user"></i> Owner Information</h4>
                                        <div class="detail-row">
                                            <span class="label">Customer:</span>
                                            <span class="value">
                                                <a href="#" onclick="viewCustomer(${customer.id}); closeVehicleProfile();">
                                                    ${customer.name || "Unknown"}
                                                </a>
                                            </span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Phone:</span>
                                            <span class="value">
                                                <a href="tel:${customer.phone || ""}">${customer.phone || "N/A"}</a>
                                            </span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Email:</span>
                                            <span class="value">
                                                <a href="mailto:${customer.email || ""}">${customer.email || "N/A"}</a>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="detail-card">
                                        <h4><i class="fas fa-chart-line"></i> Service Statistics</h4>
                                        <div class="detail-row">
                                            <span class="label">Total Services:</span>
                                            <span class="value">${jobs.length}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Total Spent:</span>
                                            <span class="value">£${invoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0).toFixed(2)}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Last Service:</span>
                                            <span class="value">${jobs.length > 0 ? formatDate(jobs[0].created_date) : "Never"}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="customer-actions">
                                    <button class="btn" onclick="createJobForVehicle('${vehicle.registration}')">
                                        <i class="fas fa-wrench"></i> New Service
                                    </button>
                                    <button class="btn btn-secondary" onclick="checkMOTForVehicle('${vehicle.registration}')">
                                        <i class="fas fa-search"></i> Check MOT
                                    </button>
                                    <button class="btn btn-secondary" onclick="editVehicle('${vehicle.registration}')">
                                        <i class="fas fa-edit"></i> Edit Vehicle
                                    </button>
                                </div>
                            </div>

                            <div id="history-tab" class="tab-pane">
                                <div class="jobs-list">
                                    ${
                                      jobs.length > 0
                                        ? jobs
                                            .map(
                                              (job) => `
                                        <div class="job-card" onclick="viewJob('${job.id}')">
                                            <div class="job-header">
                                                <h4><i class="fas fa-wrench"></i> ${formatDate(job.created_date)}</h4>
                                                <span class="job-status status-${job.status}">${job.status || "Unknown"}</span>
                                            </div>
                                            <div class="job-details">
                                                <p><strong>${job.description || "No description"}</strong></p>
                                                <p>Job #: ${job.job_number || job.id}</p>
                                                <p>Labour: £${job.labour_cost || "0.00"}</p>
                                                <p>Parts: £${job.parts_cost || "0.00"}</p>
                                                <p><strong>Total: £${job.total_amount || "0.00"}</strong></p>
                                            </div>
                                        </div>
                                    `,
                                            )
                                            .join("")
                                        : "<p>No service history found for this vehicle.</p>"
                                    }
                                </div>
                            </div>

                            <div id="invoices-tab" class="tab-pane">
                                <div class="invoices-list">
                                    ${
                                      invoices.length > 0
                                        ? invoices
                                            .map(
                                              (invoice) => `
                                        <div class="invoice-card" onclick="viewInvoice('${invoice.id}')">
                                            <div class="invoice-header">
                                                <h4><i class="fas fa-file-invoice"></i> Invoice #${invoice.invoice_number || invoice.id}</h4>
                                                <span class="invoice-amount">£${invoice.total_amount || "0.00"}</span>
                                            </div>
                                            <div class="invoice-details">
                                                <p>Date: ${formatDate(invoice.invoice_date)}</p>
                                                <p>Due: ${formatDate(invoice.due_date)}</p>
                                                <p>Status: ${invoice.status || "Unknown"}</p>
                                            </div>
                                        </div>
                                    `,
                                            )
                                            .join("")
                                        : "<p>No invoices found for this vehicle.</p>"
                                    }
                                </div>
                            </div>

                            <div id="mot-tab" class="tab-pane">
                                <div class="customer-details-grid">
                                    <div class="detail-card">
                                        <h4><i class="fas fa-car-crash"></i> MOT Information</h4>
                                        <div class="detail-row">
                                            <span class="label">MOT Due:</span>
                                            <span class="value ${vehicle.mot_due && new Date(vehicle.mot_due) < new Date() ? "text-danger" : ""}">${vehicle.mot_due || "Unknown"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">MOT Status:</span>
                                            <span class="value">${getMOTStatus(vehicle.mot_due)}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Days Until Due:</span>
                                            <span class="value">${getDaysUntilDue(vehicle.mot_due)}</span>
                                        </div>
                                    </div>
                                    <div class="detail-card">
                                        <h4><i class="fas fa-pound-sign"></i> Tax Information</h4>
                                        <div class="detail-row">
                                            <span class="label">Tax Due:</span>
                                            <span class="value ${vehicle.tax_due && new Date(vehicle.tax_due) < new Date() ? "text-danger" : ""}">${vehicle.tax_due || "Unknown"}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Tax Status:</span>
                                            <span class="value">${getTaxStatus(vehicle.tax_due)}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Days Until Due:</span>
                                            <span class="value">${getDaysUntilDue(vehicle.tax_due)}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="customer-actions">
                                    <button class="btn" onclick="bookMOT('${vehicle.registration}')">
                                        <i class="fas fa-calendar-plus"></i> Book MOT
                                    </button>
                                    <button class="btn btn-secondary" onclick="sendMOTReminder('${vehicle.registration}')">
                                        <i class="fas fa-sms"></i> Send Reminder
                                    </button>
                                    <button class="btn btn-secondary" onclick="checkDVLAData('${vehicle.registration}')">
                                        <i class="fas fa-search"></i> Check DVLA
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
        console.log("✅ Vehicle profile displayed");
      }

      function closeVehicleProfile() {
        const modal = document.querySelector(".customer-profile-modal");
        if (modal) {
          modal.remove();
          console.log("✅ Vehicle profile closed");
        }
      }

      function showVehicleTab(tabName) {
        // Remove active class from all tabs and panes
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-pane")
          .forEach((pane) => pane.classList.remove("active"));

        // Add active class to selected tab and pane
        document
          .querySelector(`[onclick*="${tabName}"]`)
          .classList.add("active");
        document.getElementById(`${tabName}-tab`).classList.add("active");

        console.log(`📋 Switched to ${tabName} tab`);
      }

      function getMOTStatus(motDue) {
        if (!motDue) return "Unknown";
        const dueDate = new Date(motDue);
        const today = new Date();
        const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

        if (daysUntil < 0) return "❌ Expired";
        if (daysUntil <= 30) return "⚠️ Due Soon";
        return "✅ Valid";
      }

      function getTaxStatus(taxDue) {
        if (!taxDue) return "Unknown";
        const dueDate = new Date(taxDue);
        const today = new Date();
        const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

        if (daysUntil < 0) return "❌ Expired";
        if (daysUntil <= 30) return "⚠️ Due Soon";
        return "✅ Valid";
      }

      function getDaysUntilDue(dueDate) {
        if (!dueDate) return "Unknown";
        const due = new Date(dueDate);
        const today = new Date();
        const daysUntil = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

        if (daysUntil < 0) return `${Math.abs(daysUntil)} days overdue`;
        return `${daysUntil} days`;
      }

      // Vehicle action functions
      function createJobForVehicle(registration) {
        console.log(`🔧 Creating job for vehicle: ${registration}`);
        alert("Create job for vehicle functionality coming soon!");
      }

      function checkMOTForVehicle(registration) {
        console.log(`🔍 Checking MOT for vehicle: ${registration}`);
        alert("MOT check functionality coming soon!");
      }

      function editVehicle(registration) {
        console.log(`✏️ Editing vehicle: ${registration}`);
        alert("Edit vehicle functionality coming soon!");
      }

      function bookMOT(registration) {
        console.log(`📅 Booking MOT for vehicle: ${registration}`);
        alert("MOT booking functionality coming soon!");
      }

      function sendMOTReminder(registration) {
        console.log(`📱 Sending MOT reminder for vehicle: ${registration}`);
        alert("MOT reminder functionality coming soon!");
      }

      function checkDVLAData(registration) {
        console.log(`🔍 Checking DVLA data for vehicle: ${registration}`);
        alert("DVLA data check functionality coming soon!");
      }

      // Job functions
      function createJob() {
        console.log("🔧 Creating new job...");
        alert("Create Job form coming soon!");
      }

      function showJobTemplates() {
        console.log("📋 Showing job templates...");
        alert("Job templates feature coming soon!");
      }

      function viewJob(id) {
        console.log(`🔧 Viewing job: ${id}`);
        alert(`Job details for ID: ${id}`);
      }

      // MOT functions
      function checkMOTExpiry() {
        console.log("🔍 Checking MOT expiry...");
        loadMOTData();
      }

      function sendReminders() {
        console.log("📱 Sending MOT reminders...");
        alert("Bulk SMS reminders feature coming soon!");
      }

      function sendMOTReminder(id) {
        console.log(`📱 Sending MOT reminder: ${id}`);
        alert(`Sending SMS reminder for: ${id}`);
      }

      // Settings functions
      function showUploadPage() {
        console.log("📤 Opening upload page...");
        window.open("/upload", "_blank");
      }

      function exportData() {
        console.log("📥 Exporting data...");
        alert("Data export feature coming soon!");
      }

      function backupData() {
        console.log("💾 Creating backup...");
        alert("Backup feature coming soon!");
      }

      function configureSMS() {
        console.log("📱 Configuring SMS...");
        alert("SMS configuration coming soon!");
      }

      // Workshop functions
      function addAppointment() {
        console.log("📅 Adding appointment...");
        alert("Add Appointment feature coming soon!");
      }

      function viewCalendar() {
        console.log("📅 Opening calendar view...");
        alert("Calendar view coming soon!");
      }

      function createJobSheet() {
        console.log("📋 Creating job sheet...");
        alert("Job sheet creation coming soon!");
      }

      function printJobSheets() {
        console.log("🖨️ Printing job sheets...");
        alert("Print job sheets coming soon!");
      }

      function createQuote() {
        console.log("💰 Creating quote...");
        alert("Quote creation coming soon!");
      }

      function quoteTemplates() {
        console.log("📄 Opening quote templates...");
        alert("Quote templates coming soon!");
      }

      // Online services functions
      function configureBooking() {
        console.log("⚙️ Configuring online booking...");
        alert("Booking configuration coming soon!");
      }

      function viewBookingPage() {
        console.log("🌐 Opening booking page...");
        window.open("/booking", "_blank");
      }

      function configurePortal() {
        console.log("⚙️ Configuring customer portal...");
        alert("Portal configuration coming soon!");
      }

      function viewPortal() {
        console.log("🌐 Opening customer portal...");
        alert("Customer portal coming soon!");
      }

      // Parts functions
      function addPart() {
        console.log("🔧 Adding part...");
        alert("Add part feature coming soon!");
      }

      function orderParts() {
        console.log("🛒 Ordering parts...");
        alert("Parts ordering coming soon!");
      }

      // Invoice functions
      function createInvoice() {
        console.log("📄 Creating invoice...");
        alert("Invoice creation coming soon!");
      }

      function exportInvoices() {
        console.log("📥 Exporting invoices...");
        alert("Invoice export coming soon!");
      }

      // Reports functions
      function generateReport() {
        console.log("📊 Generating report...");
        alert("Report generation coming soon!");
      }

      function scheduleReports() {
        console.log("⏰ Scheduling reports...");
        alert("Report scheduling coming soon!");
      }

      // Initialization
      function initializeApp() {
        console.log("🚀 Initializing GarageManager Pro...");
        console.log(
          "🍎 Safari version:",
          navigator.userAgent.match(/Version\/([0-9\.]+)/)?.[1] || "Unknown",
        );

        // Safari-specific initialization
        if (isSafari) {
          console.log("🍎 Applying Safari optimizations...");

          // Force immediate visibility
          setTimeout(() => {
            const dashboard = document.getElementById("dashboard");
            if (dashboard) {
              dashboard.style.display = "block";
              dashboard.style.opacity = "1";
              dashboard.style.visibility = "visible";
              dashboard.classList.add("active");
              console.log("🍎 Dashboard forced visible");
            }
          }, 100);
        }

        // Load initial dashboard data
        setTimeout(() => {
          loadDashboardData();
        }, 500);

        console.log("✅ App initialization complete");
      }

      // Error handling
      window.addEventListener("error", function (event) {
        console.error(
          "❌ Global error:",
          event.error?.message || event.message,
        );
      });

      window.addEventListener("unhandledrejection", function (event) {
        console.error("❌ Unhandled promise rejection:", event.reason);
      });

      // Initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeApp);
      } else {
        initializeApp();
      }

      // Expose functions globally for onclick handlers
      window.showPage = showPage;
      window.refreshData = refreshData;
      window.showNotifications = showNotifications;
      window.showHelp = showHelp;
      window.addCustomer = addCustomer;
      window.importCustomers = importCustomers;
      window.viewCustomer = viewCustomer;
      window.addVehicle = addVehicle;
      window.bulkUpload = bulkUpload;
      window.viewVehicle = viewVehicle;
      window.createJob = createJob;
      window.showJobTemplates = showJobTemplates;
      window.viewJob = viewJob;
      window.checkMOTExpiry = checkMOTExpiry;
      window.sendReminders = sendReminders;
      window.sendMOTReminder = sendMOTReminder;
      window.showUploadPage = showUploadPage;
      window.exportData = exportData;
      window.backupData = backupData;
      window.configureSMS = configureSMS;
      window.clearConsole = clearConsole;
      window.addAppointment = addAppointment;
      window.viewCalendar = viewCalendar;
      window.createJobSheet = createJobSheet;
      window.printJobSheets = printJobSheets;
      window.createQuote = createQuote;
      window.quoteTemplates = quoteTemplates;
      window.configureBooking = configureBooking;
      window.viewBookingPage = viewBookingPage;
      window.configurePortal = configurePortal;
      window.viewPortal = viewPortal;
      window.addPart = addPart;
      window.orderParts = orderParts;
      window.createInvoice = createInvoice;
      window.exportInvoices = exportInvoices;
      window.generateReport = generateReport;
      window.scheduleReports = scheduleReports;

      // Customer profile functions
      window.closeCustomerProfile = closeCustomerProfile;
      window.showProfileTab = showProfileTab;
      window.loadCustomerDocuments = loadCustomerDocuments;
      window.editCustomer = editCustomer;
      window.addVehicleForCustomer = addVehicleForCustomer;
      window.createJobForCustomer = createJobForCustomer;
      window.sendSMSToCustomer = sendSMSToCustomer;
      window.viewDocument = viewDocument;
      window.downloadDocument = downloadDocument;
      window.shareDocument = shareDocument;
      window.uploadDocument = uploadDocument;
      window.refreshDocuments = refreshDocuments;

      // Vehicle profile functions
      window.closeVehicleProfile = closeVehicleProfile;
      window.showVehicleTab = showVehicleTab;
      window.createJobForVehicle = createJobForVehicle;
      window.checkMOTForVehicle = checkMOTForVehicle;
      window.editVehicle = editVehicle;
      window.bookMOT = bookMOT;
      window.sendMOTReminder = sendMOTReminder;
      window.checkDVLAData = checkDVLAData;

      console.log("✅ GarageManager Pro loaded successfully");
    </script>
  </body>
</html>
