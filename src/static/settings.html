<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>System Settings - Garage Management System</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/modern-layout.css" />
    <link rel="stylesheet" href="/css/components.css" />

    <style>
      .settings-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .settings-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
      }

      .settings-nav {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .settings-nav .nav-link {
        padding: 15px 25px;
        border-radius: 15px;
        margin: 5px;
        transition: all 0.3s ease;
      }

      .settings-nav .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .settings-nav .nav-link:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
      }

      .settings-content {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
        min-height: 600px;
      }

      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .back-button:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .iframe-container {
        width: 100%;
        height: 600px;
        border: none;
        border-radius: 10px;
        overflow: hidden;
      }

      .embedded-content {
        width: 100%;
        min-height: 600px;
        border: none;
        background: transparent;
      }
    </style>
  </head>
  <body>
    <!-- Back Button -->
    <button class="back-button" onclick="goBack()">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </button>

    <div class="settings-container">
      <!-- Header -->
      <div class="settings-header">
        <h1><i class="fas fa-cogs"></i> System Settings</h1>
        <p class="mb-0">
          Configure system settings, manage data imports, and monitor system
          health
        </p>
      </div>

      <!-- Navigation Tabs -->
      <div class="settings-nav">
        <ul
          class="nav nav-pills justify-content-center"
          id="settingsTabs"
          role="tablist"
        >
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="data-upload-tab"
              data-bs-toggle="pill"
              data-bs-target="#data-upload"
              type="button"
              role="tab"
            >
              <i class="fas fa-upload"></i> Data Upload
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="google-drive-tab"
              data-bs-toggle="pill"
              data-bs-target="#google-drive"
              type="button"
              role="tab"
            >
              <i class="fab fa-google-drive"></i> Google Drive
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="system-config-tab"
              data-bs-toggle="pill"
              data-bs-target="#system-config"
              type="button"
              role="tab"
            >
              <i class="fas fa-server"></i> System Config
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="mot-settings-tab"
              data-bs-toggle="pill"
              data-bs-target="#mot-settings"
              type="button"
              role="tab"
            >
              <i class="fas fa-car"></i> MOT Settings
            </button>
          </li>
        </ul>
      </div>

      <!-- Tab Content -->
      <div class="settings-content">
        <div class="tab-content" id="settingsTabContent">
          <!-- Data Upload Tab -->
          <div
            class="tab-pane fade show active"
            id="data-upload"
            role="tabpanel"
          >
            <div id="uploadContent" class="embedded-content">
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading upload interface...</p>
              </div>
            </div>
          </div>

          <!-- Google Drive Tab -->
          <div class="tab-pane fade" id="google-drive" role="tabpanel">
            <div id="googleDriveContent" class="embedded-content">
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading Google Drive integration...</p>
              </div>
            </div>
          </div>

          <!-- System Config Tab -->
          <div class="tab-pane fade" id="system-config" role="tabpanel">
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h5><i class="fas fa-database"></i> Database Status</h5>
                  </div>
                  <div class="card-body">
                    <div id="dbStatus">Loading...</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h5><i class="fas fa-heartbeat"></i> System Health</h5>
                  </div>
                  <div class="card-body">
                    <div id="systemHealth">Loading...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- MOT Settings Tab -->
          <div class="tab-pane fade" id="mot-settings" role="tabpanel">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h5><i class="fas fa-car"></i> MOT System Configuration</h5>
                  </div>
                  <div class="card-body">
                    <p>
                      Configure MOT system settings, DVSA API credentials, and
                      notification preferences.
                    </p>
                    <div class="alert alert-info">
                      <i class="fas fa-info-circle"></i> MOT settings are
                      configured and working with DVSA API integration.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Debug System -->
    <script src="/js/debug-system.js"></script>

    <script>
      // Navigation function
      function goBack() {
        window.history.back();
      }

      // Load content functions
      async function loadUploadContent() {
        const contentDiv = document.getElementById("uploadContent");
        try {
          const response = await fetch("/upload");
          const html = await response.text();

          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          // Extract the main content (everything after the header)
          const mainContent = doc.querySelector(".container") || doc.body;

          if (mainContent) {
            contentDiv.innerHTML = mainContent.innerHTML;

            // Re-execute scripts
            const scripts = contentDiv.querySelectorAll("script");
            scripts.forEach((script) => {
              const newScript = document.createElement("script");
              if (script.src) {
                newScript.src = script.src;
              } else {
                newScript.textContent = script.textContent;
              }
              document.head.appendChild(newScript);
            });
          }
        } catch (error) {
          console.error("Failed to load upload content:", error);
          contentDiv.innerHTML = `
            <div class="alert alert-danger">
              <h5>Error Loading Upload Interface</h5>
              <p>Unable to load the upload interface. Please try refreshing the page.</p>
              <button class="btn btn-primary" onclick="loadUploadContent()">Retry</button>
            </div>
          `;
        }
      }

      async function loadGoogleDriveContent() {
        const contentDiv = document.getElementById("googleDriveContent");
        try {
          const response = await fetch("/google-drive/");
          const html = await response.text();

          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          const mainContent = doc.querySelector(".container") || doc.body;

          if (mainContent) {
            // Remove any back buttons and replace with settings-specific ones
            const backButtons = mainContent.querySelectorAll(
              'a[href*="dashboard"], button[onclick*="back"]',
            );
            backButtons.forEach((btn) => {
              btn.style.display = "none";
            });

            contentDiv.innerHTML = mainContent.innerHTML;
          }
        } catch (error) {
          console.error("Failed to load Google Drive content:", error);
          contentDiv.innerHTML = `
            <div class="alert alert-danger">
              <h5>Error Loading Google Drive</h5>
              <p>Unable to load Google Drive integration. Please try refreshing the page.</p>
              <button class="btn btn-primary" onclick="loadGoogleDriveContent()">Retry</button>
            </div>
          `;
        }
      }

      async function loadSystemStatus() {
        try {
          const healthResponse = await fetch("/health");
          const health = await healthResponse.json();

          const statusResponse = await fetch("/api/status");
          const status = await statusResponse.json();

          document.getElementById("systemHealth").innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i> System is healthy
            </div>
          `;

          document.getElementById("dbStatus").innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-database"></i> Database connected
            </div>
            <small class="text-muted">Records: ${Object.values(status.counts).reduce((a, b) => a + b, 0)} total</small>
          `;
        } catch (error) {
          document.getElementById("systemHealth").innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i> Unable to check system status
            </div>
          `;
        }
      }

      // Tab event listeners
      document.addEventListener("DOMContentLoaded", function () {
        // Load initial content
        loadUploadContent();
        loadSystemStatus();

        // Tab switching
        const dataUploadTab = document.getElementById("data-upload-tab");
        const googleDriveTab = document.getElementById("google-drive-tab");
        const systemConfigTab = document.getElementById("system-config-tab");

        dataUploadTab.addEventListener("shown.bs.tab", loadUploadContent);
        googleDriveTab.addEventListener("shown.bs.tab", loadGoogleDriveContent);
        systemConfigTab.addEventListener("shown.bs.tab", loadSystemStatus);
      });
    </script>
  </body>
</html>
