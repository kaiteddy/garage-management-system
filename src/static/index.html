<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GarageManager Pro - Professional Garage Management System</title>

    <!-- EMERGENCY CRASH PREVENTION - Load First -->
    <script>
        (function() {
            'use strict';
            console.log('üö® EMERGENCY CRASH PREVENTION LOADING...');

            // Immediate error catching
            window.addEventListener('error', function(event) {
                console.log('üõ°Ô∏è Emergency caught error:', event.error?.message || 'Unknown');
                event.preventDefault();
                return true;
            });

            window.addEventListener('unhandledrejection', function(event) {
                console.log('üõ°Ô∏è Emergency caught rejection:', event.reason);
                event.preventDefault();
            });

            // Safe property access
            window.safeAccess = function(obj, path, defaultValue = null) {
                try {
                    if (!obj) return defaultValue;
                    const keys = path.split('.');
                    let current = obj;
                    for (const key of keys) {
                        if (current === null || current === undefined) return defaultValue;
                        current = current[key];
                    }
                    return current !== undefined ? current : defaultValue;
                } catch (e) {
                    return defaultValue;
                }
            };

            // Emergency cleanup
            window.emergencyCleanup = function() {
                console.log('üö® EMERGENCY CLEANUP');
                try {
                    // Clear intervals and timeouts
                    for (let i = 1; i < 10000; i++) {
                        clearInterval(i);
                        clearTimeout(i);
                    }
                } catch (e) {}
            };

            console.log('‚úÖ Emergency protection active');
        })();
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <!-- Kanban Board Styles -->
    <link rel="stylesheet" href="css/kanban-board.css">
    <!-- Workshop Diary Styles -->
    <link rel="stylesheet" href="css/workshop-diary.css">
    <!-- Job Sheets & Quotes Styles -->
    <link rel="stylesheet" href="css/job-sheets.css">
    <!-- Temporarily removing enhanced CSS to fix conflicts -->
    <!-- <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/enhanced-garage-ui.css"> -->
    <!-- External CSS Files -->
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/modern-layout.css">
    <style>
        /* Critical inline styles only - moved most to external files */

        /* Minimal critical styles - most moved to external files */

        /* Moved to components.css */

        /* Moved to components.css */

        /* Moved to components.css */

        .data-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            border: 1px solid #d0d0d0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        .data-table th,
        .data-table td {
            padding: 4px 6px; /* Very compact padding like the reference */
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
            border-right: 1px solid #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 11px; /* Small, readable font */
            line-height: 1.3; /* Tight line height */
        }

        .data-table th {
            background: linear-gradient(135deg, var(--gray-700) 0%, var(--gray-800) 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-size: 11px;
            padding: 8px 6px;
            border-right: 1px solid var(--gray-600);
            border-bottom: 1px solid var(--gray-600);
        }

        .data-table td {
            font-weight: 400; /* Normal weight for readability */
            color: #333;
        }

        .data-table tr:hover {
            background: #f0f4ff; /* Light blue hover like reference */
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9; /* Light gray for even rows */
        }

        .data-table tr:nth-child(odd) {
            background-color: #ffffff; /* White for odd rows */
        }

        /* Action buttons in tables - compact style like reference */
        .data-table .action-btn {
            padding: 2px 4px;
            margin: 0 1px;
            border: none;
            border-radius: 2px;
            font-size: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            min-width: 20px;
            text-align: center;
        }

        .data-table .action-btn:hover {
            opacity: 0.8;
        }

        .action-btn.btn-view { background: #17a2b8; color: white; }
        .action-btn.btn-edit { background: #28a745; color: white; }
        .action-btn.btn-delete { background: #dc3545; color: white; }
        .action-btn.btn-print { background: #6c757d; color: white; }

        /* Quote Detail Modal Styles */
        .quote-detail {
            padding: 1rem;
        }

        .quote-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .info-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .info-section h4 {
            color: #6b5b95;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .info-section p {
            margin-bottom: 0.5rem;
            font-size: 11px;
            line-height: 1.4;
        }

        .description-content,
        .notes-content {
            background: white;
            padding: 0.75rem;
            border-radius: 3px;
            border: 1px solid #e9ecef;
            font-size: 11px;
            line-height: 1.4;
        }

        .quote-breakdown {
            margin-bottom: 2rem;
        }

        .cost-table {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            font-size: 11px;
            border-bottom: 1px solid #f0f0f0;
        }

        .cost-row:last-child {
            border-bottom: none;
        }

        .cost-row.subtotal {
            background: #f8f9fa;
            font-weight: 500;
        }

        .cost-row.total {
            background: #6b5b95;
            color: white;
            font-weight: 600;
        }

        .quote-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .quote-actions .btn {
            font-size: 11px;
            padding: 6px 12px;
        }

        .text-danger {
            color: #dc3545 !important;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .quote-info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .quote-actions {
                flex-direction: column;
            }

            .quote-actions .btn {
                width: 100%;
            }
        }

        /* Quote Detail Modal Styles */
        .quote-detail {
            padding: 1rem;
        }

        .quote-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .info-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .info-section h4 {
            color: #6b5b95;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .info-section p {
            margin-bottom: 0.5rem;
            font-size: 11px;
            line-height: 1.4;
        }

        .description-content,
        .notes-content {
            background: white;
            padding: 0.75rem;
            border-radius: 3px;
            border: 1px solid #e9ecef;
            font-size: 11px;
            line-height: 1.4;
        }

        .quote-breakdown {
            margin-bottom: 2rem;
        }

        .cost-table {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            font-size: 11px;
            border-bottom: 1px solid #f0f0f0;
        }

        .cost-row:last-child {
            border-bottom: none;
        }

        .cost-row.subtotal {
            background: #f8f9fa;
            font-weight: 500;
        }

        .cost-row.total {
            background: #6b5b95;
            color: white;
            font-weight: 600;
        }

        .quote-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .quote-actions .btn {
            font-size: 11px;
            padding: 6px 12px;
        }

        .text-danger {
            color: #dc3545 !important;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .quote-info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .quote-actions {
                flex-direction: column;
            }

            .quote-actions .btn {
                width: 100%;
            }
        }

        /* Column width management - Optimized for MOT table */
        .data-table .col-narrow {
            width: 5%;
            min-width: 50px;
        }

        .data-table .col-medium {
            width: 8%;
            min-width: 80px;
        }

        .data-table .col-wide {
            width: 12%;
            min-width: 120px;
        }

        .data-table .col-extra-wide {
            width: 15%;
            min-width: 150px;
        }

        .data-table .col-actions {
            width: 7%;
            min-width: 70px;
            text-align: center;
        }

        /* MOT Table specific optimizations */
        #mot-vehicles-table-body .col-narrow {
            width: 4%;
            min-width: 45px;
        }

        #mot-vehicles-table-body .col-medium {
            width: 7%;
            min-width: 70px;
        }

        #mot-vehicles-table-body .col-wide {
            width: 10%;
            min-width: 100px;
        }

        /* Hide less critical columns on smaller screens */
        @media (max-width: 1400px) {
            .data-table th:nth-child(10), /* Uploaded */
            .data-table td:nth-child(10) {
                display: none;
            }
        }

        @media (max-width: 1200px) {
            .data-table th:nth-child(11), /* SMS Sent */
            .data-table td:nth-child(11),
            .data-table th:nth-child(12), /* Verified */
            .data-table td:nth-child(12) {
                display: none;
            }
        }

        @media (max-width: 1000px) {
            .data-table th:nth-child(9), /* SMS Status */
            .data-table td:nth-child(9) {
                display: none;
            }
        }

        @media (max-width: 800px) {
            .data-table th:nth-child(8), /* Mobile */
            .data-table td:nth-child(8) {
                display: none;
            }
        }

        /* Very small screens - show only essential columns */
        @media (max-width: 600px) {
            .table-wrapper {
                overflow-x: auto; /* Re-enable scroll for very small screens */
            }

            .data-table th:nth-child(3), /* Make/Model */
            .data-table td:nth-child(3),
            .data-table th:nth-child(6), /* Days Left */
            .data-table td:nth-child(6) {
                display: none;
            }
        }

        .status-badge {
            padding: 2px 6px; /* Compact padding like reference */
            border-radius: 3px; /* Small border radius */
            font-size: 10px; /* Small font to match table */
            font-weight: 600; /* Bold for visibility */
            text-transform: uppercase;
            letter-spacing: 0.3px; /* Tight letter spacing */
            display: inline-block;
            min-width: 50px;
            text-align: center;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-overdue { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-locked { background: #f8d7da; color: #721c24; }

        .clickable-row {
            transition: background-color 0.2s ease;
        }

        .clickable-row:hover {
            background-color: #f8f9fa !important;
        }

        .clickable-row:active {
            background-color: #e9ecef !important;
        }

        /* Enhanced typography for section headers */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        h1 { font-size: 2.25rem; }
        h2 { font-size: 1.875rem; font-variant: small-caps; letter-spacing: 0.05em; }
        h3 { font-size: 1.5rem; font-variant: small-caps; letter-spacing: 0.025em; }
        h4 { font-size: 1.25rem; }
        h5 { font-size: 1.125rem; }
        h6 { font-size: 1rem; }

        /* Enhanced typography for invoice sections */
        .invoice-section h3 {
            font-size: 1.25rem;
            font-variant: small-caps;
            letter-spacing: 0.05em;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Enhanced typography for modal titles */
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            font-variant: small-caps;
            letter-spacing: 0.05em;
        }

        /* Bootstrap-like Grid System for Upload Page */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin-left: -0.75rem;
            margin-right: -0.75rem;
        }

        .col-12 {
            flex: 0 0 100%;
            max-width: 100%;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        /* Bootstrap-like Spacing Utilities */
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mt-4 { margin-top: 1.5rem; }
        .ms-1 { margin-left: 0.25rem; }

        /* Bootstrap-like Form Classes */
        .form-label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
            display: block;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            color: #495057;
            background-color: #fff;
            border-color: #667eea;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .form-check {
            position: relative;
            display: block;
            padding-left: 1.25rem;
        }

        .form-check-input {
            position: absolute;
            margin-top: 0.3rem;
            margin-left: -1.25rem;
        }

        .form-check-label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .text-muted {
            color: #6c757d;
        }

        .text-center {
            text-align: center;
        }

        .w-100 {
            width: 100%;
        }

        /* Responsive Grid */
        @media (max-width: 768px) {
            .col-md-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }

            /* Responsive page layout */
            .page {
                padding: 1rem;
            }

            /* Responsive page headers */
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            /* Responsive search boxes */
            .search-box {
                max-width: 100%;
                margin-bottom: 1rem;
            }

            /* Responsive button groups */
            .button-group {
                flex-direction: column;
                width: 100%;
            }

            .button-group .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            /* Responsive tables */
            .table-responsive {
                font-size: 0.875rem;
            }

            /* Responsive quick MOT check */
            #quickMOTResult .alert {
                font-size: 0.9rem;
                padding: 1rem;
            }

            /* Ensure full width on mobile */
            .table-container,
            .card,
            .upload-zone {
                width: 100%;
                margin-left: 0;
                margin-right: 0;
            }
        }

        /* Tablet responsive improvements */
        @media (max-width: 1024px) and (min-width: 769px) {
            .sidebar {
                width: 240px;
            }

            .nav-item {
                font-size: 14px;
                padding: 0.875rem 1.25rem;
            }
        }

        /* Additional responsive improvements */
        @media (max-width: 480px) {
            .page-title {
                font-size: 1.25rem;
            }

            .search-box input {
                padding: 0.875rem 1rem 0.875rem 3rem;
                font-size: 0.9rem;
            }

            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Upload Zone Styling */
        .upload-zone {
            border: 2px dashed #ced4da;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 1rem 0;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .upload-zone h4 {
            color: #495057;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .upload-zone p {
            color: #6c757d;
            margin-bottom: 1.5rem;
        }

        /* Progress Container */
        .progress-container {
            margin: 1.5rem 0;
        }

        .progress {
            height: 1rem;
            background-color: #e9ecef;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            transition: width 0.3s ease;
        }

        /* Results Container */
        .results-container {
            margin-top: 2rem;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .template-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .template-icon {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .template-card h6 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .template-card p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .btn-outline-primary {
            color: #667eea;
            border: 1px solid #667eea;
            background: transparent;
        }

        .btn-outline-primary:hover {
            color: white;
            background: #667eea;
            border-color: #667eea;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        /* Additional Upload Page Components */
        .table-selector {
            margin-bottom: 1rem;
        }

        .file-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .form-text {
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }

        .bg-light {
            background-color: #f8f9fa;
        }

        .text-dark {
            color: #212529;
        }

        /* Card body styling */
        .card-body {
            padding: 2rem;
            width: 100%;
            box-sizing: border-box;
        }

        /* Ensure upload page content fills full width */
        #upload-page .row {
            width: 100%;
            margin: 0;
        }

        #upload-page .col-12,
        #upload-page .col-md-6 {
            width: 100%;
            max-width: 100%;
            padding: 0.75rem;
        }

        /* Full width containers */
        .full-width-container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
        }

        /* Ensure all page content uses full width */
        .page-content {
            width: 100%;
            max-width: none;
        }

        /* Additional utility classes */
        .mb-0 { margin-bottom: 0; }
        .mt-2 { margin-top: 0.5rem; }

        /* Button group styling */
        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Help text styling */
        .help-text {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: normal;
        }

        /* Form group styling */
        .form-group {
            margin-bottom: 1.5rem;
        }

        /* Connection status styling */
        .connection-status {
            margin-left: 1rem;
            font-weight: 600;
        }

        .connection-status.success {
            color: #28a745;
        }

        .connection-status.error {
            color: #dc3545;
        }

        /* Quick MOT Check Styling */
        #quickMOTResult {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #quickMOTResult .alert {
            margin-bottom: 0;
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #quickMOTResult .alert-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        #quickMOTResult .alert-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        #quickMOTResult .alert-warning {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }

        #quickMOTResult .alert-danger {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        /* Improved page headers visibility */
        .page-header {
            background: white;
            padding: 2rem 2.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            position: relative;
            z-index: 10; /* Ensure headers are always visible */
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-variant: small-caps;
            letter-spacing: 0.05em;
            margin: 0; /* Remove any default margins */
            line-height: 1.2;
        }

        .page-subtitle {
            color: #7f8c8d;
            font-size: 1.05rem;
            margin-top: 0.25rem;
            font-weight: 500;
            margin-bottom: 0; /* Remove any default margins */
        }

        /* Ensure section headers are always visible */
        .table-header,
        .card-header {
            position: relative;
            z-index: 5;
            background: #6b5b95;
            color: white;
            padding: 8px 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-size: 11px;
            margin: 0; /* Remove any default margins */
            border-bottom: 1px solid #5a4a85;
        }
        .status-paid { background: #d4edda; color: #155724; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-completed { background: #d1ecf1; color: #0c5460; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem; /* Increased from 0.5rem for better button spacing */
            padding: 1.5rem; /* Increased from 1rem for more breathing room */
            background: #f8f9fa;
        }

        .pagination button {
            padding: 0.75rem 1rem; /* Increased from 0.5rem 0.75rem for better touch targets */
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem; /* Added for consistent sizing */
            min-width: 2.5rem; /* Ensure consistent button sizes */
        }

        .pagination button:hover:not(:disabled) {
            background: #e9ecef;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.1);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Detail View */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .detail-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detail-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #495057;
            min-width: 120px;
        }

        .detail-value {
            color: #2c3e50;
            text-align: right;
            flex: 1;
        }

        .detail-value input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            line-height: 1.2;
            height: 32px;
        }

        .detail-value input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* Tabs */
        .tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
        }

        .tab-list {
            display: flex;
            gap: 0;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: #6c757d;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #495057;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.5rem 1rem;
                height: 60px;
            }

            .layout {
                flex-direction: column;
                margin-top: 60px; /* Adjust for smaller mobile header */
                min-height: calc(100vh - 60px);
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .main-content {
                order: 1;
            }

            .page {
                padding: 1rem; /* Increased from 0.5rem for better mobile spacing */
            }

            .page-header {
                padding: 1.5rem; /* Reduced from desktop but still spacious */
                margin-bottom: 1.5rem;
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem; /* Maintain good spacing on mobile */
            }

            .stat-card {
                padding: 1.5rem; /* Maintain comfortable padding on mobile */
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
                padding: 1rem; /* Increased from 0.5rem for better mobile spacing */
                gap: 1rem;
            }

            .search-box {
                max-width: none;
            }

            .search-box input {
                padding: 0.875rem 1rem 0.875rem 2.5rem; /* Adjusted for mobile */
            }

            .data-table th,
            .data-table td {
                padding: 6px 8px; /* Slightly larger for mobile but still compact */
                font-size: 12px; /* Slightly larger for mobile readability */
            }

            .data-table .col-narrow {
                width: 4%;
                min-width: 40px;
            }

            .data-table .col-medium {
                width: 7%;
                min-width: 60px;
            }

            .data-table .col-wide {
                width: 10%;
                min-width: 80px;
            }

            .data-table .col-extra-wide {
                width: 12%;
                min-width: 100px;
            }

            .data-table .col-actions {
                width: 6%;
                min-width: 50px;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem; /* Increased padding for better visibility */
            color: #495057; /* Darker color for better contrast */
            background: #f8f9fa; /* Light background for better visibility */
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
            font-size: 1.1rem; /* Larger font for better readability */
        }

        .spinner {
            width: 24px; /* Larger spinner for better visibility */
            height: 24px;
            border: 3px solid #e9ecef;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem; /* Increased margin for better spacing */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced loading for table cells */
        td.loading {
            background: #f8f9fa !important;
            color: #495057 !important;
            font-weight: 500 !important;
            text-align: center !important;
            padding: 2rem !important;
        }

        td.loading .spinner {
            margin-right: 0.75rem;
        }

        /* Loading text improvements */
        .loading-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* Ensure loading states are visible in all contexts */
        tbody tr td:only-child {
            text-align: center;
            padding: 3rem 2rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: #495057;
        }

        tbody tr td:only-child .spinner {
            margin-right: 1rem;
        }

        /* ===== JOB DETAIL PAGE STYLES ===== */
        /* Ensure job detail page is displayed as a full page, not modal */
        #job-detail {
            position: static !important;
            background: transparent !important;
            z-index: auto !important;
            width: 100% !important;
            height: auto !important;
            overflow: visible !important;
        }

        #job-detail.page.active {
            display: block !important;
            position: static !important;
        }

        .job-detail-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .job-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .job-detail-sections {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .job-overview-card,
        .customer-info-card,
        .vehicle-info-card {
            min-height: 300px;
        }

        .work-items-card,
        .job-history-card,
        .related-docs-card {
            width: 100%;
        }

        /* ===== CUSTOMER DETAIL PAGE STYLES ===== */
        /* Ensure customer detail page is displayed as a full page, not modal */
        #customer-detail {
            position: static !important;
            background: transparent !important;
            z-index: auto !important;
            width: 100% !important;
            height: auto !important;
            overflow: visible !important;
        }

        #customer-detail.page.active {
            display: block !important;
            position: static !important;
        }

        .customer-detail-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .customer-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .customer-detail-sections {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .customer-info-card,
        .account-info-card {
            min-height: 350px;
        }

        .customer-tabs-card {
            width: 100%;
        }

        /* Customer detail specific styles - completely separate from modal styles */
        .customer-detail-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .customer-info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f3f4;
            gap: 1rem;
        }

        .customer-info-row:last-child {
            border-bottom: none;
        }

        .customer-info-label {
            font-weight: 600;
            color: #495057;
            min-width: 140px;
            font-variant: small-caps;
            letter-spacing: 0.025em;
            font-size: 0.9rem;
        }

        .customer-info-value {
            color: #2c3e50;
            text-align: right;
            flex: 1;
            font-weight: 500;
            word-break: break-word;
        }

        .customer-info-value input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            text-align: right;
        }

        .customer-info-value input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
        }

        /* Customer tabs styling */
        .customer-tabs {
            width: 100%;
        }

        .customer-tab-list {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e9ecef;
        }

        .customer-tab-button {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            color: #6c757d;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .customer-tab-button:hover {
            color: #495057;
            background: #f8f9fa;
        }

        .customer-tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: #f8f9fa;
        }

        .customer-tab-content {
            display: none;
            padding: 1.5rem 0;
        }

        .customer-tab-content.active {
            display: block;
        }

        /* ===== VEHICLE DETAIL PAGE STYLES ===== */
        /* Ensure vehicle detail page is displayed as a full page, not modal */
        #vehicle-detail {
            position: static !important;
            background: transparent !important;
            z-index: auto !important;
            width: 100% !important;
            height: auto !important;
            overflow: visible !important;
        }

        #vehicle-detail.page.active {
            display: block !important;
            position: static !important;
        }

        .vehicle-detail-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .vehicle-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .vehicle-detail-sections {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .vehicle-info-card,
        .owner-info-card {
            min-height: 350px;
        }

        .vehicle-tabs-card {
            width: 100%;
        }

        /* Vehicle detail specific styles - completely separate from modal styles */
        .vehicle-detail-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .vehicle-info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f3f4;
            gap: 1rem;
        }

        .vehicle-info-row:last-child {
            border-bottom: none;
        }

        .vehicle-info-label {
            font-weight: 600;
            color: #495057;
            min-width: 140px;
            font-variant: small-caps;
            letter-spacing: 0.025em;
            font-size: 0.9rem;
        }

        .vehicle-info-value {
            color: #2c3e50;
            text-align: right;
            flex: 1;
            font-weight: 500;
            word-break: break-word;
        }

        .vehicle-info-value input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            text-align: right;
        }

        .vehicle-info-value input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
        }

        /* Vehicle tabs styling */
        .vehicle-tabs {
            width: 100%;
        }

        .vehicle-tab-list {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e9ecef;
        }

        .vehicle-tab-button {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            color: #6c757d;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .vehicle-tab-button:hover {
            color: #495057;
            background: #f8f9fa;
        }

        .vehicle-tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: #f8f9fa;
        }

        .vehicle-tab-content {
            display: none;
            padding: 1.5rem 0;
        }

        .vehicle-tab-content.active {
            display: block;
        }

        /* ===== DYNAMIC SPACING SYSTEM ===== */
        /* Apply spacing variables to key elements */
        .card {
            padding: var(--card-padding) !important;
            margin-bottom: var(--card-gap) !important;
        }

        .customer-detail-grid,
        .vehicle-detail-grid,
        .job-detail-grid {
            gap: var(--grid-gap) !important;
            margin-bottom: var(--section-gap) !important;
        }

        .customer-detail-info,
        .vehicle-detail-info,
        .job-detail-info {
            gap: var(--info-row-gap) !important;
        }

        .customer-info-row,
        .vehicle-info-row,
        .job-info-row {
            padding: var(--row-padding) 0 !important;
        }

        .data-table td,
        .data-table th {
            padding: var(--table-cell-padding) !important;
        }

        .customer-detail-sections,
        .vehicle-detail-sections,
        .job-detail-sections {
            gap: var(--section-gap) !important;
        }

        /* Spacing presets */
        .layout.spacing-compact {
            --card-padding: 1rem;
            --card-gap: 1rem;
            --section-gap: 1.25rem;
            --row-padding: 0.5rem;
            --table-cell-padding: 0.5rem;
            --grid-gap: 1rem;
            --info-row-gap: 0.75rem;
        }

        .layout.spacing-wide {
            --card-padding: 2rem;
            --card-gap: 2rem;
            --section-gap: 2.5rem;
            --row-padding: 1rem;
            --table-cell-padding: 1rem;
            --grid-gap: 2rem;
            --info-row-gap: 1.25rem;
        }

        .layout.spacing-extra-wide {
            --card-padding: 2.5rem;
            --card-gap: 2.5rem;
            --section-gap: 3rem;
            --row-padding: 1.25rem;
            --table-cell-padding: 1.25rem;
            --grid-gap: 2.5rem;
            --info-row-gap: 1.5rem;
        }

        /* Compact mode specific adjustments */
        .layout.spacing-compact .page-header {
            margin-bottom: 1rem !important;
        }

        .layout.spacing-compact .stats-grid {
            gap: 1rem !important;
        }

        .layout.spacing-compact .quick-actions-grid {
            gap: 0.75rem !important;
        }

        .layout.spacing-compact .card-header {
            padding: 0.75rem 1rem !important;
        }

        /* Wide mode specific adjustments */
        .layout.spacing-wide .page-header,
        .layout.spacing-extra-wide .page-header {
            margin-bottom: 2.5rem !important;
        }

        .layout.spacing-wide .stats-grid,
        .layout.spacing-extra-wide .stats-grid {
            gap: 2rem !important;
        }

        .layout.spacing-wide .quick-actions-grid,
        .layout.spacing-extra-wide .quick-actions-grid {
            gap: 1.5rem !important;
        }

        /* Job detail specific styles - completely separate from modal styles */
        .job-detail-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .job-info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f3f4;
            gap: 1rem;
        }

        .job-info-row:last-child {
            border-bottom: none;
        }

        .job-info-label {
            font-weight: 600;
            color: #495057;
            min-width: 140px;
            font-variant: small-caps;
            letter-spacing: 0.025em;
            font-size: 0.9rem;
        }

        .job-info-value {
            color: #2c3e50;
            text-align: right;
            flex: 1;
            font-weight: 500;
            word-break: break-word;
        }

        .job-history-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .history-item {
            padding: 1rem;
            border-left: 3px solid var(--primary-color);
            background: #f8f9fa;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-item-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .history-item-date {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .history-item-content {
            color: #495057;
            line-height: 1.5;
        }

        .related-docs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem 0;
        }

        .doc-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .doc-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .doc-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .doc-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .doc-meta {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* Status badges for job detail */
        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge.status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-badge.status-in-progress {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-badge.status-completed {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-badge.status-cancelled {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Responsive adjustments for customer detail */
        @media (max-width: 768px) {
            .customer-detail-grid {
                grid-template-columns: 1fr;
            }

            .customer-detail-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .customer-info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .customer-info-label {
                min-width: auto;
            }

            .customer-info-value {
                text-align: left;
            }

            .customer-info-value input {
                text-align: left;
            }

            .customer-tab-list {
                flex-wrap: wrap;
            }

            .customer-tab-button {
                flex: 1;
                min-width: 120px;
            }
        }

        /* Responsive adjustments for job detail */
        @media (max-width: 768px) {
            .job-detail-grid {
                grid-template-columns: 1fr;
            }

            .job-detail-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .job-info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .job-info-label {
                min-width: auto;
            }

            .job-info-value {
                text-align: left;
            }
        }

        /* MOT Reminder Specific Styles */
        .mot-status-expired {
            background: #f8d7da !important;
            color: #721c24 !important;
            border-left: 4px solid #dc3545 !important;
        }

        .mot-status-critical {
            background: #fff3cd !important;
            color: #856404 !important;
            border-left: 4px solid #fd7e14 !important;
        }

        .mot-status-due-soon {
            background: #d4edda !important;
            color: #155724 !important;
            border-left: 4px solid #ffc107 !important;
        }

        .mot-status-valid {
            background: #d1ecf1 !important;
            color: #0c5460 !important;
            border-left: 4px solid #28a745 !important;
        }

        .mot-card {
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }

        .mot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .mot-card-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mot-card-body {
            padding: 1rem;
        }

        .mot-urgency-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .drag-drop-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drag-drop-area:hover,
        .drag-drop-area.dragover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .file-upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem; /* Increased from 1rem for better form section separation */
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 1rem 1.25rem; /* Increased padding for better touch targets */
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px; /* Increased from 15px for better readability */
            font-weight: 500; /* Medium weight for form inputs */
            transition: all 0.3s ease;
            line-height: 1.5; /* Improved from 1.4 for better text spacing */
            height: auto;
            color: #2c3e50;
            margin-bottom: 0.5rem; /* Added for better form element separation */
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Invoice specific styles */
        .invoice-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 1.5rem;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .invoice-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .invoice-actions {
            display: flex;
            gap: 0.5rem;
        }

        .invoice-actions button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .invoice-actions button:hover {
            background: rgba(255,255,255,0.2);
        }

        .invoice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .invoice-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .invoice-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .invoice-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0; /* Increased padding for better readability */
            border-bottom: 1px solid #e9ecef;
            font-size: 15px; /* Slightly larger font for invoice fields */
        }

        .invoice-field:last-child {
            border-bottom: none;
        }

        .invoice-label {
            font-weight: 600; /* Increased weight for labels */
            color: #495057;
            min-width: 140px; /* Increased width for better layout */
            font-variant: small-caps; /* Small caps for field labels */
            letter-spacing: 0.025em;
        }

        .invoice-value {
            color: #2c3e50;
            text-align: right;
            flex: 1;
            font-weight: 500; /* Medium weight for values */
        }

        .invoice-value input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            line-height: 1.2;
            height: 32px;
        }

        .invoice-value input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .invoice-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
        }

        .invoice-tab-list {
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .invoice-tab-button {
            padding: 0.875rem 1.75rem; /* Increased padding */
            border: none;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-weight: 600; /* Increased weight */
            margin-right: 2px;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 15px; /* Slightly larger font */
            text-transform: uppercase; /* Uppercase for tab buttons */
            letter-spacing: 0.05em;
        }

        .invoice-tab-button:hover {
            background: #5a6268;
        }

        .invoice-tab-button.active {
            background: #667eea;
        }

        .invoice-tab-content {
            display: none;
        }

        .invoice-tab-content.active {
            display: block;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .history-table th,
        .history-table td {
            padding: 0.875rem 1rem; /* Increased padding for better readability */
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
            font-size: 15px; /* Slightly larger font */
        }

        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-variant: small-caps; /* Small caps for table headers */
            letter-spacing: 0.05em;
            font-size: 14px; /* Slightly smaller for headers with small caps */
        }

        .history-table td {
            font-weight: 500; /* Medium weight for table data */
            color: #2c3e50;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        /* Make all text inputs single line */
        input[type="text"], 
        input[type="email"], 
        input[type="tel"], 
        input[type="number"],
        .form-control,
        .detail-value input,
        .invoice-value input {
            height: 32px !important;
            line-height: 1.2 !important;
            padding: 0.25rem 0.5rem !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* Ensure no textarea behavior */
        textarea {
            resize: none;
            height: 32px !important;
            line-height: 1.2 !important;
            padding: 0.25rem 0.5rem !important;
            overflow: hidden !important;
        }

        /* Completion Tracking Styles */
        .completed-vehicle {
            background-color: #f8f9fa !important;
            opacity: 0.8;
        }

        .completed-vehicle:hover {
            background-color: #e9ecef !important;
        }

        .completion-checkbox {
            accent-color: #28a745;
            transform: scale(1.1);
            margin-right: 0.5rem;
        }

        .verification-badge {
            background: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-filter-info {
            font-size: 0.9rem;
            color: #6c757d;
            padding: 0.25rem 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .bulk-actions {
            display: flex;
            gap: 1rem; /* Increased from 0.5rem for better button separation */
            align-items: center;
            flex-wrap: wrap;
            margin: 1rem 0; /* Added vertical margin for better section separation */
        }

        .bulk-actions .btn {
            font-size: 0.9rem; /* Increased from 0.8rem for better readability */
            padding: 0.6rem 1.2rem; /* Increased from 0.4rem 0.8rem for better touch targets */
        }

        /* Enhanced notification styles */
        .notification.info {
            background: #17a2b8;
            color: white;
        }

        .notification.success {
            background: #28a745;
            color: white;
        }

        /* Strikethrough effect for completed registrations */
        .completed-registration {
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Fade effect for completed rows */
        .completed-vehicle td {
            opacity: 0.7;
        }

        .completed-vehicle .verification-badge {
            opacity: 1;
        }

        /* Smart Filtering Styles */
        .flagged-vehicle {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
        }

        .flagged-vehicle:hover {
            background-color: #ffeaa7 !important;
        }

        .flagged-vehicle td {
            position: relative;
        }

        .flagged-vehicle td:first-child::before {
            content: "üîí";
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        /* SMS Status Indicators */
        .sms-status-ready {
            background-color: #d4edda !important;
            color: #155724 !important;
        }

        .sms-status-flagged {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }

        .sms-status-no-mobile {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }

        .sms-status-sent {
            background-color: #d1ecf1 !important;
            color: #0c5460 !important;
        }

        /* Visual Priority Indicators */
        .priority-expired {
            border-left: 4px solid #dc3545 !important;
        }

        .priority-critical {
            border-left: 4px solid #ffc107 !important;
        }

        .priority-due-soon {
            border-left: 4px solid #17a2b8 !important;
        }

        .priority-flagged {
            border-left: 4px solid #6c757d !important;
        }

        /* Archived Vehicle Styles */
        .archived-vehicle {
            background-color: #f8f9fa !important;
            opacity: 0.7;
            border-left: 4px solid #6c757d !important;
        }

        .archived-vehicle:hover {
            background-color: #e9ecef !important;
        }

        .archived-vehicle td {
            color: #6c757d !important;
        }

        .archived-vehicle .badge {
            opacity: 0.8;
        }

        /* Interactive Filter Button Styles */
        .filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem; /* Increased from 0.5rem for better icon-text spacing */
            padding: 0.875rem 1.5rem; /* Increased from 0.5rem 1rem for better touch targets */
            border: 2px solid #dee2e6;
            border-radius: 8px; /* Increased from 6px for consistency */
            background: white;
            color: #6c757d;
            font-size: 1rem; /* Increased from 0.9rem for better readability */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            margin-bottom: 0.5rem; /* Added for better vertical spacing when wrapping */
        }

        .filter-btn:hover {
            border-color: #adb5bd;
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .filter-btn.filter-expired.active {
            background: #dc3545;
            border-color: #dc3545;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .filter-btn.filter-critical.active {
            background: #fd7e14;
            border-color: #fd7e14;
            box-shadow: 0 2px 8px rgba(253, 126, 20, 0.3);
        }

        .filter-btn.filter-due-soon.active {
            background: #ffc107;
            border-color: #ffc107;
            color: #212529;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .filter-btn.filter-normal.active {
            background: #28a745;
            border-color: #28a745;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .filter-btn.filter-flagged.active {
            background: #6c757d;
            border-color: #6c757d;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }

        .filter-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.6rem; /* Increased from 0.2rem 0.4rem for better visibility */
            border-radius: 12px;
            font-size: 0.85rem; /* Increased from 0.8rem for better readability */
            font-weight: 600;
            min-width: 1.75rem; /* Increased from 1.5rem for better proportion */
            text-align: center;
        }

        .filter-btn.active .filter-count {
            background: rgba(255, 255, 255, 0.3);
        }

        .filter-btn.filter-due-soon.active .filter-count {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Filter indicator styles */
        #active-filter-indicator {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive filter buttons */
        @media (max-width: 768px) {
            #mot-filter-buttons {
                flex-direction: column;
            }

            .filter-btn {
                justify-content: space-between;
                width: 100%;
            }
        }

        /* Settings Page Styles */
        .settings-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Icon Grid Settings Layout */
        .settings-icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .settings-icon-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .settings-icon-card:hover {
            background: #f8fafc;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.15);
            border-color: var(--primary-color);
        }

        .settings-icon-card.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.4);
        }

        .settings-icon-card .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .settings-icon-card.active .icon {
            color: white;
            transform: scale(1.1);
        }

        .settings-icon-card h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            transition: color 0.3s ease;
        }

        .settings-icon-card.active h4 {
            color: white;
        }

        .settings-icon-card p {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0;
            transition: color 0.3s ease;
        }

        .settings-icon-card.active p {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Collapsible Content */
        .settings-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            animation: slideDown 0.3s ease;
        }

        .settings-content.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-content h3 {
            margin: 0 0 1.5rem 0;
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 1rem;
        }

        .settings-content h3 i {
            color: #6b5b95;
            font-size: 1.2rem;
        }

        .settings-content h4 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-content h4 i {
            color: #6b5b95;
        }

        /* Stats Display */
        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: #6b5b95;
        }

        /* Responsive adjustments for icon grid */
        @media (max-width: 768px) {
            .settings-icon-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
            }

            .settings-icon-card {
                padding: 1.5rem 1rem;
            }

            .settings-icon-card .icon {
                font-size: 2.5rem;
            }

            .stats-display {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .settings-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .settings-tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .settings-tab-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .settings-tab-btn.active {
            background: #6b5b95;
            color: white;
            box-shadow: 0 2px 4px rgba(107, 91, 149, 0.2);
        }

        .settings-tab-btn i {
            margin-right: 0.5rem;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .settings-section h3 {
            margin: 0 0 1.5rem 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-section h3 i {
            color: #6b5b95;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600; /* Increased weight for form labels */
            color: #495057;
            font-variant: small-caps; /* Small caps for form labels */
            letter-spacing: 0.025em;
            font-size: 15px; /* Slightly larger font */
        }

        .help-text {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 400;
            margin-top: 0.25rem;
        }

        .settings-section .form-control {
            width: 100%;
            padding: 0.875rem; /* Increased padding */
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 15px; /* Increased font size */
            font-weight: 500; /* Medium weight */
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            color: #2c3e50;
        }

        .settings-section .form-control:focus {
            outline: none;
            border-color: #6b5b95;
            box-shadow: 0 0 0 3px rgba(107, 91, 149, 0.1);
        }

        .settings-section .form-control:invalid {
            border-color: #dc3545;
        }

        .settings-section .form-control:invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            accent-color: #6b5b95;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .file-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connection-status {
            margin-left: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.testing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Operating Hours Styles */
        .operating-hours {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .day-hours {
            display: grid;
            grid-template-columns: 100px 1fr auto 1fr auto;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .day-label {
            font-weight: 500;
            color: #495057;
        }

        .time-input {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .time-input:focus {
            outline: none;
            border-color: #6b5b95;
            box-shadow: 0 0 0 2px rgba(107, 91, 149, 0.1);
        }

        /* Error Monitoring Dashboard Styles */
        .error-monitoring-dashboard {
            padding: 1.5rem;
        }

        .monitoring-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 50%;
        }

        .status-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }

        .status-info span {
            font-size: 1.5rem;
            font-weight: 700;
            color: #212529;
        }

        .status-active {
            color: #28a745 !important;
        }

        .status-paused {
            color: #ffc107 !important;
        }

        .monitoring-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .recent-errors-section,
        .fix-history-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .recent-errors-section h3,
        .fix-history-section h3 {
            margin: 0 0 1rem 0;
            color: #212529;
            font-size: 1.2rem;
        }

        .error-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: #f8f9fa;
        }

        .filter-btn.active {
            background: #6b5b95;
            color: white;
            border-color: #6b5b95;
        }

        .errors-list,
        .fixes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .error-item,
        .fix-item {
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
        }

        .error-item.severity-high {
            border-left: 4px solid #dc3545;
        }

        .error-item.severity-medium {
            border-left: 4px solid #ffc107;
        }

        .error-item.severity-low {
            border-left: 4px solid #28a745;
        }

        .fix-item.fix-success {
            border-left: 4px solid #28a745;
        }

        .fix-item.fix-failed {
            border-left: 4px solid #dc3545;
        }

        .error-header,
        .fix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .error-type,
        .fix-pattern {
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .error-time,
        .fix-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .fix-status {
            font-size: 1.2rem;
        }

        .error-message,
        .fix-description {
            font-size: 0.9rem;
            color: #212529;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .error-location {
            font-size: 0.8rem;
            color: #6c757d;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        .no-errors,
        .no-fixes {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .no-errors i,
        .no-fixes i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
            display: block;
        }

        /* Responsive Design for Settings */
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .settings-tabs {
                flex-direction: column;
            }

            .settings-tab-btn {
                min-width: auto;
            }

            .day-hours {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                text-align: center;
            }

            .button-group {
                flex-direction: column;
            }

            .settings-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* MOT Customer Integration Styles */
        .vehicle-mot-card {
            transition: all 0.3s ease;
        }

        .vehicle-mot-card.highlighted {
            background: #f8f9ff !important;
        }

        .vehicle-mot-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .mot-history-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .sms-timeline {
            max-height: 200px;
            overflow-y: auto;
        }

        .sms-entry {
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        /* Enhanced Upload Interface Styles */
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 1.5rem 0;
        }

        .upload-zone:hover {
            border-color: #6b5b95;
            background-color: #f8f9ff;
        }

        .upload-zone.dragover {
            border-color: #6b5b95;
            background-color: #e3f2fd;
        }

        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .table-selector {
            margin: 1.5rem 0;
        }

        .table-selector label {
            font-weight: 600;
            color: #495057;
        }

        .progress-container {
            margin: 1.5rem 0;
        }

        .results-container {
            margin-top: 2rem;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .template-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .template-icon {
            font-size: 2rem;
            color: #6b5b95;
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Upload form enhancements */
        .upload-zone h4 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .upload-zone .text-muted {
            margin-bottom: 1rem;
        }

        .template-card h6 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .template-card .text-muted {
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-car"></i>
            GarageManager Pro
        </div>
        <div class="header-actions">
            <div class="spacing-control">
                <label for="spacing-select" style="font-size: 0.85rem; color: #6c757d; margin-right: 0.5rem;">Layout:</label>
                <select id="spacing-select" onchange="changeSpacing(this.value)" style="padding: 0.25rem 0.5rem; border: 1px solid #dee2e6; border-radius: 4px; background: white; font-size: 0.85rem; margin-right: 1rem;">
                    <option value="compact" selected>Compact</option>
                    <option value="normal">Normal</option>
                    <option value="wide">Wide</option>
                    <option value="extra-wide">Extra Wide</option>
                </select>
            </div>
            <button class="header-btn" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <button class="header-btn" onclick="exportData()">
                <i class="fas fa-download"></i>
                Export
            </button>
            <button class="header-btn" onclick="printPage()">
                <i class="fas fa-print"></i>
                Print
            </button>
            <button class="header-btn" onclick="showHelp()">
                <i class="fas fa-question-circle"></i>
                Help
            </button>
            <button class="header-btn" style="position: relative;">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">3</span>
            </button>
            <button class="header-btn" onclick="showAdminMenu()">
                <i class="fas fa-user-circle"></i>
                Admin
            </button>
        </div>
    </div>

    <!-- Layout -->
    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="#" class="nav-item active" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            <a href="#" class="nav-item" onclick="showPage('customers')">
                <i class="fas fa-users"></i>
                Customers
            </a>
            <a href="#" class="nav-item" onclick="showPage('vehicles')">
                <i class="fas fa-car"></i>
                Vehicles
            </a>
            <a href="#" class="nav-item" onclick="showPage('jobs')">
                <i class="fas fa-wrench"></i>
                Jobs
            </a>
            <a href="#" class="nav-item" onclick="showPage('workshop-diary')">
                <i class="fas fa-calendar-alt"></i>
                Workshop Diary
            </a>
            <a href="#" class="nav-item" onclick="showPage('job-sheets')">
                <i class="fas fa-clipboard-list"></i>
                Job Sheets
            </a>
            <a href="#" class="nav-item" onclick="showPage('quotes')">
                <i class="fas fa-file-invoice-dollar"></i>
                Quotes
            </a>
            <a href="#" class="nav-item" onclick="showPage('online-booking')">
                <i class="fas fa-globe"></i>
                Online Booking
            </a>
            <a href="#" class="nav-item" onclick="showPage('customer-portal')">
                <i class="fas fa-user-circle"></i>
                Customer Portal
            </a>
            <a href="#" class="nav-item" onclick="showPage('mot-reminders')">
                <i class="fas fa-calendar-check"></i>
                MOT Reminders
                <span class="nav-badge" id="mot-urgent-count">0</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('parts')">
                <i class="fas fa-cogs"></i>
                Parts
            </a>
            <a href="#" class="nav-item" onclick="showPage('invoices')">
                <i class="fas fa-file-invoice"></i>
                Invoices
            </a>
            <a href="#" class="nav-item" onclick="showPage('reports')">
                <i class="fas fa-chart-bar"></i>
                Reports
            </a>
            <a href="#" class="nav-item" onclick="showPage('upload')">
                <i class="fas fa-upload"></i>
                Data Upload
            </a>
            <a href="/google-drive" class="nav-item">
                <i class="fab fa-google-drive"></i>
                Google Drive Sync
            </a>
            <a href="#" class="nav-item" onclick="showPage('error-monitoring')">
                <i class="fas fa-shield-alt"></i>
                Error Monitoring
            </a>
            <a href="#" class="nav-item" onclick="showPage('settings')">
                <i class="fas fa-cog"></i>
                Settings
            </a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-tachometer-alt"></i>
                            Dashboard
                        </h1>
                        <p class="page-subtitle">Overview of your garage management system</p>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon customers">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-customers">0</h3>
                            <p>Total Customers</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon vehicles">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-vehicles">0</h3>
                            <p>Total Vehicles</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue">
                            <i class="fas fa-pound-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-revenue">¬£0.00</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon documents">
                            <i class="fas fa-wrench"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-jobs">0</h3>
                            <p>Total Jobs</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Section -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-bolt"></i>
                        Quick Actions
                    </div>
                    <div class="card-content">
                        <div class="quick-actions-grid">
                            <button class="quick-action-btn" onclick="showPage('customers')">
                                <i class="fas fa-user-plus"></i>
                                <span>Add Customer</span>
                            </button>
                            <button class="quick-action-btn" onclick="showPage('vehicles')">
                                <i class="fas fa-car"></i>
                                <span>Add Vehicle</span>
                            </button>
                            <button class="quick-action-btn" onclick="showPage('jobs')">
                                <i class="fas fa-wrench"></i>
                                <span>New Job</span>
                            </button>
                            <button class="quick-action-btn" onclick="showPage('invoices')">
                                <i class="fas fa-file-invoice"></i>
                                <span>Create Invoice</span>
                            </button>
                            <button class="quick-action-btn" onclick="showPage('mot-reminders')">
                                <i class="fas fa-calendar-check"></i>
                                <span>MOT Check</span>
                            </button>
                            <button class="quick-action-btn" onclick="showPage('upload')">
                                <i class="fas fa-upload"></i>
                                <span>Import Data</span>
                            </button>
                            <button class="quick-action-btn" onclick="showDemoJobDetail()" style="border: 2px solid #6b5b95;">
                                <i class="fas fa-eye"></i>
                                <span>Test Job Detail</span>
                            </button>
                            <button class="quick-action-btn" onclick="showDemoCustomerDetail()" style="border: 2px solid #28a745;">
                                <i class="fas fa-user"></i>
                                <span>Test Customer Detail</span>
                            </button>
                            <button class="quick-action-btn" onclick="testCustomersNavigation()" style="border: 2px solid #ffc107;">
                                <i class="fas fa-users"></i>
                                <span>Test Customers Page</span>
                            </button>
                            <button class="quick-action-btn" onclick="showDemoVehicleDetail()" style="border: 2px solid #17a2b8;">
                                <i class="fas fa-car"></i>
                                <span>Test Vehicle Detail</span>
                            </button>
                            <button class="quick-action-btn" onclick="testAPIEndpoints()" style="border: 2px solid #6f42c1;">
                                <i class="fas fa-flask"></i>
                                <span>Test API Endpoints</span>
                            </button>
                        </div>
                    </div>
                </div>



                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        Recent Activity
                    </div>
                    <div class="card-content">
                        <div id="recent-activity-content">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading recent activity...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers Page -->
            <div id="customers" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-users"></i>
                            Customer Management
                        </h1>
                        <p class="page-subtitle">Manage all customers and their information</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="customer-search" placeholder="Customer Search" onkeyup="searchCustomers()">
                    </div>
                    <button class="btn btn-primary" onclick="showNewCustomerForm()">
                        <i class="fas fa-plus"></i>
                        New Customer
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-list"></i>
                        Customer List
                    </div>
                    <div class="table-controls">
                        <div>Showing <span id="customer-range">1 to 50</span> of <span id="customer-total">7,037</span> customers</div>
                        <div>
                            <select id="customer-per-page" onchange="changeCustomerPerPage()">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Account Number</th>
                                    <th class="col-wide">Name</th>
                                    <th class="col-wide">Company</th>
                                    <th class="col-extra-wide">Address</th>
                                    <th class="col-narrow">Postcode</th>
                                    <th class="col-medium">Phone</th>
                                    <th class="col-narrow">Vehicles</th>
                                    <th class="col-narrow">Documents</th>
                                    <th class="col-medium">Last Invoice</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body">
                                <tr>
                                    <td colspan="10" class="loading">
                                        <div class="spinner"></div>
                                        Loading customers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="customer-pagination">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Vehicles Page -->
            <div id="vehicles" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-car"></i>
                            Vehicle Management
                        </h1>
                        <p class="page-subtitle">Manage all vehicles and their information</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="vehicle-search" placeholder="Vehicle Search" onkeyup="searchVehicles()">
                    </div>
                    <button class="btn btn-primary" onclick="showNewVehicleForm()">
                        <i class="fas fa-plus"></i>
                        New Vehicle
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-list"></i>
                        Vehicle List
                    </div>
                    <div class="table-controls">
                        <div>Showing <span id="vehicle-range">1 to 50</span> of <span id="vehicle-total">10,364</span> vehicles</div>
                        <div>
                            <select id="vehicle-per-page" onchange="changeVehiclePerPage()">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Registration</th>
                                    <th class="col-medium">Make</th>
                                    <th class="col-medium">Model</th>
                                    <th class="col-narrow">Color</th>
                                    <th class="col-narrow">Fuel Type</th>
                                    <th class="col-medium">MOT Due</th>
                                    <th class="col-narrow">Mileage</th>
                                    <th class="col-wide">Customer</th>
                                    <th class="col-medium">Last Service</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicles-table-body">
                                <tr>
                                    <td colspan="10" class="loading">
                                        <div class="spinner"></div>
                                        Loading vehicles...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="vehicle-pagination">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Jobs Page - Enhanced with Kanban Board -->
            <div id="jobs" class="page">
                <!-- Job Management Tabs -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-tasks"></i>
                            Job Management
                        </h1>
                        <p class="page-subtitle">Professional workshop workflow management</p>
                    </div>
                    <div class="job-view-controls">
                        <div class="view-toggle">
                            <button class="btn btn-outline-primary active" id="kanban-view-btn" onclick="switchJobView('kanban')">
                                <i class="fas fa-columns"></i>
                                Kanban Board
                            </button>
                            <button class="btn btn-outline-primary" id="list-view-btn" onclick="switchJobView('list')">
                                <i class="fas fa-list"></i>
                                List View
                            </button>
                        </div>
                        <button class="btn btn-primary" onclick="showNewJobForm()">
                            <i class="fas fa-plus"></i>
                            New Job
                        </button>
                    </div>
                </div>

                <!-- Kanban Board View -->
                <div id="kanban-view" class="job-view active">
                    <div id="kanban-container">
                        <!-- Kanban board will be generated by JavaScript -->
                    </div>
                </div>

                <!-- List View -->
                <div id="list-view" class="job-view">
                    <div class="job-filters">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="job-search" placeholder="Search jobs...">
                        </div>
                        <select id="status-filter" onchange="filterJobs()">
                            <option value="">All Statuses</option>
                            <option value="BOOKED_IN">Booked In</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="AWAITING_PARTS">Awaiting Parts</option>
                            <option value="QUALITY_CHECK">Quality Check</option>
                            <option value="READY_FOR_COLLECTION">Ready for Collection</option>
                            <option value="COMPLETED">Completed</option>
                        </select>
                        <select id="priority-filter" onchange="filterJobs()">
                            <option value="">All Priorities</option>
                            <option value="URGENT">Urgent</option>
                            <option value="HIGH">High</option>
                            <option value="NORMAL">Normal</option>
                            <option value="LOW">Low</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <i class="fas fa-wrench"></i>
                            Job List
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="col-narrow">Job No</th>
                                        <th class="col-narrow">Priority</th>
                                        <th class="col-medium">Date</th>
                                        <th class="col-wide">Customer</th>
                                        <th class="col-medium">Vehicle</th>
                                        <th class="col-extra-wide">Description</th>
                                        <th class="col-narrow">Status</th>
                                        <th class="col-narrow">Technician</th>
                                        <th class="col-narrow">Total</th>
                                        <th class="col-actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobs-table-body">
                                    <tr>
                                        <td colspan="10" class="loading">
                                            <div class="spinner"></div>
                                            Loading jobs...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workshop Diary Page -->
            <div id="workshop-diary" class="page">
                <div id="workshop-diary-container">
                    <!-- Workshop diary will be generated by JavaScript -->
                </div>
            </div>

            <!-- Job Sheets Page -->
            <div id="job-sheets" class="page">
                <div id="job-sheets-container">
                    <!-- Job sheets will be generated by JavaScript -->
                </div>
            </div>

            <!-- Quotes Page -->
            <div id="quotes" class="page">
                <div id="quotes-container">
                    <!-- Quotes will be generated by JavaScript -->
                </div>
            </div>

            <!-- Online Booking Page -->
            <div id="online-booking" class="page">
                <div id="online-booking-container">
                    <!-- Online booking widget will be generated by JavaScript -->
                </div>
            </div>

            <!-- Customer Portal Page -->
            <div id="customer-portal" class="page">
                <div id="customer-portal-container">
                    <!-- Customer portal will be generated by JavaScript -->
                </div>
            </div>

            <!-- Customer Detail Page -->
            <div id="customer-detail" class="page">
                <div class="page-header">
                    <div>
                        <button class="btn btn-outline-primary" onclick="showPage('customers')" style="margin-right: 1rem;">
                            <i class="fas fa-arrow-left"></i>
                            Back to Customers
                        </button>
                        <h1 class="page-title" id="customer-detail-title">
                            <i class="fas fa-user"></i>
                            Customer Details
                        </h1>
                        <p class="page-subtitle" id="customer-detail-subtitle">Complete customer information and history</p>
                    </div>
                    <div class="customer-detail-actions">
                        <button class="btn btn-outline-primary" onclick="editCustomerDetail()" id="edit-customer-btn">
                            <i class="fas fa-edit"></i>
                            Edit Customer
                        </button>
                        <button class="btn btn-primary" onclick="createJobForCustomer()" id="create-job-btn">
                            <i class="fas fa-plus"></i>
                            New Job
                        </button>
                    </div>
                </div>

                <!-- Customer Information Grid -->
                <div class="customer-detail-grid">
                    <!-- Customer Information Card -->
                    <div class="card customer-info-card">
                        <div class="card-header">
                            <i class="fas fa-user"></i>
                            Customer Information
                        </div>
                        <div class="card-content">
                            <div class="customer-detail-info">
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Account Number</span>
                                    <span class="customer-info-value">
                                        <input type="text" id="customer-account-number-page" onchange="updateCustomerField('account_number', this.value)">
                                    </span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Company</span>
                                    <span class="customer-info-value">
                                        <input type="text" id="customer-company-page" onchange="updateCustomerField('company_name', this.value)">
                                    </span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Name</span>
                                    <span class="customer-info-value">
                                        <input type="text" id="customer-name-page" onchange="updateCustomerField('name', this.value)">
                                    </span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Address</span>
                                    <span class="customer-info-value">
                                        <input type="text" id="customer-address-page" onchange="updateCustomerField('address', this.value)">
                                    </span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Postcode</span>
                                    <span class="customer-info-value">
                                        <input type="text" id="customer-postcode-page" onchange="updateCustomerField('postcode', this.value)">
                                    </span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Mobile</span>
                                    <span class="customer-info-value">
                                        <input type="text" id="customer-mobile-page" onchange="updateCustomerField('mobile', this.value)">
                                    </span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Email</span>
                                    <span class="customer-info-value">
                                        <input type="text" id="customer-email-page" onchange="updateCustomerField('email', this.value)">
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Information Card -->
                    <div class="card account-info-card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i>
                            Account Information
                        </div>
                        <div class="card-content">
                            <div class="customer-detail-info">
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Customer Since</span>
                                    <span class="customer-info-value" id="customer-since-page">-</span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Total Vehicles</span>
                                    <span class="customer-info-value" id="customer-vehicle-count-page">-</span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Total Services</span>
                                    <span class="customer-info-value" id="customer-service-count-page">-</span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Last Service</span>
                                    <span class="customer-info-value" id="customer-last-service-page">-</span>
                                </div>
                                <div class="customer-info-row">
                                    <span class="customer-info-label">Account Balance</span>
                                    <span class="customer-info-value" id="customer-balance-page">¬£0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Detail Sections -->
                <div class="customer-detail-sections">
                    <!-- Tabbed Content -->
                    <div class="card customer-tabs-card">
                        <div class="card-header">
                            <div class="customer-tabs">
                                <div class="customer-tab-list">
                                    <button class="customer-tab-button active" onclick="showCustomerPageTab('vehicles')">
                                        <i class="fas fa-car"></i>
                                        Vehicles
                                    </button>
                                    <button class="customer-tab-button" onclick="showCustomerPageTab('history')">
                                        <i class="fas fa-history"></i>
                                        Service History
                                    </button>
                                    <button class="customer-tab-button" onclick="showCustomerPageTab('invoices')">
                                        <i class="fas fa-file-invoice"></i>
                                        Invoices
                                    </button>
                                    <button class="customer-tab-button" onclick="showCustomerPageTab('documents')">
                                        <i class="fas fa-file-alt"></i>
                                        Documents
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="customer-page-tab-vehicles" class="customer-tab-content active">
                                <div class="table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th class="col-medium">Registration</th>
                                                <th class="col-medium">Make</th>
                                                <th class="col-medium">Model</th>
                                                <th class="col-narrow">Color</th>
                                                <th class="col-medium">MOT Due</th>
                                                <th class="col-narrow">Mileage</th>
                                                <th class="col-actions">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customer-vehicles-table-page">
                                            <tr>
                                                <td colspan="7" class="loading">
                                                    <div class="spinner"></div>
                                                    Loading vehicles...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="customer-page-tab-history" class="customer-tab-content">
                                <div class="table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th class="col-medium">Date</th>
                                                <th class="col-medium">Vehicle</th>
                                                <th class="col-extra-wide">Description</th>
                                                <th class="col-narrow">Total</th>
                                                <th class="col-narrow">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customer-history-table-page">
                                            <tr>
                                                <td colspan="5" class="loading">
                                                    <div class="spinner"></div>
                                                    Loading service history...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="customer-page-tab-invoices" class="customer-tab-content">
                                <div class="table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th class="col-medium">Invoice No</th>
                                                <th class="col-medium">Date</th>
                                                <th class="col-medium">Vehicle</th>
                                                <th class="col-extra-wide">Description</th>
                                                <th class="col-narrow">Total</th>
                                                <th class="col-narrow">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customer-invoices-table-page">
                                            <tr>
                                                <td colspan="6" class="loading">
                                                    <div class="spinner"></div>
                                                    Loading invoices...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="customer-page-tab-documents" class="customer-tab-content">
                                <div style="padding: 2rem; text-align: center; color: #6c757d;">
                                    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <p>Customer documents will be displayed here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vehicle Detail Page -->
            <div id="vehicle-detail" class="page">
                <div class="page-header">
                    <div>
                        <button class="btn btn-outline-primary" onclick="showPage('vehicles')" style="margin-right: 1rem;">
                            <i class="fas fa-arrow-left"></i>
                            Back to Vehicles
                        </button>
                        <h1 class="page-title" id="vehicle-detail-title">
                            <i class="fas fa-car"></i>
                            Vehicle Details
                        </h1>
                        <p class="page-subtitle" id="vehicle-detail-subtitle">Complete vehicle information and history</p>
                    </div>
                    <div class="vehicle-detail-actions">
                        <button class="btn btn-outline-primary" onclick="editVehicleDetail()" id="edit-vehicle-btn">
                            <i class="fas fa-edit"></i>
                            Edit Vehicle
                        </button>
                        <button class="btn btn-primary" onclick="createJobForVehicle()" id="create-vehicle-job-btn">
                            <i class="fas fa-plus"></i>
                            New Job
                        </button>
                    </div>
                </div>

                <!-- Vehicle Information Grid -->
                <div class="vehicle-detail-grid">
                    <!-- Vehicle Information Card -->
                    <div class="card vehicle-info-card">
                        <div class="card-header">
                            <i class="fas fa-car"></i>
                            Vehicle Information
                        </div>
                        <div class="card-content">
                            <div class="vehicle-detail-info">
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Registration</span>
                                    <span class="vehicle-info-value">
                                        <input type="text" id="vehicle-registration-page" onchange="updateVehicleField('registration', this.value)">
                                    </span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Make</span>
                                    <span class="vehicle-info-value">
                                        <input type="text" id="vehicle-make-page" onchange="updateVehicleField('make', this.value)">
                                    </span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Model</span>
                                    <span class="vehicle-info-value">
                                        <input type="text" id="vehicle-model-page" onchange="updateVehicleField('model', this.value)">
                                    </span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Color</span>
                                    <span class="vehicle-info-value">
                                        <input type="text" id="vehicle-color-page" onchange="updateVehicleField('color', this.value)">
                                    </span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Fuel Type</span>
                                    <span class="vehicle-info-value">
                                        <input type="text" id="vehicle-fuel-type-page" onchange="updateVehicleField('fuel_type', this.value)">
                                    </span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Mileage</span>
                                    <span class="vehicle-info-value">
                                        <input type="text" id="vehicle-mileage-page" onchange="updateVehicleField('mileage', this.value)">
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Owner Information Card -->
                    <div class="card owner-info-card">
                        <div class="card-header">
                            <i class="fas fa-user"></i>
                            Owner Information
                        </div>
                        <div class="card-content">
                            <div class="vehicle-detail-info">
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Customer</span>
                                    <span class="vehicle-info-value" id="vehicle-customer-name-page">-</span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Account</span>
                                    <span class="vehicle-info-value" id="vehicle-customer-account-page">-</span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Phone</span>
                                    <span class="vehicle-info-value" id="vehicle-customer-phone-page">-</span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">MOT Due</span>
                                    <span class="vehicle-info-value" id="vehicle-mot-due-page">-</span>
                                </div>
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Last Service</span>
                                    <span class="vehicle-info-value" id="vehicle-last-service-page">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Detail Sections -->
                <div class="vehicle-detail-sections">
                    <!-- Tabbed Content -->
                    <div class="card vehicle-tabs-card">
                        <div class="card-header">
                            <div class="vehicle-tabs">
                                <div class="vehicle-tab-list">
                                    <button class="vehicle-tab-button active" onclick="showVehiclePageTab('history')">
                                        <i class="fas fa-history"></i>
                                        Service History
                                    </button>
                                    <button class="vehicle-tab-button" onclick="showVehiclePageTab('jobs')">
                                        <i class="fas fa-wrench"></i>
                                        Jobs
                                    </button>
                                    <button class="vehicle-tab-button" onclick="showVehiclePageTab('invoices')">
                                        <i class="fas fa-file-invoice"></i>
                                        Invoices
                                    </button>
                                    <button class="vehicle-tab-button" onclick="showVehiclePageTab('documents')">
                                        <i class="fas fa-file-alt"></i>
                                        Documents
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="vehicle-page-tab-history" class="vehicle-tab-content active">
                                <div class="table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Doc No</th>
                                                <th>Mileage</th>
                                                <th>Description</th>
                                                <th>Total</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vehicle-history-table-page">
                                            <tr>
                                                <td colspan="6" class="loading">
                                                    <div class="spinner"></div>
                                                    Loading service history...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="vehicle-page-tab-jobs" class="vehicle-tab-content">
                                <div class="table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Job No</th>
                                                <th>Date</th>
                                                <th>Description</th>
                                                <th>Status</th>
                                                <th>Total</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vehicle-jobs-table-page">
                                            <tr>
                                                <td colspan="6" class="loading">
                                                    <div class="spinner"></div>
                                                    Loading jobs...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="vehicle-page-tab-invoices" class="vehicle-tab-content">
                                <div class="table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Invoice No</th>
                                                <th>Date</th>
                                                <th>Description</th>
                                                <th>Total</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vehicle-invoices-table-page">
                                            <tr>
                                                <td colspan="6" class="loading">
                                                    <div class="spinner"></div>
                                                    Loading invoices...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="vehicle-page-tab-documents" class="vehicle-tab-content">
                                <div style="padding: 2rem; text-align: center; color: #6c757d;">
                                    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <p>Vehicle documents will be displayed here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Detail Page -->
            <div id="job-detail" class="page">
                <div class="page-header">
                    <div>
                        <button class="btn btn-outline-primary" onclick="showPage('jobs')" style="margin-right: 1rem;">
                            <i class="fas fa-arrow-left"></i>
                            Back to Jobs
                        </button>
                        <h1 class="page-title" id="job-detail-title">
                            <i class="fas fa-wrench"></i>
                            Job Details
                        </h1>
                        <p class="page-subtitle" id="job-detail-subtitle">Detailed job information and history</p>
                    </div>
                    <div class="job-detail-actions">
                        <button class="btn btn-outline-primary" onclick="editJobDetail()" id="edit-job-btn">
                            <i class="fas fa-edit"></i>
                            Edit Job
                        </button>
                        <button class="btn btn-primary" onclick="createInvoiceFromJob()" id="create-invoice-btn">
                            <i class="fas fa-file-invoice"></i>
                            Create Invoice
                        </button>
                    </div>
                </div>

                <!-- Job Information Grid -->
                <div class="job-detail-grid">
                    <!-- Job Overview Card -->
                    <div class="card job-overview-card">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i>
                            Job Overview
                        </div>
                        <div class="card-content">
                            <div class="job-detail-info">
                                <div class="job-info-row">
                                    <span class="job-info-label">Job Number</span>
                                    <span class="job-info-value" id="job-number">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Date Created</span>
                                    <span class="job-info-value" id="job-date">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Status</span>
                                    <span class="job-info-value" id="job-status">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Total Amount</span>
                                    <span class="job-info-value" id="job-total">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Description</span>
                                    <span class="job-info-value" id="job-description">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information Card -->
                    <div class="card customer-info-card">
                        <div class="card-header">
                            <i class="fas fa-user"></i>
                            Customer Information
                        </div>
                        <div class="card-content">
                            <div class="job-detail-info">
                                <div class="job-info-row">
                                    <span class="job-info-label">Customer Name</span>
                                    <span class="job-info-value" id="customer-name">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Company</span>
                                    <span class="job-info-value" id="customer-company">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Phone</span>
                                    <span class="job-info-value" id="customer-phone">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Email</span>
                                    <span class="job-info-value" id="customer-email">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Address</span>
                                    <span class="job-info-value" id="customer-address">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Information Card -->
                    <div class="card vehicle-info-card">
                        <div class="card-header">
                            <i class="fas fa-car"></i>
                            Vehicle Information
                        </div>
                        <div class="card-content">
                            <div class="job-detail-info">
                                <div class="job-info-row">
                                    <span class="job-info-label">Registration</span>
                                    <span class="job-info-value" id="vehicle-registration">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Make & Model</span>
                                    <span class="job-info-value" id="vehicle-make-model">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Year</span>
                                    <span class="job-info-value" id="vehicle-year">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Color</span>
                                    <span class="job-info-value" id="vehicle-color">-</span>
                                </div>
                                <div class="job-info-row">
                                    <span class="job-info-label">Mileage</span>
                                    <span class="job-info-value" id="vehicle-mileage">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Job Details Sections -->
                <div class="job-detail-sections">
                    <!-- Work Items Card -->
                    <div class="card work-items-card">
                        <div class="card-header">
                            <i class="fas fa-list"></i>
                            Work Items & Parts
                        </div>
                        <div class="card-content">
                            <div class="table-wrapper">
                                <table class="data-table" id="work-items-table">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="work-items-body">
                                        <tr>
                                            <td colspan="4" class="loading">Loading work items...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Job History Card -->
                    <div class="card job-history-card">
                        <div class="card-header">
                            <i class="fas fa-history"></i>
                            Job History & Notes
                        </div>
                        <div class="card-content">
                            <div class="job-history-content" id="job-history-content">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Loading job history...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Related Documents Card -->
                    <div class="card related-docs-card">
                        <div class="card-header">
                            <i class="fas fa-file-alt"></i>
                            Related Documents
                        </div>
                        <div class="card-content">
                            <div class="related-docs-grid" id="related-docs-grid">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Loading related documents...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices Page -->
            <div id="invoices" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-file-invoice"></i>
                            Invoice Management
                        </h1>
                        <p class="page-subtitle">All invoices and billing</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="invoice-search" placeholder="Invoice Search">
                    </div>
                    <button class="btn btn-primary" onclick="showNewInvoiceForm()">
                        <i class="fas fa-plus"></i>
                        New Invoice
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <i class="fas fa-file-invoice"></i>
                        Invoice List
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Invoice No</th>
                                    <th class="col-medium">Date</th>
                                    <th class="col-wide">Customer</th>
                                    <th class="col-medium">Vehicle</th>
                                    <th class="col-extra-wide">Description</th>
                                    <th class="col-narrow">Total</th>
                                    <th class="col-narrow">Status</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-table-body">
                                <tr>
                                    <td colspan="8" class="loading">
                                        <div class="spinner"></div>
                                        Loading invoices...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- MOT Reminders Page -->
            <div id="mot-reminders" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-calendar-check"></i>
                            MOT Reminders
                        </h1>
                        <p class="page-subtitle">Monitor MOT expiry dates and send reminders</p>
                    </div>
                </div>

                <!-- MOT Statistics Section -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar"></i>
                        MOT Statistics
                    </div>
                    <div class="card-content">
                        <div id="mot-stats-grid" class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); margin-bottom: 0.5rem;">
                            <div class="stat-card" style="background: #F1F3F4; border-left: 4px solid var(--primary-color); padding: 0.75rem;">
                                <div class="stat-info">
                                    <h3 id="mot-expired" style="font-size: 1.5rem; color: #495057;">0</h3>
                                    <p style="font-size: 0.75rem; color: #6c757d;">Expired</p>
                                </div>
                            </div>
                            <div class="stat-card" style="background: #F1F3F4; border-left: 4px solid var(--primary-dark); padding: 0.75rem;">
                                <div class="stat-info">
                                    <h3 id="mot-critical" style="font-size: 1.5rem; color: #495057;">0</h3>
                                    <p style="font-size: 0.75rem; color: #6c757d;">Critical (‚â§7 days)</p>
                                </div>
                            </div>
                            <div class="stat-card" style="background: #F1F3F4; border-left: 4px solid var(--primary-light); padding: 0.75rem;">
                                <div class="stat-info">
                                    <h3 id="mot-due-soon" style="font-size: 1.5rem; color: #495057;">0</h3>
                                    <p style="font-size: 0.75rem; color: #6c757d;">Due Soon (8-30 days)</p>
                                </div>
                            </div>
                            <div class="stat-card" style="background: #F1F3F4; border-left: 4px solid #8E8E93; padding: 0.75rem;">
                                <div class="stat-info">
                                    <h3 id="mot-valid" style="font-size: 1.5rem; color: #495057;">0</h3>
                                    <p style="font-size: 0.75rem; color: #6c757d;">Valid</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SMS Centre Section -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-sms"></i>
                        SMS Centre
                    </div>
                    <div class="card-content">
                        <div id="sms-stats-grid" class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); margin-bottom: 0.5rem;">
                            <div class="stat-card" style="background: #F1F3F4; border-left: 4px solid #8E8E93; padding: 0.75rem;">
                                <div class="stat-info">
                                    <h3 id="sms-total-vehicles" style="font-size: 1.5rem; color: #495057;">0</h3>
                                    <p style="font-size: 0.75rem; color: #6c757d;">Total Vehicles</p>
                                </div>
                            </div>
                            <div class="stat-card" style="background: #F1F3F4; border-left: 4px solid var(--primary-light); padding: 0.75rem;">
                                <div class="stat-info">
                                    <h3 id="sms-with-mobile" style="font-size: 1.5rem; color: #495057;">0</h3>
                                    <p style="font-size: 0.75rem; color: #6c757d;">With Mobile</p>
                                </div>
                            </div>
                            <div class="stat-card" style="background: #F1F3F4; border-left: 4px solid var(--primary-color); padding: 0.75rem;">
                                <div class="stat-info">
                                    <h3 id="sms-urgent" style="font-size: 1.5rem; color: #495057;">0</h3>
                                    <p style="font-size: 0.75rem; color: #6c757d;">Urgent + Mobile</p>
                                </div>
                            </div>
                            <div class="stat-card" style="background: #F1F3F4; border-left: 4px solid var(--primary-dark); padding: 0.75rem;">
                                <div class="stat-info">
                                    <h3 id="sms-coverage" style="font-size: 1.5rem; color: #495057;">0%</h3>
                                    <p style="font-size: 0.75rem; color: #6c757d;">Coverage</p>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                            <button class="btn btn-primary btn-sm" onclick="showSMSModal()">
                                <i class="fas fa-sms"></i>
                                Send SMS Reminders
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="showSMSHistoryModal()">
                                <i class="fas fa-history"></i>
                                SMS History
                            </button>
                        </div>
                        <div id="sms-service-status">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin"></i>
                                Checking SMS service status...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MOT Management Interface -->
                <div class="row" style="margin-bottom: 3rem;"> <!-- Increased from mb-4 for better section separation -->
                    <!-- Add Vehicle Form -->
                    <div class="col-md-6" style="margin-bottom: 2rem;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-plus"></i> Add Vehicle
                                </h5>
                            </div>
                            <div class="card-body" style="padding: 2rem;"> <!-- Increased padding for better spacing -->
                                <form id="addVehicleForm" class="row g-3">
                                    <div class="col-12" style="margin-bottom: 1.5rem;">
                                        <input type="text" class="form-control" id="vehicleRegistration" placeholder="Enter Registration Number for Quick MOT Check" required style="padding: 1rem; font-size: 1rem;" oninput="quickMOTCheck(this.value)">
                                        <div class="form-text">Type a registration to instantly check MOT expiry date</div>
                                    </div>

                                    <!-- Quick MOT Check Results -->
                                    <div id="quickMOTResult" class="col-12" style="display: none; margin-bottom: 1.5rem;">
                                        <div class="alert" id="quickMOTAlert">
                                            <div class="d-flex align-items-center">
                                                <div class="spinner" id="quickMOTSpinner" style="display: none;"></div>
                                                <div id="quickMOTContent"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary w-100" style="padding: 1rem; font-size: 1rem;">
                                            <i class="fas fa-plus"></i> Add Vehicle to MOT Reminders
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Upload Form -->
                    <div class="col-md-6" style="margin-bottom: 2rem;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-upload"></i> Bulk Upload
                                </h5>
                            </div>
                            <div class="card-body" style="padding: 2rem;"> <!-- Increased padding for better spacing -->
                                <form id="bulkUploadForm" enctype="multipart/form-data">
                                    <div class="mb-3" style="margin-bottom: 1.5rem;">
                                        <input type="file" class="form-control" id="motFileInput" accept=".csv,.xlsx,.xls" style="padding: 1rem; font-size: 1rem;">
                                        <div class="form-text" style="margin-top: 0.75rem; font-size: 0.95rem;">Upload CSV or Excel file with vehicle registrations</div>
                                    </div>
                                    <button type="submit" class="btn btn-success w-100" style="padding: 1rem; font-size: 1rem; margin-bottom: 1.5rem;">
                                        <i class="fas fa-upload"></i> Upload File
                                    </button>
                                </form>
                                <div class="mt-3" style="margin-top: 1.5rem;">
                                    <small class="text-muted" style="font-size: 0.95rem;">Download templates:</small><br>
                                    <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <a href="/mot/download_template/csv" class="btn btn-outline-secondary btn-sm" style="padding: 0.75rem 1rem;">
                                            <i class="fas fa-download"></i> CSV Template
                                        </a>
                                        <a href="/mot/download_template/excel" class="btn btn-outline-secondary btn-sm" style="padding: 0.75rem 1rem;">
                                            <i class="fas fa-download"></i> Excel Template
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="mot-search" placeholder="Search by registration..." onkeyup="searchMOTVehicles()">
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;"> <!-- Increased gap and added margin -->
                        <button class="btn btn-primary" onclick="showAddVehicleModal()" style="padding: 0.875rem 1.5rem;">
                            <i class="fas fa-plus"></i>
                            Add Vehicle
                        </button>
                        <button class="btn btn-secondary" onclick="showBulkUploadModal()" style="padding: 0.875rem 1.5rem;">
                            <i class="fas fa-upload"></i>
                            Bulk Upload
                        </button>
                        <button class="btn btn-warning" onclick="showFailedRegistrationsModal()" id="failed-regs-button" style="padding: 0.875rem 1.5rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Review Failed
                            <span class="badge bg-light text-dark ms-1" id="failed-count">0</span>
                        </button>
                        <button class="btn btn-success" onclick="showSMSModal()" id="sms-button" style="padding: 0.875rem 1.5rem;">
                            <i class="fas fa-sms"></i>
                            Send SMS
                            <span class="badge bg-light text-dark ms-1" id="sms-count">0</span>
                        </button>
                        <button class="btn btn-info" onclick="showSMSHistoryModal()" style="padding: 0.875rem 1.5rem;">
                            <i class="fas fa-history"></i>
                            SMS History
                        </button>
                        <button class="btn btn-secondary" onclick="toggleArchivedView()" id="archive-toggle-btn" style="padding: 0.875rem 1.5rem;">
                            <i class="fas fa-archive"></i>
                            <span id="archive-toggle-text">Show Archived</span>
                        </button>
                        <button class="btn btn-warning" onclick="linkExistingVehicles()" title="Link existing vehicles to customers" style="padding: 0.875rem 1.5rem;">
                            <i class="fas fa-link"></i>
                            Link Customers
                        </button>
                        <button class="btn btn-danger" onclick="confirmClearAllData()" title="Clear all MOT data" style="padding: 0.875rem 1.5rem;">
                            <i class="fas fa-trash-alt"></i>
                            Clear All
                        </button>
                    </div>
                </div>










            </div>

            <div id="parts" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-cogs"></i>
                            Parts Management
                        </h1>
                        <p class="page-subtitle">Inventory and parts tracking</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <p>Parts management functionality will be available soon.</p>
                    </div>
                </div>
            </div>

            <div id="reports" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-chart-bar"></i>
                            Reports
                        </h1>
                        <p class="page-subtitle">Business analytics and reports</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <p>Reports functionality will be available soon.</p>
                    </div>
                </div>
            </div>

            <!-- Data Upload Page -->
            <div id="upload" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-upload"></i>
                            Data Upload
                        </h1>
                        <p class="page-subtitle">Import CSV and Excel files</p>
                    </div>
                </div>

                <!-- Upload Interface -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-upload"></i> Upload Data Files
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="mainUploadForm" enctype="multipart/form-data">
                                    <div class="table-selector mb-3">
                                        <label for="mainTableSelect" class="form-label">Data Type:</label>
                                        <select id="mainTableSelect" name="table_name" class="form-control" required>
                                            <option value="">Select data type...</option>
                                            <option value="customers">Customers</option>
                                            <option value="vehicles">Vehicles</option>
                                            <option value="jobs">Jobs/Work Orders</option>
                                            <option value="invoices">Invoices</option>
                                            <option value="parts">Parts/Stock</option>
                                            <option value="suppliers">Suppliers</option>
                                            <option value="expenses">Expenses</option>
                                            <option value="document_extras">Document Extras (Job Descriptions)</option>
                                            <option value="documents">Documents (Jobs + Invoices + Vehicles)</option>
                                            <option value="receipts">Receipts/Payments</option>
                                        </select>
                                    </div>

                                    <div class="upload-zone" id="mainUploadZone">
                                        <div class="upload-icon">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                        </div>
                                        <h4>Drag & Drop your CSV file here</h4>
                                        <p class="text-muted">or click to browse files</p>
                                        <input type="file" id="mainFileInput" name="file" accept=".csv,.xlsx,.xls" style="display: none;">
                                        <button type="button" class="btn btn-primary" onclick="document.getElementById('mainFileInput').click()">
                                            <i class="fas fa-folder-open"></i> Browse Files
                                        </button>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="mainClearExisting" name="clear_existing">
                                                <label class="form-check-label" for="mainClearExisting">
                                                    Clear existing data before import
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="mainUpdateDuplicates" name="update_duplicates" checked>
                                                <label class="form-check-label" for="mainUpdateDuplicates">
                                                    Update existing records
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="progress-container" id="mainProgressContainer" style="display: none;">
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2">Uploading and processing...</p>
                                    </div>

                                    <div class="text-center mt-3">
                                        <button type="submit" class="btn btn-success btn-lg" id="mainUploadBtn" disabled>
                                            <i class="fas fa-upload"></i> Upload Data
                                        </button>
                                    </div>
                                </form>

                                <div class="results-container" id="mainResultsContainer" style="display: none;">
                                    <div class="alert" id="mainResultsAlert"></div>
                                    <div id="mainResultsDetails"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Templates Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-download"></i> Download Templates
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Download CSV templates to ensure your data is formatted correctly</p>

                                <div class="template-grid">
                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h6>Customers</h6>
                                        <p class="text-muted">Customer information and contact details</p>
                                        <a href="/upload/templates/customers" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-car"></i>
                                        </div>
                                        <h6>Vehicles</h6>
                                        <p class="text-muted">Vehicle registrations and details</p>
                                        <a href="/upload/templates/vehicles" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-wrench"></i>
                                        </div>
                                        <h6>Jobs</h6>
                                        <p class="text-muted">Work orders and job records</p>
                                        <a href="/upload/templates/jobs" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-file-invoice"></i>
                                        </div>
                                        <h6>Invoices</h6>
                                        <p class="text-muted">Invoice and billing records</p>
                                        <a href="/upload/templates/invoices" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-cogs"></i>
                                        </div>
                                        <h6>Parts</h6>
                                        <p class="text-muted">Parts inventory and stock</p>
                                        <a href="/upload/templates/parts" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-truck"></i>
                                        </div>
                                        <h6>Suppliers</h6>
                                        <p class="text-muted">Supplier contact information</p>
                                        <a href="/upload/templates/suppliers" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-receipt"></i>
                                        </div>
                                        <h6>Expenses</h6>
                                        <p class="text-muted">Business expenses and costs</p>
                                        <a href="/upload/templates/expenses" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                        <h6>Document Extras</h6>
                                        <p class="text-muted">Job descriptions and service notes</p>
                                        <a href="/upload/templates/document_extras" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-file-invoice"></i>
                                        </div>
                                        <h6>Documents</h6>
                                        <p class="text-muted">Complete job, invoice & vehicle data</p>
                                        <a href="/upload/templates/documents" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <div class="template-card">
                                        <div class="template-icon">
                                            <i class="fas fa-credit-card"></i>
                                        </div>
                                        <h6>Receipts</h6>
                                        <p class="text-muted">Payment records and transactions</p>
                                        <a href="/upload/templates/receipts" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Statistics -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-bar"></i> Database Statistics
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Current record counts in your database</p>

                                <div class="stats-grid" id="mainStatsGrid">
                                    <!-- Stats will be loaded here -->
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-outline-primary" onclick="loadUploadStatus()">
                                        <i class="fas fa-sync"></i> Refresh Status
                                    </button>
                                    <a href="/upload" class="btn btn-primary" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Full Upload Interface
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Monitoring Dashboard -->
            <div id="error-monitoring" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-shield-alt"></i>
                            Error Monitoring
                        </h1>
                        <p class="page-subtitle">Real-time error detection and automated resolution system</p>
                    </div>
                </div>

                <div class="error-monitoring-dashboard">
                    <!-- Status Overview -->
                    <div class="monitoring-status-grid">
                        <div class="status-card">
                            <div class="status-icon">üõ°Ô∏è</div>
                            <div class="status-info">
                                <h3>System Status</h3>
                                <span id="monitoring-status" class="status-active">Active</span>
                            </div>
                        </div>

                        <div class="status-card">
                            <div class="status-icon">üö®</div>
                            <div class="status-info">
                                <h3>Total Errors</h3>
                                <span id="total-errors-count">0</span>
                            </div>
                        </div>

                        <div class="status-card">
                            <div class="status-icon">üîß</div>
                            <div class="status-info">
                                <h3>Fixes Applied</h3>
                                <span id="total-fixes-count">0</span>
                            </div>
                        </div>

                        <div class="status-card">
                            <div class="status-icon">üìä</div>
                            <div class="status-info">
                                <h3>Success Rate</h3>
                                <span id="fix-success-rate">N/A</span>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="monitoring-controls">
                        <button class="btn btn-primary" onclick="generateErrorReport()">
                            <i class="fas fa-download"></i> Generate Report
                        </button>
                        <button class="btn btn-secondary" onclick="clearErrorLog()">
                            <i class="fas fa-trash"></i> Clear Log
                        </button>
                        <button class="btn btn-warning" onclick="toggleMonitoring()">
                            <i class="fas fa-pause"></i> <span id="monitoring-toggle-text">Pause</span>
                        </button>
                    </div>

                    <!-- Recent Errors -->
                    <div class="recent-errors-section">
                        <h3>Recent Errors</h3>
                        <div class="error-filters">
                            <button class="filter-btn active" data-severity="all">All</button>
                            <button class="filter-btn" data-severity="high">High</button>
                            <button class="filter-btn" data-severity="medium">Medium</button>
                            <button class="filter-btn" data-severity="low">Low</button>
                        </div>

                        <div class="errors-list" id="recent-errors-list">
                            <div class="no-errors">
                                <i class="fas fa-check-circle"></i>
                                <p>No errors detected</p>
                            </div>
                        </div>
                    </div>

                    <!-- Fix History -->
                    <div class="fix-history-section">
                        <h3>Fix History</h3>
                        <div class="fixes-list" id="fix-history-list">
                            <div class="no-fixes">
                                <i class="fas fa-tools"></i>
                                <p>No fixes applied yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings" class="page">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-cog"></i>
                            Settings
                        </h1>
                        <p class="page-subtitle">System configuration and preferences</p>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-success" onclick="saveAllSettings()">
                            <i class="fas fa-save"></i> Save All Settings
                        </button>
                        <button class="btn btn-secondary" onclick="resetAllSettings()">
                            <i class="fas fa-undo"></i> Reset to Defaults
                        </button>
                    </div>
                </div>

                <!-- Settings Icon Grid -->
                <div class="settings-icon-grid">
                    <div class="settings-icon-card" onclick="toggleSettingsSection('mot-settings')">
                        <div class="icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h4>MOT Reminders</h4>
                        <p>DVLA API, SMS settings, and notification preferences</p>
                    </div>

                    <div class="settings-icon-card" onclick="toggleSettingsSection('system-settings')">
                        <div class="icon">
                            <i class="fas fa-desktop"></i>
                        </div>
                        <h4>System Settings</h4>
                        <p>Date formats, display preferences, and UI theme</p>
                    </div>

                    <div class="settings-icon-card" onclick="toggleSettingsSection('garage-settings')">
                        <div class="icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <h4>Garage Information</h4>
                        <p>Business details, contact info, and operating hours</p>
                    </div>

                    <div class="settings-icon-card" onclick="toggleSettingsSection('user-settings')">
                        <div class="icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <h4>User Account</h4>
                        <p>Personal information and security settings</p>
                    </div>

                    <div class="settings-icon-card" onclick="toggleSettingsSection('data-upload')">
                        <div class="icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <h4>Data Upload</h4>
                        <p>Import CSV files and manage database</p>
                    </div>

                    <div class="settings-icon-card" onclick="toggleSettingsSection('backup-restore')">
                        <div class="icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h4>Backup & Restore</h4>
                        <p>Data backup, export, and system maintenance</p>
                    </div>
                </div>

                <!-- MOT Reminder Settings Content -->
                <div id="mot-settings" class="settings-content">
                    <h3><i class="fas fa-calendar-check"></i> MOT Reminder Settings</h3>

                    <div class="settings-section">
                        <h4><i class="fas fa-key"></i> DVLA API Configuration</h4>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Client ID
                                    <span class="help-text">Your DVSA API Client ID</span>
                                </label>
                                <input type="text" id="dvla-client-id" class="form-control"
                                       placeholder="Enter DVSA Client ID"
                                       value="2b3911f4-55f5-4a86-a9f0-0fc02c2bff0f">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Token URL
                                    <span class="help-text">DVSA OAuth2 token endpoint</span>
                                </label>
                                <input type="url" id="dvla-token-url" class="form-control"
                                       placeholder="Enter Token URL"
                                       value="https://login.microsoftonline.com/a455b827-244f-4c97-b5b4-ce5d13b4d00c/oauth2/v2.0/token">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="testDVLAConnection()">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <span id="dvla-status" class="connection-status"></span>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-sms"></i> SMS Service Settings</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    SMS Provider
                                    <span class="help-text">Choose your SMS service provider</span>
                                </label>
                                <select id="sms-provider" class="form-control">
                                    <option value="twilio">Twilio</option>
                                    <option value="textlocal">Textlocal</option>
                                    <option value="clicksend">ClickSend</option>
                                    <option value="custom">Custom Provider</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Sender ID
                                    <span class="help-text">Name or number shown as sender</span>
                                </label>
                                <input type="text" id="sms-sender-id" class="form-control"
                                       placeholder="e.g., GarageABC" maxlength="11">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Default SMS Template
                                <span class="help-text">Use {customer_name}, {registration}, {expiry_date} as placeholders</span>
                            </label>
                            <textarea id="sms-template" class="form-control" rows="3"
                                      placeholder="Hi {customer_name}, your vehicle {registration} MOT expires on {expiry_date}. Please contact us to book your MOT test.">Hi {customer_name}, your vehicle {registration} MOT expires on {expiry_date}. Please contact us to book your MOT test.</textarea>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-bell"></i> Notification Preferences</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Primary Reminder (Days Before)
                                    <span class="help-text">First reminder before MOT expiry</span>
                                </label>
                                <select id="reminder-primary" class="form-control">
                                    <option value="60">60 days</option>
                                    <option value="45">45 days</option>
                                    <option value="30" selected>30 days</option>
                                    <option value="21">21 days</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Follow-up Reminder (Days Before)
                                    <span class="help-text">Second reminder before MOT expiry</span>
                                </label>
                                <select id="reminder-followup" class="form-control">
                                    <option value="21">21 days</option>
                                    <option value="14" selected>14 days</option>
                                    <option value="10">10 days</option>
                                    <option value="7">7 days</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Final Reminder (Days Before)
                                    <span class="help-text">Last reminder before MOT expiry</span>
                                </label>
                                <select id="reminder-final" class="form-control">
                                    <option value="14">14 days</option>
                                    <option value="10">10 days</option>
                                    <option value="7" selected>7 days</option>
                                    <option value="3">3 days</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-database"></i> Data Management</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">Export MOT Data</label>
                                <div class="button-group">
                                    <button class="btn btn-secondary" onclick="exportMOTData('csv')">
                                        <i class="fas fa-file-csv"></i> Export as CSV
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportMOTData('json')">
                                        <i class="fas fa-file-code"></i> Export as JSON
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Import MOT Data</label>
                                <div class="file-input-group">
                                    <input type="file" id="import-mot-data" accept=".csv,.json" style="display: none;" onchange="importMOTData(event)">
                                    <button class="btn btn-secondary" onclick="document.getElementById('import-mot-data').click()">
                                        <i class="fas fa-upload"></i> Import Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">Completion Tracking</label>
                                <div class="button-group">
                                    <button class="btn btn-warning" onclick="clearCompletionHistory()">
                                        <i class="fas fa-eraser"></i> Clear Completion History
                                    </button>
                                    <button class="btn btn-info" onclick="exportCompletionData()">
                                        <i class="fas fa-download"></i> Export Completion Data
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Backup & Restore</label>
                                <div class="button-group">
                                    <button class="btn btn-success" onclick="createBackup()">
                                        <i class="fas fa-shield-alt"></i> Create Backup
                                    </button>
                                    <button class="btn btn-danger" onclick="restoreFromBackup()">
                                        <i class="fas fa-history"></i> Restore Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Settings Content -->
                <div id="system-settings" class="settings-content">
                    <h3><i class="fas fa-desktop"></i> System Settings</h3>

                    <div class="settings-section">
                        <h4><i class="fas fa-calendar-alt"></i> Date Format Preferences</h4>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Date Format
                                    <span class="help-text">Choose how dates are displayed throughout the system</span>
                                </label>
                                <select id="date-format" class="form-control">
                                    <option value="DD-MM-YYYY" selected>DD-MM-YYYY (31-12-2024)</option>
                                    <option value="MM-DD-YYYY">MM-DD-YYYY (12-31-2024)</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD (2024-12-31)</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY (31/12/2024)</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY (12/31/2024)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Time Format
                                    <span class="help-text">Choose 12-hour or 24-hour time format</span>
                                </label>
                                <select id="time-format" class="form-control">
                                    <option value="24h" selected>24-hour (14:30)</option>
                                    <option value="12h">12-hour (2:30 PM)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-table"></i> Display Preferences</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Table Row Density
                                    <span class="help-text">Spacing between table rows</span>
                                </label>
                                <select id="table-density" class="form-control">
                                    <option value="compact">Compact</option>
                                    <option value="normal" selected>Normal</option>
                                    <option value="comfortable">Comfortable</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Default Page Size
                                    <span class="help-text">Number of items shown per page</span>
                                </label>
                                <select id="page-size" class="form-control">
                                    <option value="10">10 items</option>
                                    <option value="25" selected>25 items</option>
                                    <option value="50">50 items</option>
                                    <option value="100">100 items</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    UI Theme
                                    <span class="help-text">Choose the application theme</span>
                                </label>
                                <select id="ui-theme" class="form-control">
                                    <option value="light" selected>Light Theme</option>
                                    <option value="dark">Dark Theme</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="show-tooltips" checked>
                                <span class="checkmark"></span>
                                Show helpful tooltips and hints
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="auto-save" checked>
                                <span class="checkmark"></span>
                                Auto-save form data as you type
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-bell"></i> Notification Settings</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="desktop-notifications" checked>
                                    <span class="checkmark"></span>
                                    Enable desktop notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sound-notifications">
                                    <span class="checkmark"></span>
                                    Play sound for notifications
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Notification Duration
                                <span class="help-text">How long notifications stay visible</span>
                            </label>
                            <select id="notification-duration" class="form-control">
                                <option value="3000">3 seconds</option>
                                <option value="5000" selected>5 seconds</option>
                                <option value="10000">10 seconds</option>
                                <option value="0">Until dismissed</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Garage Information Settings Content -->
                <div id="garage-settings" class="settings-content">
                    <h3><i class="fas fa-building"></i> Garage Information</h3>

                    <div class="settings-section">
                        <h4><i class="fas fa-building"></i> Business Information</h4>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Garage Name
                                    <span class="help-text">Your business trading name</span>
                                </label>
                                <input type="text" id="garage-name" class="form-control"
                                       placeholder="Enter garage name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Business Registration Number
                                    <span class="help-text">Company registration or VAT number</span>
                                </label>
                                <input type="text" id="business-reg" class="form-control"
                                       placeholder="Enter registration number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Business Address
                                <span class="help-text">Full business address</span>
                            </label>
                            <textarea id="garage-address" class="form-control" rows="3"
                                      placeholder="Enter full business address"></textarea>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-phone"></i> Contact Information</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Main Phone Number
                                    <span class="help-text">Primary contact number</span>
                                </label>
                                <input type="tel" id="garage-phone" class="form-control"
                                       placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Mobile Number
                                    <span class="help-text">Mobile contact number</span>
                                </label>
                                <input type="tel" id="garage-mobile" class="form-control"
                                       placeholder="Enter mobile number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Email Address
                                    <span class="help-text">Business email address</span>
                                </label>
                                <input type="email" id="garage-email" class="form-control"
                                       placeholder="Enter email address">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Website URL
                                    <span class="help-text">Business website (optional)</span>
                                </label>
                                <input type="url" id="garage-website" class="form-control"
                                       placeholder="https://www.example.com">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-clock"></i> Operating Hours</h3>
                        <div class="operating-hours">
                            <div class="day-hours">
                                <label class="day-label">Monday</label>
                                <input type="time" id="mon-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="mon-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="mon-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Tuesday</label>
                                <input type="time" id="tue-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="tue-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="tue-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Wednesday</label>
                                <input type="time" id="wed-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="wed-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="wed-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Thursday</label>
                                <input type="time" id="thu-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="thu-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="thu-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Friday</label>
                                <input type="time" id="fri-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="fri-close" class="time-input" value="17:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="fri-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Saturday</label>
                                <input type="time" id="sat-open" class="time-input" value="08:00">
                                <span>to</span>
                                <input type="time" id="sat-close" class="time-input" value="13:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sat-closed">
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                            <div class="day-hours">
                                <label class="day-label">Sunday</label>
                                <input type="time" id="sun-open" class="time-input" value="10:00">
                                <span>to</span>
                                <input type="time" id="sun-close" class="time-input" value="16:00">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sun-closed" checked>
                                    <span class="checkmark"></span>
                                    Closed
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Account Settings Content -->
                <div id="user-settings" class="settings-content">
                    <h3><i class="fas fa-user"></i> User Account Settings</h3>

                    <div class="settings-section">
                        <h4><i class="fas fa-user"></i> Account Information</h4>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Full Name
                                    <span class="help-text">Your full name</span>
                                </label>
                                <input type="text" id="user-name" class="form-control"
                                       placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Email Address
                                    <span class="help-text">Your email address</span>
                                </label>
                                <input type="email" id="user-email" class="form-control"
                                       placeholder="Enter your email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Job Title
                                    <span class="help-text">Your role in the garage</span>
                                </label>
                                <input type="text" id="user-title" class="form-control"
                                       placeholder="e.g., Manager, Technician">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Phone Number
                                    <span class="help-text">Your contact number</span>
                                </label>
                                <input type="tel" id="user-phone" class="form-control"
                                       placeholder="Enter your phone number">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-shield-alt"></i> Security Settings</h3>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="changePassword()">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="two-factor-auth">
                                <span class="checkmark"></span>
                                Enable two-factor authentication
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="session-timeout" checked>
                                <span class="checkmark"></span>
                                Auto-logout after inactivity
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-cog"></i> Personal Preferences</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Language
                                    <span class="help-text">Interface language</span>
                                </label>
                                <select id="user-language" class="form-control">
                                    <option value="en" selected>English</option>
                                    <option value="es">Espa√±ol</option>
                                    <option value="fr">Fran√ßais</option>
                                    <option value="de">Deutsch</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Timezone
                                    <span class="help-text">Your local timezone</span>
                                </label>
                                <select id="user-timezone" class="form-control">
                                    <option value="Europe/London" selected>London (GMT)</option>
                                    <option value="Europe/Paris">Paris (CET)</option>
                                    <option value="America/New_York">New York (EST)</option>
                                    <option value="America/Los_Angeles">Los Angeles (PST)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="email-notifications" checked>
                                <span class="checkmark"></span>
                                Receive email notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="marketing-emails">
                                <span class="checkmark"></span>
                                Receive marketing emails
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Data Upload Settings Content -->
                <div id="data-upload" class="settings-content">
                    <h3><i class="fas fa-upload"></i> Data Upload & Import</h3>

                    <div class="settings-section">
                        <h4><i class="fas fa-file-csv"></i> CSV Data Import</h4>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">Quick Upload</label>
                                <div class="button-group">
                                    <button class="btn btn-primary" onclick="window.open('/upload', '_blank')">
                                        <i class="fas fa-external-link-alt"></i> Open Upload Interface
                                    </button>
                                    <button class="btn btn-secondary" onclick="downloadAllTemplates()">
                                        <i class="fas fa-download"></i> Download All Templates
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Database Status</label>
                                <div id="database-stats" class="stats-display">
                                    <div class="stat-item">
                                        <span class="stat-label">Customers:</span>
                                        <span class="stat-value" id="db-customers-count">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Vehicles:</span>
                                        <span class="stat-value" id="db-vehicles-count">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Jobs:</span>
                                        <span class="stat-value" id="db-jobs-count">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Invoices:</span>
                                        <span class="stat-value" id="db-invoices-count">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="auto-validate-uploads" checked>
                                <span class="checkmark"></span>
                                Automatically validate uploaded data
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="backup-before-import" checked>
                                <span class="checkmark"></span>
                                Create backup before large imports
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Backup & Restore Settings Content -->
                <div id="backup-restore" class="settings-content">
                    <h3><i class="fas fa-shield-alt"></i> Backup & Restore</h3>

                    <div class="settings-section">
                        <h4><i class="fas fa-save"></i> Data Backup</h4>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">Create Backup</label>
                                <div class="button-group">
                                    <button class="btn btn-success" onclick="createFullBackup()">
                                        <i class="fas fa-database"></i> Full Database Backup
                                    </button>
                                    <button class="btn btn-info" onclick="createMOTBackup()">
                                        <i class="fas fa-calendar-check"></i> MOT Data Only
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Export Data</label>
                                <div class="button-group">
                                    <button class="btn btn-secondary" onclick="exportAllData('csv')">
                                        <i class="fas fa-file-csv"></i> Export as CSV
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportAllData('json')">
                                        <i class="fas fa-file-code"></i> Export as JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Automatic Backup Schedule
                                <span class="help-text">How often to create automatic backups</span>
                            </label>
                            <select id="backup-schedule" class="form-control">
                                <option value="disabled">Disabled</option>
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-history"></i> Data Restore</h4>
                        <div class="form-group">
                            <label class="form-label">Restore from Backup</label>
                            <div class="file-input-group">
                                <input type="file" id="restore-backup-file" accept=".db,.sql,.json" style="display: none;" onchange="restoreFromFile(event)">
                                <button class="btn btn-warning" onclick="document.getElementById('restore-backup-file').click()">
                                    <i class="fas fa-upload"></i> Select Backup File
                                </button>
                            </div>
                            <span class="help-text">‚ö†Ô∏è This will replace all current data. Create a backup first!</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">System Maintenance</label>
                            <div class="button-group">
                                <button class="btn btn-info" onclick="optimizeDatabase()">
                                    <i class="fas fa-tools"></i> Optimize Database
                                </button>
                                <button class="btn btn-warning" onclick="clearTempData()">
                                    <i class="fas fa-broom"></i> Clear Temp Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customer-detail-modal" class="modal">
        <div class="modal-content" style="width: 95vw; max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title" id="customer-detail-title">Customer Details</h2>
                <button class="modal-close" onclick="closeCustomerDetail()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>Customer Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Account Number</span>
                            <span class="detail-value">
                                <input type="text" id="customer-account-number" onchange="updateCustomerField('account_number', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Company</span>
                            <span class="detail-value">
                                <input type="text" id="customer-company" onchange="updateCustomerField('company_name', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Name</span>
                            <span class="detail-value">
                                <input type="text" id="customer-name" onchange="updateCustomerField('name', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Address</span>
                            <span class="detail-value">
                                <input type="text" id="customer-address" onchange="updateCustomerField('address', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Postcode</span>
                            <span class="detail-value">
                                <input type="text" id="customer-postcode" onchange="updateCustomerField('postcode', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Mobile</span>
                            <span class="detail-value">
                                <input type="text" id="customer-mobile" onchange="updateCustomerField('mobile', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email</span>
                            <span class="detail-value">
                                <input type="text" id="customer-email" onchange="updateCustomerField('email', this.value)">
                            </span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h3>Account Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Customer Since</span>
                            <span class="detail-value" id="customer-since">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Total Vehicles</span>
                            <span class="detail-value" id="customer-vehicle-count">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Total Services</span>
                            <span class="detail-value" id="customer-service-count">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Last Service</span>
                            <span class="detail-value" id="customer-last-service">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Account Balance</span>
                            <span class="detail-value" id="customer-balance">¬£0.00</span>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab-list">
                        <button class="tab-button active" onclick="showCustomerTab('vehicles')">Vehicles</button>
                        <button class="tab-button" onclick="showCustomerTab('history')">Service History</button>
                        <button class="tab-button" onclick="showCustomerTab('invoices')">Invoices</button>
                        <button class="tab-button" onclick="showCustomerTab('documents')">Documents</button>
                    </div>
                </div>

                <div id="customer-tab-vehicles" class="tab-content active">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Registration</th>
                                    <th class="col-medium">Make</th>
                                    <th class="col-medium">Model</th>
                                    <th class="col-narrow">Color</th>
                                    <th class="col-medium">MOT Due</th>
                                    <th class="col-narrow">Mileage</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customer-vehicles-table">
                                <tr>
                                    <td colspan="7" class="loading">
                                        <div class="spinner"></div>
                                        Loading vehicles...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="customer-tab-history" class="tab-content">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Date</th>
                                    <th class="col-medium">Vehicle</th>
                                    <th class="col-extra-wide">Description</th>
                                    <th class="col-narrow">Total</th>
                                    <th class="col-narrow">Status</th>
                                </tr>
                            </thead>
                            <tbody id="customer-history-table">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <div class="spinner"></div>
                                        Loading service history...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="customer-tab-invoices" class="tab-content">
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-medium">Invoice No</th>
                                    <th class="col-medium">Date</th>
                                    <th class="col-medium">Vehicle</th>
                                    <th class="col-extra-wide">Description</th>
                                    <th class="col-narrow">Total</th>
                                    <th class="col-narrow">Status</th>
                                </tr>
                            </thead>
                            <tbody id="customer-invoices-table">
                                <tr>
                                    <td colspan="6" class="loading">
                                        <div class="spinner"></div>
                                        Loading invoices...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="customer-tab-documents" class="tab-content">
                    <p>Customer documents will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Detail Modal -->
    <div id="vehicle-detail-modal" class="modal">
        <div class="modal-content" style="width: 95vw; max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title" id="vehicle-detail-title">Vehicle Details</h2>
                <button class="modal-close" onclick="closeVehicleDetail()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>Vehicle Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Registration</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-registration" onchange="updateVehicleField('registration', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Make</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-make" onchange="updateVehicleField('make', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Model</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-model" onchange="updateVehicleField('model', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Color</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-color" onchange="updateVehicleField('color', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fuel Type</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-fuel-type" onchange="updateVehicleField('fuel_type', this.value)">
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Mileage</span>
                            <span class="detail-value">
                                <input type="text" id="vehicle-mileage" onchange="updateVehicleField('mileage', this.value)">
                            </span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h3>Owner Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Customer</span>
                            <span class="detail-value" id="vehicle-customer-name">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Account</span>
                            <span class="detail-value" id="vehicle-customer-account">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone</span>
                            <span class="detail-value" id="vehicle-customer-phone">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">MOT Due</span>
                            <span class="detail-value" id="vehicle-mot-due">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Last Service</span>
                            <span class="detail-value" id="vehicle-last-service">-</span>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab-list">
                        <button class="tab-button active" onclick="showVehicleTab('history')">Service History</button>
                        <button class="tab-button" onclick="showVehicleTab('jobs')">Jobs</button>
                        <button class="tab-button" onclick="showVehicleTab('invoices')">Invoices</button>
                        <button class="tab-button" onclick="showVehicleTab('documents')">Documents</button>
                    </div>
                </div>

                <div id="vehicle-tab-history" class="tab-content active">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Doc No</th>
                                <th>Mileage</th>
                                <th>Description</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-history-table">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Loading service history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="vehicle-tab-jobs" class="tab-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Job No</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-jobs-table">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Loading jobs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="vehicle-tab-invoices" class="tab-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Invoice No</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-invoices-table">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Loading invoices...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="vehicle-tab-documents" class="tab-content">
                    <p>Vehicle documents will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div id="invoice-detail-modal" class="modal">
        <div class="modal-content" style="width: 95vw; max-width: 1400px;">
            <div class="modal-body">
                <div class="invoice-header">
                    <h2 class="invoice-title" id="invoice-detail-title">Standard Invoice: 88187 (JS: 90242) (Issued)</h2>
                    <button class="modal-close" onclick="closeInvoiceDetail()">&times;</button>
                </div>

                <div class="invoice-grid">
                    <div class="invoice-section">
                        <h3>Vehicle Information</h3>
                        <div class="invoice-field">
                            <span class="invoice-label">Registration</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-registration" onchange="updateInvoiceField('vehicle.registration', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Make / Model</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-make-model" onchange="updateInvoiceField('vehicle.make_model', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Chassis</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-chassis" onchange="updateInvoiceField('vehicle.chassis', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Engine CC</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-engine-cc" onchange="updateInvoiceField('vehicle.engine_cc', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Fuel Type</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-fuel-type" onchange="updateInvoiceField('vehicle.fuel_type', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Color</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-color" onchange="updateInvoiceField('vehicle.color', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Mileage</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-vehicle-mileage" onchange="updateInvoiceField('vehicle.mileage', this.value)">
                            </span>
                        </div>
                    </div>
                    <div class="invoice-section">
                        <h3>Customer Information</h3>
                        <div class="invoice-field">
                            <span class="invoice-label">Account Number</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-account" onchange="updateInvoiceField('customer.account_number', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Company</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-company" onchange="updateInvoiceField('customer.company', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Name</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-name" onchange="updateInvoiceField('customer.name', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Address</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-address" onchange="updateInvoiceField('customer.address', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Postcode</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-postcode" onchange="updateInvoiceField('customer.postcode', this.value)">
                            </span>
                        </div>
                        <div class="invoice-field">
                            <span class="invoice-label">Mobile</span>
                            <span class="invoice-value">
                                <input type="text" id="invoice-customer-mobile" onchange="updateInvoiceField('customer.mobile', this.value)">
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Job Information Section -->
                <div class="invoice-section" style="margin-bottom: 2rem;">
                    <h3>Job Information</h3>
                    <div class="invoice-field">
                        <span class="invoice-label">Job Number</span>
                        <span class="invoice-value">
                            <input type="text" id="invoice-job-number" readonly style="background: #f8f9fa;">
                        </span>
                    </div>
                    <div class="invoice-field">
                        <span class="invoice-label">Job Amount</span>
                        <span class="invoice-value">
                            <input type="text" id="invoice-job-amount" readonly style="background: #f8f9fa;">
                        </span>
                    </div>
                    <div class="invoice-field">
                        <span class="invoice-label">Invoice Amount</span>
                        <span class="invoice-value">
                            <input type="text" id="invoice-amount" readonly style="background: #f8f9fa;">
                        </span>
                    </div>
                    <div class="invoice-field">
                        <span class="invoice-label">Status</span>
                        <span class="invoice-value">
                            <input type="text" id="invoice-status" readonly style="background: #f8f9fa;">
                        </span>
                    </div>
                </div>

                <div class="invoice-tabs">
                    <div class="invoice-tab-list">
                        <button class="invoice-tab-button active" onclick="showInvoiceTab('history')">History</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('description')">Description</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('labour')">Labour</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('parts')">Parts</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('advisories')">Advisories</button>
                        <button class="invoice-tab-button" onclick="showInvoiceTab('activity')">Activity</button>
                    </div>
                </div>

                <div id="invoice-tab-history" class="invoice-tab-content active">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Doc No</th>
                                <th>Mileage</th>
                                <th>Description</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-history-table">
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>
                                    Loading history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="invoice-tab-description" class="invoice-tab-content">
                    <div style="padding: 1rem;">
                        <textarea id="invoice-description" style="width: 100%; height: 200px; padding: 1rem; border: 1px solid #dee2e6; border-radius: 4px;" onchange="updateInvoiceField('description', this.value)"></textarea>
                    </div>
                </div>

                <div id="invoice-tab-labour" class="invoice-tab-content">
                    <p>Labour details will be displayed here.</p>
                </div>

                <div id="invoice-tab-parts" class="invoice-tab-content">
                    <p>Parts details will be displayed here.</p>
                </div>

                <div id="invoice-tab-advisories" class="invoice-tab-content">
                    <p>Advisories will be displayed here.</p>
                </div>

                <div id="invoice-tab-activity" class="invoice-tab-content">
                    <p>Activity log will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="add-vehicle-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Add Vehicle for MOT Monitoring</h2>
                <button class="modal-close" onclick="closeAddVehicleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-vehicle-form" onsubmit="addMOTVehicle(event)">
                    <div class="form-group">
                        <label class="form-label">Vehicle Registration</label>
                        <input type="text" id="vehicle-registration-input" class="form-control"
                               placeholder="e.g., AB12 CDE" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Name (Optional)</label>
                        <input type="text" id="customer-name-input" class="form-control"
                               placeholder="Customer name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobile Number (Optional)</label>
                        <input type="text" id="mobile-number-input" class="form-control"
                               placeholder="e.g., 07123456789">
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeAddVehicleModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Vehicle
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulk-upload-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Bulk Upload Vehicles</h2>
                <button class="modal-close" onclick="closeBulkUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Upload CSV or Excel File</label>
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: #0066cc;"></i>
                            <strong style="color: #0066cc;">DVLA Data Only</strong>
                        </div>
                        <p style="margin: 0; font-size: 0.9rem; color: #0066cc;">
                            Only vehicles found in the DVLA database will be added. Vehicles not found will be skipped to ensure data accuracy.
                        </p>
                    </div>
                    <div class="drag-drop-area" id="file-drop-area" onclick="document.getElementById('file-input').click()">
                        <div class="file-upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <p><strong>Click to select file</strong> or drag and drop</p>
                        <p style="font-size: 0.9rem; color: #6c757d;">Supports CSV and Excel files (.csv, .xlsx, .xls)</p>
                    </div>
                    <input type="file" id="file-input" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                </div>

                <div id="file-preview" style="display: none; margin-top: 1rem;">
                    <h5>File Preview:</h5>
                    <div id="file-info" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"></div>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        <table class="data-table" style="margin: 0;">
                            <thead id="preview-header"></thead>
                            <tbody id="preview-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Download Template</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="downloadTemplate('csv')">
                            <i class="fas fa-download"></i> CSV Template
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="downloadTemplate('excel')">
                            <i class="fas fa-download"></i> Excel Template
                        </button>
                    </div>
                    <small class="text-muted">Download a template file with the correct format</small>
                </div>

                <!-- Progress indicator -->
                <div id="upload-progress" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 0.375rem;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <div id="progress-text">Processing vehicles...</div>
                            <div class="progress" style="width: 300px; height: 8px; margin-top: 0.5rem;">
                                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" id="cancel-upload-btn" onclick="closeBulkUploadModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="upload-btn" onclick="processBulkUpload()" disabled>
                        <i class="fas fa-upload"></i> Upload Vehicles
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SMS Modal -->
    <div id="sms-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Send MOT Reminder SMS</h2>
                <button class="modal-close" onclick="closeSMSModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5>Selected Vehicles for SMS</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="selectUrgentVehicles()">
                                <i class="fas fa-exclamation-triangle"></i> Select Urgent Only
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="clearSMSSelection()">
                                <i class="fas fa-times"></i> Clear Selection
                            </button>
                        </div>
                    </div>

                    <div id="sms-vehicle-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        <!-- Selected vehicles will be listed here -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">SMS Service Status</label>
                    <div id="sms-service-status" style="padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
                        <i class="fas fa-info-circle"></i> Checking SMS service status...
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeSMSModal()">Cancel</button>
                    <button type="button" class="btn btn-success" id="send-sms-btn" onclick="sendBulkSMS()" disabled>
                        <i class="fas fa-sms"></i> Send SMS (<span id="sms-send-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Failed Registrations Review Modal -->
    <div id="failed-registrations-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title">Review Failed Registrations</h2>
                <button class="modal-close" onclick="closeFailedRegistrationsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5>Failed Registrations for Manual Review</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="loadFailedRegistrations()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-sm btn-success" onclick="bulkProcessSelected()">
                                <i class="fas fa-check"></i> Process Selected
                            </button>
                        </div>
                    </div>

                    <div id="failed-registrations-list" style="max-height: 500px; overflow-y: auto;">
                        <div class="loading" style="text-align: center; padding: 2rem;">
                            <div class="spinner"></div>
                            Loading failed registrations...
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeFailedRegistrationsModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SMS History Modal -->
    <div id="sms-history-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title">SMS History & Message Log</h2>
                <button class="modal-close" onclick="closeSMSHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5>SMS Message History</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="loadSMSHistory()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-sm btn-info" onclick="checkDeliveryStatus()">
                                <i class="fas fa-sync"></i> Check Delivery Status
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="exportSMSHistory()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div>
                                <label class="form-label">Filter by Registration:</label>
                                <input type="text" id="sms-history-filter" placeholder="Enter registration..."
                                       onkeyup="filterSMSHistory()" style="padding: 0.25rem;">
                            </div>
                            <div>
                                <label class="form-label">Show Last:</label>
                                <select id="sms-history-limit" onchange="loadSMSHistory()" style="padding: 0.25rem;">
                                    <option value="50">50 messages</option>
                                    <option value="100">100 messages</option>
                                    <option value="200">200 messages</option>
                                    <option value="500">500 messages</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="sms-history-list" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        <div class="loading" style="text-align: center; padding: 2rem;">
                            <div class="spinner"></div>
                            Loading SMS history...
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeSMSHistoryModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Monitoring System - Moved to external file -->
    <script src="js/error-monitoring.js"></script>

    <!-- Main Application JavaScript - Moved to external file -->
    <script src="js/main-app.js"></script>

    <!-- Application Initialization - Moved to external file -->
    <script src="js/app-init.js"></script>



                // Moved to error-monitoring.js

                // Moved to error-monitoring.js

                // Enhanced automatic updates with error handling and performance optimization
                let dashboardUpdateInterval = null;
                let lastDashboardUpdate = 0;
                const DASHBOARD_UPDATE_COOLDOWN = 30000; // 30 seconds minimum between updates

                function safeDashboardUpdate() {
                    try {
                        const now = Date.now();
                        if (now - lastDashboardUpdate < DASHBOARD_UPDATE_COOLDOWN) {
                            console.log('üìä Dashboard update skipped - too soon');
                            return;
                        }

                        lastDashboardUpdate = now;

                        // Only update if dashboard is visible
                        const dashboardElement = document.getElementById('dashboard');
                        if (dashboardElement && dashboardElement.classList.contains('active')) {
                            console.log('üìä Updating dashboard...');

                            // Update stats with timeout
                            Promise.race([
                                loadDashboardStats(),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
                            ]).catch(error => {
                                console.warn('‚ö†Ô∏è Dashboard stats update failed:', error.message);
                            });

                            // Update recent items with timeout
                            Promise.race([
                                loadRecentActivity(),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
                            ]).catch(error => {
                                console.warn('‚ö†Ô∏è Recent items update failed:', error.message);
                            });
                        }
                    } catch (error) {
                        console.error('‚ùå Dashboard update error:', error);
                    }
                }

                // Start safe dashboard updates
                dashboardUpdateInterval = setInterval(safeDashboardUpdate, 45000); // 45 seconds

                // Enhanced Error Monitoring Auto-Updates with safety measures
                let errorMonitoringUpdateInterval = null;
                let lastErrorMonitoringUpdate = 0;
                const ERROR_MONITORING_UPDATE_COOLDOWN = 60000; // 60 seconds minimum between updates

                function safeErrorMonitoringUpdate() {
                    try {
                        const now = Date.now();
                        if (now - lastErrorMonitoringUpdate < ERROR_MONITORING_UPDATE_COOLDOWN) {
                            console.log('üõ°Ô∏è Error monitoring update skipped - too soon');
                            return;
                        }

                        lastErrorMonitoringUpdate = now;

                        // Only update if error monitoring dashboard is visible and active
                        const errorMonitoringElement = document.getElementById('error-monitoring');
                        if (errorMonitoringElement && errorMonitoringElement.classList.contains('active')) {
                            console.log('üõ°Ô∏è Updating error monitoring dashboard...');

                            // Safe update with timeout and error handling
                            Promise.race([
                                updateErrorMonitoringDashboard(),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 15000))
                            ]).catch(error => {
                                console.warn('‚ö†Ô∏è Error monitoring update failed:', error.message);
                                // Don't show user notification for background updates
                            });
                        }
                    } catch (error) {
                        console.error('‚ùå Error monitoring update error:', error);
                    }
                }

                // Start safe error monitoring updates (every 90 seconds)
                errorMonitoringUpdateInterval = setInterval(safeErrorMonitoringUpdate, 90000);

                // Cleanup on page unload
                window.addEventListener('beforeunload', () => {
                    if (dashboardUpdateInterval) {
                        clearInterval(dashboardUpdateInterval);
                    }
                    if (errorMonitoringUpdateInterval) {
                        clearInterval(errorMonitoringUpdateInterval);
                    }
                });

                // Navigation system is ready globally

            } catch (error) {
                console.error('üí• Application initialization failed:', error);
            }
        });

        // Navigation functions are now defined globally above

        // Dashboard functions - Updated to use real API data
        function loadDashboardStats() {
            console.log('üìä Loading dashboard statistics...');

            // Use the /api/stats endpoint which returns properly formatted data
            fetch('/api/stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('üìä Dashboard stats loaded:', result);

                    // API returns data wrapped in success/stats format
                    if (result && result.success && result.stats) {
                        const stats = result.stats;
                        console.log('üîÑ Updating dashboard elements...');

                        // Check if elements exist
                        const customersEl = document.getElementById('total-customers');
                        const vehiclesEl = document.getElementById('total-vehicles');
                        const revenueEl = document.getElementById('total-revenue');
                        const jobsEl = document.getElementById('total-jobs');

                        console.log('üìç Dashboard elements found:', {
                            customers: !!customersEl,
                            vehicles: !!vehiclesEl,
                            revenue: !!revenueEl,
                            jobs: !!jobsEl
                        });

                        // Update dashboard cards with real data
                        if (customersEl) customersEl.textContent = stats.customers.toLocaleString();
                        if (vehiclesEl) vehiclesEl.textContent = stats.vehicles.toLocaleString();

                        // Revenue is already formatted as a string from the API
                        if (revenueEl) revenueEl.textContent = stats.revenue;

                        // Use jobs count
                        const jobsCount = stats.jobs || stats.documents || 0;
                        if (jobsEl) jobsEl.textContent = jobsCount.toLocaleString();

                        console.log('‚úÖ Dashboard stats updated successfully');
                    } else {
                        console.error('‚ùå Invalid API response format:', result);
                        showDashboardError();
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading dashboard stats:', error);
                    showDashboardError();
                });
        }

        // Show error state on dashboard
        function showDashboardError() {
            document.getElementById('total-customers').textContent = 'Error';
            document.getElementById('total-vehicles').textContent = 'Error';
            document.getElementById('total-revenue').textContent = 'Error';
            document.getElementById('total-jobs').textContent = 'Error';
        }

        // Load MOT data for dashboard
        function loadMOTDashboardData() {
            console.log('üöó Loading MOT dashboard data...');

            // Only load if we're on a page that has MOT dashboard elements
            if (!document.getElementById('mot-expired') && !document.getElementById('urgent-mot-list')) {
                return;
            }

            fetch('/api/mot/vehicles')
                .then(response => response.json())
                .then(data => {
                    console.log('üöó MOT data loaded:', data);

                    // Calculate MOT statistics
                    const expired = data.filter(v => v.is_expired).length;
                    const critical = data.filter(v => !v.is_expired && v.days_until_expiry <= 7).length;
                    const dueSoon = data.filter(v => !v.is_expired && v.days_until_expiry > 7 && v.days_until_expiry <= 30).length;
                    const valid = data.filter(v => !v.is_expired && v.days_until_expiry > 30).length;

                    // Update MOT statistics
                    document.getElementById('mot-expired').textContent = expired;
                    document.getElementById('mot-critical').textContent = critical;
                    document.getElementById('mot-due-soon').textContent = dueSoon;
                    document.getElementById('mot-valid').textContent = valid;

                    // Show urgent MOT vehicles (expired and critical)
                    const urgentVehicles = data.filter(v => v.is_expired || v.days_until_expiry <= 7)
                                              .sort((a, b) => a.days_until_expiry - b.days_until_expiry)
                                              .slice(0, 5); // Show top 5 most urgent

                    displayUrgentMOTVehicles(urgentVehicles);
                })
                .catch(error => {
                    console.error('‚ùå Error loading MOT data:', error);

                    // Only update elements if they exist (dashboard page)
                    const urgentList = document.getElementById('urgent-mot-list');
                    if (urgentList) {
                        urgentList.innerHTML = '<p class="text-danger">Error loading MOT data</p>';
                    }

                    // Set error values for MOT stats if elements exist
                    const motExpired = document.getElementById('mot-expired');
                    const motCritical = document.getElementById('mot-critical');
                    const motDueSoon = document.getElementById('mot-due-soon');
                    const motValid = document.getElementById('mot-valid');

                    if (motExpired) motExpired.textContent = '0';
                    if (motCritical) motCritical.textContent = '0';
                    if (motDueSoon) motDueSoon.textContent = '0';
                    if (motValid) motValid.textContent = '0';
                });
        }

        // Display urgent MOT vehicles on dashboard
        function displayUrgentMOTVehicles(vehicles) {
            const container = document.getElementById('urgent-mot-list');

            // Check if container exists (only on dashboard)
            if (!container) {
                return;
            }

            if (vehicles.length === 0) {
                container.innerHTML = '<p class="text-success"><i class="fas fa-check-circle"></i> No urgent MOT reminders</p>';
                return;
            }

            let html = '<div style="max-height: 200px; overflow-y: auto;"><table class="table table-sm table-hover">';
            html += '<thead><tr><th>Registration</th><th>Vehicle</th><th>Customer</th><th>Status</th></tr></thead><tbody>';

            vehicles.forEach(vehicle => {
                const statusClass = vehicle.is_expired ? 'badge bg-danger' : 'badge bg-warning text-dark';
                const statusText = vehicle.is_expired ? 'EXPIRED' : `${vehicle.days_until_expiry} days`;

                html += `<tr>
                    <td><strong>${vehicle.registration}</strong></td>
                    <td>${vehicle.make} ${vehicle.model}</td>
                    <td>${vehicle.customer_name || 'Unknown'}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Load SMS data for dashboard
        function loadSMSDashboardData() {
            console.log('üì± Loading SMS dashboard data...');

            // Only load if we're on a page that has SMS dashboard elements
            if (!document.getElementById('sms-total-vehicles')) {
                return;
            }

            Promise.all([
                fetch('/api/mot/vehicles').then(r => r.json()),
                fetch('/api/mot/sms/status').then(r => r.json())
            ])
            .then(([vehicles, smsStatus]) => {
                console.log('üì± SMS data loaded:', { vehicles: vehicles.length, smsStatus });

                // Calculate SMS statistics
                const totalVehicles = vehicles.length;
                const withMobile = vehicles.filter(v => v.mobile_number).length;
                const urgent = vehicles.filter(v => (v.is_expired || v.days_until_expiry <= 7) && v.mobile_number).length;
                const coverage = totalVehicles > 0 ? Math.round((withMobile / totalVehicles) * 100) : 0;

                // Update SMS statistics
                document.getElementById('sms-total-vehicles').textContent = totalVehicles;
                document.getElementById('sms-with-mobile').textContent = withMobile;
                document.getElementById('sms-urgent').textContent = urgent;
                document.getElementById('sms-coverage').textContent = coverage + '%';

                // Display SMS service status
                displaySMSServiceStatus(smsStatus);
            })
            .catch(error => {
                console.error('‚ùå Error loading SMS data:', error);
                document.getElementById('sms-service-status').innerHTML = '<p class="text-danger">Error loading SMS data</p>';
                // Set error values for SMS stats
                document.getElementById('sms-total-vehicles').textContent = '0';
                document.getElementById('sms-with-mobile').textContent = '0';
                document.getElementById('sms-urgent').textContent = '0';
                document.getElementById('sms-coverage').textContent = '0%';
            });
        }

        // Display SMS service status
        function displaySMSServiceStatus(status) {
            const container = document.getElementById('sms-service-status');

            if (status.configured) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> SMS Service Active
                        <small class="d-block">Ready to send MOT reminders</small>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> SMS Service in Demo Mode
                        <small class="d-block">Configure Twilio credentials to send real SMS</small>
                    </div>
                `;
            }
        }

        // Load recent activity for dashboard
        function loadRecentActivity() {
            console.log('üìà Loading recent activity...');

            const activityContent = document.getElementById('recent-activity-content');
            if (!activityContent) return;

            // Load recent jobs and invoices
            Promise.all([
                fetch('/api/jobs?limit=5').then(r => r.json()),
                fetch('/api/invoices?limit=5').then(r => r.json())
            ])
            .then(([jobsResult, invoicesResult]) => {
                const recentJobs = (jobsResult && jobsResult.jobs) ? jobsResult.jobs.slice(0, 3) : [];
                const recentInvoices = (invoicesResult && invoicesResult.invoices) ? invoicesResult.invoices.slice(0, 3) : [];

                let activityHTML = '<div class="recent-activity-list">';

                // Add recent jobs
                recentJobs.forEach(job => {
                    const date = new Date(job.created_date || job.date).toLocaleDateString('en-GB');
                    activityHTML += `
                        <div class="activity-item">
                            <i class="fas fa-wrench activity-icon job"></i>
                            <div class="activity-details">
                                <div class="activity-title">Job #${job.job_number || job.id}</div>
                                <div class="activity-subtitle">${job.customer_name || 'Customer'} - ${job.registration || 'Vehicle'}</div>
                                <div class="activity-date">${date}</div>
                            </div>
                        </div>
                    `;
                });

                // Add recent invoices
                recentInvoices.forEach(invoice => {
                    const date = new Date(invoice.created_date || invoice.date).toLocaleDateString('en-GB');
                    const amount = invoice.total_amount || invoice.amount || 0;
                    activityHTML += `
                        <div class="activity-item">
                            <i class="fas fa-file-invoice activity-icon invoice"></i>
                            <div class="activity-details">
                                <div class="activity-title">Invoice #${invoice.invoice_number || invoice.id}</div>
                                <div class="activity-subtitle">${invoice.customer_name || 'Customer'} - ¬£${amount.toFixed(2)}</div>
                                <div class="activity-date">${date}</div>
                            </div>
                        </div>
                    `;
                });

                if (recentJobs.length === 0 && recentInvoices.length === 0) {
                    activityHTML += '<div class="no-activity">No recent activity found</div>';
                }

                activityHTML += '</div>';
                activityContent.innerHTML = activityHTML;

                console.log('‚úÖ Recent activity loaded successfully');
            })
            .catch(error => {
                console.error('‚ùå Error loading recent activity:', error);
                activityContent.innerHTML = '<div class="error-message">Error loading recent activity</div>';
            });
        }

        // Customer functions
        function loadCustomers() {
            console.log('üë• loadCustomers() called');
            const tableBody = document.getElementById('customers-table-body');
            console.log('üìç customers-table-body found:', !!tableBody);

            if (!tableBody) {
                console.error('‚ùå customers-table-body element not found!');
                return;
            }

            tableBody.innerHTML = '<tr><td colspan="10" class="loading"><div class="spinner"></div>Loading customers...</td></tr>';

            const url = `/api/customers?page=${currentCustomerPage}&per_page=${currentCustomerPerPage}&search=${encodeURIComponent(currentCustomerSearch)}`;
            console.log('üåê Fetching customers from:', url);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayCustomers(data);
                    updateCustomerPagination(data);
                })
                .catch(error => {
                    console.error('Error loading customers:', error);
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #dc3545;">Error loading customers</td></tr>';
                });
        }

        function displayCustomers(data) {
            console.log('üîÑ displayCustomers called with data:', data);
            const tableBody = document.getElementById('customers-table-body');
            console.log('üìç customers-table-body element found:', !!tableBody);

            // Handle both paginated and non-paginated responses
            const customers = data.customers || data || [];
            console.log(`üìä Processing ${customers.length} customers`);

            if (customers && customers.length > 0) {
                tableBody.innerHTML = customers.map(customer => `
                    <tr>
                        <td>${customer.account_number || '-'}</td>
                        <td>${customer.name || '-'}</td>
                        <td>${customer.company || customer.company_name || '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${customer.address || '-'}</td>
                        <td>${extractPostcode(customer.address) || customer.postcode || '-'}</td>
                        <td>${customer.mobile || customer.phone || customer.telephone || '-'}</td>
                        <td>${customer.vehicle_count || 0}</td>
                        <td>${customer.document_count || 0}</td>
                        <td>-</td>
                        <td>
                            <button class="btn btn-primary" onclick="showCustomerDetailPage('${customer.id || customer.account_number}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No customers found</td></tr>';
            }

            // Update range display
            if (data.page && data.per_page && data.total !== undefined) {
                const start = (data.page - 1) * data.per_page + 1;
                const end = Math.min(data.page * data.per_page, data.total);
                document.getElementById('customer-range').textContent = `${start} to ${end}`;
                document.getElementById('customer-total').textContent = data.total.toLocaleString();
            } else {
                // Fallback for non-paginated data
                const total = customers.length;
                document.getElementById('customer-range').textContent = `1 to ${total}`;
                document.getElementById('customer-total').textContent = total.toLocaleString();
            }
        }

        function updateCustomerPagination(data) {
            const pagination = document.getElementById('customer-pagination');

            // Handle both 'pages' and 'total_pages' formats
            const totalPages = data.total_pages || data.pages;
            const currentPage = data.page;

            // Check if pagination data is available
            if (!totalPages || !currentPage) {
                // Hide pagination for non-paginated data
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // Previous button
            paginationHTML += `<button onclick="changeCustomerPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button onclick="changeCustomerPage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }

            // Next button
            paginationHTML += `<button onclick="changeCustomerPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;

            pagination.innerHTML = paginationHTML;
        }

        function changeCustomerPage(page) {
            currentCustomerPage = page;
            loadCustomers();
        }

        function changeCustomerPerPage() {
            currentCustomerPerPage = parseInt(document.getElementById('customer-per-page').value);
            currentCustomerPage = 1;
            loadCustomers();
        }

        function searchCustomers() {
            currentCustomerSearch = document.getElementById('customer-search').value;
            currentCustomerPage = 1;
            loadCustomers();
        }

        function showCustomerDetailPage(customerId) {
            console.log('üéØ showCustomerDetailPage called with customerId:', customerId);

            // Store the current customer ID for reference
            currentCustomerId = customerId;

            // Check if customer-detail page exists
            const customerDetailPage = document.getElementById('customer-detail');
            console.log('üë§ Customer detail page element found:', !!customerDetailPage);

            if (!customerDetailPage) {
                console.error('‚ùå Customer detail page element not found!');
                showNotification('Customer detail page not found', 'error');
                return;
            }

            // Force remove any modal-like styling
            customerDetailPage.style.position = 'static';
            customerDetailPage.style.background = 'transparent';
            customerDetailPage.style.zIndex = 'auto';
            console.log('üîß Forced customer detail page styling reset');

            // Hide any open modals first
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                modal.classList.remove('active');
                console.log('üö´ Closed modal:', modal.id);
            });

            // Show the customer detail page
            console.log('üîÑ Calling showPage with customer-detail');
            showPage('customer-detail');

            // Load customer details
            loadCustomerDetailsPage(customerId);
        }

        function loadCustomerDetailsPage(customerId) {
            console.log('üîÑ loadCustomerDetailsPage called with customerId:', customerId);

            // Show loading state
            document.getElementById('customer-detail-title').innerHTML = `
                <i class="fas fa-user"></i>
                <i class="fas fa-spinner fa-spin" style="margin-left: 0.5rem;"></i>
                Loading Customer Details...
            `;

            // Construct API URL
            const apiUrl = `/api/customers/${customerId}`;
            console.log('üåê Fetching customer details from:', apiUrl);

            // Fetch customer details from API
            fetch(apiUrl)
                .then(response => {
                    console.log('üì° API Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Customer data received:', data);
                    if (data.success && data.customer) {
                        const customer = data.customer;
                        populateCustomerDetailsPage(customer, data.vehicles || [], data.jobs || [], data.invoices || []);
                    } else {
                        throw new Error(data.error || 'Customer data not found');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading customer details:', error);
                    showNotification(`Error loading customer details: ${error.message}`, 'error');

                    // Show error state
                    document.getElementById('customer-detail-title').innerHTML = `
                        <i class="fas fa-user"></i>
                        Error Loading Customer
                    `;
                });
        }

        function populateCustomerDetailsPage(customer, vehicles, jobs, invoices) {
            // Update page title and subtitle
            document.getElementById('customer-detail-title').innerHTML = `
                <i class="fas fa-user"></i>
                ${customer.name || customer.company || 'Customer'}
            `;
            document.getElementById('customer-detail-subtitle').textContent =
                `Account: ${customer.account_number || customer.id} - ${vehicles.length} vehicles, ${jobs.length} services`;

            // Populate customer information (editable fields)
            const editableFields = [
                { id: 'customer-account-number-page', value: customer.account_number },
                { id: 'customer-company-page', value: customer.company },
                { id: 'customer-name-page', value: customer.name },
                { id: 'customer-address-page', value: customer.address },
                { id: 'customer-postcode-page', value: customer.postcode },
                { id: 'customer-mobile-page', value: customer.phone || customer.mobile },
                { id: 'customer-email-page', value: customer.email }
            ];

            editableFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.value = field.value || '';
                } else {
                    console.error(`Element not found: ${field.id}`);
                }
            });

            // Populate account information (read-only)
            document.getElementById('customer-since-page').textContent = formatDate(customer.created_date) || '-';
            document.getElementById('customer-vehicle-count-page').textContent = vehicles.length.toString();
            document.getElementById('customer-service-count-page').textContent = jobs.length.toString();
            document.getElementById('customer-last-service-page').textContent =
                jobs.length > 0 ? formatDate(jobs[0].created_date) : '-';
            document.getElementById('customer-balance-page').textContent =
                '¬£' + (customer.account_balance || 0).toFixed(2);

            // Load customer data into tabs
            loadCustomerVehiclesPage(vehicles);
            loadCustomerHistoryPage(jobs);
            loadCustomerInvoicesPage(invoices);
        }

        function showCustomerPageTab(tabName) {
            console.log('üîÑ Switching to customer tab:', tabName);

            // Remove active class from all tab buttons
            document.querySelectorAll('.customer-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Hide all tab contents
            document.querySelectorAll('.customer-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected tab
            const selectedButton = document.querySelector(`.customer-tab-button[onclick*="'${tabName}'"]`);
            const selectedContent = document.getElementById(`customer-page-tab-${tabName}`);

            if (selectedButton) selectedButton.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');
        }

        function loadCustomerVehiclesPage(vehicles) {
            const tableBody = document.getElementById('customer-vehicles-table-page');

            if (vehicles && vehicles.length > 0) {
                tableBody.innerHTML = vehicles.map(vehicle => `
                    <tr>
                        <td>${vehicle.registration || '-'}</td>
                        <td>${vehicle.make || '-'}</td>
                        <td>${vehicle.model || '-'}</td>
                        <td>${vehicle.color || '-'}</td>
                        <td>${vehicle.mot_due ? formatDate(vehicle.mot_due) : '-'}</td>
                        <td>${vehicle.mileage || '-'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="showVehicleDetailPage('${vehicle.id}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6c757d; padding: 2rem;">No vehicles found</td></tr>';
            }
        }

        function loadCustomerHistoryPage(jobs) {
            const tableBody = document.getElementById('customer-history-table-page');

            if (jobs && jobs.length > 0) {
                tableBody.innerHTML = jobs.map(job => `
                    <tr>
                        <td>${formatDate(job.created_date) || '-'}</td>
                        <td>${job.registration || job.vehicle || '-'}</td>
                        <td>${job.description || job.work_description || '-'}</td>
                        <td>¬£${(job.total_amount || job.total || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${(job.status || 'unknown').toLowerCase()}">${job.status || 'UNKNOWN'}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d; padding: 2rem;">No service history found</td></tr>';
            }
        }

        function loadCustomerInvoicesPage(invoices) {
            const tableBody = document.getElementById('customer-invoices-table-page');

            if (invoices && invoices.length > 0) {
                tableBody.innerHTML = invoices.map(invoice => `
                    <tr>
                        <td>${invoice.invoice_number || invoice.id || '-'}</td>
                        <td>${formatDate(invoice.created_date) || '-'}</td>
                        <td>${invoice.registration || invoice.vehicle || '-'}</td>
                        <td>${invoice.description || '-'}</td>
                        <td>¬£${(invoice.total_amount || invoice.amount || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${(invoice.status || 'unknown').toLowerCase()}">${invoice.status || 'UNKNOWN'}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: 2rem;">No invoices found</td></tr>';
            }
        }

        function editCustomerDetail() {
            showNotification('Customer editing functionality coming soon', 'info');
        }

        function createJobForCustomer() {
            if (currentCustomerId) {
                showNotification('Creating new job for customer...', 'info');
                // This would integrate with the job creation system
            }
        }

        // Keep the original modal function for backward compatibility
        function showCustomerDetail(customerId) {
            currentCustomerId = customerId;
            const modal = document.getElementById('customer-detail-modal');
            modal.classList.add('active');

            // Small delay to ensure modal is rendered
            setTimeout(() => {
                // Load customer details
                fetch(`/api/customers/${customerId}`)
                .then(response => response.json())
                .then(data => {
                    const customer = data.customer;

                    if (!customer) {
                        console.error('No customer data found in response');
                        showNotification('Customer data not found', 'error');
                        return;
                    }

                    document.getElementById('customer-detail-title').textContent = `Customer Details: ${customer.account_number || customer.id} - ${customer.name || customer.company}`;

                    // Populate customer information
                    const fields = [
                        { id: 'customer-account-number', value: customer.account_number },
                        { id: 'customer-company', value: customer.company },
                        { id: 'customer-name', value: customer.name },
                        { id: 'customer-address', value: customer.address },
                        { id: 'customer-postcode', value: customer.postcode },
                        { id: 'customer-mobile', value: customer.phone },
                        { id: 'customer-email', value: customer.email }
                    ];

                    fields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element) {
                            element.value = field.value || '';
                        } else {
                            console.error(`Element not found: ${field.id}`);
                        }
                    });

                    // Populate account information
                    document.getElementById('customer-since').textContent = formatDate(customer.created_date);
                    document.getElementById('customer-vehicle-count').textContent = data.vehicles ? data.vehicles.length : '0';
                    document.getElementById('customer-service-count').textContent = data.jobs ? data.jobs.length : '0';
                    document.getElementById('customer-last-service').textContent = data.jobs && data.jobs.length > 0 ? formatDate(data.jobs[0].created_date) : '-';
                    document.getElementById('customer-balance').textContent = '¬£' + (customer.account_balance || 0).toFixed(2);

                    // Load customer vehicles
                    loadCustomerVehicles(data.vehicles || []);

                    // Load service history
                    loadCustomerHistory(data.jobs || []);

                    // Load customer invoices
                    loadCustomerInvoices(data.invoices || []);
                })
                .catch(error => {
                    console.error('Error loading customer details:', error);
                    showNotification('Error loading customer details', 'error');
                });
            }, 100); // End of setTimeout
        }

        function closeCustomerDetail() {
            document.getElementById('customer-detail-modal').classList.remove('active');
            currentCustomerId = null;
        }

        function showCustomerTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('#customer-detail-modal .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide all tab contents
            document.querySelectorAll('#customer-detail-modal .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.querySelector(`#customer-detail-modal .tab-button[onclick="showCustomerTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`customer-tab-${tabName}`).classList.add('active');
        }

        function loadCustomerVehicles(vehicles) {
            const tableBody = document.getElementById('customer-vehicles-table');
            
            if (vehicles && vehicles.length > 0) {
                tableBody.innerHTML = vehicles.map(vehicle => `
                    <tr>
                        <td>${vehicle.registration || '-'}</td>
                        <td>${vehicle.make || '-'}</td>
                        <td>${vehicle.model || '-'}</td>
                        <td>${vehicle.color || '-'}</td>
                        <td>${formatDate(vehicle.mot_due)}</td>
                        <td>${vehicle.mileage || '-'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="showVehicleDetailPage('${vehicle.id || vehicle.registration}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No vehicles found</td></tr>';
            }
        }

        function loadCustomerHistory(history) {
            const tableBody = document.getElementById('customer-history-table');

            if (history && history.length > 0) {
                tableBody.innerHTML = history.map(item => `
                    <tr class="clickable-row" onclick="showJobInvoiceDetail('${item.id}', 'job')" style="cursor: pointer;">
                        <td>${formatDate(item.created_date)}</td>
                        <td>${item.registration || '-'}</td>
                        <td>${item.description}</td>
                        <td>¬£${(item.total_amount || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${item.status.toLowerCase()}">${item.status}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No service history found</td></tr>';
            }
        }

        function loadCustomerInvoices(invoices) {
            const tableBody = document.getElementById('customer-invoices-table');

            if (invoices && invoices.length > 0) {
                tableBody.innerHTML = invoices.map(invoice => `
                    <tr class="clickable-row" onclick="showInvoiceDetail('${invoice.id}')" style="cursor: pointer;">
                        <td>${invoice.invoice_number || '-'}</td>
                        <td>${formatDate(invoice.created_date)}</td>
                        <td>${invoice.registration || '-'}</td>
                        <td>${invoice.job_description || invoice.description || '-'}</td>
                        <td>¬£${(invoice.amount || 0).toFixed(2)}</td>
                        <td>
                            <span class="status-badge status-${invoice.status.toLowerCase()}">
                                ${invoice.status}
                                ${invoice.status === 'PAID' || invoice.status === 'LOCKED' ? ' üîí' : ''}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No invoices found</td></tr>';
            }
        }

        function showJobInvoiceDetail(itemId, type) {
            // For jobs, we need to find the corresponding invoice
            if (type === 'job') {
                // More efficient approach: directly look for invoice with job_id
                fetch(`/api/invoices`)
                    .then(response => response.json())
                    .then(data => {
                        // Look for invoice with matching job_id
                        const invoice = data.invoices.find(inv =>
                            inv.job_id == itemId ||
                            (inv.job_description && inv.job_description.includes('J-' + itemId))
                        );
                        if (invoice) {
                            showInvoiceDetail(invoice.id);
                        } else {
                            // If no direct invoice found, try to find by job number pattern
                            const jobInvoice = data.invoices.find(inv =>
                                inv.invoice_number && inv.invoice_number.includes(itemId)
                            );
                            if (jobInvoice) {
                                showInvoiceDetail(jobInvoice.id);
                            } else {
                                showNotification('No invoice found for this job', 'info');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error finding invoice:', error);
                        showNotification('Error loading invoice details', 'error');
                    });
            } else {
                // Direct invoice
                showInvoiceDetail(itemId);
            }
        }

        function updateCustomerField(field, value) {
            if (!currentCustomerId) return;

            const data = {};
            data[field] = value;

            fetch(`/api/customers/${currentCustomerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification('Customer updated successfully', 'success');
                } else {
                    showNotification('Error updating customer', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating customer:', error);
                showNotification('Error updating customer', 'error');
            });
        }

        // Vehicle functions
        function loadVehicles() {
            const tableBody = document.getElementById('vehicles-table-body');
            tableBody.innerHTML = '<tr><td colspan="10" class="loading"><div class="spinner"></div>Loading vehicles...</td></tr>';
            
            const url = `/api/vehicles?page=${currentVehiclePage}&per_page=${currentVehiclePerPage}&search=${encodeURIComponent(currentVehicleSearch)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayVehicles(data);
                    updateVehiclePagination(data);
                })
                .catch(error => {
                    console.error('Error loading vehicles:', error);
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #dc3545;">Error loading vehicles</td></tr>';
                });
        }

        function displayVehicles(data) {
            console.log('üîÑ displayVehicles called with data:', data);
            const tableBody = document.getElementById('vehicles-table-body');
            console.log('üìç vehicles-table-body element found:', !!tableBody);

            const vehicles = data.vehicles || data || [];
            console.log(`üìä Processing ${vehicles.length} vehicles`);

            if (vehicles && vehicles.length > 0) {
                tableBody.innerHTML = vehicles.map(vehicle => `
                    <tr>
                        <td>${vehicle.registration || '-'}</td>
                        <td>${vehicle.make || '-'}</td>
                        <td>${vehicle.model || '-'}</td>
                        <td>${vehicle.color || '-'}</td>
                        <td>${vehicle.fuel_type || '-'}</td>
                        <td>${formatDate(vehicle.mot_due)}</td>
                        <td>${vehicle.mileage || '-'}</td>
                        <td>${vehicle.customer_name || vehicle.customer_company || '-'}</td>
                        <td>-</td>
                        <td>
                            <button class="btn btn-primary" onclick="showVehicleDetailPage('${vehicle.id || vehicle.registration}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No vehicles found</td></tr>';
            }
            
            // Update range display with safe null checks
            if (data.page && data.per_page && data.total !== undefined) {
                const start = (data.page - 1) * data.per_page + 1;
                const end = Math.min(data.page * data.per_page, data.total);
                const rangeElement = document.getElementById('vehicle-range');
                const totalElement = document.getElementById('vehicle-total');

                if (rangeElement) rangeElement.textContent = `${start} to ${end}`;
                if (totalElement) totalElement.textContent = data.total.toLocaleString();
            } else {
                // Fallback for non-paginated data or missing pagination info
                const total = vehicles.length;
                const rangeElement = document.getElementById('vehicle-range');
                const totalElement = document.getElementById('vehicle-total');

                if (rangeElement) rangeElement.textContent = `1 to ${total}`;
                if (totalElement) totalElement.textContent = total.toLocaleString();
            }
        }

        function updateVehiclePagination(data) {
            const pagination = document.getElementById('vehicle-pagination');
            const totalPages = data.total_pages;
            const currentPage = data.page;
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button onclick="changeVehiclePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button onclick="changeVehiclePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            
            // Next button
            paginationHTML += `<button onclick="changeVehiclePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changeVehiclePage(page) {
            currentVehiclePage = page;
            loadVehicles();
        }

        function changeVehiclePerPage() {
            currentVehiclePerPage = parseInt(document.getElementById('vehicle-per-page').value);
            currentVehiclePage = 1;
            loadVehicles();
        }

        function searchVehicles() {
            currentVehicleSearch = document.getElementById('vehicle-search').value;
            currentVehiclePage = 1;
            loadVehicles();
        }

        function showVehicleDetail(vehicleId) {
            currentVehicleId = vehicleId;
            const modal = document.getElementById('vehicle-detail-modal');
            modal.classList.add('active');
            
            // Load vehicle details
            fetch(`/api/vehicles/${vehicleId}`)
                .then(response => response.json())
                .then(data => {
                    const vehicle = data.vehicle;
                    document.getElementById('vehicle-detail-title').textContent = `Vehicle Details: ${vehicle.registration} - ${vehicle.make} ${vehicle.model}`;
                    
                    // Populate vehicle information
                    document.getElementById('vehicle-registration').value = vehicle.registration || '';
                    document.getElementById('vehicle-make').value = vehicle.make || '';
                    document.getElementById('vehicle-model').value = vehicle.model || '';
                    document.getElementById('vehicle-color').value = vehicle.color || '';
                    document.getElementById('vehicle-fuel-type').value = vehicle.fuel_type || '';
                    document.getElementById('vehicle-mileage').value = vehicle.mileage || '';
                    
                    // Populate owner information
                    document.getElementById('vehicle-customer-name').textContent = vehicle.customer_name || vehicle.customer_company || '-';
                    document.getElementById('vehicle-customer-account').textContent = vehicle.customer_account || '-';
                    document.getElementById('vehicle-customer-phone').textContent = vehicle.customer_mobile || vehicle.customer_phone || '-';
                    document.getElementById('vehicle-mot-due').textContent = formatDate(vehicle.mot_due);
                    document.getElementById('vehicle-last-service').textContent = data.jobs && data.jobs.length > 0 ? formatDate(data.jobs[0].created_date) : '-';

                    // Load service history
                    loadVehicleHistory(data.jobs || []);
                })
                .catch(error => {
                    console.error('Error loading vehicle details:', error);
                    showNotification('Error loading vehicle details', 'error');
                });
        }

        function closeVehicleDetail() {
            document.getElementById('vehicle-detail-modal').classList.remove('active');
            currentVehicleId = null;
        }

        function showVehicleTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('#vehicle-detail-modal .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide all tab contents
            document.querySelectorAll('#vehicle-detail-modal .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.querySelector(`#vehicle-detail-modal .tab-button[onclick="showVehicleTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`vehicle-tab-${tabName}`).classList.add('active');
        }

        function loadVehicleHistory(history) {
            const tableBody = document.getElementById('vehicle-history-table');

            if (history && history.length > 0) {
                tableBody.innerHTML = history.map(item => `
                    <tr>
                        <td>${formatDate(item.created_date)}</td>
                        <td>${item.job_number || '-'}</td>
                        <td>-</td>
                        <td>${item.description}</td>
                        <td>¬£${(item.total_amount || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${item.status.toLowerCase()}">${item.status}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No service history found</td></tr>';
            }
        }

        function updateVehicleField(field, value) {
            if (!currentVehicleId) return;
            
            const data = {};
            data[field] = value;
            
            fetch(`/api/vehicles/${currentVehicleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification('Vehicle updated successfully', 'success');
                } else {
                    showNotification('Error updating vehicle', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating vehicle:', error);
                showNotification('Error updating vehicle', 'error');
            });
        }

        // Job functions
        function loadJobs() {
            const tableBody = document.getElementById('jobs-table-body');
            tableBody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>Loading jobs...</td></tr>';
            
            fetch('/api/jobs')
                .then(response => response.json())
                .then(data => {
                    displayJobs(data.jobs || []);
                })
                .catch(error => {
                    console.error('Error loading jobs:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545;">Error loading jobs</td></tr>';
                });
        }

        function displayJobs(jobs) {
            const tableBody = document.getElementById('jobs-table-body');

            if (jobs && jobs.length > 0) {
                tableBody.innerHTML = jobs.map(job => `
                    <tr>
                        <td>${job.job_number || job.job_no || '-'}</td>
                        <td>${formatDate(job.created_date || job.date) || '-'}</td>
                        <td>${job.customer_name || job.customer_company || job.customer || '-'}</td>
                        <td>${job.registration || job.vehicle || '-'}</td>
                        <td>${job.description || '-'}</td>
                        <td><span class="status-badge status-${(job.status || 'unknown').toLowerCase()}">${job.status || 'UNKNOWN'}</span></td>
                        <td>¬£${(job.total_amount || job.total || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-primary" onclick="showJobDetail('${job.id}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                // Show demo job if no real jobs exist
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem;">
                            <div style="margin-bottom: 1rem;">No jobs found in database</div>
                            <button class="btn btn-primary" onclick="showDemoJobDetail()">
                                <i class="fas fa-eye"></i>
                                View Demo Job Detail
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function showDemoJobDetail() {
            console.log('üéØ showDemoJobDetail called');

            // Check if job-detail page exists
            const jobDetailPage = document.getElementById('job-detail');
            console.log('üìã Job detail page element found:', !!jobDetailPage);
            console.log('üìã Job detail page classes:', jobDetailPage ? jobDetailPage.className : 'N/A');

            if (!jobDetailPage) {
                console.error('‚ùå Job detail page element not found!');
                showNotification('Job detail page not found', 'error');
                return;
            }

            // Force remove any modal-like styling
            jobDetailPage.style.position = 'static';
            jobDetailPage.style.background = 'transparent';
            jobDetailPage.style.zIndex = 'auto';
            console.log('üîß Forced job detail page styling reset');

            // Create demo job data for testing the detail view
            const demoJob = {
                id: 'demo',
                job_number: 'J-DEMO-001',
                created_date: '2025-06-14',
                status: 'COMPLETED',
                total_amount: 450.00,
                labour_cost: 200.00,
                parts_cost: 250.00,
                description: 'MOT Test and Brake Pad Replacement - Demo Job',
                notes: 'This is a demonstration job to show the new full-page job detail view.',
                customer_name: 'John Smith',
                customer_company: 'Smith Motors Ltd',
                customer_phone: '020 1234 5678',
                customer_mobile: '07700 123456',
                customer_email: 'john@smithmotors.co.uk',
                customer_address: '123 High Street, London, SW1A 1AA',
                registration: 'AB12 CDE',
                make: 'Ford',
                model: 'Focus',
                year: '2018',
                color: 'Blue',
                mileage: '45,000'
            };

            console.log('üìã Demo job data created:', demoJob);

            // Hide any open modals first
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                modal.classList.remove('active');
                console.log('üö´ Closed modal:', modal.id);
            });

            // Store demo job and show detail page
            currentJobId = 'demo';
            console.log('üîÑ Calling showPage with job-detail');
            showPage('job-detail');

            // Wait a moment then populate details
            setTimeout(() => {
                console.log('üìù Populating job details');
                populateJobDetails(demoJob, [], [], []);
                console.log('‚úÖ Demo job detail should now be visible');
            }, 200);
        }

        // Invoice functions
        function loadInvoices() {
            const tableBody = document.getElementById('invoices-table-body');
            tableBody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>Loading invoices...</td></tr>';
            
            fetch('/api/invoices')
                .then(response => response.json())
                .then(data => {
                    displayInvoices(data.invoices || []);
                })
                .catch(error => {
                    console.error('Error loading invoices:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545;">Error loading invoices</td></tr>';
                });
        }

        function displayInvoices(invoices) {
            const tableBody = document.getElementById('invoices-table-body');

            if (invoices && invoices.length > 0) {
                tableBody.innerHTML = invoices.map(invoice => {
                    const isLocked = invoice.status === 'PAID' || invoice.status === 'LOCKED';
                    const lockIcon = isLocked ? ' üîí' : '';

                    return `
                        <tr class="clickable-row" onclick="showInvoiceDetail('${invoice.id}')" style="cursor: pointer;">
                            <td>${invoice.invoice_number || invoice.invoice_no || '-'}</td>
                            <td>${invoice.created_date || formatDate(invoice.date) || '-'}</td>
                            <td>${invoice.customer_name || invoice.customer || '-'}</td>
                            <td>${invoice.registration || invoice.vehicle || '-'}</td>
                            <td>${invoice.job_description || invoice.description || '-'}</td>
                            <td>¬£${(invoice.amount || invoice.total || 0).toFixed(2)}</td>
                            <td>
                                <span class="status-badge status-${invoice.status.toLowerCase()}">
                                    ${invoice.status}${lockIcon}
                                </span>
                            </td>
                            <td onclick="event.stopPropagation();">
                                <button class="btn btn-primary" onclick="showInvoiceDetail('${invoice.id}')">
                                    <i class="fas fa-eye"></i>
                                    View
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No invoices found</td></tr>';
            }
        }

        function showInvoiceDetail(invoiceId) {
            currentInvoiceId = invoiceId;
            const modal = document.getElementById('invoice-detail-modal');
            modal.classList.add('active');

            // Load invoice details
            fetch(`/api/invoices/${invoiceId}`)
                .then(response => response.json())
                .then(data => {
                    const invoice = data.invoice;
                    const lockIcon = invoice.is_locked ? ' üîí' : '';
                    const lockStatus = invoice.is_locked ? 'LOCKED' : invoice.status;

                    // Enhanced title with job information
                    const jobInfo = invoice.job && invoice.job.job_number ? ` (Job: ${invoice.job.job_number})` : '';
                    document.getElementById('invoice-detail-title').textContent = `Invoice: ${invoice.invoice_number}${jobInfo} - ${lockStatus}${lockIcon}`;

                    // Set lock status for form controls
                    const isLocked = invoice.is_locked;

                    // Populate vehicle information
                    document.getElementById('invoice-vehicle-registration').value = invoice.vehicle.registration || '';
                    document.getElementById('invoice-vehicle-registration').disabled = isLocked;

                    document.getElementById('invoice-vehicle-make-model').value = `${invoice.vehicle.make || ''} ${invoice.vehicle.model || ''}`.trim();
                    document.getElementById('invoice-vehicle-make-model').disabled = isLocked;

                    document.getElementById('invoice-vehicle-chassis').value = invoice.vehicle.chassis || '';
                    document.getElementById('invoice-vehicle-chassis').disabled = isLocked;

                    document.getElementById('invoice-vehicle-engine-cc').value = invoice.vehicle.engine_cc || '';
                    document.getElementById('invoice-vehicle-engine-cc').disabled = isLocked;

                    document.getElementById('invoice-vehicle-fuel-type').value = invoice.vehicle.fuel_type || '';
                    document.getElementById('invoice-vehicle-fuel-type').disabled = isLocked;

                    document.getElementById('invoice-vehicle-color').value = invoice.vehicle.color || '';
                    document.getElementById('invoice-vehicle-color').disabled = isLocked;

                    document.getElementById('invoice-vehicle-mileage').value = invoice.vehicle.mileage || '';
                    document.getElementById('invoice-vehicle-mileage').disabled = isLocked;

                    // Populate customer information
                    document.getElementById('invoice-customer-account').value = invoice.customer.account_number || '';
                    document.getElementById('invoice-customer-account').disabled = isLocked;

                    document.getElementById('invoice-customer-company').value = invoice.customer.company || '';
                    document.getElementById('invoice-customer-company').disabled = isLocked;

                    document.getElementById('invoice-customer-name').value = invoice.customer.name || '';
                    document.getElementById('invoice-customer-name').disabled = isLocked;

                    document.getElementById('invoice-customer-address').value = invoice.customer.address || '';
                    document.getElementById('invoice-customer-address').disabled = isLocked;

                    document.getElementById('invoice-customer-postcode').value = invoice.customer.postcode || '';
                    document.getElementById('invoice-customer-postcode').disabled = isLocked;

                    document.getElementById('invoice-customer-mobile').value = invoice.customer.phone || '';
                    document.getElementById('invoice-customer-mobile').disabled = isLocked;

                    // Populate description
                    document.getElementById('invoice-description').value = invoice.description || '';
                    document.getElementById('invoice-description').disabled = isLocked;

                    // Populate job information
                    document.getElementById('invoice-job-number').value = invoice.job ? invoice.job.job_number || '' : '';
                    document.getElementById('invoice-job-amount').value = invoice.job ? `¬£${(invoice.job.total_amount || 0).toFixed(2)}` : '';
                    document.getElementById('invoice-amount').value = `¬£${(invoice.amount || 0).toFixed(2)}`;
                    document.getElementById('invoice-status').value = invoice.status || '';

                    // Load history
                    loadInvoiceHistory(invoice.history || []);

                    // Load parts, labour, and advisories
                    loadInvoiceParts(invoice.parts || []);
                    loadInvoiceLabour(invoice.labour || []);
                    loadInvoiceAdvisories(invoice.advisories || []);

                    // Show lock/unlock controls
                    updateLockControls(invoice);
                })
                .catch(error => {
                    console.error('Error loading invoice details:', error);
                    showNotification('Error loading invoice details', 'error');
                });
        }

        function closeInvoiceDetail() {
            document.getElementById('invoice-detail-modal').classList.remove('active');
            currentInvoiceId = null;
        }

        function showInvoiceTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('#invoice-detail-modal .invoice-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide all tab contents
            document.querySelectorAll('#invoice-detail-modal .invoice-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.querySelector(`#invoice-detail-modal .invoice-tab-button[onclick="showInvoiceTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`invoice-tab-${tabName}`).classList.add('active');
        }

        function loadInvoiceHistory(history) {
            const tableBody = document.getElementById('invoice-history-table');

            if (history && history.length > 0) {
                tableBody.innerHTML = history.map(item => `
                    <tr>
                        <td>${item.date}</td>
                        <td>${item.doc_no}</td>
                        <td>${item.mileage}</td>
                        <td>${item.description}</td>
                        <td>¬£${(item.total || 0).toFixed(2)}</td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No history found</td></tr>';
            }
        }

        function loadInvoiceParts(parts) {
            const partsTab = document.getElementById('invoice-tab-parts');

            if (parts && parts.length > 0) {
                partsTab.innerHTML = `
                    <div style="padding: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Part Number</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Supplier</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${parts.map(part => `
                                    <tr>
                                        <td>${part.part_number}</td>
                                        <td>${part.description}</td>
                                        <td>${part.quantity}</td>
                                        <td>¬£${(part.unit_price || 0).toFixed(2)}</td>
                                        <td>¬£${(part.total_price || 0).toFixed(2)}</td>
                                        <td>${part.supplier}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                partsTab.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6c757d;">No parts recorded for this invoice</div>';
            }
        }

        function loadInvoiceLabour(labour) {
            const labourTab = document.getElementById('invoice-tab-labour');

            if (labour && labour.length > 0) {
                labourTab.innerHTML = `
                    <div style="padding: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Hours</th>
                                    <th>Rate</th>
                                    <th>Total</th>
                                    <th>Technician</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${labour.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.hours}</td>
                                        <td>¬£${(item.rate || 0).toFixed(2)}</td>
                                        <td>¬£${(item.total_price || 0).toFixed(2)}</td>
                                        <td>${item.technician}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                labourTab.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6c757d;">No labour recorded for this invoice</div>';
            }
        }

        function loadInvoiceAdvisories(advisories) {
            const advisoriesTab = document.getElementById('invoice-tab-advisories');

            if (advisories && advisories.length > 0) {
                advisoriesTab.innerHTML = `
                    <div style="padding: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Severity</th>
                                    <th>Recommendation</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${advisories.map(advisory => `
                                    <tr>
                                        <td>${advisory.description}</td>
                                        <td><span class="status-badge status-${advisory.severity.toLowerCase()}">${advisory.severity}</span></td>
                                        <td>${advisory.recommendation}</td>
                                        <td>${advisory.created_date}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                advisoriesTab.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6c757d;">No advisories recorded for this invoice</div>';
            }
        }

        function updateLockControls(invoice) {
            // Add lock/unlock controls to the invoice header
            const header = document.querySelector('.invoice-header');
            let lockControls = document.getElementById('invoice-lock-controls');

            if (!lockControls) {
                lockControls = document.createElement('div');
                lockControls.id = 'invoice-lock-controls';
                lockControls.style.marginTop = '1rem';
                header.appendChild(lockControls);
            }

            if (invoice.is_locked) {
                lockControls.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #dc3545;">
                        <span style="color: #dc3545; font-weight: bold;">üîí This invoice is locked and cannot be edited</span>
                        <button class="btn btn-warning" onclick="unlockInvoice(${invoice.id})" style="margin-left: auto;">
                            <i class="fas fa-unlock"></i> Unlock Invoice
                        </button>
                    </div>
                `;
            } else {
                lockControls.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #28a745;">
                        <span style="color: #28a745; font-weight: bold;">‚úèÔ∏è This invoice can be edited</span>
                        <button class="btn btn-danger" onclick="lockInvoice(${invoice.id})" style="margin-left: auto;">
                            <i class="fas fa-lock"></i> Lock Invoice
                        </button>
                    </div>
                `;
            }
        }

        function lockInvoice(invoiceId) {
            if (confirm('Are you sure you want to lock this invoice? This will prevent any further edits.')) {
                // For now, just show a notification - will implement API call later
                showNotification('Invoice locked successfully', 'success');
                // Refresh the invoice details to show locked state
                setTimeout(() => showInvoiceDetail(invoiceId), 500);
            }
        }

        function unlockInvoice(invoiceId) {
            if (confirm('Are you sure you want to unlock this invoice? This will allow edits again.')) {
                // For now, just show a notification - will implement API call later
                showNotification('Invoice unlocked successfully', 'success');
                // Refresh the invoice details to show unlocked state
                setTimeout(() => showInvoiceDetail(invoiceId), 500);
            }
        }

        function updateInvoiceField(field, value) {
            if (!currentInvoiceId) return;

            // Check if invoice is locked first
            fetch(`/api/invoices/${currentInvoiceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.invoice.is_locked) {
                        showNotification('Cannot update locked invoice', 'error');
                        return;
                    }

                    // For now, just show a notification that the field was updated
                    showNotification('Invoice field updated', 'success');
                })
                .catch(error => {
                    console.error('Error checking invoice lock status:', error);
                    showNotification('Error updating invoice', 'error');
                });
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString || dateString === '-' || dateString === '') return '-';

            // Handle different date formats
            let date;
            if (dateString.includes('.')) {
                // Handle YYYY.MM.DD format (DVSA API format)
                const parts = dateString.split('.');
                if (parts.length === 3) {
                    date = new Date(parts[0], parts[1] - 1, parts[2]); // Month is 0-indexed
                } else {
                    return dateString;
                }
            } else if (dateString.includes('/')) {
                // Handle MM/DD/YYYY or DD/MM/YYYY format
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    // Try DD/MM/YYYY format first (UK format)
                    if (parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                        // Assume DD/MM/YYYY if day and month are 2 digits or less
                        date = new Date(parts[2], parts[1] - 1, parts[0]); // Year, Month (0-indexed), Day
                    } else {
                        // Fallback to MM/DD/YYYY (US format)
                        date = new Date(dateString);
                    }
                } else {
                    date = new Date(dateString);
                }
            } else if (dateString.includes('-')) {
                // Handle YYYY-MM-DD format or DD-MM-YYYY format
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    if (parts[0].length === 4) {
                        // YYYY-MM-DD format
                        date = new Date(dateString);
                    } else {
                        // DD-MM-YYYY format (already formatted)
                        return dateString;
                    }
                } else {
                    date = new Date(dateString);
                }
            } else {
                return dateString; // Return as-is if format is unrecognized
            }

            // Check if date is valid
            if (isNaN(date.getTime())) {
                return dateString; // Return original if invalid
            }

            // Format as DD-MM-YYYY
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            return `${day}-${month}-${year}`;
        }

        function extractPostcode(address) {
            if (!address) return '';
            const postcodeRegex = /([A-Z]{1,2}[0-9][A-Z0-9]?\s?[0-9][A-Z]{2})/i;
            const match = address.match(postcodeRegex);
            return match ? match[1] : '';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Header button functions
        function refreshData() {
            showNotification('Refreshing data...', 'info');

            // Refresh data for all pages
            loadDashboardStats();
            loadRecentActivity();
            loadCustomers();
            loadVehicles();
            loadJobs();
            loadInvoices();



            // Refresh MOT data if on MOT page
            if (currentActivePage === 'mot-reminders') {
                loadMOTReminders();
                loadFailedRegistrations();
            }

            // Stay on current page
            console.log('üîÑ Refreshing while staying on page:', currentActivePage);
        }

        function exportData() {
            showNotification('Export functionality coming soon', 'warning');
        }

        function printPage() {
            window.print();
        }

        function showHelp() {
            showNotification('Help documentation coming soon', 'info');
        }

        function showAdminMenu() {
            showNotification('Admin menu coming soon', 'info');
        }

        // Form functions (placeholders)
        function showNewCustomerForm() {
            showNotification('New customer form coming soon', 'info');
        }

        function showNewVehicleForm() {
            showNotification('New vehicle form coming soon', 'info');
        }

        function showNewJobForm() {
            showNotification('New job form coming soon', 'info');
        }

        function showNewInvoiceForm() {
            showNotification('New invoice form coming soon', 'info');
        }

        function showJobDetail(jobId) {
            console.log('showJobDetail called with jobId:', jobId);

            // Store the current job ID for reference
            currentJobId = jobId;

            // Hide any open modals first
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                modal.classList.remove('active');
                console.log('Closed modal:', modal.id);
            });

            // Show the job detail page
            console.log('Showing job-detail page');
            showPage('job-detail');

            // Load job details
            loadJobDetails(jobId);
        }

        function loadJobDetails(jobId) {
            // Show loading state
            document.getElementById('job-detail-title').innerHTML = `
                <i class="fas fa-wrench"></i>
                <i class="fas fa-spinner fa-spin" style="margin-left: 0.5rem;"></i>
                Loading Job Details...
            `;

            // Fetch job details from API (using the correct endpoint format)
            fetch(`/api/job/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.job) {
                        const job = data.job;
                        // Flatten the nested customer and vehicle data for easier access
                        const flatJob = {
                            ...job,
                            customer_name: job.customer?.name || '',
                            customer_phone: job.customer?.phone || '',
                            customer_mobile: job.customer?.mobile || '',
                            customer_email: job.customer?.email || '',
                            customer_account: job.customer?.account_number || '',
                            registration: job.vehicle?.registration || '',
                            make: job.vehicle?.make || '',
                            model: job.vehicle?.model || '',
                            year: job.vehicle?.year || '',
                            color: job.vehicle?.color || ''
                        };

                        populateJobDetails(flatJob, [], [], []);
                    } else {
                        throw new Error(data.error || 'Failed to load job details');
                    }
                })
                .catch(error => {
                    console.error('Error loading job details:', error);
                    showNotification('Error loading job details', 'error');

                    // Show error state
                    document.getElementById('job-detail-title').innerHTML = `
                        <i class="fas fa-wrench"></i>
                        Error Loading Job
                    `;
                });
        }

        function populateJobDetails(job, workItems, history, documents) {
            // Update page title and subtitle
            document.getElementById('job-detail-title').innerHTML = `
                <i class="fas fa-wrench"></i>
                Job #${job.job_number || job.id}
            `;
            document.getElementById('job-detail-subtitle').textContent =
                `${job.customer_name || 'Unknown Customer'} - ${job.registration || 'Unknown Vehicle'}`;

            // Populate job overview
            document.getElementById('job-number').textContent = job.job_number || job.id || '-';
            document.getElementById('job-date').textContent = formatDate(job.created_date) || '-';
            document.getElementById('job-status').innerHTML = job.status ?
                `<span class="status-badge status-${job.status.toLowerCase().replace(/\s+/g, '-')}">${job.status}</span>` : '-';

            // Calculate total from parts and labour if total_amount not available
            const totalAmount = job.total_amount || ((job.labour_cost || 0) + (job.parts_cost || 0));
            document.getElementById('job-total').textContent = totalAmount ? `¬£${totalAmount.toFixed(2)}` : '-';
            document.getElementById('job-description').textContent = job.description || job.notes || '-';

            // Populate customer information
            document.getElementById('customer-name').textContent = job.customer_name || '-';
            document.getElementById('customer-company').textContent = job.customer_company || '-';
            document.getElementById('customer-phone').textContent = job.customer_phone || '-';
            document.getElementById('customer-email').textContent = job.customer_email || '-';
            document.getElementById('customer-address').textContent = job.customer_address || '-';

            // Populate vehicle information
            document.getElementById('vehicle-registration').textContent = job.registration || '-';
            document.getElementById('vehicle-make-model').textContent =
                `${job.make || ''} ${job.model || ''}`.trim() || '-';
            document.getElementById('vehicle-year').textContent = job.year || '-';
            document.getElementById('vehicle-color').textContent = job.color || '-';
            document.getElementById('vehicle-mileage').textContent = job.mileage ? `${job.mileage} miles` : '-';

            // Populate work items (create from job data if no separate items)
            const jobWorkItems = workItems.length > 0 ? workItems : [
                ...(job.labour_cost ? [{
                    description: 'Labour',
                    quantity: 1,
                    unit_price: job.labour_cost,
                    type: 'labour'
                }] : []),
                ...(job.parts_cost ? [{
                    description: 'Parts',
                    quantity: 1,
                    unit_price: job.parts_cost,
                    type: 'parts'
                }] : [])
            ];
            populateWorkItems(jobWorkItems);

            // Populate job history
            populateJobHistory(history, job);

            // Populate related documents
            populateRelatedDocuments(documents, job);
        }

        function populateWorkItems(workItems) {
            const tbody = document.getElementById('work-items-body');

            if (workItems && workItems.length > 0) {
                tbody.innerHTML = workItems.map(item => `
                    <tr>
                        <td>${item.description || item.item_description || '-'}</td>
                        <td>${item.quantity || 1}</td>
                        <td>¬£${(item.unit_price || item.price || 0).toFixed(2)}</td>
                        <td>¬£${((item.quantity || 1) * (item.unit_price || item.price || 0)).toFixed(2)}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6c757d; padding: 2rem;">No work items found</td></tr>';
            }
        }

        function populateJobHistory(history, job) {
            const container = document.getElementById('job-history-content');

            // Create history from job data if no explicit history
            const historyItems = history.length > 0 ? history : [
                {
                    title: 'Job Created',
                    date: job.created_date || job.date,
                    content: `Job created for ${job.customer_name || job.customer || 'customer'}`
                },
                ...(job.status ? [{
                    title: 'Status Updated',
                    date: job.updated_date || job.date,
                    content: `Job status set to: ${job.status}`
                }] : [])
            ];

            if (historyItems.length > 0) {
                container.innerHTML = historyItems.map(item => `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span class="history-item-title">${item.title || 'Update'}</span>
                            <span class="history-item-date">${formatDate(item.date) || 'Unknown date'}</span>
                        </div>
                        <div class="history-item-content">${item.content || item.description || 'No details available'}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No history available</div>';
            }
        }

        function populateRelatedDocuments(documents, job) {
            const container = document.getElementById('related-docs-grid');

            // Add job-related documents if available
            const relatedDocs = documents.length > 0 ? documents : [
                ...(job.invoice_id ? [{
                    type: 'invoice',
                    title: `Invoice #${job.invoice_number || job.invoice_id}`,
                    icon: 'fas fa-file-invoice',
                    id: job.invoice_id
                }] : []),
                {
                    type: 'job-sheet',
                    title: 'Job Sheet',
                    icon: 'fas fa-clipboard-list',
                    id: job.id
                }
            ];

            if (relatedDocs.length > 0) {
                container.innerHTML = relatedDocs.map(doc => `
                    <div class="doc-item" onclick="openDocument('${doc.type}', '${doc.id}')">
                        <div class="doc-icon">
                            <i class="${doc.icon || 'fas fa-file'}"></i>
                        </div>
                        <div class="doc-title">${doc.title || 'Document'}</div>
                        <div class="doc-meta">${doc.date ? formatDate(doc.date) : 'Click to view'}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No related documents</div>';
            }
        }

        function editJobDetail() {
            showNotification('Job editing functionality coming soon', 'info');
        }

        function createInvoiceFromJob() {
            if (currentJobId) {
                showNotification('Creating invoice from job...', 'info');
                // This would integrate with the invoice creation system
            }
        }

        function openDocument(type, id) {
            if (type === 'invoice') {
                showInvoiceDetail(id);
            } else if (type === 'job-sheet') {
                showNotification('Job sheet view coming soon', 'info');
            } else {
                showNotification('Document viewer coming soon', 'info');
            }
        }

        function showDemoCustomerDetail() {
            console.log('üéØ showDemoCustomerDetail called');

            // Create demo customer data for testing the detail view
            const demoCustomer = {
                id: 'demo-customer',
                account_number: 'CUST-001',
                name: 'John Smith',
                company: 'Smith Motors Ltd',
                address: '123 High Street, London, SW1A 1AA',
                postcode: 'SW1A 1AA',
                phone: '020 1234 5678',
                mobile: '07700 123456',
                email: 'john@smithmotors.co.uk',
                created_date: '2020-01-15',
                account_balance: 150.00
            };

            const demoVehicles = [
                {
                    id: 'demo-vehicle-1',
                    registration: 'AB12 CDE',
                    make: 'Ford',
                    model: 'Focus',
                    color: 'Blue',
                    mot_due: '2025-08-15',
                    mileage: '45,000'
                },
                {
                    id: 'demo-vehicle-2',
                    registration: 'XY98 ZAB',
                    make: 'Vauxhall',
                    model: 'Astra',
                    color: 'Silver',
                    mot_due: '2025-12-03',
                    mileage: '32,500'
                }
            ];

            const demoJobs = [
                {
                    id: 'demo-job-1',
                    created_date: '2025-05-20',
                    registration: 'AB12 CDE',
                    description: 'MOT Test and Brake Pad Replacement',
                    total_amount: 450.00,
                    status: 'COMPLETED'
                },
                {
                    id: 'demo-job-2',
                    created_date: '2025-03-10',
                    registration: 'XY98 ZAB',
                    description: 'Annual Service and Oil Change',
                    total_amount: 180.00,
                    status: 'COMPLETED'
                }
            ];

            const demoInvoices = [
                {
                    id: 'demo-invoice-1',
                    invoice_number: 'INV-2025-001',
                    created_date: '2025-05-20',
                    registration: 'AB12 CDE',
                    description: 'MOT Test and Brake Pad Replacement',
                    total_amount: 450.00,
                    status: 'PAID'
                }
            ];

            console.log('üë§ Demo customer data created:', demoCustomer);

            // Hide any open modals first
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                modal.classList.remove('active');
                console.log('üö´ Closed modal:', modal.id);
            });

            // Store demo customer and show detail page
            currentCustomerId = 'demo-customer';
            console.log('üîÑ Calling showPage with customer-detail');
            showPage('customer-detail');

            // Wait a moment then populate details
            setTimeout(() => {
                console.log('üìù Populating customer details');
                populateCustomerDetailsPage(demoCustomer, demoVehicles, demoJobs, demoInvoices);
                console.log('‚úÖ Demo customer detail should now be visible');
            }, 200);
        }

        function showVehicleDetailPage(vehicleId) {
            console.log('üéØ showVehicleDetailPage called with vehicleId:', vehicleId);

            // Store the current vehicle ID for reference
            currentVehicleId = vehicleId;

            // Check if vehicle-detail page exists
            const vehicleDetailPage = document.getElementById('vehicle-detail');
            console.log('üöó Vehicle detail page element found:', !!vehicleDetailPage);

            if (!vehicleDetailPage) {
                console.error('‚ùå Vehicle detail page element not found!');
                showNotification('Vehicle detail page not found', 'error');
                return;
            }

            // Force remove any modal-like styling
            vehicleDetailPage.style.position = 'static';
            vehicleDetailPage.style.background = 'transparent';
            vehicleDetailPage.style.zIndex = 'auto';
            console.log('üîß Forced vehicle detail page styling reset');

            // Hide any open modals first
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                modal.classList.remove('active');
                console.log('üö´ Closed modal:', modal.id);
            });

            // Show the vehicle detail page
            console.log('üîÑ Calling showPage with vehicle-detail');
            showPage('vehicle-detail');

            // Load vehicle details
            loadVehicleDetailsPage(vehicleId);
        }

        function loadVehicleDetailsPage(vehicleId) {
            console.log('üîÑ loadVehicleDetailsPage called with vehicleId:', vehicleId);

            // Show loading state
            document.getElementById('vehicle-detail-title').innerHTML = `
                <i class="fas fa-car"></i>
                <i class="fas fa-spinner fa-spin" style="margin-left: 0.5rem;"></i>
                Loading Vehicle Details...
            `;

            // Construct API URL
            const apiUrl = `/api/vehicles/${vehicleId}`;
            console.log('üåê Fetching vehicle details from:', apiUrl);

            // Fetch vehicle details from API
            fetch(apiUrl)
                .then(response => {
                    console.log('üì° API Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Vehicle data received:', data);
                    if (data.success && data.vehicle) {
                        const vehicle = data.vehicle;
                        populateVehicleDetailsPage(vehicle, data.jobs || [], data.invoices || [], data.history || []);
                    } else {
                        throw new Error(data.error || 'Vehicle data not found');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading vehicle details:', error);
                    showNotification(`Error loading vehicle details: ${error.message}`, 'error');

                    // Show error state
                    document.getElementById('vehicle-detail-title').innerHTML = `
                        <i class="fas fa-car"></i>
                        Error Loading Vehicle
                    `;
                });
        }

        function populateVehicleDetailsPage(vehicle, jobs, invoices, history) {
            // Update page title and subtitle
            document.getElementById('vehicle-detail-title').innerHTML = `
                <i class="fas fa-car"></i>
                ${vehicle.registration || 'Vehicle'}
            `;
            document.getElementById('vehicle-detail-subtitle').textContent =
                `${vehicle.make || ''} ${vehicle.model || ''} - ${jobs.length} jobs, ${invoices.length} invoices`;

            // Populate vehicle information (editable fields)
            const editableFields = [
                { id: 'vehicle-registration-page', value: vehicle.registration },
                { id: 'vehicle-make-page', value: vehicle.make },
                { id: 'vehicle-model-page', value: vehicle.model },
                { id: 'vehicle-color-page', value: vehicle.color },
                { id: 'vehicle-fuel-type-page', value: vehicle.fuel_type },
                { id: 'vehicle-mileage-page', value: vehicle.mileage }
            ];

            editableFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.value = field.value || '';
                } else {
                    console.error(`Element not found: ${field.id}`);
                }
            });

            // Populate owner information (read-only)
            document.getElementById('vehicle-customer-name-page').textContent =
                vehicle.customer_name || vehicle.customer_company || '-';
            document.getElementById('vehicle-customer-account-page').textContent =
                vehicle.customer_account || vehicle.account_number || '-';
            document.getElementById('vehicle-customer-phone-page').textContent =
                vehicle.customer_phone || vehicle.customer_mobile || '-';
            document.getElementById('vehicle-mot-due-page').textContent =
                vehicle.mot_due ? formatDate(vehicle.mot_due) : '-';
            document.getElementById('vehicle-last-service-page').textContent =
                jobs.length > 0 ? formatDate(jobs[0].created_date) : '-';

            // Load vehicle data into tabs
            loadVehicleHistoryPage(history);
            loadVehicleJobsPage(jobs);
            loadVehicleInvoicesPage(invoices);
        }

        function showVehiclePageTab(tabName) {
            console.log('üîÑ Switching to vehicle tab:', tabName);

            // Remove active class from all tab buttons
            document.querySelectorAll('.vehicle-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Hide all tab contents
            document.querySelectorAll('.vehicle-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected tab
            const selectedButton = document.querySelector(`.vehicle-tab-button[onclick*="'${tabName}'"]`);
            const selectedContent = document.getElementById(`vehicle-page-tab-${tabName}`);

            if (selectedButton) selectedButton.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');
        }

        function loadVehicleHistoryPage(history) {
            const tableBody = document.getElementById('vehicle-history-table-page');

            if (history && history.length > 0) {
                tableBody.innerHTML = history.map(item => `
                    <tr>
                        <td>${formatDate(item.date) || '-'}</td>
                        <td>${item.document_number || item.doc_no || '-'}</td>
                        <td>${item.mileage || '-'}</td>
                        <td>${item.description || item.work_description || '-'}</td>
                        <td>¬£${(item.total_amount || item.total || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${(item.status || 'unknown').toLowerCase()}">${item.status || 'UNKNOWN'}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: 2rem;">No service history found</td></tr>';
            }
        }

        function loadVehicleJobsPage(jobs) {
            const tableBody = document.getElementById('vehicle-jobs-table-page');

            if (jobs && jobs.length > 0) {
                tableBody.innerHTML = jobs.map(job => `
                    <tr>
                        <td>${job.job_number || job.id || '-'}</td>
                        <td>${formatDate(job.created_date) || '-'}</td>
                        <td>${job.description || job.work_description || '-'}</td>
                        <td><span class="status-badge status-${(job.status || 'unknown').toLowerCase()}">${job.status || 'UNKNOWN'}</span></td>
                        <td>¬£${(job.total_amount || job.total || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-primary" onclick="showJobDetailPage('${job.id}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: 2rem;">No jobs found</td></tr>';
            }
        }

        function loadVehicleInvoicesPage(invoices) {
            const tableBody = document.getElementById('vehicle-invoices-table-page');

            if (invoices && invoices.length > 0) {
                tableBody.innerHTML = invoices.map(invoice => `
                    <tr>
                        <td>${invoice.invoice_number || invoice.id || '-'}</td>
                        <td>${formatDate(invoice.created_date) || '-'}</td>
                        <td>${invoice.description || '-'}</td>
                        <td>¬£${(invoice.total_amount || invoice.amount || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${(invoice.status || 'unknown').toLowerCase()}">${invoice.status || 'UNKNOWN'}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="showInvoiceDetail('${invoice.id}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: 2rem;">No invoices found</td></tr>';
            }
        }

        function editVehicleDetail() {
            showNotification('Vehicle editing functionality coming soon', 'info');
        }

        function createJobForVehicle() {
            if (currentVehicleId) {
                showNotification('Creating new job for vehicle...', 'info');
                // This would integrate with the job creation system
            }
        }

        function testAPIEndpoints() {
            console.log('üß™ Testing API endpoints...');

            // First get a list of customers to find a valid ID
            console.log('üîç Getting customer list to find valid ID...');
            fetch('/api/customers?page=1&per_page=1')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.customers && data.customers.length > 0) {
                        const firstCustomer = data.customers[0];
                        const customerId = firstCustomer.id;

                        console.log(`üîç Testing customer endpoint with ID: ${customerId}...`);

                        // Test customer detail endpoint with real ID
                        return fetch(`/api/customers/${customerId}`);
                    } else {
                        throw new Error('No customers found in database');
                    }
                })
                .then(response => {
                    console.log('üì° Customer API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Customer API Response:', data);
                    if (data.success) {
                        showNotification(`‚úÖ Customer API working! Found: ${data.customer.name || 'Customer'}`, 'success');
                    } else {
                        showNotification(`‚ùå Customer API error: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Customer API Error:', error);
                    showNotification(`‚ùå Customer API failed: ${error.message}`, 'error');
                });

            // Test general endpoints that don't need specific IDs
            console.log('üîç Testing stats endpoint...');
            fetch('/api/stats')
                .then(response => {
                    console.log('üì° Stats API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Stats API Response:', data);
                    if (data.success) {
                        showNotification(`‚úÖ Stats API working! Found ${data.stats.customers} customers`, 'success');
                    } else {
                        showNotification(`‚ùå Stats API error: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Stats API Error:', error);
                    showNotification(`‚ùå Stats API failed: ${error.message}`, 'error');
                });
        }

        function testCustomersNavigation() {
            console.log('üß™ Testing customers navigation...');

            // Test if showPage function exists
            if (typeof showPage === 'function') {
                console.log('‚úÖ showPage function exists');

                // Test if customers page element exists
                const customersPage = document.getElementById('customers');
                console.log('üìÑ Customers page element found:', !!customersPage);

                if (customersPage) {
                    console.log('üîÑ Calling showPage("customers")...');
                    showPage('customers');
                } else {
                    console.error('‚ùå Customers page element not found!');
                    showNotification('Customers page element not found', 'error');
                }
            } else {
                console.error('‚ùå showPage function not found!');
                showNotification('Navigation function not found', 'error');
            }
        }

        function showDemoVehicleDetail() {
            console.log('üéØ showDemoVehicleDetail called');

            // Create demo vehicle data for testing the detail view
            const demoVehicle = {
                id: 'demo-vehicle',
                registration: 'AB12 CDE',
                make: 'Ford',
                model: 'Focus',
                color: 'Blue',
                fuel_type: 'Petrol',
                mileage: '45,000',
                mot_due: '2025-08-15',
                customer_name: 'John Smith',
                customer_company: 'Smith Motors Ltd',
                customer_account: 'CUST-001',
                customer_phone: '020 1234 5678'
            };

            const demoJobs = [
                {
                    id: 'demo-job-1',
                    job_number: 'J-2025-001',
                    created_date: '2025-05-20',
                    description: 'MOT Test and Brake Pad Replacement',
                    total_amount: 450.00,
                    status: 'COMPLETED'
                },
                {
                    id: 'demo-job-2',
                    job_number: 'J-2025-002',
                    created_date: '2025-03-10',
                    description: 'Annual Service and Oil Change',
                    total_amount: 180.00,
                    status: 'COMPLETED'
                }
            ];

            const demoInvoices = [
                {
                    id: 'demo-invoice-1',
                    invoice_number: 'INV-2025-001',
                    created_date: '2025-05-20',
                    description: 'MOT Test and Brake Pad Replacement',
                    total_amount: 450.00,
                    status: 'PAID'
                }
            ];

            const demoHistory = [
                {
                    date: '2025-05-20',
                    document_number: 'J-2025-001',
                    mileage: '45,000',
                    description: 'MOT Test and Brake Pad Replacement',
                    total_amount: 450.00,
                    status: 'COMPLETED'
                },
                {
                    date: '2025-03-10',
                    document_number: 'J-2025-002',
                    mileage: '42,500',
                    description: 'Annual Service and Oil Change',
                    total_amount: 180.00,
                    status: 'COMPLETED'
                }
            ];

            console.log('üöó Demo vehicle data created:', demoVehicle);

            // Hide any open modals first
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                modal.classList.remove('active');
                console.log('üö´ Closed modal:', modal.id);
            });

            // Store demo vehicle and show detail page
            currentVehicleId = 'demo-vehicle';
            console.log('üîÑ Calling showPage with vehicle-detail');
            showPage('vehicle-detail');

            // Wait a moment then populate details
            setTimeout(() => {
                console.log('üìù Populating vehicle details');
                populateVehicleDetailsPage(demoVehicle, demoJobs, demoInvoices, demoHistory);
                console.log('‚úÖ Demo vehicle detail should now be visible');
            }, 200);
        }

        function changeSpacing(spacingMode) {
            console.log('üé® Changing spacing to:', spacingMode);

            const layout = document.querySelector('.layout');
            if (!layout) {
                console.error('‚ùå Layout element not found');
                return;
            }

            // Remove existing spacing classes
            layout.classList.remove('spacing-compact', 'spacing-wide', 'spacing-extra-wide');

            // Add new spacing class if not normal
            if (spacingMode !== 'normal') {
                layout.classList.add(`spacing-${spacingMode}`);
            }

            // Save preference to localStorage
            localStorage.setItem('preferred-spacing', spacingMode);

            // Show notification
            const spacingNames = {
                'normal': 'Normal',
                'compact': 'Compact',
                'wide': 'Wide',
                'extra-wide': 'Extra Wide'
            };

            showNotification(`Layout changed to ${spacingNames[spacingMode]}`, 'success');
            console.log('‚úÖ Spacing changed successfully');
        }

        function loadSpacingPreference() {
            const savedSpacing = localStorage.getItem('preferred-spacing') || 'compact';
            const spacingSelect = document.getElementById('spacing-select');

            if (spacingSelect) {
                spacingSelect.value = savedSpacing;
                changeSpacing(savedSpacing);
            }
        }

        // Global variables to store current IDs
        let currentJobId = null;

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        showNotification('Save functionality coming soon', 'info');
                        break;
                    case 'f':
                        e.preventDefault();
                        const activeSearchBox = document.querySelector('.page.active .search-box input');
                        if (activeSearchBox) {
                            activeSearchBox.focus();
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshData();
                        break;
                }
            }
        });
        // MOT Reminder System Variables
        let motVehicles = [];
        let selectedMOTVehicles = [];
        let currentMOTView = 'list';
        let motSortBy = 'urgency';
        let completedVehicles = new Set(); // Track completed/verified vehicles
        let currentStatusFilter = 'all'; // 'all', 'pending', 'completed'
        let currentMOTFilter = 'all'; // Interactive filter for vehicle status
        let motGroupedData = {}; // Store grouped vehicle data
        let showArchivedVehicles = false; // Whether to show archived vehicles

        // API Configuration
        const API_BASE_URL = 'http://127.0.0.1:5001/api';

        const DVSA_CONFIG = {
            clientId: '2b3911f4-55f5-4a86-a9f0-0fc02c2bff0f',
            tokenUrl: 'https://login.microsoftonline.com/a455b827-244f-4c97-b5b4-ce5d13b4d00c/oauth2/v2.0/token',
            apiUrl: 'https://history.mot.api.gov.uk/v1/trade/vehicles/registration'
        };

        // Load MOT Reminders
        async function loadMOTReminders() {
            try {
                console.log('Loading MOT reminders...');

                // Try to load from backend API first
                try {
                    const apiUrl = `${API_BASE_URL}/mot/vehicles?include_archived=${showArchivedVehicles}`;
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.vehicles) {
                            console.log('Loaded vehicles from API:', data.vehicles.length);
                            motVehicles = data.vehicles;
                            updateMOTStatistics();
                            displayMOTVehicles();
                            updateMOTUrgentBadge();
                            updateFailedRegistrationsCount();
                            return;
                        }
                    }
                } catch (apiError) {
                    console.log('Backend API not available, using local storage:', apiError.message);
                }

                // Fallback to localStorage
                const savedVehicles = localStorage.getItem('motVehicles');
                if (savedVehicles) {
                    try {
                        motVehicles = JSON.parse(savedVehicles);
                        console.log('Loaded vehicles from localStorage:', motVehicles.length);
                    } catch (parseError) {
                        console.error('Error parsing saved vehicles:', parseError);
                        motVehicles = [];
                    }
                } else {
                    console.log('No saved vehicles found, starting with empty system');
                    // Start with empty array - no demo data
                    motVehicles = [];
                }

                updateMOTStatistics();
                displayMOTVehicles();
                updateMOTUrgentBadge();
                updateFailedRegistrationsCount();
                console.log('MOT reminders loaded successfully');
            } catch (error) {
                console.error('Error loading MOT reminders:', error);
                showNotification('Error loading MOT data', 'error');
                // Ensure we still show something even if there's an error
                motVehicles = [];
                updateMOTStatistics();
                displayMOTVehicles();
                updateMOTUrgentBadge();
                updateFailedRegistrationsCount();
            }
        }



        // Update MOT Statistics with smart filtering
        function updateMOTStatistics() {
            const stats = {
                expired: 0,
                critical: 0,
                dueSoon: 0,
                valid: 0,
                flagged: 0
            };

            let pendingCount = 0;
            let completedCount = 0;

            if (motVehicles && motVehicles.length > 0) {
                motVehicles.forEach(vehicle => {
                    // Count completion status
                    if (completedVehicles.has(vehicle.registration)) {
                        completedCount++;
                    } else {
                        pendingCount++;
                    }

                    // Count MOT status with smart filtering
                    if (vehicle.is_expired) {
                        stats.expired++;
                    } else if (vehicle.days_until_expiry <= 7) {
                        stats.critical++;
                    } else if (vehicle.days_until_expiry <= 30) {
                        stats.dueSoon++;
                    } else if (vehicle.days_until_expiry > 365) {
                        stats.flagged++;
                    } else {
                        stats.valid++;
                    }
                });
            }

            // Update MOT status counts (only if elements exist)
            const expiredElement = document.getElementById('mot-expired-count');
            const criticalElement = document.getElementById('mot-critical-count');
            const dueSoonElement = document.getElementById('mot-due-soon-count');
            const validElement = document.getElementById('mot-valid-count');
            const flaggedElement = document.getElementById('mot-flagged-count');
            const totalElement = document.getElementById('mot-total-count');

            if (expiredElement) expiredElement.textContent = stats.expired;
            if (criticalElement) criticalElement.textContent = stats.critical;
            if (dueSoonElement) dueSoonElement.textContent = stats.dueSoon;
            if (validElement) validElement.textContent = stats.valid;
            if (flaggedElement) flaggedElement.textContent = stats.flagged;
            if (totalElement) totalElement.textContent = motVehicles ? motVehicles.length : 0;

            // Update completion status counts
            const pendingElement = document.getElementById('pending-count');
            const completedElement = document.getElementById('completed-count');
            if (pendingElement) pendingElement.textContent = pendingCount;
            if (completedElement) completedElement.textContent = completedCount;

            // Update filter button counts
            updateFilterButtonCounts(stats);
        }

        // Update MOT Urgent Badge in Navigation
        function updateMOTUrgentBadge() {
            const urgentCount = motVehicles && motVehicles.length > 0
                ? motVehicles.filter(v => v.is_expired || v.days_until_expiry <= 7).length
                : 0;
            const badge = document.getElementById('mot-urgent-count');
            badge.textContent = urgentCount;
            badge.style.display = urgentCount > 0 ? 'inline' : 'none';
            badge.style.background = urgentCount > 0 ? '#dc3545' : '#6c757d';
        }

        // Display MOT Vehicles
        function displayMOTVehicles() {
            if (currentMOTView === 'list') {
                displayMOTList();
            } else {
                displayMOTCards();
            }
        }

        // Interactive Filter Functions
        function updateFilterButtonCounts(stats) {
            const totalCount = motVehicles ? motVehicles.length : 0;

            // Update filter button counts (only if elements exist)
            const allElement = document.getElementById('filter-count-all');
            const expiredElement = document.getElementById('filter-count-expired');
            const criticalElement = document.getElementById('filter-count-critical');
            const dueSoonElement = document.getElementById('filter-count-due-soon');
            const normalElement = document.getElementById('filter-count-normal');
            const flaggedElement = document.getElementById('filter-count-flagged');

            if (allElement) allElement.textContent = totalCount;
            if (expiredElement) expiredElement.textContent = stats.expired || 0;
            if (criticalElement) criticalElement.textContent = stats.critical || 0;
            if (dueSoonElement) dueSoonElement.textContent = stats.dueSoon || 0;
            if (normalElement) normalElement.textContent = stats.valid || 0;
            if (flaggedElement) flaggedElement.textContent = stats.flagged || 0;
        }

        function applyMOTFilter(filterType) {
            // Update active filter
            currentMOTFilter = filterType;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');

            // Show/hide filter indicator
            const indicator = document.getElementById('active-filter-indicator');
            const indicatorText = document.getElementById('active-filter-text');

            if (filterType === 'all') {
                indicator.style.display = 'none';
            } else {
                const filterNames = {
                    'expired': 'Expired Vehicles',
                    'critical': 'Critical Vehicles (‚â§7 days)',
                    'due_soon': 'Due Soon Vehicles (8-30 days)',
                    'normal': 'Normal Vehicles (31-365 days)',
                    'flagged': 'Flagged Vehicles (365+ days)'
                };

                const filteredVehicles = getFilteredVehicles();
                const totalCount = motVehicles ? motVehicles.length : 0;

                indicatorText.textContent = `Showing: ${filterNames[filterType]} (${filteredVehicles.length} of ${totalCount})`;
                indicator.style.display = 'block';
            }

            // Refresh the display
            displayMOTVehicles();
        }

        function clearMOTFilter() {
            applyMOTFilter('all');
        }

        function getFilteredVehicles() {
            if (!motVehicles || currentMOTFilter === 'all') {
                return motVehicles || [];
            }

            return motVehicles.filter(vehicle => {
                switch (currentMOTFilter) {
                    case 'expired':
                        return vehicle.is_expired;
                    case 'critical':
                        return !vehicle.is_expired && vehicle.days_until_expiry <= 7;
                    case 'due_soon':
                        return !vehicle.is_expired && vehicle.days_until_expiry > 7 && vehicle.days_until_expiry <= 30;
                    case 'normal':
                        return !vehicle.is_expired && vehicle.days_until_expiry > 30 && vehicle.days_until_expiry <= 365;
                    case 'flagged':
                        return !vehicle.is_expired && vehicle.days_until_expiry > 365;
                    default:
                        return true;
                }
            });
        }

        // Display MOT List View
        function displayMOTList() {
            const tbody = document.getElementById('mot-vehicles-table-body');

            // Check if table body exists (only on MOT reminders page)
            if (!tbody) {
                return;
            }

            // Apply interactive filter first
            let filteredVehicles = getFilteredVehicles();

            // Then apply status filter (pending/completed)
            if (currentStatusFilter === 'pending') {
                filteredVehicles = filteredVehicles.filter(v => !completedVehicles.has(v.registration));
            } else if (currentStatusFilter === 'completed') {
                filteredVehicles = filteredVehicles.filter(v => completedVehicles.has(v.registration));
            }

            if (filteredVehicles.length === 0) {
                let message, description;

                if (motVehicles.length === 0) {
                    message = 'No Vehicles Added Yet';
                    description = 'Start monitoring MOT expiry dates by adding vehicles to the system.';
                } else if (currentMOTFilter !== 'all') {
                    const filterNames = {
                        'expired': 'Expired Vehicles',
                        'critical': 'Critical Vehicles',
                        'due_soon': 'Due Soon Vehicles',
                        'normal': 'Normal Vehicles',
                        'flagged': 'Flagged Vehicles'
                    };
                    message = `No ${filterNames[currentMOTFilter]} Found`;
                    description = `There are currently no vehicles in the ${filterNames[currentMOTFilter].toLowerCase()} category.`;
                } else if (currentStatusFilter === 'pending') {
                    message = 'No Pending Vehicles';
                    description = 'All vehicles have been marked as completed/verified.';
                } else {
                    message = 'No Completed Vehicles';
                    description = 'No vehicles have been marked as completed yet.';
                }

                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 3rem; color: #6c757d;">
                            <i class="fas fa-car" style="font-size: 4rem; margin-bottom: 1rem; display: block; color: #dee2e6;"></i>
                            <h4 style="margin-bottom: 1rem; color: #6c757d;">${message}</h4>
                            <p style="margin-bottom: 1.5rem;">${description}</p>
                            ${motVehicles.length === 0 ? `
                                <div style="display: flex; gap: 1rem; justify-content: center;">
                                    <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                        <i class="fas fa-plus"></i> Add Vehicle
                                    </button>
                                    <button class="btn btn-secondary" onclick="showBulkUploadModal()">
                                        <i class="fas fa-upload"></i> Bulk Upload
                                    </button>
                                </div>
                            ` : ''}
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedVehicles = getSortedMOTVehicles(filteredVehicles);

            tbody.innerHTML = sortedVehicles.map(vehicle => {
                const statusClass = getMOTStatusClass(vehicle);
                const statusText = getMOTStatusText(vehicle);
                const isSelected = selectedMOTVehicles.includes(vehicle.registration);
                const isCompleted = completedVehicles.has(vehicle.registration);

                // Smart filtering indicators
                const isFlagged = vehicle.days_until_expiry > 365;
                const canSendSMS = vehicle.mobile_number && !isFlagged;
                const recentSMS = vehicle.recent_sms?.has_recent_sms;

                // Visual indicators
                const flagIcon = isFlagged ? 'üîí' : vehicle.is_expired ? 'üö®' : vehicle.days_until_expiry <= 7 ? '‚ö†Ô∏è' : vehicle.days_until_expiry <= 30 ? 'üìÖ' : '‚úÖ';

                return `
                    <tr class="${statusClass} ${isCompleted ? 'completed-vehicle' : ''} ${isFlagged ? 'flagged-vehicle' : ''} ${vehicle.is_archived ? 'archived-vehicle' : ''}">
                        <td>
                            <input type="checkbox" ${isSelected ? 'checked' : ''}
                                   onchange="toggleMOTVehicleSelection('${vehicle.registration}')"
                                   ${isFlagged ? 'title="Flagged vehicle - requires manual approval"' : ''}>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" ${isCompleted ? 'checked' : ''}
                                       onchange="toggleVehicleCompletion('${vehicle.registration}')"
                                       title="Mark as completed/verified"
                                       style="accent-color: #28a745;">
                                <span style="font-size: 1.2rem; margin-right: 0.25rem;" title="${isFlagged ? 'Flagged: 365+ days' : statusText}">${flagIcon}</span>
                                <strong style="${isCompleted ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${vehicle.registration}</strong>
                                ${isFlagged ? '<span class="badge bg-secondary" style="font-size: 0.6rem; margin-left: 0.25rem;">FLAGGED</span>' : ''}
                                ${vehicle.is_archived ? '<span class="badge bg-dark" style="font-size: 0.6rem; margin-left: 0.25rem;">ARCHIVED</span>' : ''}
                            </div>
                        </td>
                        <td style="${isCompleted ? 'opacity: 0.7;' : ''}">${vehicle.make} ${vehicle.model}</td>
                        <td style="${isCompleted ? 'opacity: 0.7;' : ''}">${vehicle.customer_name || '-'}</td>
                        <td style="${isCompleted ? 'opacity: 0.7;' : ''}">${formatDateForDisplay(vehicle.mot_expiry_date)}</td>
                        <td>
                            <span class="badge ${vehicle.is_expired ? 'bg-danger' : vehicle.days_until_expiry <= 7 ? 'bg-warning' : vehicle.days_until_expiry <= 30 ? 'bg-info' : isFlagged ? 'bg-secondary' : 'bg-success'}" style="${isCompleted ? 'opacity: 0.7;' : ''}">
                                ${vehicle.is_expired ? 'EXPIRED' : isFlagged ? vehicle.days_until_expiry + ' days (Flagged)' : vehicle.days_until_expiry + ' days'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass.replace('mot-status-', 'status-')}" style="${isCompleted ? 'opacity: 0.7;' : ''}">${isFlagged ? 'FLAGGED' : statusText}</span>
                        </td>
                        <td style="${isCompleted ? 'opacity: 0.7;' : ''}">${vehicle.mobile_number || '-'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.25rem; flex-direction: column;">
                                ${!vehicle.mobile_number ? `
                                    <span class="badge bg-danger" style="font-size: 0.6rem;">No Mobile</span>
                                ` : isFlagged ? `
                                    <span class="badge bg-warning" style="font-size: 0.6rem;">Manual Review</span>
                                ` : recentSMS ? `
                                    <span class="badge bg-info" style="font-size: 0.6rem;">SMS Sent</span>
                                ` : canSendSMS ? `
                                    <span class="badge bg-success" style="font-size: 0.6rem;">Ready</span>
                                ` : `
                                    <span class="badge bg-secondary" style="font-size: 0.6rem;">Cannot Send</span>
                                `}
                            </div>
                        </td>
                        <td style="font-size: 0.8rem; ${isCompleted ? 'opacity: 0.7;' : ''}">
                            ${vehicle.uploaded_at ? formatDateTime(vehicle.uploaded_at) : '-'}
                        </td>
                        <td style="font-size: 0.8rem; ${isCompleted ? 'opacity: 0.7;' : ''}">
                            ${vehicle.sms_sent_at ? formatDateTime(vehicle.sms_sent_at) : '-'}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                ${isCompleted ? `
                                    <span class="badge bg-success" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                                        <i class="fas fa-check"></i> Verified
                                    </span>
                                ` : ''}
                            </div>
                        </td>
                        <td>
                            ${vehicle.main_customer_id ? `
                                <button class="btn btn-sm btn-info" onclick="viewCustomerDetails('${vehicle.main_customer_id}', '${vehicle.registration}')" title="View Customer Details">
                                    <i class="fas fa-user"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-primary" onclick="checkMOTStatus('${vehicle.registration}')" title="Refresh MOT Status">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="sendSingleSMS('${vehicle.registration}')"
                                    ${!canSendSMS ? 'disabled' : ''}
                                    title="${!vehicle.mobile_number ? 'No mobile number' : isFlagged ? 'Flagged vehicle - manual approval required' : 'Send SMS'}">
                                <i class="fas fa-sms"></i>
                            </button>
                            ${vehicle.is_archived ? `
                                <button class="btn btn-sm btn-info" onclick="unarchiveVehicle('${vehicle.registration}')" title="Unarchive vehicle">
                                    <i class="fas fa-box-open"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-secondary" onclick="archiveVehicle('${vehicle.registration}')" title="Archive vehicle">
                                    <i class="fas fa-archive"></i>
                                </button>
                            `}
                            <button class="btn btn-sm btn-danger" onclick="removeMOTVehicle('${vehicle.registration}')" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get MOT Status Class
        function getMOTStatusClass(vehicle) {
            if (vehicle.is_expired) return 'mot-status-expired';
            if (vehicle.days_until_expiry <= 7) return 'mot-status-critical';
            if (vehicle.days_until_expiry <= 30) return 'mot-status-due-soon';
            return 'mot-status-valid';
        }

        // Get MOT Status Text
        function getMOTStatusText(vehicle) {
            if (vehicle.is_expired) return 'EXPIRED';
            if (vehicle.days_until_expiry <= 7) return 'CRITICAL';
            if (vehicle.days_until_expiry <= 30) return 'DUE SOON';
            return 'VALID';
        }

        // Sort MOT Vehicles Utility Function
        function getSortedMOTVehicles(vehicles) {
            if (!vehicles || vehicles.length === 0) return [];

            const sorted = [...vehicles];

            switch (motSortBy) {
                case 'urgency':
                    return sorted.sort((a, b) => {
                        if (a.is_expired && !b.is_expired) return -1;
                        if (!a.is_expired && b.is_expired) return 1;
                        if (a.is_expired && b.is_expired) return b.days_until_expiry - a.days_until_expiry;
                        return a.days_until_expiry - b.days_until_expiry;
                    });
                case 'expiry':
                    return sorted.sort((a, b) => a.days_until_expiry - b.days_until_expiry);
                case 'registration':
                    return sorted.sort((a, b) => a.registration.localeCompare(b.registration));
                case 'customer':
                    return sorted.sort((a, b) => (a.customer_name || '').localeCompare(b.customer_name || ''));
                default:
                    return sorted;
            }
        }

        // Apply sort to MOT vehicles and refresh display
        function applySortToMOTVehicles() {
            motSortBy = document.getElementById('mot-sort-select').value;
            displayMOTVehicles();
        }

        // Switch MOT View
        function switchMOTView(view) {
            currentMOTView = view;

            const listBtn = document.getElementById('list-view-btn');
            const cardBtn = document.getElementById('card-view-btn');
            const listView = document.getElementById('mot-list-view');
            const cardView = document.getElementById('mot-card-view');

            if (view === 'list') {
                listBtn.style.background = '#667eea';
                listBtn.style.color = 'white';
                cardBtn.style.background = '#6c757d';
                cardBtn.style.color = 'white';
                listView.style.display = 'block';
                cardView.style.display = 'none';
                displayMOTList();
            } else {
                cardBtn.style.background = '#667eea';
                cardBtn.style.color = 'white';
                listBtn.style.background = '#6c757d';
                listBtn.style.color = 'white';
                listView.style.display = 'none';
                cardView.style.display = 'block';
                displayMOTCards();
            }

            localStorage.setItem('motViewMode', view);
        }

        // Display MOT Cards View
        function displayMOTCards() {
            const container = document.getElementById('mot-vehicles-cards');

            // Apply interactive filter
            const filteredVehicles = getFilteredVehicles();

            if (filteredVehicles.length === 0) {
                let message, description;

                if (motVehicles.length === 0) {
                    message = 'No Vehicles Added Yet';
                    description = 'Start monitoring MOT expiry dates by adding vehicles to the system.';
                } else if (currentMOTFilter !== 'all') {
                    const filterNames = {
                        'expired': 'Expired Vehicles',
                        'critical': 'Critical Vehicles',
                        'due_soon': 'Due Soon Vehicles',
                        'normal': 'Normal Vehicles',
                        'flagged': 'Flagged Vehicles'
                    };
                    message = `No ${filterNames[currentMOTFilter]} Found`;
                    description = `There are currently no vehicles in the ${filterNames[currentMOTFilter].toLowerCase()} category.`;
                } else {
                    message = 'No Vehicles Found';
                    description = 'No vehicles match the current filter criteria.';
                }

                container.innerHTML = `
                    <div class="col-12" style="text-align: center; padding: 4rem; color: #6c757d;">
                        <i class="fas fa-car" style="font-size: 5rem; margin-bottom: 1.5rem; display: block; color: #dee2e6;"></i>
                        <h3 style="margin-bottom: 1rem; color: #6c757d;">${message}</h3>
                        <p style="margin-bottom: 2rem; font-size: 1.1rem;">${description}</p>
                        ${motVehicles.length === 0 ? `
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                    <i class="fas fa-plus"></i> Add Vehicle
                                </button>
                                <button class="btn btn-secondary" onclick="showBulkUploadModal()">
                                    <i class="fas fa-upload"></i> Bulk Upload
                                </button>
                            </div>
                        ` : currentMOTFilter !== 'all' ? `
                            <button class="btn btn-secondary" onclick="clearMOTFilter()">
                                <i class="fas fa-times"></i> Clear Filter
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }

            const sortedVehicles = getSortedMOTVehicles(filteredVehicles);

            container.innerHTML = sortedVehicles.map(vehicle => {
                const statusClass = getMOTStatusClass(vehicle);
                const statusText = getMOTStatusText(vehicle);
                const isSelected = selectedMOTVehicles.includes(vehicle.registration);

                return `
                    <div class="col-md-6 col-lg-4">
                        <div class="mot-card ${statusClass}">
                            <div class="mot-card-header">
                                <div>
                                    <h5 style="margin: 0; font-weight: bold;">${vehicle.registration}</h5>
                                    <small>${vehicle.make} ${vehicle.model}</small>
                                </div>
                                <div>
                                    <input type="checkbox" ${isSelected ? 'checked' : ''}
                                           onchange="toggleMOTVehicleSelection('${vehicle.registration}')">
                                </div>
                            </div>
                            <div class="mot-card-body">
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>Customer:</strong> ${vehicle.customer_name || 'Not specified'}
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>MOT Expires:</strong> ${formatDateForDisplay(vehicle.mot_expiry_date)}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <span class="badge ${vehicle.is_expired ? 'bg-danger mot-urgency-badge' : vehicle.days_until_expiry <= 7 ? 'bg-warning' : vehicle.days_until_expiry <= 30 ? 'bg-info' : 'bg-success'}">
                                        ${vehicle.is_expired ? 'EXPIRED' : vehicle.days_until_expiry + ' days left'}
                                    </span>
                                    <span class="status-badge ${statusClass.replace('mot-status-', 'status-')}" style="margin-left: 0.5rem;">${statusText}</span>
                                </div>
                                <div style="display: flex; gap: 0.25rem;">
                                    <button class="btn btn-sm btn-primary" onclick="checkMOTStatus('${vehicle.registration}')" title="Refresh">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="sendSingleSMS('${vehicle.registration}')"
                                            ${!vehicle.mobile_number ? 'disabled' : ''} title="SMS">
                                        <i class="fas fa-sms"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="removeMOTVehicle('${vehicle.registration}')" title="Remove">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format Date for Display (DD-MM-YYYY)
        function formatDateForDisplay(dateString) {
            if (!dateString || dateString === '-' || dateString === 'Unknown') {
                return '-';
            }

            // If already in DD-MM-YYYY format, return as-is
            if (typeof dateString === 'string' && dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
                return dateString;
            }

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString;
                }

                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();

                return `${day}-${month}-${year}`;
            } catch (error) {
                return dateString;
            }
        }

        // Calculate Days Until Expiry
        function calculateDaysUntilExpiry(expiryDate) {
            try {
                const today = new Date();
                const expiry = new Date(expiryDate);
                const diffTime = expiry - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            } catch (error) {
                return 0;
            }
        }

        // Modal Functions
        function showAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.add('active');
            document.getElementById('vehicle-registration-input').focus();
        }

        function closeAddVehicleModal() {
            document.getElementById('add-vehicle-modal').classList.remove('active');
            document.getElementById('add-vehicle-form').reset();
        }

        function showBulkUploadModal() {
            document.getElementById('bulk-upload-modal').classList.add('active');
        }

        function closeBulkUploadModal() {
            document.getElementById('bulk-upload-modal').classList.remove('active');

            // Reset modal state
            document.getElementById('file-input').value = '';
            document.getElementById('file-info').innerHTML = '';
            document.getElementById('file-preview').style.display = 'none';
            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-btn').disabled = true;
            document.getElementById('cancel-upload-btn').disabled = false;

            // Clear upload data
            window.uploadFileData = null;
        }

        function showSMSModal() {
            updateSMSVehicleList();
            document.getElementById('sms-modal').classList.add('active');
            checkSMSServiceStatus();
        }

        function closeSMSModal() {
            document.getElementById('sms-modal').classList.remove('active');
        }

        function showMOTUploadModal() {
            document.getElementById('bulk-upload-modal').classList.add('active');
        }

        // Add Vehicle Function
        async function addMOTVehicle(event) {
            event.preventDefault();

            const registration = document.getElementById('vehicle-registration-input').value.trim().toUpperCase().replace(/\s+/g, ''); // Remove all spaces
            const customerName = document.getElementById('customer-name-input').value.trim();
            const mobileNumber = document.getElementById('mobile-number-input').value.trim();

            if (!registration) {
                showNotification('Please enter a vehicle registration', 'error');
                return;
            }

            // Check if vehicle already exists
            if (motVehicles.find(v => v.registration === registration)) {
                showNotification('Vehicle already exists in the system', 'error');
                return;
            }

            try {
                showNotification('Checking MOT status with DVSA API...', 'info');

                // Try to use backend API first
                try {
                    const response = await fetch(`${API_BASE_URL}/mot/vehicles`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            registration: registration,
                            customer_name: customerName,
                            mobile_number: mobileNumber
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            // Reload vehicles from backend
                            await loadMOTReminders();
                            closeAddVehicleModal();
                            showNotification(`Vehicle ${registration} added successfully`, 'success');
                            return;
                        } else {
                            throw new Error(result.error || 'Backend API error');
                        }
                    }
                } catch (apiError) {
                    console.log('Backend API not available, using local storage');
                }

                // Only use real DVSA API data - no fallback
                let motData = await fetchDVSAData(registration);
                if (!motData) {
                    console.log('DVSA API failed - no fallback data will be used');
                    throw new Error('Could not retrieve MOT data from DVLA. Please check the registration number and try again.');
                }

                if (motData) {
                    const vehicle = {
                        registration: registration,
                        make: motData.make || 'Unknown',
                        model: motData.model || 'Unknown',
                        customer_name: customerName || '',
                        mobile_number: mobileNumber || '',
                        mot_expiry_date: motData.mot_expiry_date,
                        days_until_expiry: motData.days_until_expiry,
                        is_expired: motData.is_expired,
                        last_test_date: motData.last_test_date,
                        test_result: motData.test_result
                    };

                    motVehicles.push(vehicle);
                    localStorage.setItem('motVehicles', JSON.stringify(motVehicles));

                    updateMOTStatistics();
                    displayMOTVehicles();
                    updateMOTUrgentBadge();

                    closeAddVehicleModal();
                    showNotification(`Vehicle ${registration} added successfully`, 'success');
                } else {
                    showNotification('Could not retrieve MOT data for this vehicle', 'error');
                }
            } catch (error) {
                console.error('Error adding vehicle:', error);
                showNotification('Error adding vehicle. Please try again.', 'error');
            }
        }

        // Real DVSA API Call - Direct integration with DVSA MOT History API
        async function fetchDVSAData(registration) {
            try {
                console.log(`üîç Fetching real DVSA data for registration: ${registration}`);

                // Call through our backend API to avoid CORS issues
                const apiUrl = `${API_BASE_URL}/mot/check/${registration}`;
                console.log(`üì° Backend API URL: ${apiUrl}`);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log(`üì• Backend API Response status: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    console.log(`üìã Full DVSA response for ${registration}:`, result);

                    if (result && result.length > 0) {
                        const vehicle = result[0]; // Get the first vehicle record

                        // Extract MOT data from DVSA response
                        const motTests = vehicle.motTests || [];
                        const latestTest = motTests.length > 0 ? motTests[0] : null;

                        let motExpiryDate = null;
                        let lastTestDate = null;
                        let testResult = 'UNKNOWN';

                        if (latestTest) {
                            motExpiryDate = latestTest.expiryDate;
                            lastTestDate = latestTest.completedDate;
                            testResult = latestTest.testResult;
                        }

                        // Calculate days until expiry
                        let daysUntilExpiry = 0;
                        let isExpired = false;

                        if (motExpiryDate) {
                            const today = new Date();
                            const expiry = new Date(motExpiryDate);
                            daysUntilExpiry = Math.floor((expiry - today) / (1000 * 60 * 60 * 24));
                            isExpired = daysUntilExpiry < 0;
                        }

                        const motData = {
                            registration: registration,
                            make: vehicle.make || 'Unknown',
                            model: vehicle.model || 'Unknown',
                            mot_expiry_date: motExpiryDate ? formatDateToDDMMYYYY(motExpiryDate) : null,
                            days_until_expiry: daysUntilExpiry,
                            is_expired: isExpired,
                            last_test_date: lastTestDate ? formatDateToDDMMYYYY(lastTestDate) : null,
                            test_result: testResult
                        };

                        console.log(`‚úÖ Backend API success for ${registration}:`, motData);
                        return motData;
                    } else {
                        console.error(`‚ùå No vehicle data found in backend response for ${registration}`);
                        return null;
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`‚ùå Backend API HTTP error ${response.status} for ${registration}: ${errorText}`);
                    return null;
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error(`‚è∞ Backend API timeout for ${registration}`);
                } else {
                    console.error(`üí• Error fetching backend data for ${registration}:`, error);
                }
                return null;
            }
        }

        // Helper function to format date to DD-MM-YYYY
        function formatDateToDDMMYYYY(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return dateString;
            }
        }



        // Check MOT Status (refresh)
        async function checkMOTStatus(registration) {
            try {
                showNotification('Refreshing MOT status from DVSA...', 'info');

                // Only use real DVSA API data
                let motData = await fetchDVSAData(registration);
                if (!motData) {
                    console.log('Backend API failed for refresh - no fallback data available');
                    showNotification('Could not refresh MOT data from DVLA', 'error');
                    return;
                }

                if (motData) {
                    const vehicleIndex = motVehicles.findIndex(v => v.registration === registration);
                    if (vehicleIndex !== -1) {
                        motVehicles[vehicleIndex] = {
                            ...motVehicles[vehicleIndex],
                            ...motData
                        };

                        localStorage.setItem('motVehicles', JSON.stringify(motVehicles));
                        updateMOTStatistics();
                        displayMOTVehicles();
                        updateMOTUrgentBadge();

                        showNotification(`MOT status updated for ${registration}`, 'success');
                    }
                }
            } catch (error) {
                console.error('Error checking MOT status:', error);
                showNotification('Error refreshing MOT status', 'error');
            }
        }

        // Remove MOT Vehicle
        function removeMOTVehicle(registration) {
            if (confirm(`Are you sure you want to remove ${registration} from MOT monitoring?`)) {
                motVehicles = motVehicles.filter(v => v.registration !== registration);
                selectedMOTVehicles = selectedMOTVehicles.filter(r => r !== registration);

                localStorage.setItem('motVehicles', JSON.stringify(motVehicles));

                updateMOTStatistics();
                displayMOTVehicles();
                updateMOTUrgentBadge();

                showNotification(`Vehicle ${registration} removed`, 'success');
            }
        }

        // Vehicle Selection Functions
        function toggleMOTVehicleSelection(registration) {
            const index = selectedMOTVehicles.indexOf(registration);
            if (index === -1) {
                selectedMOTVehicles.push(registration);
            } else {
                selectedMOTVehicles.splice(index, 1);
            }

            updateSMSButtonState();
            displayMOTVehicles(); // Refresh to show selection state
        }

        function toggleAllMOTSelection() {
            const selectAllCheckbox = document.getElementById('select-all-mot');

            if (selectAllCheckbox.checked) {
                selectedMOTVehicles = motVehicles.map(v => v.registration);
            } else {
                selectedMOTVehicles = [];
            }

            updateSMSButtonState();
            displayMOTVehicles();
        }

        function selectUrgentVehicles() {
            selectedMOTVehicles = motVehicles
                .filter(v => v.is_expired || v.days_until_expiry <= 7)
                .map(v => v.registration);

            updateSMSButtonState();
            displayMOTVehicles();
            updateSMSVehicleList();
        }

        function clearSMSSelection() {
            selectedMOTVehicles = [];
            updateSMSButtonState();
            displayMOTVehicles();
            updateSMSVehicleList();
        }

        // Update SMS Button State
        function updateSMSButtonState() {
            const smsButton = document.getElementById('sms-button');
            const smsCount = document.getElementById('sms-count');
            const vehiclesWithMobile = selectedMOTVehicles.filter(reg => {
                const vehicle = motVehicles.find(v => v.registration === reg);
                return vehicle && vehicle.mobile_number;
            }).length;

            smsCount.textContent = vehiclesWithMobile;
            smsButton.disabled = vehiclesWithMobile === 0;
        }

        // SMS Functions
        function updateSMSVehicleList() {
            const container = document.getElementById('sms-vehicle-list');
            const sendBtn = document.getElementById('send-sms-btn');
            const sendCount = document.getElementById('sms-send-count');

            const selectedVehicles = motVehicles.filter(v => selectedMOTVehicles.includes(v.registration));
            const vehiclesWithMobile = selectedVehicles.filter(v => v.mobile_number);

            if (selectedVehicles.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; text-align: center; color: #6c757d;">No vehicles selected</p>';
                sendBtn.disabled = true;
                sendCount.textContent = '0';
                return;
            }

            container.innerHTML = selectedVehicles.map(vehicle => {
                const statusClass = getMOTStatusClass(vehicle);
                const statusText = getMOTStatusText(vehicle);
                const hasMobile = !!vehicle.mobile_number;

                return `
                    <div style="padding: 0.75rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; ${!hasMobile ? 'opacity: 0.6;' : ''}">
                        <div>
                            <strong>${vehicle.registration}</strong> - ${vehicle.make} ${vehicle.model}
                            <br>
                            <small>Customer: ${vehicle.customer_name || 'Not specified'}</small>
                            <br>
                            <small>Mobile: ${vehicle.mobile_number || 'Not provided'}</small>
                        </div>
                        <div>
                            <span class="status-badge ${statusClass.replace('mot-status-', 'status-')}">${statusText}</span>
                            ${!hasMobile ? '<br><small style="color: #dc3545;">No mobile number</small>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            sendBtn.disabled = vehiclesWithMobile.length === 0;
            sendCount.textContent = vehiclesWithMobile.length;
        }

        async function checkSMSServiceStatus() {
            const statusDiv = document.getElementById('sms-service-status');

            // Show loading state
            statusDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="spinner" style="width: 16px; height: 16px;"></div>
                    <span>Checking SMS service status...</span>
                </div>
            `;

            try {
                // Check SMS service status using dedicated endpoint
                const response = await fetch(`${API_BASE_URL}/mot/sms/status`);
                const data = await response.json();

                if (data.success && data.configured && !data.demo_mode) {
                    // Real SMS sending is enabled
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-check-circle" style="color: #28a745;"></i>
                            <span><strong>SMS Service:</strong> Real SMS Sending Enabled</span>
                        </div>
                        <small style="color: #6c757d; margin-top: 0.25rem; display: block;">
                            SMS messages will be sent to customers via Twilio (${data.from_number})
                        </small>
                    `;
                } else if (data.success && data.demo_mode) {
                    // Demo mode
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: #17a2b8;"></i>
                            <span><strong>SMS Service:</strong> Demo Mode - Messages will be logged to console</span>
                        </div>
                        <small style="color: #6c757d; margin-top: 0.25rem; display: block;">
                            Configure Twilio credentials to enable real SMS sending
                        </small>
                    `;
                } else {
                    throw new Error(data.error || 'SMS service not configured');
                }
            } catch (error) {
                // Fallback to demo mode display
                statusDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
                        <span><strong>SMS Service:</strong> Not Available</span>
                    </div>
                    <small style="color: #6c757d; margin-top: 0.25rem; display: block;">
                        Check that the MOT service is running
                    </small>
                `;
            }
        }

        async function sendSingleSMS(registration) {
            const vehicle = motVehicles.find(v => v.registration === registration);
            if (!vehicle || !vehicle.mobile_number) {
                showNotification('No mobile number available for this vehicle', 'error');
                return;
            }

            if (confirm(`Send MOT reminder SMS to ${vehicle.customer_name || 'customer'} for ${registration}?`)) {
                try {
                    // Try to use backend API first
                    const response = await fetch(`${API_BASE_URL}/mot/sms/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            registrations: [registration]
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.sent > 0) {
                            showNotification(`SMS sent successfully to ${vehicle.customer_name || 'customer'}`, 'success');
                            loadMOTReminders(); // Refresh to show archived vehicle
                            return;
                        } else if (result.skipped > 0) {
                            showNotification(`SMS skipped: ${result.results[0]?.reason || 'Unknown reason'}`, 'warning');
                            return;
                        }
                    }
                } catch (apiError) {
                    console.log('Backend API not available, using demo mode');
                }

                // Fallback to demo mode
                simulateSMSSend([vehicle]);
                loadMOTReminders(); // Refresh even in demo mode
            }
        }

        async function sendBulkSMS() {
            const selectedVehicles = motVehicles.filter(v =>
                selectedMOTVehicles.includes(v.registration) && v.mobile_number
            );

            if (selectedVehicles.length === 0) {
                showNotification('No vehicles with mobile numbers selected', 'error');
                return;
            }

            if (confirm(`Send MOT reminder SMS to ${selectedVehicles.length} customers?`)) {
                try {
                    showNotification(`Sending SMS to ${selectedVehicles.length} customers...`, 'info');

                    // Try to use backend API first
                    try {
                        const response = await fetch(`${API_BASE_URL}/mot/sms/send`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                registrations: selectedVehicles.map(v => v.registration)
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                showNotification(`SMS sent successfully to ${result.sent} customers`, 'success');
                                if (result.failed > 0) {
                                    showNotification(`${result.failed} SMS messages failed to send`, 'warning');
                                }
                                if (result.skipped > 0) {
                                    showNotification(`${result.skipped} vehicles skipped`, 'info');
                                }

                                // Clear selection and refresh list (vehicles will be archived)
                                selectedMOTVehicles = [];
                                updateSMSButtonState();
                                loadMOTReminders();
                                closeSMSModal();
                                return;
                            }
                        }
                    } catch (apiError) {
                        console.log('Backend API not available, using demo mode');
                    }

                    // Fallback to demo mode
                    simulateSMSSend(selectedVehicles);

                    // Clear selection and refresh list (even in demo mode)
                    selectedMOTVehicles = [];
                    updateSMSButtonState();
                    loadMOTReminders();
                    closeSMSModal();
                } catch (error) {
                    console.error('Error sending SMS:', error);
                    showNotification('Error sending SMS messages', 'error');
                }
            }
        }

        function simulateSMSSend(vehicles) {
            showNotification(`Sending SMS to ${vehicles.length} customers...`, 'info');

            // Simulate SMS sending delay
            setTimeout(() => {
                vehicles.forEach(vehicle => {
                    const template = getSMSTemplate(vehicle);
                    console.log(`üì± SMS DEMO MODE:`);
                    console.log(`To: ${vehicle.mobile_number}`);
                    console.log(`Customer: ${vehicle.customer_name || 'Unknown'}`);
                    console.log(`Vehicle: ${vehicle.registration}`);
                    console.log(`Message: ${template}`);
                    console.log('-'.repeat(50));
                });

                showNotification(`SMS sent successfully to ${vehicles.length} customers`, 'success');
            }, 1000);
        }

        function getSMSTemplate(vehicle) {
            const customerGreeting = vehicle.customer_name ? `Hi ${vehicle.customer_name}, ` : 'Hi, ';

            if (vehicle.is_expired) {
                return `üö® URGENT: MOT EXPIRED
${customerGreeting}Your ${vehicle.make} ${vehicle.model} (${vehicle.registration}) MOT expired on ${vehicle.mot_expiry_date}.
You cannot legally drive this vehicle. Please book your MOT test immediately.
Contact us for assistance.`;
            } else if (vehicle.days_until_expiry <= 7) {
                return `‚ö†Ô∏è CRITICAL: MOT Due Soon
${customerGreeting}Your ${vehicle.make} ${vehicle.model} (${vehicle.registration}) MOT expires in ${vehicle.days_until_expiry} days on ${vehicle.mot_expiry_date}.
Please book your MOT test urgently to avoid any issues.
Contact us to arrange your test.`;
            } else if (vehicle.days_until_expiry <= 30) {
                return `üìÖ MOT Reminder
${customerGreeting}Your ${vehicle.make} ${vehicle.model} (${vehicle.registration}) MOT expires in ${vehicle.days_until_expiry} days on ${vehicle.mot_expiry_date}.
Please book your MOT test soon to ensure continuous coverage.
Contact us to schedule your test.`;
            } else {
                return `üîî MOT Reminder
${customerGreeting}Your ${vehicle.make} ${vehicle.model} (${vehicle.registration}) MOT expires on ${vehicle.mot_expiry_date}.
Don't forget to book your MOT test.
Contact us for more information.`;
            }
        }

        // Search Function
        function searchMOTVehicles() {
            const searchTerm = document.getElementById('mot-search').value.toLowerCase();

            if (!searchTerm) {
                displayMOTVehicles();
                return;
            }

            const filteredVehicles = motVehicles.filter(vehicle =>
                vehicle.registration.toLowerCase().includes(searchTerm) ||
                vehicle.make.toLowerCase().includes(searchTerm) ||
                vehicle.model.toLowerCase().includes(searchTerm) ||
                (vehicle.customer_name && vehicle.customer_name.toLowerCase().includes(searchTerm))
            );

            // Temporarily replace motVehicles for display
            const originalVehicles = motVehicles;
            motVehicles = filteredVehicles;
            displayMOTVehicles();
            motVehicles = originalVehicles;
        }

        // Quick MOT Check Function
        let quickCheckTimeout;
        function quickMOTCheck(registration) {
            // Clear previous timeout
            if (quickCheckTimeout) {
                clearTimeout(quickCheckTimeout);
            }

            const resultDiv = document.getElementById('quickMOTResult');
            const alertDiv = document.getElementById('quickMOTAlert');
            const contentDiv = document.getElementById('quickMOTContent');
            const spinner = document.getElementById('quickMOTSpinner');

            // Hide result if registration is empty or too short
            if (!registration || registration.length < 3) {
                resultDiv.style.display = 'none';
                return;
            }

            // Clean registration
            const cleanReg = registration.replace(/\s+/g, '').toUpperCase();

            // Debounce the API call
            quickCheckTimeout = setTimeout(async () => {
                try {
                    // Show loading state
                    resultDiv.style.display = 'block';
                    alertDiv.className = 'alert alert-info';
                    spinner.style.display = 'inline-block';
                    contentDiv.innerHTML = 'Checking MOT status...';

                    // Check if vehicle already exists in our data
                    const existingVehicle = motVehicles.find(v =>
                        v.registration.replace(/\s+/g, '').toUpperCase() === cleanReg
                    );

                    if (existingVehicle) {
                        // Show existing vehicle data
                        spinner.style.display = 'none';
                        const statusClass = existingVehicle.is_expired ? 'alert-danger' :
                                          existingVehicle.days_until_expiry <= 30 ? 'alert-warning' : 'alert-success';
                        alertDiv.className = `alert ${statusClass}`;

                        const statusIcon = existingVehicle.is_expired ? 'üö®' :
                                         existingVehicle.days_until_expiry <= 30 ? '‚ö†Ô∏è' : '‚úÖ';

                        contentDiv.innerHTML = `
                            <strong>${statusIcon} ${existingVehicle.registration}</strong><br>
                            <strong>Make/Model:</strong> ${existingVehicle.make} ${existingVehicle.model}<br>
                            <strong>MOT Expires:</strong> ${existingVehicle.mot_expiry_date}<br>
                            <strong>Status:</strong> ${existingVehicle.is_expired ? 'EXPIRED' :
                                existingVehicle.days_until_expiry <= 30 ? `Due in ${existingVehicle.days_until_expiry} days` : 'Valid'}
                            <br><small>Vehicle already in MOT reminders</small>
                        `;
                        return;
                    }

                    // Make API call to check MOT status
                    const response = await fetch('/api/mot/check', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ registration: cleanReg })
                    });

                    const data = await response.json();
                    spinner.style.display = 'none';

                    if (data.success && data.vehicle) {
                        const vehicle = data.vehicle;
                        const isExpired = new Date(vehicle.mot_expiry_date) < new Date();
                        const daysUntilExpiry = Math.ceil((new Date(vehicle.mot_expiry_date) - new Date()) / (1000 * 60 * 60 * 24));

                        const statusClass = isExpired ? 'alert-danger' :
                                          daysUntilExpiry <= 30 ? 'alert-warning' : 'alert-success';
                        alertDiv.className = `alert ${statusClass}`;

                        const statusIcon = isExpired ? 'üö®' :
                                         daysUntilExpiry <= 30 ? '‚ö†Ô∏è' : '‚úÖ';

                        contentDiv.innerHTML = `
                            <strong>${statusIcon} ${vehicle.registration}</strong><br>
                            <strong>Make/Model:</strong> ${vehicle.make} ${vehicle.model}<br>
                            <strong>MOT Expires:</strong> ${vehicle.mot_expiry_date}<br>
                            <strong>Status:</strong> ${isExpired ? 'EXPIRED' :
                                daysUntilExpiry <= 30 ? `Due in ${daysUntilExpiry} days` : 'Valid'}
                        `;
                    } else {
                        // Vehicle not found or API error
                        alertDiv.className = 'alert alert-warning';
                        contentDiv.innerHTML = `
                            <strong>‚ö†Ô∏è ${cleanReg}</strong><br>
                            ${data.message || 'Vehicle not found in DVSA database or invalid registration'}
                        `;
                    }
                } catch (error) {
                    console.error('Quick MOT check error:', error);
                    spinner.style.display = 'none';
                    alertDiv.className = 'alert alert-danger';
                    contentDiv.innerHTML = `
                        <strong>‚ùå Error</strong><br>
                        Unable to check MOT status. Please try again.
                    `;
                }
            }, 800); // 800ms delay for debouncing
        }

        // Sort Function (for UI sorting)
        function applySortToMOTVehicles() {
            motSortBy = document.getElementById('mot-sort-select').value;
            displayMOTVehicles();
        }

        // Completion Tracking Functions
        function loadCompletionStatus() {
            // Load completion status from localStorage
            try {
                const saved = localStorage.getItem('motCompletedVehicles');
                if (saved) {
                    completedVehicles = new Set(JSON.parse(saved));
                    console.log(`üìã Loaded ${completedVehicles.size} completed vehicles from storage`);
                }
            } catch (error) {
                console.error('Error loading completion status:', error);
                completedVehicles = new Set();
            }
        }

        function saveCompletionStatus() {
            // Save completion status to localStorage
            try {
                localStorage.setItem('motCompletedVehicles', JSON.stringify([...completedVehicles]));
                console.log(`üíæ Saved ${completedVehicles.size} completed vehicles to storage`);
            } catch (error) {
                console.error('Error saving completion status:', error);
            }
        }

        function toggleVehicleCompletion(registration) {
            // Toggle completion status for a single vehicle
            if (completedVehicles.has(registration)) {
                completedVehicles.delete(registration);
                console.log(`‚úÖ Marked ${registration} as pending`);
            } else {
                completedVehicles.add(registration);
                console.log(`‚úÖ Marked ${registration} as completed`);
            }

            saveCompletionStatus();
            displayMOTVehicles();
            updateMOTStatistics();
        }

        function markSelectedAsCompleted() {
            // Mark all selected vehicles as completed
            if (selectedMOTVehicles.length === 0) {
                showNotification('No vehicles selected', 'warning');
                return;
            }

            const pendingSelected = selectedMOTVehicles.filter(reg => !completedVehicles.has(reg));

            if (pendingSelected.length === 0) {
                showNotification('All selected vehicles are already marked as completed', 'info');
                return;
            }

            if (confirm(`Mark ${pendingSelected.length} vehicles as completed/verified?`)) {
                pendingSelected.forEach(reg => completedVehicles.add(reg));
                saveCompletionStatus();
                displayMOTVehicles();
                updateMOTStatistics();
                showNotification(`${pendingSelected.length} vehicles marked as completed`, 'success');
            }
        }

        function markSelectedAsPending() {
            // Mark all selected vehicles as pending
            if (selectedMOTVehicles.length === 0) {
                showNotification('No vehicles selected', 'warning');
                return;
            }

            const completedSelected = selectedMOTVehicles.filter(reg => completedVehicles.has(reg));

            if (completedSelected.length === 0) {
                showNotification('All selected vehicles are already pending', 'info');
                return;
            }

            if (confirm(`Mark ${completedSelected.length} vehicles as pending (reset completion status)?`)) {
                completedSelected.forEach(reg => completedVehicles.delete(reg));
                saveCompletionStatus();
                displayMOTVehicles();
                updateMOTStatistics();
                showNotification(`${completedSelected.length} vehicles marked as pending`, 'success');
            }
        }

        function resetAllCompletionStatus() {
            // Reset completion status for all vehicles
            if (completedVehicles.size === 0) {
                showNotification('No completed vehicles to reset', 'info');
                return;
            }

            const count = completedVehicles.size;
            if (confirm(`Reset completion status for all ${count} completed vehicles?\n\nThis will mark them all as pending again.`)) {
                completedVehicles.clear();
                saveCompletionStatus();
                displayMOTVehicles();
                updateMOTStatistics();
                showNotification(`Reset completion status for ${count} vehicles`, 'success');
            }
        }

        function applyStatusFilter() {
            // Apply status filter to vehicle display
            currentStatusFilter = document.getElementById('status-filter-select').value;
            displayMOTVehicles();
            updateMOTStatistics();
        }

        // Helper function to parse customer field and extract information
        function parseCustomerField(customerField) {
            if (!customerField) return { name: '', mobile: '' };

            // Extract mobile number (pattern: m: followed by digits)
            const mobileMatch = customerField.match(/m:\s*(\d{11}|\d{10})/);
            const mobile = mobileMatch ? mobileMatch[1] : '';

            // Extract name - look for pattern before first 't:'
            // Handle cases like "Mr Benaim t:" where there's no space before t:
            const nameMatch = customerField.match(/^([^t]+?)(?:\s*t:|$)/);
            let name = nameMatch ? nameMatch[1].trim() : '';

            // Clean up name (remove quotes and common prefixes)
            name = name.replace(/^["']|["']$/g, ''); // Remove quotes
            name = name.replace(/^(Mr|Mrs|Ms|Miss|Dr)\s+/i, ''); // Remove titles

            return { name: name.trim(), mobile: mobile };
        }

        // Helper function to clean and validate mobile numbers
        function cleanMobileNumber(mobileField) {
            if (!mobileField) return '';

            // Remove all non-digit characters except +
            let cleaned = mobileField.replace(/[^\d+]/g, '');

            // Handle UK mobile numbers
            if (cleaned.match(/^(\+44|0)?7\d{9}$/)) {
                // Convert to +44 format
                if (cleaned.startsWith('07')) {
                    return '+44' + cleaned.substring(1);
                } else if (cleaned.startsWith('447')) {
                    return '+' + cleaned;
                } else if (cleaned.startsWith('+447')) {
                    return cleaned;
                } else if (cleaned.match(/^7\d{9}$/)) {
                    return '+44' + cleaned;
                }
            }

            // Return original if it looks like a valid mobile (10-11 digits starting with 07)
            if (cleaned.match(/^07\d{9}$/)) {
                return cleaned;
            }

            return ''; // Invalid mobile number
        }

        // File Upload Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processUploadFile(file);
            }
        }

        function processUploadFile(file) {
            const fileInfo = document.getElementById('file-info');
            const preview = document.getElementById('file-preview');
            const uploadBtn = document.getElementById('upload-btn');

            fileInfo.innerHTML = `
                <strong>File:</strong> ${file.name}<br>
                <strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                <strong>Type:</strong> ${file.type || 'Unknown'}
            `;

            preview.style.display = 'block';

            if (file.name.endsWith('.csv')) {
                processCSVFile(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                showNotification('Excel files are supported but require additional processing. Please use CSV format for now.', 'warning');
                uploadBtn.disabled = true;
            } else {
                showNotification('Unsupported file format. Please use CSV or Excel files.', 'error');
                uploadBtn.disabled = true;
            }
        }

        function processCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                console.log('üìÑ Raw CSV content (first 500 chars):', csv.substring(0, 500));

                const lines = csv.split('\n').filter(line => line.trim());
                console.log('üìä Total lines found:', lines.length);

                if (lines.length < 2) {
                    showNotification('CSV file must contain at least a header row and one data row', 'error');
                    return;
                }

                // Parse CSV properly handling quoted fields
                const parsedData = parseCSV(csv);
                console.log('üîç Parsed CSV data:', parsedData);

                if (parsedData.length < 2) {
                    showNotification('CSV file must contain at least a header row and one data row', 'error');
                    return;
                }

                const headers = parsedData[0].map(h => h.trim().toLowerCase().replace(/"/g, ''));
                const dataRows = parsedData.slice(1);

                console.log('üìã Parsed headers:', headers);
                console.log('üìÑ First few data rows:', dataRows.slice(0, 3));

                const previewHeader = document.getElementById('preview-header');
                const previewBody = document.getElementById('preview-body');

                // Show headers
                previewHeader.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

                // Show first 5 rows
                const previewRows = dataRows.slice(0, 5).map(row => {
                    return `<tr>${row.map(cell => `<td>${cell.replace(/"/g, '').substring(0, 50)}</td>`).join('')}</tr>`;
                }).join('');

                previewBody.innerHTML = previewRows;

                // Validate required columns
                const hasRegistration = headers.some(h =>
                    h.includes('registration') || h.includes('reg') || h === 'vehicle'
                );

                console.log('üéØ Registration column found:', hasRegistration);
                console.log('üîç Available headers:', headers);

                if (hasRegistration) {
                    document.getElementById('upload-btn').disabled = false;
                    // Store parsed data instead of raw lines
                    window.uploadFileData = {
                        headers,
                        lines: dataRows.map(row => row.join(',')) // Convert back to CSV format for compatibility
                    };
                    console.log('‚úÖ Upload data prepared:', window.uploadFileData);
                } else {
                    showNotification('CSV must contain a registration column (registration, reg, or vehicle)', 'error');
                    document.getElementById('upload-btn').disabled = true;
                }
            };
            reader.readAsText(file);
        }

        // Improved CSV parser that handles quoted fields properly
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');

            for (let line of lines) {
                if (!line.trim()) continue;

                const row = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            // Escaped quote
                            current += '"';
                            i++; // Skip next quote
                        } else {
                            // Toggle quote state
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // End of field
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }

                // Add the last field
                row.push(current.trim());
                rows.push(row);
            }

            return rows;
        }

        // Helper function to parse a single CSV line
        function parseCSVLine(line) {
            const row = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    row.push(current.trim().replace(/^"|"$/g, '')); // Remove surrounding quotes
                    current = '';
                } else {
                    current += char;
                }
            }

            // Add the last field
            row.push(current.trim().replace(/^"|"$/g, ''));
            return row;
        }

        async function processBulkUpload() {
            console.log('üöÄ Starting bulk upload process with REAL uploaded file data...');

            if (!window.uploadFileData) {
                console.error('‚ùå No upload file data available');
                showNotification('No file data available', 'error');
                return;
            }

            // Prevent multiple simultaneous uploads
            if (window.uploadInProgress) {
                console.log('‚ö†Ô∏è Upload already in progress, ignoring request');
                return;
            }

            window.uploadInProgress = true;

            try {
                const { headers, lines } = window.uploadFileData;
                console.log('üìä PROCESSING REAL UPLOADED FILE DATA:');
                console.log('   üìã Headers found:', headers);
                console.log('   üìÑ Total data lines:', lines.length);
                console.log('   üîç First 3 lines of YOUR uploaded file:');
                lines.slice(0, 3).forEach((line, i) => {
                    console.log(`      Line ${i + 1}: ${line}`);
                });

                // Validate data size
                if (lines.length > 100) {
                    if (!confirm(`You are about to upload ${lines.length} vehicles. This may take a while. Continue?`)) {
                        window.uploadInProgress = false;
                        return;
                    }
                }

                const regIndex = headers.findIndex(h =>
                    h.includes('registration') || h.includes('reg') || h === 'vehicle'
                );
                const nameIndex = headers.findIndex(h =>
                    h.includes('name') || h.includes('customer')
                );
                const mobileIndex = headers.findIndex(h =>
                    h.includes('mobile') || h.includes('phone') || h.includes('tel')
                );
                // Also look for additional mobile columns
                const mobileIndex2 = headers.findIndex((h, i) =>
                    i !== mobileIndex && (h.includes('mobile') || h.includes('phone') || h.includes('tel'))
                );
                const makeIndex = headers.findIndex(h =>
                    h.includes('make') || h === 'make'
                );

                console.log('üéØ Column indices:', { regIndex, nameIndex, mobileIndex, mobileIndex2, makeIndex });
                console.log('üîç Registration column found at index:', regIndex, '- header:', headers[regIndex]);
                console.log('üë§ Customer column found at index:', nameIndex, '- header:', nameIndex >= 0 ? headers[nameIndex] : 'NOT FOUND');
                console.log('üì± Mobile column found at index:', mobileIndex, '- header:', mobileIndex >= 0 ? headers[mobileIndex] : 'NOT FOUND');
                console.log('üì± Mobile column 2 found at index:', mobileIndex2, '- header:', mobileIndex2 >= 0 ? headers[mobileIndex2] : 'NOT FOUND');

                if (regIndex === -1) {
                    console.error('No registration column found');
                    showNotification('No registration column found in CSV', 'error');
                    window.uploadInProgress = false;
                    return;
                }

                let processed = 0;
                let skipped = 0;
                const totalLines = lines.length;

                // Show progress indicator
                document.getElementById('upload-progress').style.display = 'block';
                document.getElementById('upload-btn').disabled = true;
                document.getElementById('cancel-upload-btn').disabled = true;

                showNotification('Processing bulk upload with DVSA API...', 'info');

                // Process each line using the backend API
                for (let index = 0; index < lines.length; index++) {
                    try {
                        const line = lines[index];
                        console.log(`\nüìù Processing YOUR uploaded data - Line ${index + 1}/${totalLines}:`);
                        console.log(`   Raw line: ${line}`);

                        if (!line || line.trim() === '') {
                            console.log('‚ö†Ô∏è Empty line, skipping');
                            skipped++;
                            continue;
                        }

                        // Parse the CSV line properly
                        const cells = parseCSVLine(line);
                        console.log(`   üìä Parsed into ${cells.length} cells:`, cells);

                        const registration = cells[regIndex]?.toUpperCase().trim().replace(/\s+/g, '');
                        console.log(`   üöó Extracted registration from column ${regIndex} (${headers[regIndex]}): "${registration}"`);

                        if (!registration || registration === '') {
                            console.log('‚ùå No registration found in this line, skipping');
                            skipped++;
                            continue;
                        }

                        // Parse customer information
                        let customerName = '';
                        let mobileNumber = '';

                        if (nameIndex >= 0 && cells[nameIndex]) {
                            const customerField = cells[nameIndex];
                            console.log(`   üë§ Customer field from column ${nameIndex} (${headers[nameIndex]}): "${customerField}"`);

                            // Check if this looks like a complex customer field (contains 't:' or 'm:')
                            if (customerField.includes('t:') || customerField.includes('m:')) {
                                // Use the complex parser for fields like "Mr Gary Liss t: m: 07804391204 e: maps.liss@gmail.com"
                                const customerInfo = parseCustomerField(customerField);
                                customerName = customerInfo.name;
                                mobileNumber = customerInfo.mobile;
                            } else {
                                // Simple customer name - just clean it up
                                customerName = customerField.trim();
                                // Remove titles and clean up
                                customerName = customerName.replace(/^(Mr|Mrs|Ms|Miss|Dr|Lady)\s+/i, '');
                                customerName = customerName.replace(/^["']|["']$/g, ''); // Remove quotes
                            }
                            console.log(`   üìã Parsed customer info: name="${customerName}", mobile="${mobileNumber}"`);
                        }

                        // Try to get mobile number from various columns
                        if (!mobileNumber && mobileIndex >= 0) {
                            const mobileField = cells[mobileIndex] || '';
                            console.log(`   üì± Mobile field from column ${mobileIndex} (${headers[mobileIndex]}): "${mobileField}"`);
                            // Clean and validate mobile number
                            const cleanMobile = cleanMobileNumber(mobileField);
                            if (cleanMobile) {
                                mobileNumber = cleanMobile;
                            }
                        }

                        // Try second mobile column if first didn't work
                        if (!mobileNumber && mobileIndex2 >= 0) {
                            const mobileField2 = cells[mobileIndex2] || '';
                            console.log(`   üì± Mobile field 2 from column ${mobileIndex2} (${headers[mobileIndex2]}): "${mobileField2}"`);
                            const cleanMobile = cleanMobileNumber(mobileField2);
                            if (cleanMobile) {
                                mobileNumber = cleanMobile;
                            }
                        }

                        // Prepare data for API call
                        const vehicleData = {
                            registration: registration,
                            customer_name: customerName,
                            mobile_number: mobileNumber,
                            upload_batch_id: `bulk_${Date.now()}`
                        };

                        console.log(`   üöÄ Sending to DVSA API:`, vehicleData);

                        // Use the backend API to add the vehicle (handles DVSA API and failed registrations automatically)
                        const response = await fetch(`${API_BASE_URL}/mot/vehicles`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(vehicleData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                processed++;
                                console.log(`‚úÖ Successfully processed ${registration}`);
                            } else {
                                skipped++;
                                console.log(`‚ùå Failed ${registration}: ${result.error}`);
                            }
                        } else {
                            skipped++;
                            console.log(`üí• API error for ${registration}`);
                        }

                        // Update progress
                        const progressPercent = Math.round(((index + 1) / totalLines) * 100);
                        document.getElementById('progress-bar').style.width = progressPercent + '%';
                        document.getElementById('progress-text').textContent = `Processing ${index + 1} of ${totalLines} (${processed} added, ${skipped} failed)`;

                        // Small delay to prevent overwhelming
                        if (index % 5 === 0 && index > 0) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }

                    } catch (lineError) {
                        console.error(`Error processing line ${index + 1}:`, lineError);
                        skipped++;
                    }
                }

                // Reload data to show results
                await loadMOTReminders();
                updateFailedRegistrationsCount();

                // Hide progress and close modal
                document.getElementById('upload-progress').style.display = 'none';
                document.getElementById('upload-btn').disabled = false;
                document.getElementById('cancel-upload-btn').disabled = false;

                window.uploadInProgress = false;
                closeBulkUploadModal();

                if (processed > 0 && skipped > 0) {
                    showNotification(`Upload complete: ${processed} vehicles added, ${skipped} failed (available for manual review)`, 'warning');
                } else if (processed > 0) {
                    showNotification(`Upload complete: ${processed} vehicles added successfully`, 'success');
                } else {
                    showNotification(`No vehicles added - all ${skipped} registrations failed (check manual review)`, 'error');
                }

            } catch (error) {
                console.error('Error in bulk upload process:', error);

                // Hide progress and re-enable buttons
                document.getElementById('upload-progress').style.display = 'none';
                document.getElementById('upload-btn').disabled = false;
                document.getElementById('cancel-upload-btn').disabled = false;

                window.uploadInProgress = false;
                showNotification('Error during bulk upload: ' + error.message, 'error');
            }
        }

        function downloadTemplate(format) {
            if (format === 'csv') {
                // Create CSV content matching your format with real UK registrations
                const csvContent = `type,work due,print due,email due,sms due,registration,make,customer,last invoiced
MOT,22/06/2025,Due Now,-,-,AB12CDE,Vauxhall Astra,"Mr John Smith t: m: 07123456789 e: john@example.com",10/06/2024
MOT,23/06/2025,Due Now,-,Due Now,EJ13UYV,Toyota Yaris,"Mrs Sarah Johnson t: m: 07987654321 e: sarah@example.com",05/12/2024
MOT,24/06/2025,Due Now,-,Due Now,L15AJR,Ford Focus,"Mr Mike Wilson t: m: 07555123456 e: mike@example.com",28/11/2024
MOT,25/06/2025,Due Now,-,-,MT03HHE,Fiat Punto,"Ms Emma Davis t: m: 07777888999 e: emma@example.com",25/06/2024
MOT,26/06/2025,Due Now,-,Due Now,KU53UYG,Renault Clio,"Mr James Brown t: m: 07444555666 e: james@example.com",15/05/2024`;

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mot_vehicles_template.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('CSV template downloaded successfully', 'success');
            } else if (format === 'excel') {
                // For Excel, we'll create a CSV that can be opened in Excel
                const csvContent = `type,work due,print due,email due,sms due,registration,make,customer,last invoiced
MOT,22/06/2025,Due Now,-,-,AB12CDE,Vauxhall Astra,"Mr John Smith t: m: 07123456789 e: john@example.com",10/06/2024
MOT,23/06/2025,Due Now,-,Due Now,EJ13UYV,Toyota Yaris,"Mrs Sarah Johnson t: m: 07987654321 e: sarah@example.com",05/12/2024
MOT,24/06/2025,Due Now,-,Due Now,L15AJR,Ford Focus,"Mr Mike Wilson t: m: 07555123456 e: mike@example.com",28/11/2024
MOT,25/06/2025,Due Now,-,-,MT03HHE,Fiat Punto,"Ms Emma Davis t: m: 07777888999 e: emma@example.com",25/06/2024
MOT,26/06/2025,Due Now,-,Due Now,KU53UYG,Renault Clio,"Mr James Brown t: m: 07444555666 e: james@example.com",15/05/2024`;

                const blob = new Blob([csvContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mot_vehicles_template.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('Excel-compatible template downloaded successfully', 'success');
            }
        }

        // Drag and Drop Functionality
        function initializeDragAndDrop() {
            const dropArea = document.getElementById('file-drop-area');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            dropArea.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                dropArea.classList.add('dragover');
            }

            function unhighlight() {
                dropArea.classList.remove('dragover');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    processUploadFile(files[0]);
                }
            }
        }

        // Confirm and clear all MOT data
        function confirmClearAllData() {
            const vehicleCount = motVehicles.length;
            if (vehicleCount === 0) {
                showNotification('No data to clear', 'info');
                return;
            }

            const message = `Are you sure you want to clear all ${vehicleCount} vehicles from the MOT system?\n\nThis action cannot be undone.`;
            if (confirm(message)) {
                clearAllMOTData();
            }
        }

        // Clear all MOT data function
        function clearAllMOTData() {
            console.log('Clearing all MOT data from localStorage');
            localStorage.removeItem('motVehicles');
            motVehicles = [];
            selectedMOTVehicles = [];
            updateMOTStatistics();
            displayMOTVehicles();
            updateMOTUrgentBadge();
            showNotification('All MOT data cleared successfully', 'success');
        }

        // Clear demo data function (legacy)
        function clearDemoData() {
            const savedVehicles = localStorage.getItem('motVehicles');
            if (savedVehicles) {
                try {
                    const vehicles = JSON.parse(savedVehicles);
                    // Check if this looks like demo data (has specific demo registrations)
                    const demoRegistrations = ['AB12CDE', 'XY98ZYZ', 'MN56JKL', 'PQ34RST', 'UV78WXY', 'CD90EFG', 'GH12IJK', 'LM34NOP', 'QR56STU', 'VW78XYZ'];
                    const hasDemoData = vehicles.some(v => demoRegistrations.includes(v.registration));

                    if (hasDemoData) {
                        console.log('Clearing demo data from localStorage');
                        localStorage.removeItem('motVehicles');
                    }
                } catch (error) {
                    console.log('Error checking demo data, clearing localStorage');
                    localStorage.removeItem('motVehicles');
                }
            }
        }



        // Also ensure data loads when switching to MOT page
        function ensureMOTDataLoaded() {
            console.log('üîÑ Ensuring MOT data is loaded...');

            // Load completion status if not already loaded
            if (completedVehicles.size === 0) {
                loadCompletionStatus();
            }

            // Always try to load MOT reminders when switching to the page
            console.log('Loading MOT reminders for page switch...');
            loadMOTReminders();

            // Load MOT and SMS statistics for the MOT page
            loadMOTDashboardData();
            loadSMSDashboardData();

            // Also load failed registrations count
            updateFailedRegistrationsCount();
        }

        // Failed Registrations Management
        let failedRegistrations = [];

        async function loadFailedRegistrations() {
            try {
                console.log('Loading failed registrations...');

                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations?status=pending`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        failedRegistrations = result.failed_registrations;
                        displayFailedRegistrations();
                        updateFailedRegistrationsCount();
                        console.log(`Loaded ${failedRegistrations.length} failed registrations`);
                    } else {
                        throw new Error(result.error || 'Failed to load failed registrations');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error loading failed registrations:', error);
                showNotification('Error loading failed registrations', 'error');
                failedRegistrations = [];
                displayFailedRegistrations();
            }
        }

        function displayFailedRegistrations() {
            const container = document.getElementById('failed-registrations-list');

            if (failedRegistrations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h4>No Failed Registrations</h4>
                        <p>All registrations have been successfully processed or reviewed.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-narrow">
                                <input type="checkbox" id="select-all-failed" onchange="toggleAllFailedSelection()">
                            </th>
                            <th class="col-medium">Original Registration</th>
                            <th class="col-medium">Customer</th>
                            <th class="col-medium">Mobile</th>
                            <th class="col-wide">Error Message</th>
                            <th class="col-medium">Corrected Registration</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            failedRegistrations.forEach(failed => {
                html += `
                    <tr>
                        <td>
                            <input type="checkbox" class="failed-checkbox" value="${failed.id}">
                        </td>
                        <td>
                            <strong>${failed.original_registration}</strong>
                        </td>
                        <td>${failed.customer_name || '-'}</td>
                        <td>${failed.mobile_number || '-'}</td>
                        <td>
                            <small style="color: #dc3545;">${failed.error_message}</small>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm"
                                   id="corrected-${failed.id}"
                                   value="${failed.original_registration}"
                                   placeholder="Enter corrected registration"
                                   style="min-width: 150px;">
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.25rem;">
                                <button class="btn btn-sm btn-success"
                                        onclick="retryFailedRegistration(${failed.id})"
                                        title="Retry with corrected registration">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary"
                                        onclick="dismissFailedRegistration(${failed.id})"
                                        title="Dismiss this registration">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        async function retryFailedRegistration(failedId) {
            const correctedInput = document.getElementById(`corrected-${failedId}`);
            const correctedRegistration = correctedInput.value.trim().toUpperCase();

            if (!correctedRegistration) {
                showNotification('Please enter a corrected registration', 'error');
                return;
            }

            try {
                showNotification('Retrying with corrected registration...', 'info');

                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations/${failedId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        corrected_registration: correctedRegistration,
                        action: 'retry'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification(result.message || 'Registration corrected successfully', 'success');
                        await loadFailedRegistrations(); // Refresh the list
                        await loadMOTReminders(); // Refresh main MOT list
                    } else {
                        showNotification(result.error || 'Failed to retry registration', 'error');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error retrying failed registration:', error);
                showNotification('Error retrying registration', 'error');
            }
        }

        async function dismissFailedRegistration(failedId) {
            if (!confirm('Are you sure you want to dismiss this failed registration? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations/${failedId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'dismiss'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Registration dismissed', 'success');
                        await loadFailedRegistrations(); // Refresh the list
                    } else {
                        showNotification(result.error || 'Failed to dismiss registration', 'error');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error dismissing failed registration:', error);
                showNotification('Error dismissing registration', 'error');
            }
        }

        function toggleAllFailedSelection() {
            const selectAll = document.getElementById('select-all-failed');
            const checkboxes = document.querySelectorAll('.failed-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        async function bulkProcessSelected() {
            const selectedCheckboxes = document.querySelectorAll('.failed-checkbox:checked');

            if (selectedCheckboxes.length === 0) {
                showNotification('Please select registrations to process', 'error');
                return;
            }

            const updates = [];
            for (const checkbox of selectedCheckboxes) {
                const failedId = parseInt(checkbox.value);
                const correctedInput = document.getElementById(`corrected-${failedId}`);
                const correctedRegistration = correctedInput.value.trim().toUpperCase();

                if (correctedRegistration) {
                    updates.push({
                        id: failedId,
                        corrected_registration: correctedRegistration,
                        action: 'retry'
                    });
                }
            }

            if (updates.length === 0) {
                showNotification('Please enter corrected registrations for selected items', 'error');
                return;
            }

            try {
                showNotification(`Processing ${updates.length} registrations...`, 'info');

                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ updates })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`Processed ${result.successful} of ${result.total_processed} registrations`, 'success');
                        await loadFailedRegistrations(); // Refresh the list
                        await loadMOTReminders(); // Refresh main MOT list
                    } else {
                        showNotification('Bulk processing failed', 'error');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error bulk processing failed registrations:', error);
                showNotification('Error processing registrations', 'error');
            }
        }

        async function updateFailedRegistrationsCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/mot/failed-registrations?status=pending`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const count = result.failed_registrations.length;
                        const badge = document.getElementById('failed-count');
                        const button = document.getElementById('failed-regs-button');

                        if (badge) {
                            badge.textContent = count;
                        }

                        if (button) {
                            if (count > 0) {
                                button.style.display = 'inline-flex';
                            } else {
                                button.style.display = 'none';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating failed registrations count:', error);
            }
        }

        function showFailedRegistrationsModal() {
            loadFailedRegistrations();
            document.getElementById('failed-registrations-modal').classList.add('active');
        }

        function closeFailedRegistrationsModal() {
            document.getElementById('failed-registrations-modal').classList.remove('active');
        }

        // Real-time Correction During Upload
        let currentUploadState = {
            lines: [],
            currentIndex: 0,
            processed: 0,
            skipped: 0,
            correctionPending: false,
            currentLine: null,
            regIndex: -1,
            nameIndex: -1,
            mobileIndex: -1
        };

        function showRealtimeCorrection(originalReg, customerName, mobile, currentIndex, totalCount) {
            currentUploadState.correctionPending = true;

            document.getElementById('failed-original-reg').textContent = originalReg;
            document.getElementById('correction-input').value = originalReg;
            document.getElementById('failed-customer-info').textContent = customerName ? `${customerName}${mobile ? ` (${mobile})` : ''}` : 'No customer info';
            document.getElementById('current-processing-index').textContent = currentIndex + 1;
            document.getElementById('total-processing-count').textContent = totalCount;

            document.getElementById('realtime-correction').style.display = 'block';
            document.getElementById('correction-input').focus();
            document.getElementById('correction-input').select();

            // Enable Enter key to apply correction
            document.getElementById('correction-input').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    applyCorrectionAndContinue();
                }
            };
        }

        function hideRealtimeCorrection() {
            document.getElementById('realtime-correction').style.display = 'none';
            currentUploadState.correctionPending = false;
        }

        async function applyCorrectionAndContinue() {
            const correctedReg = document.getElementById('correction-input').value.trim().toUpperCase();

            if (!correctedReg) {
                showNotification('Please enter a corrected registration', 'error');
                return;
            }

            try {
                document.getElementById('correct-btn').disabled = true;
                document.getElementById('correct-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';

                // Try to add the corrected registration
                const line = currentUploadState.currentLine;
                const customerName = currentUploadState.nameIndex >= 0 ? line[currentUploadState.nameIndex] : '';
                const mobileNumber = currentUploadState.mobileIndex >= 0 ? line[currentUploadState.mobileIndex] : '';

                const response = await fetch(`${API_BASE_URL}/mot/vehicles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        registration: correctedReg,
                        customer_name: customerName,
                        mobile_number: mobileNumber
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentUploadState.processed++;
                        showNotification(`‚úÖ Corrected: ${correctedReg} added successfully`, 'success');
                        hideRealtimeCorrection();
                        continueUploadProcessing();
                        return;
                    } else {
                        showNotification(`‚ùå Correction failed: ${result.error}`, 'error');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error applying correction:', error);
                showNotification('Error applying correction', 'error');
            } finally {
                document.getElementById('correct-btn').disabled = false;
                document.getElementById('correct-btn').innerHTML = '<i class="fas fa-check"></i> Correct & Continue';
            }
        }

        function skipAndContinue() {
            currentUploadState.skipped++;
            hideRealtimeCorrection();
            continueUploadProcessing();
        }

        function cancelUpload() {
            hideRealtimeCorrection();
            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-btn').disabled = false;
            document.getElementById('cancel-upload-btn').disabled = false;
            window.uploadInProgress = false;
            showNotification('Upload cancelled', 'warning');
        }

        function continueUploadProcessing() {
            // Continue with the next registration in the upload
            currentUploadState.currentIndex++;
            processNextUploadLine();
        }

        async function processNextUploadLine() {
            const { lines, currentIndex, regIndex, nameIndex, mobileIndex } = currentUploadState;

            if (currentIndex >= lines.length) {
                // Upload complete
                completeUpload();
                return;
            }

            const line = lines[currentIndex];
            const registration = line[regIndex];

            if (!registration || registration.trim() === '') {
                currentUploadState.currentIndex++;
                processNextUploadLine();
                return;
            }

            const cleanReg = registration.trim().toUpperCase().replace(/\s+/g, '');
            const customerName = nameIndex >= 0 ? line[nameIndex] : '';
            const mobileNumber = mobileIndex >= 0 ? line[mobileIndex] : '';

            // Update progress
            const progress = ((currentIndex + 1) / lines.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `Processing ${currentIndex + 1} of ${lines.length}: ${cleanReg}`;

            try {
                // Try to add the vehicle
                const response = await fetch(`${API_BASE_URL}/mot/vehicles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        registration: cleanReg,
                        customer_name: customerName,
                        mobile_number: mobileNumber
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentUploadState.processed++;
                        currentUploadState.currentIndex++;
                        processNextUploadLine();
                    } else {
                        // Registration failed - show correction interface
                        currentUploadState.currentLine = line;
                        showRealtimeCorrection(cleanReg, customerName, mobileNumber, currentIndex, lines.length);
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error processing registration:', error);
                currentUploadState.currentLine = line;
                showRealtimeCorrection(cleanReg, customerName, mobileNumber, currentIndex, lines.length);
            }
        }

        function completeUpload() {
            const { processed, skipped } = currentUploadState;

            // Reload data
            loadMOTReminders();
            updateFailedRegistrationsCount();

            // Hide progress and close modal
            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-btn').disabled = false;
            document.getElementById('cancel-upload-btn').disabled = false;

            window.uploadInProgress = false;
            closeBulkUploadModal();

            if (processed > 0 && skipped > 0) {
                showNotification(`Upload complete: ${processed} vehicles added, ${skipped} skipped`, 'warning');
            } else if (processed > 0) {
                showNotification(`Upload complete: ${processed} vehicles added successfully`, 'success');
            } else {
                showNotification('No vehicles were added', 'warning');
            }

            // Reset upload state
            currentUploadState = {
                lines: [],
                currentIndex: 0,
                processed: 0,
                skipped: 0,
                correctionPending: false,
                currentLine: null,
                regIndex: -1,
                nameIndex: -1,
                mobileIndex: -1
            };
        }

        // Settings Page Functions
        let currentSettingsSection = null;
        let settingsData = {};

        // Toggle Settings Section (Icon-based)
        function toggleSettingsSection(sectionId) {
            const allCards = document.querySelectorAll('.settings-icon-card');
            const allContents = document.querySelectorAll('.settings-content');
            const clickedCard = document.querySelector(`[onclick="toggleSettingsSection('${sectionId}')"]`);
            const sectionContent = document.getElementById(sectionId);

            // If clicking the same section, close it
            if (currentSettingsSection === sectionId) {
                // Close current section
                allCards.forEach(card => card.classList.remove('active'));
                allContents.forEach(content => content.classList.remove('active'));
                currentSettingsSection = null;
                console.log('Settings section closed:', sectionId);
                return;
            }

            // Close all sections
            allCards.forEach(card => card.classList.remove('active'));
            allContents.forEach(content => content.classList.remove('active'));

            // Open selected section
            if (clickedCard && sectionContent) {
                clickedCard.classList.add('active');
                sectionContent.classList.add('active');
                currentSettingsSection = sectionId;
                console.log('Settings section opened:', sectionId);

                // Load section-specific data
                loadSettingsSectionData(sectionId);
            }
        }

        // Load data for specific settings section
        function loadSettingsSectionData(sectionId) {
            switch (sectionId) {
                case 'data-upload':
                    loadDatabaseStats();
                    break;
                case 'backup-restore':
                    loadBackupInfo();
                    break;
                default:
                    // Load general settings data
                    if (!settingsData || Object.keys(settingsData).length === 0) {
                        loadSettings();
                    }
                    break;
            }
        }

        // Legacy function for compatibility
        function showSettingsTab(tabId) {
            toggleSettingsSection(tabId);
        }

        // Load database statistics
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/upload/status');
                const result = await response.json();

                if (result.success) {
                    const counts = result.counts;
                    document.getElementById('db-customers-count').textContent = counts.customers || 0;
                    document.getElementById('db-vehicles-count').textContent = counts.vehicles || 0;
                    document.getElementById('db-jobs-count').textContent = counts.jobs || 0;
                    document.getElementById('db-invoices-count').textContent = counts.invoices || 0;
                }
            } catch (error) {
                console.error('Failed to load database stats:', error);
            }
        }

        // Load backup information
        function loadBackupInfo() {
            // This would load backup history and status
            console.log('Loading backup information...');
        }

        // Download all CSV templates
        function downloadAllTemplates() {
            const tables = ['customers', 'vehicles', 'jobs', 'invoices', 'parts', 'suppliers', 'expenses'];
            tables.forEach(table => {
                const link = document.createElement('a');
                link.href = `/upload/templates/${table}`;
                link.download = `${table}_template.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // Create full backup
        function createFullBackup() {
            if (confirm('Create a full database backup? This may take a few moments.')) {
                // Implementation would go here
                alert('Backup functionality will be implemented in the next update.');
            }
        }

        // Create MOT backup
        function createMOTBackup() {
            if (confirm('Create a backup of MOT reminder data only?')) {
                // Implementation would go here
                alert('MOT backup functionality will be implemented in the next update.');
            }
        }

        // Export all data
        function exportAllData(format) {
            if (confirm(`Export all data as ${format.toUpperCase()}? This may take a few moments.`)) {
                // Implementation would go here
                alert(`${format.toUpperCase()} export functionality will be implemented in the next update.`);
            }
        }

        // Restore from file
        function restoreFromFile(event) {
            const file = event.target.files[0];
            if (file) {
                if (confirm('‚ö†Ô∏è WARNING: This will replace ALL current data. Are you sure you want to continue?')) {
                    // Implementation would go here
                    alert('Restore functionality will be implemented in the next update.');
                }
            }
        }

        // Optimize database
        function optimizeDatabase() {
            if (confirm('Optimize the database? This may improve performance.')) {
                // Implementation would go here
                alert('Database optimization functionality will be implemented in the next update.');
            }
        }

        // Clear temporary data
        function clearTempData() {
            if (confirm('Clear temporary data and cache? This is safe and may free up space.')) {
                // Clear localStorage cache
                localStorage.removeItem('motRemindersCache');
                localStorage.removeItem('customersCache');
                localStorage.removeItem('vehiclesCache');
                alert('Temporary data cleared successfully.');
            }
        }

        // Load Settings from localStorage
        function loadSettings() {
            try {
                const saved = localStorage.getItem('garageSettings');
                if (saved) {
                    settingsData = JSON.parse(saved);
                    populateSettingsForm();
                } else {
                    // Set default values
                    setDefaultSettings();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                setDefaultSettings();
            }
        }

        // Set Default Settings
        function setDefaultSettings() {
            settingsData = {
                // DVLA API Settings
                dvlaClientId: '2b3911f4-55f5-4a86-a9f0-0fc02c2bff0f',
                dvlaTokenUrl: 'https://login.microsoftonline.com/a455b827-244f-4c97-b5b4-ce5d13b4d00c/oauth2/v2.0/token',

                // SMS Settings
                smsProvider: 'twilio',
                smsSenderId: '',
                smsTemplate: 'Hi {customer_name}, your vehicle {registration} MOT expires on {expiry_date}. Please contact us to book your MOT test.',

                // Notification Settings
                reminderPrimary: 30,
                reminderFollowup: 14,
                reminderFinal: 7,

                // System Settings
                dateFormat: 'DD-MM-YYYY',
                timeFormat: '24h',
                tableDensity: 'normal',
                pageSize: 25,
                uiTheme: 'light',
                showTooltips: true,
                autoSave: true,
                desktopNotifications: true,
                soundNotifications: false,
                notificationDuration: 5000,

                // Garage Information
                garageName: '',
                businessReg: '',
                garageAddress: '',
                garagePhone: '',
                garageMobile: '',
                garageEmail: '',
                garageWebsite: '',

                // Operating Hours
                operatingHours: {
                    monday: { open: '08:00', close: '17:00', closed: false },
                    tuesday: { open: '08:00', close: '17:00', closed: false },
                    wednesday: { open: '08:00', close: '17:00', closed: false },
                    thursday: { open: '08:00', close: '17:00', closed: false },
                    friday: { open: '08:00', close: '17:00', closed: false },
                    saturday: { open: '08:00', close: '13:00', closed: false },
                    sunday: { open: '10:00', close: '16:00', closed: true }
                },

                // User Settings
                userName: '',
                userEmail: '',
                userTitle: '',
                userPhone: '',
                twoFactorAuth: false,
                sessionTimeout: true,
                userLanguage: 'en',
                userTimezone: 'Europe/London',
                emailNotifications: true,
                marketingEmails: false
            };

            populateSettingsForm();
        }

        // Populate Settings Form
        function populateSettingsForm() {
            // DVLA API Settings
            document.getElementById('dvla-client-id').value = settingsData.dvlaClientId || '';
            document.getElementById('dvla-token-url').value = settingsData.dvlaTokenUrl || '';

            // SMS Settings
            document.getElementById('sms-provider').value = settingsData.smsProvider || 'twilio';
            document.getElementById('sms-sender-id').value = settingsData.smsSenderId || '';
            document.getElementById('sms-template').value = settingsData.smsTemplate || '';

            // Notification Settings
            document.getElementById('reminder-primary').value = settingsData.reminderPrimary || 30;
            document.getElementById('reminder-followup').value = settingsData.reminderFollowup || 14;
            document.getElementById('reminder-final').value = settingsData.reminderFinal || 7;

            // System Settings
            document.getElementById('date-format').value = settingsData.dateFormat || 'DD-MM-YYYY';
            document.getElementById('time-format').value = settingsData.timeFormat || '24h';
            document.getElementById('table-density').value = settingsData.tableDensity || 'normal';
            document.getElementById('page-size').value = settingsData.pageSize || 25;
            document.getElementById('ui-theme').value = settingsData.uiTheme || 'light';
            document.getElementById('show-tooltips').checked = settingsData.showTooltips !== false;
            document.getElementById('auto-save').checked = settingsData.autoSave !== false;
            document.getElementById('desktop-notifications').checked = settingsData.desktopNotifications !== false;
            document.getElementById('sound-notifications').checked = settingsData.soundNotifications === true;
            document.getElementById('notification-duration').value = settingsData.notificationDuration || 5000;

            // Garage Information
            document.getElementById('garage-name').value = settingsData.garageName || '';
            document.getElementById('business-reg').value = settingsData.businessReg || '';
            document.getElementById('garage-address').value = settingsData.garageAddress || '';
            document.getElementById('garage-phone').value = settingsData.garagePhone || '';
            document.getElementById('garage-mobile').value = settingsData.garageMobile || '';
            document.getElementById('garage-email').value = settingsData.garageEmail || '';
            document.getElementById('garage-website').value = settingsData.garageWebsite || '';

            // Operating Hours
            if (settingsData.operatingHours) {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                const dayAbbr = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

                days.forEach((day, index) => {
                    const abbr = dayAbbr[index];
                    const hours = settingsData.operatingHours[day];
                    if (hours) {
                        document.getElementById(`${abbr}-open`).value = hours.open || '08:00';
                        document.getElementById(`${abbr}-close`).value = hours.close || '17:00';
                        document.getElementById(`${abbr}-closed`).checked = hours.closed === true;
                    }
                });
            }

            // User Settings
            document.getElementById('user-name').value = settingsData.userName || '';
            document.getElementById('user-email').value = settingsData.userEmail || '';
            document.getElementById('user-title').value = settingsData.userTitle || '';
            document.getElementById('user-phone').value = settingsData.userPhone || '';
            document.getElementById('two-factor-auth').checked = settingsData.twoFactorAuth === true;
            document.getElementById('session-timeout').checked = settingsData.sessionTimeout !== false;
            document.getElementById('user-language').value = settingsData.userLanguage || 'en';
            document.getElementById('user-timezone').value = settingsData.userTimezone || 'Europe/London';
            document.getElementById('email-notifications').checked = settingsData.emailNotifications !== false;
            document.getElementById('marketing-emails').checked = settingsData.marketingEmails === true;
        }

        // Save All Settings
        function saveAllSettings() {
            try {
                // Collect all form data
                settingsData = {
                    // DVLA API Settings
                    dvlaClientId: document.getElementById('dvla-client-id').value,
                    dvlaTokenUrl: document.getElementById('dvla-token-url').value,

                    // SMS Settings
                    smsProvider: document.getElementById('sms-provider').value,
                    smsSenderId: document.getElementById('sms-sender-id').value,
                    smsTemplate: document.getElementById('sms-template').value,

                    // Notification Settings
                    reminderPrimary: parseInt(document.getElementById('reminder-primary').value),
                    reminderFollowup: parseInt(document.getElementById('reminder-followup').value),
                    reminderFinal: parseInt(document.getElementById('reminder-final').value),

                    // System Settings
                    dateFormat: document.getElementById('date-format').value,
                    timeFormat: document.getElementById('time-format').value,
                    tableDensity: document.getElementById('table-density').value,
                    pageSize: parseInt(document.getElementById('page-size').value),
                    uiTheme: document.getElementById('ui-theme').value,
                    showTooltips: document.getElementById('show-tooltips').checked,
                    autoSave: document.getElementById('auto-save').checked,
                    desktopNotifications: document.getElementById('desktop-notifications').checked,
                    soundNotifications: document.getElementById('sound-notifications').checked,
                    notificationDuration: parseInt(document.getElementById('notification-duration').value),

                    // Garage Information
                    garageName: document.getElementById('garage-name').value,
                    businessReg: document.getElementById('business-reg').value,
                    garageAddress: document.getElementById('garage-address').value,
                    garagePhone: document.getElementById('garage-phone').value,
                    garageMobile: document.getElementById('garage-mobile').value,
                    garageEmail: document.getElementById('garage-email').value,
                    garageWebsite: document.getElementById('garage-website').value,

                    // Operating Hours
                    operatingHours: {
                        monday: {
                            open: document.getElementById('mon-open').value,
                            close: document.getElementById('mon-close').value,
                            closed: document.getElementById('mon-closed').checked
                        },
                        tuesday: {
                            open: document.getElementById('tue-open').value,
                            close: document.getElementById('tue-close').value,
                            closed: document.getElementById('tue-closed').checked
                        },
                        wednesday: {
                            open: document.getElementById('wed-open').value,
                            close: document.getElementById('wed-close').value,
                            closed: document.getElementById('wed-closed').checked
                        },
                        thursday: {
                            open: document.getElementById('thu-open').value,
                            close: document.getElementById('thu-close').value,
                            closed: document.getElementById('thu-closed').checked
                        },
                        friday: {
                            open: document.getElementById('fri-open').value,
                            close: document.getElementById('fri-close').value,
                            closed: document.getElementById('fri-closed').checked
                        },
                        saturday: {
                            open: document.getElementById('sat-open').value,
                            close: document.getElementById('sat-close').value,
                            closed: document.getElementById('sat-closed').checked
                        },
                        sunday: {
                            open: document.getElementById('sun-open').value,
                            close: document.getElementById('sun-close').value,
                            closed: document.getElementById('sun-closed').checked
                        }
                    },

                    // User Settings
                    userName: document.getElementById('user-name').value,
                    userEmail: document.getElementById('user-email').value,
                    userTitle: document.getElementById('user-title').value,
                    userPhone: document.getElementById('user-phone').value,
                    twoFactorAuth: document.getElementById('two-factor-auth').checked,
                    sessionTimeout: document.getElementById('session-timeout').checked,
                    userLanguage: document.getElementById('user-language').value,
                    userTimezone: document.getElementById('user-timezone').value,
                    emailNotifications: document.getElementById('email-notifications').checked,
                    marketingEmails: document.getElementById('marketing-emails').checked
                };

                // Save to localStorage
                localStorage.setItem('garageSettings', JSON.stringify(settingsData));

                // Apply settings immediately
                applySettings();

                showNotification('Settings saved successfully!', 'success');

            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Error saving settings. Please try again.', 'error');
            }
        }

        // Reset All Settings
        function resetAllSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
                localStorage.removeItem('garageSettings');
                setDefaultSettings();
                showNotification('Settings reset to defaults', 'info');
            }
        }

        // Apply Settings
        function applySettings() {
            // Apply date format
            if (settingsData.dateFormat) {
                // This would be used throughout the application
                console.log('Applied date format:', settingsData.dateFormat);
            }

            // Apply theme
            if (settingsData.uiTheme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }

            // Apply table density
            if (settingsData.tableDensity) {
                document.body.className = document.body.className.replace(/table-density-\w+/g, '');
                document.body.classList.add(`table-density-${settingsData.tableDensity}`);
            }
        }

        // Test DVLA Connection
        function testDVLAConnection() {
            const statusElement = document.getElementById('dvla-status');
            const clientId = document.getElementById('dvla-client-id').value;
            const tokenUrl = document.getElementById('dvla-token-url').value;

            if (!clientId || !tokenUrl) {
                statusElement.textContent = 'Please enter both Client ID and Token URL';
                statusElement.className = 'connection-status error';
                return;
            }

            statusElement.textContent = 'Testing connection...';
            statusElement.className = 'connection-status testing';

            // Simulate API test (in real implementation, this would make an actual API call)
            setTimeout(() => {
                if (clientId === '2b3911f4-55f5-4a86-a9f0-0fc02c2bff0f') {
                    statusElement.textContent = 'Connection successful!';
                    statusElement.className = 'connection-status success';
                } else {
                    statusElement.textContent = 'Connection failed - Invalid credentials';
                    statusElement.className = 'connection-status error';
                }
            }, 2000);
        }

        // Export MOT Data
        function exportMOTData(format) {
            if (format === 'csv') {
                // Export as CSV
                const csvData = convertMOTDataToCSV();
                downloadFile(csvData, 'mot-data.csv', 'text/csv');
                showNotification('MOT data exported as CSV', 'success');
            } else if (format === 'json') {
                // Export as JSON
                const jsonData = JSON.stringify(motVehicles, null, 2);
                downloadFile(jsonData, 'mot-data.json', 'application/json');
                showNotification('MOT data exported as JSON', 'success');
            }
        }

        // Import MOT Data
        function importMOTData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedData;

                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(content);
                    } else if (file.name.endsWith('.csv')) {
                        importedData = parseCSVToMOTData(content);
                    }

                    if (importedData && importedData.length > 0) {
                        motVehicles = importedData;
                        displayMOTVehicles();
                        updateMOTStatistics();
                        showNotification(`Imported ${importedData.length} vehicles successfully`, 'success');
                    } else {
                        showNotification('No valid data found in file', 'error');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Error importing data. Please check file format.', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Clear Completion History
        function clearCompletionHistory() {
            if (confirm('Are you sure you want to clear all completion tracking history?')) {
                localStorage.removeItem('motCompletedVehicles');
                completedVehicles.clear();
                displayMOTVehicles();
                updateMOTStatistics();
                showNotification('Completion history cleared', 'info');
            }
        }

        // Export Completion Data
        function exportCompletionData() {
            const completionData = {
                completedVehicles: [...completedVehicles],
                exportDate: new Date().toISOString(),
                totalCompleted: completedVehicles.size
            };

            const jsonData = JSON.stringify(completionData, null, 2);
            downloadFile(jsonData, 'completion-data.json', 'application/json');
            showNotification('Completion data exported', 'success');
        }

        // Create Backup
        function createBackup() {
            const backupData = {
                settings: settingsData,
                motVehicles: motVehicles,
                completedVehicles: [...completedVehicles],
                backupDate: new Date().toISOString(),
                version: '1.0'
            };

            const jsonData = JSON.stringify(backupData, null, 2);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            downloadFile(jsonData, `garage-backup-${timestamp}.json`, 'application/json');
            showNotification('Backup created successfully', 'success');
        }

        // Restore from Backup
        function restoreFromBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);

                        if (confirm('Are you sure you want to restore from backup? This will overwrite all current data.')) {
                            // Restore settings
                            if (backupData.settings) {
                                settingsData = backupData.settings;
                                localStorage.setItem('garageSettings', JSON.stringify(settingsData));
                                populateSettingsForm();
                            }

                            // Restore MOT vehicles
                            if (backupData.motVehicles) {
                                motVehicles = backupData.motVehicles;
                                displayMOTVehicles();
                                updateMOTStatistics();
                            }

                            // Restore completion data
                            if (backupData.completedVehicles) {
                                completedVehicles = new Set(backupData.completedVehicles);
                                saveCompletionStatus();
                            }

                            showNotification('Backup restored successfully', 'success');
                        }
                    } catch (error) {
                        console.error('Restore error:', error);
                        showNotification('Error restoring backup. Please check file format.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Change Password
        function changePassword() {
            // This would open a password change dialog
            showNotification('Password change functionality would be implemented here', 'info');
        }

        // Helper function to download files
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Helper function to convert MOT data to CSV
        function convertMOTDataToCSV() {
            if (!motVehicles || motVehicles.length === 0) {
                return 'No data available';
            }

            const headers = ['Registration', 'Make', 'Model', 'MOT Expiry', 'Days Until Expiry', 'Customer', 'Phone', 'Email'];
            const csvRows = [headers.join(',')];

            motVehicles.forEach(vehicle => {
                const row = [
                    vehicle.registration || '',
                    vehicle.make || '',
                    vehicle.model || '',
                    vehicle.mot_expiry || '',
                    vehicle.days_until_expiry || '',
                    vehicle.customer_name || '',
                    vehicle.customer_phone || '',
                    vehicle.customer_email || ''
                ];
                csvRows.push(row.map(field => `"${field}"`).join(','));
            });

            return csvRows.join('\n');
        }

        // Helper function to parse CSV to MOT data
        function parseCSVToMOTData(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                    const vehicle = {};
                    headers.forEach((header, index) => {
                        vehicle[header.toLowerCase().replace(/\s+/g, '_')] = values[index] || '';
                    });
                    data.push(vehicle);
                }
            }

            return data;
        }

        // Initialize Settings when page loads
        function initializeSettings() {
            try {
                loadSettings();
                applySettings();
                console.log('Settings initialized successfully');
            } catch (error) {
                console.error('Error initializing settings:', error);
                // Set default settings if there's an error
                setDefaultSettings();
            }
        }

        // Test function to verify settings page is working
        function testSettingsPage() {
            console.log('Testing settings page...');

            // Test if settings page exists
            const settingsPage = document.getElementById('settings');
            console.log('Settings page element:', settingsPage ? 'Found' : 'Not found');

            // Test if settings tabs exist
            const settingsTabs = document.querySelectorAll('.settings-tab-btn');
            console.log('Settings tabs found:', settingsTabs.length);

            // Test if settings functions exist
            const functions = ['showPage', 'showSettingsTab', 'loadSettings', 'saveAllSettings'];
            functions.forEach(func => {
                console.log(`Function ${func}:`, typeof window[func] === 'function' ? 'Exists' : 'Missing');
            });

            // Test localStorage
            try {
                localStorage.setItem('test', 'value');
                const retrieved = localStorage.getItem('test');
                console.log('localStorage test:', retrieved === 'value' ? 'Working' : 'Failed');
                localStorage.removeItem('test');
            } catch (e) {
                console.log('localStorage error:', e.message);
            }

            return 'Settings page test completed - check console for details';
        }

        // Make test function available globally for debugging
        window.testSettingsPage = testSettingsPage;

        // Quick settings test function
        window.quickSettingsTest = function() {
            console.log('üß™ Quick Settings Test Starting...');

            // Test 1: Check if settings page exists
            const settingsPage = document.getElementById('settings');
            console.log('1Ô∏è‚É£ Settings page element:', settingsPage ? '‚úÖ Found' : '‚ùå Not found');

            // Test 2: Check if showPage function exists
            console.log('2Ô∏è‚É£ showPage function:', typeof showPage === 'function' ? '‚úÖ Exists' : '‚ùå Missing');

            // Test 3: Check navigation link
            const settingsNav = document.querySelector('a[onclick*="settings"]');
            console.log('3Ô∏è‚É£ Settings navigation:', settingsNav ? '‚úÖ Found' : '‚ùå Not found');

            // Test 4: Try to show settings page
            if (typeof showPage === 'function') {
                console.log('4Ô∏è‚É£ Attempting to show settings page...');
                showPage('settings');

                // Check if it worked
                setTimeout(() => {
                    const isActive = settingsPage && settingsPage.classList.contains('active');
                    console.log('5Ô∏è‚É£ Settings page active:', isActive ? '‚úÖ Yes' : '‚ùå No');

                    if (isActive) {
                        console.log('üéâ Settings page is working correctly!');
                    } else {
                        console.log('‚ùå Settings page failed to activate');
                    }
                }, 200);
            }

            return 'Test completed - check console output above';
        };

        // Force settings navigation function
        window.forceShowSettings = function() {
            console.log('üîß Force showing settings page...');

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show settings page
            const settingsPage = document.getElementById('settings');
            if (settingsPage) {
                settingsPage.classList.add('active');
                console.log('‚úÖ Settings page forced to show');

                // Activate first tab
                const firstTab = document.querySelector('.settings-tab-btn');
                const firstTabContent = document.querySelector('.settings-tab-content');
                if (firstTab) firstTab.classList.add('active');
                if (firstTabContent) firstTabContent.classList.add('active');

                return 'Settings page should now be visible';
            } else {
                console.error('‚ùå Settings page element not found');
                return 'Settings page element not found';
            }
        };

        // SMS History Functions
        function showSMSHistoryModal() {
            document.getElementById('sms-history-modal').classList.add('active');
            loadSMSHistory();
        }

        function closeSMSHistoryModal() {
            document.getElementById('sms-history-modal').classList.remove('active');
        }

        async function loadSMSHistory() {
            const historyList = document.getElementById('sms-history-list');
            const limit = document.getElementById('sms-history-limit').value;

            historyList.innerHTML = `
                <div class="loading" style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    Loading SMS history...
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/mot/sms/history?limit=${limit}`);
                const data = await response.json();

                if (data.success && data.history) {
                    displaySMSHistory(data.history);
                } else {
                    historyList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6c757d;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                            <h4>No SMS History Found</h4>
                            <p>No SMS messages have been sent yet.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading SMS history:', error);
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                        <h4>Error Loading History</h4>
                        <p>Could not load SMS history. Please try again.</p>
                    </div>
                `;
            }
        }

        function displaySMSHistory(history) {
            const historyList = document.getElementById('sms-history-list');

            if (history.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                        <h4>No SMS History</h4>
                        <p>No SMS messages have been sent yet.</p>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = `
                <table class="data-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Registration</th>
                            <th>Customer</th>
                            <th>Mobile</th>
                            <th>Message Type</th>
                            <th>MOT Expiry</th>
                            <th>Days Left</th>
                            <th>Send Status</th>
                            <th>Delivery Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(item => `
                            <tr>
                                <td style="font-size: 0.9rem;">
                                    ${formatDateTime(item.sent_at)}
                                </td>
                                <td>
                                    <strong>${item.registration}</strong>
                                </td>
                                <td>${item.customer_name || '-'}</td>
                                <td>${item.mobile_number || '-'}</td>
                                <td>
                                    <span class="badge ${getMessageTypeBadge(item.message_type)}">${item.message_type.toUpperCase()}</span>
                                </td>
                                <td>${formatDateForDisplay(item.mot_expiry_date)}</td>
                                <td>
                                    <span class="badge ${getDaysLeftBadge(item.days_until_expiry)}">
                                        ${item.days_until_expiry !== null ? item.days_until_expiry + ' days' : '-'}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge ${item.status === 'sent' ? 'bg-success' : 'bg-danger'}">
                                        ${item.status === 'sent' ? 'Sent' : 'Failed'}
                                    </span>
                                </td>
                                <td>
                                    ${getDeliveryStatusBadge(item.delivery_status, item.delivery_error_code)}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function getMessageTypeBadge(messageType) {
            switch (messageType) {
                case 'expired': return 'bg-danger';
                case 'critical': return 'bg-warning';
                case 'due_soon': return 'bg-info';
                case 'reminder': return 'bg-primary';
                default: return 'bg-secondary';
            }
        }

        function getDaysLeftBadge(daysLeft) {
            if (daysLeft === null) return 'bg-secondary';
            if (daysLeft < 0) return 'bg-danger';
            if (daysLeft <= 7) return 'bg-warning';
            if (daysLeft <= 30) return 'bg-info';
            return 'bg-success';
        }

        function getDeliveryStatusBadge(deliveryStatus, errorCode) {
            if (!deliveryStatus) {
                return '<span class="badge bg-secondary" title="Delivery status pending">Pending</span>';
            }

            switch (deliveryStatus.toLowerCase()) {
                case 'delivered':
                    return '<span class="badge bg-success" title="Message delivered successfully"><i class="fas fa-check"></i> Delivered</span>';
                case 'sent':
                    return '<span class="badge bg-info" title="Message sent, delivery pending"><i class="fas fa-paper-plane"></i> Sent</span>';
                case 'queued':
                    return '<span class="badge bg-warning" title="Message queued for delivery"><i class="fas fa-clock"></i> Queued</span>';
                case 'failed':
                case 'undelivered':
                    const errorText = errorCode ? ` (Error: ${errorCode})` : '';
                    return `<span class="badge bg-danger" title="Message delivery failed${errorText}"><i class="fas fa-times"></i> Failed</span>`;
                case 'receiving':
                    return '<span class="badge bg-primary" title="Message being processed"><i class="fas fa-spinner"></i> Processing</span>';
                default:
                    return `<span class="badge bg-secondary" title="Status: ${deliveryStatus}">${deliveryStatus}</span>`;
            }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            try {
                const date = new Date(dateTimeString);
                return date.toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateTimeString;
            }
        }

        function filterSMSHistory() {
            const filter = document.getElementById('sms-history-filter').value.toLowerCase();
            const rows = document.querySelectorAll('#sms-history-list tbody tr');

            rows.forEach(row => {
                const registration = row.cells[1].textContent.toLowerCase();
                const customer = row.cells[2].textContent.toLowerCase();

                if (registration.includes(filter) || customer.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function checkDeliveryStatus() {
            try {
                showNotification('Checking delivery status...', 'info');

                const response = await fetch(`${API_BASE_URL}/mot/sms/check-delivery-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(
                        `Delivery status updated for ${result.updated_count} of ${result.total_checked} messages`,
                        'success'
                    );
                    // Refresh the SMS history to show updated statuses
                    loadSMSHistory();
                } else {
                    showNotification(`Error checking delivery status: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error checking delivery status:', error);
                showNotification('Error checking delivery status', 'error');
            }
        }

        function exportSMSHistory() {
            // This would export the SMS history to CSV
            showNotification('Export functionality coming soon', 'info');
        }

        // Archive Functions
        function toggleArchivedView() {
            showArchivedVehicles = !showArchivedVehicles;
            const toggleBtn = document.getElementById('archive-toggle-btn');
            const toggleText = document.getElementById('archive-toggle-text');

            if (showArchivedVehicles) {
                toggleText.textContent = 'Hide Archived';
                toggleBtn.classList.remove('btn-secondary');
                toggleBtn.classList.add('btn-warning');
            } else {
                toggleText.textContent = 'Show Archived';
                toggleBtn.classList.remove('btn-warning');
                toggleBtn.classList.add('btn-secondary');
            }

            loadMOTReminders();
        }

        async function archiveVehicle(registration) {
            if (!confirm(`Archive vehicle ${registration}?\n\nThis will remove it from the active MOT reminders list.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/mot/vehicles/${registration}/archive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reason: 'Manual archive'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`Vehicle ${registration} archived successfully`, 'success');
                    loadMOTReminders();
                } else {
                    showNotification(`Error archiving vehicle: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error archiving vehicle:', error);
                showNotification('Error archiving vehicle', 'error');
            }
        }

        async function unarchiveVehicle(registration) {
            if (!confirm(`Unarchive vehicle ${registration}?\n\nThis will return it to the active MOT reminders list.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/mot/vehicles/${registration}/unarchive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`Vehicle ${registration} unarchived successfully`, 'success');
                    loadMOTReminders();
                } else {
                    showNotification(`Error unarchiving vehicle: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error unarchiving vehicle:', error);
                showNotification('Error unarchiving vehicle', 'error');
            }
        }

        async function archiveSelectedVehicles() {
            if (selectedMOTVehicles.length === 0) {
                showNotification('No vehicles selected', 'warning');
                return;
            }

            const activeSelected = selectedMOTVehicles.filter(reg => {
                const vehicle = motVehicles.find(v => v.registration === reg);
                return vehicle && !vehicle.is_archived;
            });

            if (activeSelected.length === 0) {
                showNotification('No active vehicles selected for archiving', 'info');
                return;
            }

            if (!confirm(`Archive ${activeSelected.length} selected vehicles?\n\nThis will remove them from the active MOT reminders list.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/mot/vehicles/archive/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        registrations: activeSelected,
                        reason: 'Bulk archive - selected vehicles'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`${result.archived_count} vehicles archived successfully`, 'success');
                    selectedMOTVehicles = [];
                    updateSMSButtonState();
                    loadMOTReminders();
                } else {
                    showNotification(`Error archiving vehicles: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error archiving vehicles:', error);
                showNotification('Error archiving vehicles', 'error');
            }
        }

        // Link Existing Vehicles to Customers
        async function linkExistingVehicles() {
            if (!confirm('Link existing MOT vehicles to customer accounts?\n\nThis will:\n‚Ä¢ Match vehicles to existing customers\n‚Ä¢ Create new customer accounts where needed\n‚Ä¢ Enable customer view buttons\n\nContinue?')) {
                return;
            }

            try {
                showNotification('Linking vehicles to customers...', 'info');

                const response = await fetch('http://127.0.0.1:5001/api/mot/link-existing-vehicles', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    const message = `Customer linking completed!\n\n` +
                        `‚Ä¢ ${result.linked_to_existing} vehicles linked to existing customers\n` +
                        `‚Ä¢ ${result.created_new_customers} new customers created\n` +
                        `‚Ä¢ ${result.total_processed - result.linked_to_existing - result.created_new_customers} vehicles skipped\n\n` +
                        `Customer view buttons are now available for linked vehicles.`;

                    showNotification(message, 'success');

                    // Refresh the MOT list to show customer buttons
                    loadMOTReminders();
                } else {
                    showNotification(`Error linking customers: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Error linking customers:', error);
                showNotification('Error linking customers to vehicles', 'error');
            }
        }

        // Customer Integration Functions
        async function viewCustomerDetails(customerId, registration) {
            try {
                // Get customer information from main database
                const customerResponse = await fetch(`/api/customers/${customerId}`);
                const customerData = await customerResponse.json();

                if (!customerData.customer) {
                    showNotification('Error loading customer details', 'error');
                    return;
                }

                // Get MOT history for this customer
                const motHistoryResponse = await fetch(`http://127.0.0.1:5001/api/mot/customer/history/${customerId}`);
                const motHistoryData = await motHistoryResponse.json();

                // Show customer detail modal with MOT integration
                showCustomerDetailWithMOT(customerData.customer, motHistoryData.vehicles || [], registration);

            } catch (error) {
                console.error('Error loading customer details:', error);
                showNotification('Error loading customer details', 'error');
            }
        }

        function showCustomerDetailWithMOT(customer, motVehicles, highlightRegistration) {
            // Update customer detail modal title
            document.getElementById('customer-detail-title').textContent = `${customer.name} - Customer & MOT Details`;

            // Add MOT tab to existing customer modal
            const tabsHeader = document.querySelector('#customer-detail-modal .tabs-header');
            if (tabsHeader && !document.querySelector('.tab-button[onclick*="mot-history"]')) {
                const motTab = document.createElement('button');
                motTab.className = 'tab-button';
                motTab.onclick = () => showCustomerTab('mot-history');
                motTab.innerHTML = '<i class="fas fa-car"></i> MOT History';
                tabsHeader.appendChild(motTab);
            }

            // Add MOT tab content
            const tabsContainer = document.querySelector('#customer-detail-modal .tabs-container');
            if (tabsContainer && !document.getElementById('customer-tab-mot-history')) {
                const motTabContent = document.createElement('div');
                motTabContent.id = 'customer-tab-mot-history';
                motTabContent.className = 'tab-content';
                motTabContent.innerHTML = generateMOTHistoryContent(motVehicles, highlightRegistration);
                tabsContainer.appendChild(motTabContent);
            }

            // Show the customer detail modal
            document.getElementById('customer-detail-modal').classList.add('active');

            // Load customer data into the modal
            showCustomerDetail(customer.id);

            // If we have a specific registration to highlight, switch to MOT tab
            if (highlightRegistration) {
                setTimeout(() => {
                    showCustomerTab('mot-history');
                }, 100);
            }
        }

        function generateMOTHistoryContent(motVehicles, highlightRegistration) {
            if (!motVehicles || motVehicles.length === 0) {
                return `
                    <div class="empty-state">
                        <i class="fas fa-car" style="font-size: 3rem; color: #dee2e6; margin-bottom: 1rem;"></i>
                        <h4>No MOT Data Found</h4>
                        <p>This customer has no vehicles in the MOT reminder system.</p>
                    </div>
                `;
            }

            return `
                <div class="mot-history-container">
                    <h4 style="margin-bottom: 1.5rem;">
                        <i class="fas fa-car"></i> Vehicle MOT History
                        <span class="badge bg-primary ms-2">${motVehicles.length} Vehicle${motVehicles.length !== 1 ? 's' : ''}</span>
                    </h4>

                    ${motVehicles.map(vehicle => {
                        const isHighlighted = vehicle.registration === highlightRegistration;
                        const motData = vehicle.mot_data;
                        const statusClass = motData ? (motData.is_expired ? 'danger' : motData.days_until_expiry <= 7 ? 'warning' : motData.days_until_expiry <= 30 ? 'info' : 'success') : 'secondary';

                        return `
                            <div class="vehicle-mot-card ${isHighlighted ? 'highlighted' : ''}" style="margin-bottom: 1.5rem; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; ${isHighlighted ? 'border-color: #0d6efd; box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);' : ''}">
                                <div class="vehicle-header" style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                    <div>
                                        <h5 style="margin: 0; color: #0d6efd;">
                                            ${vehicle.registration}
                                            ${isHighlighted ? '<i class="fas fa-star text-warning ms-2" title="Current vehicle"></i>' : ''}
                                        </h5>
                                        <p style="margin: 0; color: #6c757d;">${vehicle.make} ${vehicle.model}</p>
                                    </div>
                                    <div>
                                        ${motData ? `
                                            <span class="badge bg-${statusClass}">
                                                ${motData.is_expired ? 'EXPIRED' : motData.days_until_expiry <= 7 ? 'CRITICAL' : motData.days_until_expiry <= 30 ? 'DUE SOON' : 'VALID'}
                                            </span>
                                        ` : '<span class="badge bg-secondary">NO MOT DATA</span>'}
                                    </div>
                                </div>

                                ${motData ? `
                                    <div class="mot-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                        <div>
                                            <strong>MOT Expiry:</strong><br>
                                            <span style="color: ${motData.is_expired ? '#dc3545' : '#6c757d'};">
                                                ${formatDateForDisplay(motData.mot_expiry_date)}
                                            </span>
                                        </div>
                                        <div>
                                            <strong>Days Until Expiry:</strong><br>
                                            <span style="color: ${motData.is_expired ? '#dc3545' : motData.days_until_expiry <= 7 ? '#fd7e14' : '#6c757d'};">
                                                ${motData.days_until_expiry} days
                                            </span>
                                        </div>
                                        <div>
                                            <strong>Last Test:</strong><br>
                                            <span style="color: #6c757d;">
                                                ${formatDateForDisplay(motData.last_test_date)}
                                            </span>
                                        </div>
                                        <div>
                                            <strong>Test Result:</strong><br>
                                            <span style="color: #6c757d;">
                                                ${motData.test_result || 'Unknown'}
                                            </span>
                                        </div>
                                    </div>
                                ` : ''}

                                ${vehicle.sms_history && vehicle.sms_history.length > 0 ? `
                                    <div class="sms-history">
                                        <h6><i class="fas fa-sms"></i> SMS History</h6>
                                        <div class="sms-timeline">
                                            ${vehicle.sms_history.map(sms => `
                                                <div class="sms-entry" style="padding: 0.5rem; border-left: 3px solid #0d6efd; margin-left: 1rem; margin-bottom: 0.5rem; background: #f8f9fa;">
                                                    <div style="display: flex; justify-content: between; align-items: center;">
                                                        <span style="font-weight: 500;">${sms.message_type}</span>
                                                        <span style="font-size: 0.8rem; color: #6c757d;">
                                                            ${formatDateTime(sms.sent_at)}
                                                        </span>
                                                    </div>
                                                    <div style="font-size: 0.8rem; color: #6c757d;">
                                                        Status: ${sms.status} ${sms.delivery_status ? `| Delivery: ${sms.delivery_status}` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Enhanced Upload Functions
        async function loadUploadStatus() {
            try {
                const response = await fetch('/upload/status');
                const data = await response.json();

                if (data.success) {
                    const counts = data.counts;

                    // Update enhanced stats grid
                    const statsGrid = document.getElementById('mainStatsGrid');
                    if (statsGrid) {
                        statsGrid.innerHTML = Object.entries(counts).map(([table, count]) => `
                            <div class="stat-card">
                                <div class="stat-number">${count.toLocaleString()}</div>
                                <div class="stat-label">${table.charAt(0).toUpperCase() + table.slice(1)}</div>
                            </div>
                        `).join('');
                    }

                    // Update legacy elements if they exist
                    const legacyElements = ['customers-count', 'vehicles-count', 'jobs-count', 'invoices-count', 'parts-count', 'suppliers-count'];
                    legacyElements.forEach(elementId => {
                        const element = document.getElementById(elementId);
                        if (element) {
                            const tableName = elementId.replace('-count', '');
                            element.textContent = counts[tableName] || 0;
                        }
                    });
                } else {
                    console.error('Error loading upload status:', data.error);
                }
            } catch (error) {
                console.error('Error loading upload status:', error);
            }
        }

        // Enhanced upload form functionality
        function initializeEnhancedUpload() {
            const uploadZone = document.getElementById('mainUploadZone');
            const fileInput = document.getElementById('mainFileInput');
            const uploadBtn = document.getElementById('mainUploadBtn');
            const uploadForm = document.getElementById('mainUploadForm');
            const progressContainer = document.getElementById('mainProgressContainer');
            const resultsContainer = document.getElementById('mainResultsContainer');

            if (!uploadZone || !fileInput || !uploadBtn || !uploadForm) {
                return; // Elements not found, skip initialization
            }

            // Drag and drop functionality
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    updateUploadButton();
                }
            });

            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', updateUploadButton);

            function updateUploadButton() {
                uploadBtn.disabled = !fileInput.files.length;

                if (fileInput.files.length > 0) {
                    const fileName = fileInput.files[0].name;
                    uploadZone.querySelector('h4').textContent = `Selected: ${fileName}`;
                }
            }
        }

        function showUploadResults(result) {
            const alertDiv = document.getElementById('mainResultsAlert');
            const detailsDiv = document.getElementById('mainResultsDetails');
            const resultsContainer = document.getElementById('mainResultsContainer');

            if (!alertDiv || !detailsDiv || !resultsContainer) {
                return;
            }

            if (result.success) {
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> Upload completed successfully!
                    <br>Imported: ${result.imported || 0} | Failed: ${result.failed || 0} | Duplicates: ${result.duplicates || 0}
                `;

                if (result.errors && result.errors.length > 0) {
                    detailsDiv.innerHTML = `
                        <h6>Errors encountered:</h6>
                        <ul class="list-unstyled">
                            ${result.errors.map(error => `<li class="text-warning"><i class="fas fa-exclamation-triangle"></i> ${error}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    detailsDiv.innerHTML = '';
                }
            } else {
                alertDiv.className = 'alert alert-danger';
                alertDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${result.error}`;
                detailsDiv.innerHTML = '';
            }

            resultsContainer.style.display = 'block';
        }

        // Enhanced main upload form handler
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize enhanced upload interface
            initializeEnhancedUpload();

            const uploadForm = document.getElementById('mainUploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const fileInput = document.getElementById('mainFileInput');
                    const tableSelect = document.getElementById('mainTableSelect');
                    const clearExisting = document.getElementById('mainClearExisting').checked;
                    const updateDuplicates = document.getElementById('mainUpdateDuplicates').checked;
                    const progressContainer = document.getElementById('mainProgressContainer');
                    const resultsContainer = document.getElementById('mainResultsContainer');
                    const uploadBtn = document.getElementById('mainUploadBtn');

                    if (!fileInput.files[0]) {
                        showNotification('Please select a file to upload', 'error');
                        return;
                    }

                    if (!tableSelect.value) {
                        showNotification('Please select a data type', 'error');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('table_name', tableSelect.value);
                    formData.append('clear_existing', clearExisting);
                    formData.append('update_duplicates', updateDuplicates);

                    try {
                        // Show progress
                        if (progressContainer) progressContainer.style.display = 'block';
                        if (uploadBtn) uploadBtn.disabled = true;
                        if (resultsContainer) resultsContainer.style.display = 'none';

                        const response = await fetch('/upload/csv', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        // Hide progress
                        if (progressContainer) progressContainer.style.display = 'none';
                        if (uploadBtn) uploadBtn.disabled = false;

                        if (result.success) {
                            showNotification(result.message || 'File uploaded successfully!', 'success');
                            showUploadResults(result);

                            // Reset form
                            uploadForm.reset();

                            // Reset upload zone text
                            const uploadZone = document.getElementById('mainUploadZone');
                            if (uploadZone) {
                                uploadZone.querySelector('h4').textContent = 'Drag & Drop your CSV file here';
                            }

                            // Disable upload button
                            if (uploadBtn) uploadBtn.disabled = true;

                            // Refresh status
                            loadUploadStatus();

                            // Refresh relevant data in other pages
                            if (tableSelect.value === 'customers') {
                                loadCustomersFromAPI();
                            } else if (tableSelect.value === 'vehicles') {
                                loadVehiclesFromAPI();
                            } else if (tableSelect.value === 'jobs') {
                                loadJobsFromAPI();
                            } else if (tableSelect.value === 'invoices') {
                                loadInvoicesFromAPI();
                            }
                        } else {
                            showNotification(result.error || 'Upload failed', 'error');
                            showUploadResults(result);
                        }
                    } catch (error) {
                        // Hide progress
                        if (progressContainer) progressContainer.style.display = 'none';
                        if (uploadBtn) uploadBtn.disabled = false;

                        console.error('Upload error:', error);
                        showNotification('Upload failed: ' + error.message, 'error');
                        showUploadResults({
                            success: false,
                            error: 'Upload failed: ' + error.message
                        });
                    }
                });
            }

            // Load upload status when upload page is shown
            if (document.getElementById('upload')) {
                loadUploadStatus();
            }
        });

    </script>

    <!-- Kanban Board JavaScript -->
    <script src="js/kanban-board.js"></script>

    <!-- Workshop Diary JavaScript -->
    <script src="js/workshop-diary.js"></script>

    <!-- Job Sheets & Quotes JavaScript -->
    <script src="js/job-sheets.js"></script>

    <!-- Online Booking JavaScript -->
    <script src="js/online-booking.js"></script>

    <!-- Customer Portal JavaScript -->
    <script src="js/customer-portal.js"></script>

    <script>
        // Job view switching functionality
        function switchJobView(viewType) {
            // Update button states
            document.querySelectorAll('.view-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(viewType + '-view-btn').classList.add('active');

            // Update view visibility
            document.querySelectorAll('.job-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewType + '-view').classList.add('active');

            // Load appropriate data
            if (viewType === 'kanban') {
                if (window.kanban) {
                    window.kanban.refreshBoard();
                }
            } else if (viewType === 'list') {
                loadJobsFromAPI();
            }
        }

        // Filter jobs functionality
        function filterJobs() {
            const searchTerm = document.getElementById('job-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;

            // This will be implemented to filter the job list
            console.log('Filtering jobs:', { searchTerm, statusFilter, priorityFilter });
            // TODO: Implement actual filtering logic
        }
    </script>

    <!-- Critical Performance Optimization Script -->
    <script>
        (function() {
            'use strict';

            console.log('üöÄ Applying critical performance fixes...');

            // 1. Request Caching to reduce API calls
            const requestCache = new Map();
            const CACHE_DURATION = 30000; // 30 seconds

            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                if (!options.method || options.method.toUpperCase() === 'GET') {
                    const cacheKey = url;
                    const now = Date.now();

                    if (requestCache.has(cacheKey)) {
                        const cached = requestCache.get(cacheKey);
                        if (now - cached.timestamp < CACHE_DURATION) {
                            console.log('üì¶ Using cached response for:', url);
                            return Promise.resolve(cached.response.clone());
                        }
                    }

                    return originalFetch(url, options).then(response => {
                        if (response.ok) {
                            requestCache.set(cacheKey, {
                                response: response.clone(),
                                timestamp: now
                            });
                        }
                        return response;
                    });
                }
                return originalFetch(url, options);
            };

            // 2. Prevent excessive intervals
            const originalSetInterval = window.setInterval;
            window.setInterval = function(callback, delay) {
                if (delay < 10000) {
                    console.log('‚ö° Slowing down interval from', delay, 'to', Math.max(delay * 2, 10000));
                    delay = Math.max(delay * 2, 10000); // Minimum 10 seconds
                }
                return originalSetInterval(callback, delay);
            };

            // 3. Cleanup cache periodically
            setInterval(() => {
                const now = Date.now();
                let cleaned = 0;
                for (const [key, value] of requestCache.entries()) {
                    if (now - value.timestamp > CACHE_DURATION) {
                        requestCache.delete(key);
                        cleaned++;
                    }
                }
                if (cleaned > 0) {
                    console.log('üßπ Cleaned up', cleaned, 'expired cache entries');
                }
            }, 60000);

            console.log('‚úÖ Critical performance fixes applied');
        })();
    </script>
</body>
</html>

