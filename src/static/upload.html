<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Data Upload - Garage Management System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI",
          Roboto, sans-serif;
        background-color: #f8f9fa;
      }

      .upload-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      .upload-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .upload-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .upload-header h1 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .upload-header p {
        color: #6c757d;
        font-size: 1.1rem;
      }

      .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #f8f9fa;
        position: relative;
      }

      .upload-zone:hover {
        border-color: #6366f1;
        background-color: #f0f4ff;
        transform: translateY(-2px);
      }

      .upload-zone.dragover {
        border-color: #10b981;
        background-color: #d1fae5;
        transform: scale(1.02);
      }

      .upload-zone #browseBtn {
        margin-top: 1rem;
        position: relative;
        z-index: 10;
      }

      .upload-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
      }

      .table-selector {
        margin: 1.5rem 0;
      }

      .table-selector label {
        font-weight: 600;
        color: #495057;
      }

      .progress-container {
        display: none;
        margin: 1.5rem 0;
      }

      .results-container {
        display: none;
        margin-top: 2rem;
      }

      .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
      }

      .template-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
      }

      .template-card:hover {
        background: #e9ecef;
        transform: translateY(-2px);
      }

      .template-icon {
        font-size: 2rem;
        color: #007bff;
        margin-bottom: 1rem;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="upload-container">
      <!-- Header -->
      <div class="upload-card">
        <div class="upload-header">
          <h1><i class="fas fa-upload"></i> ELI MOTORS Data Upload</h1>
          <p>Import your complete garage database from CSV files</p>
        </div>
      </div>

      <!-- Upload Section -->
      <div class="upload-card">
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="uploadTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="csv-upload-tab" data-bs-toggle="tab" data-bs-target="#csv-upload" type="button" role="tab">
              <i class="fas fa-file-csv"></i> CSV Upload
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="google-drive-tab" data-bs-toggle="tab" data-bs-target="#google-drive" type="button" role="tab">
              <i class="fab fa-google-drive"></i> Google Drive
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="uploadTabContent">
          <!-- CSV Upload Tab -->
          <div class="tab-pane fade show active" id="csv-upload" role="tabpanel">
            <h3><i class="fas fa-file-csv"></i> Upload CSV Files</h3>
            <p class="text-muted">
              Select the type of data you're uploading and choose your CSV file
            </p>

        <form id="uploadForm" enctype="multipart/form-data">
          <div class="table-selector">
            <label for="tableSelect" class="form-label">Data Type:</label>
            <select id="tableSelect" name="table_name" class="form-select">
              <option value="customers">Customers</option>
              <option value="vehicles">Vehicles</option>
              <option value="jobs">Jobs/Work Orders</option>
              <option value="invoices">Invoices</option>
              <option value="parts">Parts/Stock</option>
              <option value="suppliers">Suppliers</option>
              <option value="expenses">Expenses</option>
              <option value="document_extras">
                Document Extras (Job Descriptions)
              </option>
              <option value="documents">
                Documents (Jobs + Invoices + Vehicles)
              </option>
              <option value="receipts">Receipts/Payments</option>
            </select>
          </div>

          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h4 id="uploadText">Drag & Drop your CSV file here</h4>
            <p class="text-muted">
              or click to browse files, or use Google Drive integration
            </p>
            <input
              type="file"
              id="fileInput"
              name="file"
              accept=".csv,.xlsx,.xls"
              style="display: none"
            />
            <button type="button" class="btn btn-primary" id="browseBtn">
              <i class="fas fa-folder-open"></i> Browse Files
            </button>
            <div class="btn-group ms-2" role="group">
              <button type="button" class="btn btn-success" id="googleDriveBtn">
                <i class="fab fa-google-drive"></i> Google Drive
              </button>
              <button
                type="button"
                class="btn btn-outline-success"
                title="Switch to Google Drive tab"
                onclick="document.getElementById('google-drive-tab').click()"
              >
                <i class="fas fa-external-link-alt"></i>
              </button>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="clearExisting"
                  name="clear_existing"
                />
                <label class="form-check-label" for="clearExisting">
                  Clear existing data before import
                </label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="updateDuplicates"
                  name="update_duplicates"
                  checked
                />
                <label class="form-check-label" for="updateDuplicates">
                  Update existing records
                </label>
              </div>
            </div>
          </div>

          <div class="progress-container">
            <div class="progress">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
              ></div>
            </div>
            <p class="text-center mt-2">Uploading and processing...</p>
          </div>

          <div class="text-center mt-3">
            <button
              type="submit"
              class="btn btn-success btn-lg"
              id="uploadBtn"
              disabled
            >
              <i class="fas fa-upload"></i> Upload Data
            </button>
          </div>
        </form>

            <div class="results-container" id="resultsContainer">
              <div class="alert" id="resultsAlert"></div>
              <div id="resultsDetails"></div>
            </div>
          </div>
          <!-- End CSV Upload Tab -->

          <!-- Google Drive Tab -->
          <div class="tab-pane fade" id="google-drive" role="tabpanel">
            <div id="googleDriveContent">
              <!-- Google Drive content will be loaded here -->
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading Google Drive integration...</p>
              </div>
            </div>
          </div>
          <!-- End Google Drive Tab -->
        </div>
        <!-- End Tab Content -->
      </div>

      <!-- Templates Section -->
      <div class="upload-card">
        <h3><i class="fas fa-download"></i> Download Templates</h3>
        <p class="text-muted">
          Download CSV templates to ensure your data is formatted correctly
        </p>

        <div class="template-grid">
          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-users"></i>
            </div>
            <h5>Customers</h5>
            <p class="text-muted">Customer information and contact details</p>
            <a
              href="/api/templates/customers"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-car"></i>
            </div>
            <h5>Vehicles</h5>
            <p class="text-muted">Vehicle registrations and details</p>
            <a
              href="/api/templates/vehicles"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-wrench"></i>
            </div>
            <h5>Jobs</h5>
            <p class="text-muted">Work orders and job records</p>
            <a
              href="/api/templates/jobs"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-file-invoice"></i>
            </div>
            <h5>Invoices</h5>
            <p class="text-muted">Invoice and billing records</p>
            <a
              href="/api/templates/invoices"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-cogs"></i>
            </div>
            <h5>Parts</h5>
            <p class="text-muted">Parts inventory and stock</p>
            <a
              href="/api/templates/parts"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-truck"></i>
            </div>
            <h5>Suppliers</h5>
            <p class="text-muted">Supplier contact information</p>
            <a
              href="/api/templates/suppliers"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-receipt"></i>
            </div>
            <h5>Expenses</h5>
            <p class="text-muted">Business expenses and costs</p>
            <a
              href="/api/templates/expenses"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-file-alt"></i>
            </div>
            <h5>Document Extras</h5>
            <p class="text-muted">Job descriptions and service notes</p>
            <a
              href="/api/templates/document_extras"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-file-invoice"></i>
            </div>
            <h5>Documents</h5>
            <p class="text-muted">Complete job, invoice & vehicle data</p>
            <a
              href="/api/templates/documents"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>

          <div class="template-card">
            <div class="template-icon">
              <i class="fas fa-credit-card"></i>
            </div>
            <h5>Receipts</h5>
            <p class="text-muted">Payment records and transactions</p>
            <a
              href="/api/templates/receipts"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-download"></i> Download
            </a>
          </div>
        </div>
      </div>

      <!-- Statistics Section -->
      <div class="upload-card">
        <h3><i class="fas fa-chart-bar"></i> Database Statistics</h3>
        <p class="text-muted">Current record counts in your database</p>

        <div class="stats-grid" id="statsGrid">
          <!-- Stats will be loaded here -->
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Debug System -->
    <script src="/js/debug-system.js"></script>
    <script src="/js/garage-issue-tracker.js"></script>

    <script>
      // Upload functionality
      const uploadZone = document.getElementById("uploadZone");
      const fileInput = document.getElementById("fileInput");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadForm = document.getElementById("uploadForm");
      const progressContainer = document.querySelector(".progress-container");
      const resultsContainer = document.getElementById("resultsContainer");
      const browseBtn = document.getElementById("browseBtn");
      const googleDriveBtn = document.getElementById("googleDriveBtn");
      const uploadText = document.getElementById("uploadText");

      // Debug logging
      console.log("Upload elements found:", {
        uploadZone: !!uploadZone,
        fileInput: !!fileInput,
        uploadBtn: !!uploadBtn,
        browseBtn: !!browseBtn,
        googleDriveBtn: !!googleDriveBtn,
      });

      // Browse button click handler
      if (browseBtn) {
        browseBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          console.log("Browse button clicked");
          if (fileInput) {
            fileInput.click();
          } else {
            console.error("File input not found");
          }
        });
      }

      // Google Drive button click handler
      if (googleDriveBtn) {
        googleDriveBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          console.log("Google Drive button clicked - switching to Google Drive tab");

          // Switch to Google Drive tab
          const googleDriveTab = document.getElementById('google-drive-tab');
          if (googleDriveTab) {
            const tab = new bootstrap.Tab(googleDriveTab);
            tab.show();
          }
        });
        console.log("Google Drive button event listener added");
      } else {
        console.error("Google Drive button not found");
      }

      // Upload zone click handler (but not when clicking the buttons)
      if (uploadZone) {
        uploadZone.addEventListener("click", (e) => {
          // Don't trigger if clicking any buttons or links
          if (
            e.target.closest("#browseBtn") ||
            e.target.closest("#googleDriveBtn") ||
            e.target.closest(".btn-group")
          ) {
            return;
          }
          console.log("Upload zone clicked");
          if (fileInput) {
            fileInput.click();
          }
        });
      }

      // Drag and drop functionality
      if (uploadZone) {
        uploadZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadZone.classList.add("dragover");
        });

        uploadZone.addEventListener("dragleave", () => {
          uploadZone.classList.remove("dragover");
        });

        uploadZone.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadZone.classList.remove("dragover");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFileSelection(files);
          }
        });
      }

      // File input change handler
      if (fileInput) {
        fileInput.addEventListener("change", (e) => {
          console.log("File input changed:", e.target.files.length);
          if (e.target.files.length > 0) {
            handleFileSelection(e.target.files);
          }
        });
      }

      function handleFileSelection(files) {
        console.log("Handling file selection:", files.length);
        if (files.length > 0) {
          const file = files[0];
          console.log("Selected file:", file.name);

          // Update the file input if it's from drag and drop
          if (fileInput && files !== fileInput.files) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
          }

          updateUploadButton(file);
        }
      }

      function updateUploadButton(file = null) {
        const hasFiles = fileInput && fileInput.files.length > 0;
        console.log("Updating upload button:", hasFiles);

        if (uploadBtn) {
          uploadBtn.disabled = !hasFiles;
        }

        if (hasFiles) {
          const fileName = file ? file.name : fileInput.files[0].name;
          if (uploadText) {
            uploadText.textContent = `Selected: ${fileName}`;
          }
          console.log("File selected:", fileName);
        } else {
          if (uploadText) {
            uploadText.textContent = "Drag & Drop your CSV file here";
          }
        }
      }

      // Form submission
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!fileInput.files.length) {
          alert("Please select a file to upload");
          return;
        }

        const formData = new FormData(uploadForm);

        // Show progress
        progressContainer.style.display = "block";
        uploadBtn.disabled = true;
        resultsContainer.style.display = "none";

        try {
          const response = await fetch("/api/csv", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          // Hide progress
          progressContainer.style.display = "none";
          uploadBtn.disabled = false;

          // Show results
          showResults(result);

          // Refresh stats
          loadStats();
        } catch (error) {
          progressContainer.style.display = "none";
          uploadBtn.disabled = false;

          showResults({
            success: false,
            error: "Upload failed: " + error.message,
          });
        }
      });

      function showResults(result) {
        const alertDiv = document.getElementById("resultsAlert");
        const detailsDiv = document.getElementById("resultsDetails");

        if (result.success) {
          alertDiv.className = "alert alert-success";
          alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> Upload completed successfully!
                    <br>Imported: ${result.imported || 0} | Failed: ${result.failed || 0} | Duplicates: ${result.duplicates || 0}
                `;

          if (result.errors && result.errors.length > 0) {
            detailsDiv.innerHTML = `
                        <h6>Errors encountered:</h6>
                        <ul class="list-unstyled">
                            ${result.errors.map((error) => `<li class="text-warning"><i class="fas fa-exclamation-triangle"></i> ${error}</li>`).join("")}
                        </ul>
                    `;
          }
        } else {
          alertDiv.className = "alert alert-danger";
          alertDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${result.error}`;
          detailsDiv.innerHTML = "";
        }

        resultsContainer.style.display = "block";
      }

      // Load statistics
      async function loadStats() {
        try {
          const response = await fetch("/api/status");
          const result = await response.json();

          if (result.success) {
            const statsGrid = document.getElementById("statsGrid");
            const counts = result.counts;

            statsGrid.innerHTML = Object.entries(counts)
              .map(
                ([table, count]) => `
                        <div class="stat-card">
                            <div class="stat-number">${count.toLocaleString()}</div>
                            <div class="stat-label">${table.charAt(0).toUpperCase() + table.slice(1)}</div>
                        </div>
                    `,
              )
              .join("");
          }
        } catch (error) {
          console.error("Failed to load stats:", error);
        }
      }

      // Google Drive integration
      async function loadGoogleDriveContent() {
        console.log("Loading Google Drive content...");

        const contentDiv = document.getElementById("googleDriveContent");
        if (!contentDiv) return;

        try {
          // Show loading state
          contentDiv.innerHTML = `
            <div class="text-center">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading Google Drive integration...</p>
            </div>
          `;

          // Fetch Google Drive status first
          const statusResponse = await fetch('/google-drive/status');
          const status = await statusResponse.json();

          // Create embedded Google Drive interface
          const connected = status.status.connected;

          contentDiv.innerHTML = `
            <div class="google-drive-integration">
              <div class="row">
                <div class="col-12">
                  <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                      <h5 class="mb-0">
                        <i class="fab fa-google-drive"></i> Google Drive Integration
                      </h5>
                      <small>Automatic synchronization with Google Drive folders for real-time data updates</small>
                    </div>
                    <div class="card-body">
                      <div id="googleDriveStatus">
                        ${connected ?
                          '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Connected to Google Drive</div>' :
                          '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Setup Required - You need to create Google Cloud credentials first.</div>'
                        }
                      </div>

                      ${!connected ? `
                        <div class="setup-section">
                          <h6><i class="fas fa-cloud-upload-alt"></i> Setup Instructions</h6>
                          <ol class="mb-3">
                            <li>Create Google Cloud credentials (JSON file)</li>
                            <li>Upload credentials using the form below</li>
                            <li>Authorize access to your Google Drive</li>
                            <li>Configure folder mappings for automatic sync</li>
                          </ol>

                          <form id="embeddedCredentialsForm" class="mt-3">
                            <div class="mb-3">
                              <label for="embeddedCredentialsFile" class="form-label">Google Cloud Credentials (JSON)</label>
                              <input type="file" class="form-control" id="embeddedCredentialsFile" accept=".json" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                              <i class="fas fa-upload"></i> Upload Credentials
                            </button>
                          </form>
                        </div>
                      ` : `
                        <div class="connected-section">
                          <div class="row">
                            <div class="col-md-6">
                              <div class="card">
                                <div class="card-header">
                                  <h6><i class="fas fa-folder"></i> Folder Configuration</h6>
                                </div>
                                <div class="card-body">
                                  <p>Configure which Google Drive folders contain your data files.</p>
                                  <button class="btn btn-primary" onclick="showFolderConfig()">
                                    <i class="fas fa-cog"></i> Configure Folders
                                  </button>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="card">
                                <div class="card-header">
                                  <h6><i class="fas fa-sync"></i> Synchronization</h6>
                                </div>
                                <div class="card-body">
                                  <p>Manually sync data or enable automatic synchronization.</p>
                                  <button class="btn btn-success" onclick="syncGoogleDriveNow()">
                                    <i class="fas fa-sync"></i> Sync Now
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      `}

                      <div class="row mt-3">
                        <div class="col-md-6">
                          <button class="btn btn-outline-primary w-100" onclick="checkGoogleDriveStatus()">
                            <i class="fas fa-refresh"></i> Refresh Status
                          </button>
                        </div>
                        <div class="col-md-6">
                          <button class="btn btn-outline-secondary w-100" onclick="showGoogleDriveHelp()">
                            <i class="fas fa-question-circle"></i> Help & Documentation
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          // Initialize embedded form if present
          const embeddedForm = document.getElementById('embeddedCredentialsForm');
          if (embeddedForm) {
            embeddedForm.addEventListener('submit', handleEmbeddedCredentialsUpload);
          }
        } catch (error) {
          console.error('Failed to load Google Drive content:', error);
          contentDiv.innerHTML = `
            <div class="alert alert-warning">
              <h5><i class="fas fa-exclamation-triangle"></i> Google Drive Integration</h5>
              <p>Unable to load Google Drive interface. Please try refreshing the page.</p>
              <button class="btn btn-primary" onclick="loadGoogleDriveContent()">
                <i class="fas fa-refresh"></i> Retry
              </button>
            </div>
          `;
        }
      }

      // Google Drive helper functions
      async function setupGoogleDrive() {
        console.log("Setting up Google Drive credentials...");

        const contentDiv = document.getElementById("googleDriveContent");
        if (!contentDiv) return;

        try {
          // Show loading state
          contentDiv.innerHTML = `
            <div class="text-center">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading Google Drive setup...</p>
            </div>
          `;

          // Fetch the full Google Drive page content
          const response = await fetch('/google-drive/');
          const html = await response.text();

          // Extract the main content
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');

          // Get the main container content
          const mainContent = doc.querySelector('.container') || doc.querySelector('main') || doc.body;

          if (mainContent) {
            // Remove any "Back to Dashboard" links and update them
            const backLinks = mainContent.querySelectorAll('a[href*="dashboard"], a[href="/"]');
            backLinks.forEach(link => {
              link.onclick = function(e) {
                e.preventDefault();
                loadGoogleDriveContent(); // Go back to status view
              };
              link.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Upload';
            });

            contentDiv.innerHTML = mainContent.innerHTML;

            // Initialize any scripts that might be needed
            initializeGoogleDriveScripts();
          } else {
            throw new Error('Could not find main content');
          }
        } catch (error) {
          console.error('Failed to load Google Drive setup:', error);
          contentDiv.innerHTML = `
            <div class="alert alert-danger">
              <h5><i class="fas fa-exclamation-triangle"></i> Setup Error</h5>
              <p>Unable to load Google Drive setup interface. Please try again.</p>
              <button class="btn btn-primary" onclick="setupGoogleDrive()">
                <i class="fas fa-refresh"></i> Retry Setup
              </button>
              <button class="btn btn-secondary ms-2" onclick="loadGoogleDriveContent()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
            </div>
          `;
        }
      }

      // Initialize Google Drive scripts and event handlers
      function initializeGoogleDriveScripts() {
        // Re-bind any form submissions to use AJAX instead of page redirects
        const forms = document.querySelectorAll('#googleDriveContent form');
        forms.forEach(form => {
          form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(form);
            const action = form.action || form.getAttribute('action');

            try {
              const response = await fetch(action, {
                method: 'POST',
                body: formData
              });

              const result = await response.json();

              if (result.success) {
                // Refresh the Google Drive content to show updated status
                await loadGoogleDriveContent();
              } else {
                alert('Error: ' + (result.error || 'Unknown error occurred'));
              }
            } catch (error) {
              console.error('Form submission error:', error);
              alert('Error submitting form. Please try again.');
            }
          });
        });

        // Re-bind any buttons that might open new windows
        const externalLinks = document.querySelectorAll('#googleDriveContent a[target="_blank"]');
        externalLinks.forEach(link => {
          link.removeAttribute('target');
          link.onclick = function(e) {
            e.preventDefault();
            // Handle the action within the current interface
            const href = link.href;
            if (href.includes('google-drive')) {
              // Load the content inline
              fetch(href)
                .then(response => response.text())
                .then(html => {
                  const parser = new DOMParser();
                  const doc = parser.parseFromString(html, 'text/html');
                  const content = doc.querySelector('.container') || doc.body;
                  document.getElementById('googleDriveContent').innerHTML = content.innerHTML;
                  initializeGoogleDriveScripts();
                })
                .catch(error => {
                  console.error('Error loading content:', error);
                });
            }
          };
        });
      }

      async function checkGoogleDriveStatus() {
        await loadGoogleDriveContent();
      }

      // Embedded Google Drive helper functions
      async function handleEmbeddedCredentialsUpload(e) {
        e.preventDefault();

        const fileInput = document.getElementById('embeddedCredentialsFile');
        const file = fileInput.files[0];

        if (!file) {
          alert('Please select a credentials file');
          return;
        }

        const formData = new FormData();
        formData.append('credentials', file);

        try {
          const response = await fetch('/google-drive/upload-credentials', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            alert('Credentials uploaded successfully! Refreshing status...');
            await loadGoogleDriveContent();
          } else {
            alert('Error: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Upload error:', error);
          alert('Error uploading credentials. Please try again.');
        }
      }

      function showFolderConfig() {
        const contentDiv = document.getElementById("googleDriveContent");
        contentDiv.innerHTML = `
          <div class="folder-config">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5><i class="fas fa-folder"></i> Folder Configuration</h5>
              <button class="btn btn-secondary" onclick="loadGoogleDriveContent()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
            </div>

            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> Configure which Google Drive folders contain your data files for automatic synchronization.
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6>Available Data Types</h6>
                  </div>
                  <div class="card-body">
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item">Customers</li>
                      <li class="list-group-item">Vehicles</li>
                      <li class="list-group-item">Jobs</li>
                      <li class="list-group-item">Invoices</li>
                      <li class="list-group-item">Parts</li>
                      <li class="list-group-item">MOT Records</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6>Quick Setup</h6>
                  </div>
                  <div class="card-body">
                    <p>Use smart mapping to automatically detect and configure folders.</p>
                    <button class="btn btn-primary w-100" onclick="startSmartMapping()">
                      <i class="fas fa-magic"></i> Smart Setup
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function syncGoogleDriveNow() {
        alert('Starting manual synchronization...\n\nThis would sync all configured Google Drive folders with your database.');
      }

      function showGoogleDriveHelp() {
        const contentDiv = document.getElementById("googleDriveContent");
        contentDiv.innerHTML = `
          <div class="help-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5><i class="fas fa-question-circle"></i> Google Drive Help</h5>
              <button class="btn btn-secondary" onclick="loadGoogleDriveContent()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h6>How Google Drive Integration Works</h6>
                  </div>
                  <div class="card-body">
                    <ol>
                      <li><strong>One-time setup:</strong> Connect your Google Drive account (like signing into Gmail)</li>
                      <li><strong>Choose folders:</strong> Tell us which Google Drive folders contain your data files</li>
                      <li><strong>Automatic sync:</strong> We'll check for updates every 30 minutes and import new data</li>
                    </ol>

                    <div class="alert alert-success mt-3">
                      <i class="fas fa-shield-alt"></i> <strong>Secure:</strong> We only read your files, never modify or delete them.
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6>Getting Google Cloud Credentials</h6>
                  </div>
                  <div class="card-body">
                    <ol>
                      <li>Go to Google Cloud Console</li>
                      <li>Create a new project or select existing</li>
                      <li>Enable Google Drive API</li>
                      <li>Create service account credentials</li>
                      <li>Download JSON credentials file</li>
                    </ol>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6>Supported File Types</h6>
                  </div>
                  <div class="card-body">
                    <ul>
                      <li>CSV files (.csv)</li>
                      <li>Excel files (.xlsx, .xls)</li>
                      <li>Text files (.txt)</li>
                    </ul>
                    <p class="text-muted">Files are automatically detected and categorized based on content and folder structure.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function startSmartMapping() {
        alert('Smart mapping would analyze your Google Drive folders and automatically suggest the best configuration for your data types.');
      }

      // Tab switching functionality
      document.addEventListener('DOMContentLoaded', function() {
        const googleDriveTab = document.getElementById('google-drive-tab');
        if (googleDriveTab) {
          googleDriveTab.addEventListener('shown.bs.tab', function() {
            loadGoogleDriveContent();
          });
        }
      });

      // Load stats on page load
      loadStats();

      // Debug commands for console
      window.debugCommands = {
        // Generate comprehensive report
        report: () => {
          console.log('🔧 GARAGE DEBUG REPORT:');
          if (window.garageDebug) {
            const report = window.garageDebug.generateDiagnosticReport();
            console.table(report.summary);
            console.log('Critical Issues:', report.criticalIssues);
            return report;
          }
        },

        // Test Google Drive button
        testGoogleDrive: () => {
          console.log('🔍 Testing Google Drive button...');
          const btn = document.getElementById('googleDriveBtn');
          if (btn) {
            console.log('Button found, simulating click...');
            btn.click();
          } else {
            console.error('Google Drive button not found!');
          }
        },

        // Test tab switching
        testTabSwitch: () => {
          console.log('🔍 Testing tab switching...');
          const tab = document.getElementById('google-drive-tab');
          if (tab) {
            console.log('Tab found, switching...');
            const bsTab = new bootstrap.Tab(tab);
            bsTab.show();
          } else {
            console.error('Google Drive tab not found!');
          }
        },

        // Test upload form
        testUpload: () => {
          console.log('🔍 Testing upload form...');
          const form = document.getElementById('uploadForm');
          if (form) {
            console.log('Form found, checking validation...');
            console.log('Form action:', form.action);
            console.log('Form method:', form.method);
            console.log('Has file input:', !!form.querySelector('input[type="file"]'));
          } else {
            console.error('Upload form not found!');
          }
        },

        // Check current state
        checkState: () => {
          console.log('🔍 Current page state:');
          console.log('URL:', window.location.href);
          console.log('Active tab:', document.querySelector('.nav-link.active')?.id);
          console.log('Google Drive button:', !!document.getElementById('googleDriveBtn'));
          console.log('Upload form:', !!document.getElementById('uploadForm'));
          console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined');
          console.log('Debug system:', !!window.garageDebug);
          console.log('Issue tracker:', !!window.garageIssueTracker);
        },

        // Export logs
        exportLogs: () => {
          if (window.garageDebug) {
            window.garageDebug.exportLogs();
          }
          if (window.garageIssueTracker) {
            const report = window.garageIssueTracker.generateReport();
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `garage-issues-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
          }
        }
      };

      // Show available debug commands
      console.log('🔧 Garage Debug System loaded!');
      console.log('Available commands:');
      console.log('- debugCommands.report() - Generate diagnostic report');
      console.log('- debugCommands.testGoogleDrive() - Test Google Drive button');
      console.log('- debugCommands.testTabSwitch() - Test tab switching');
      console.log('- debugCommands.testUpload() - Test upload form');
      console.log('- debugCommands.checkState() - Check current state');
      console.log('- debugCommands.exportLogs() - Export debug logs');
      console.log('');
      console.log('Debug panel is visible in top-right corner');
      console.log('Issue tracker is monitoring all interactions');
    </script>
  </body>
</html>
